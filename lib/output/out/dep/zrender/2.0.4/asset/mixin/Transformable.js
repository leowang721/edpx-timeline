/*! @2014 Leo Wang. All Rights Reserved */
define("zrender/mixin/Transformable",["require","../tool/matrix","../tool/vector"],function(require){"use strict";function e(e){return e>-r&&r>e}function t(e){return e>r||-r>e}var n=require("../tool/matrix"),i=require("../tool/vector"),a=[0,0],r=5e-5,o=function(){if(!this.position)this.position=[0,0];if("undefined"==typeof this.rotation)this.rotation=[0,0,0];if(!this.scale)this.scale=[1,1,0,0];this.needLocalTransform=!1,this.needTransform=!1};return o.prototype={constructor:o,updateNeedTransform:function(){this.needLocalTransform=t(this.rotation[0])||t(this.position[0])||t(this.position[1])||t(this.scale[0]-1)||t(this.scale[1]-1)},updateTransform:function(){if(this.updateNeedTransform(),this.parent)this.needTransform=this.needLocalTransform||this.parent.needTransform;else this.needTransform=this.needLocalTransform;if(this.needTransform){var e=this.transform||n.create();if(n.identity(e),this.needLocalTransform){if(t(this.scale[0])||t(this.scale[1])){a[0]=-this.scale[2]||0,a[1]=-this.scale[3]||0;var i=t(a[0])||t(a[1]);if(i)n.translate(e,e,a);if(n.scale(e,e,this.scale),i)a[0]=-a[0],a[1]=-a[1],n.translate(e,e,a)}if(this.rotation instanceof Array){if(0!==this.rotation[0]){a[0]=-this.rotation[1]||0,a[1]=-this.rotation[2]||0;var i=t(a[0])||t(a[1]);if(i)n.translate(e,e,a);if(n.rotate(e,e,this.rotation[0]),i)a[0]=-a[0],a[1]=-a[1],n.translate(e,e,a)}}else if(0!==this.rotation)n.rotate(e,e,this.rotation);if(t(this.position[0])||t(this.position[1]))n.translate(e,e,this.position)}if(this.transform=e,this.parent&&this.parent.needTransform)if(this.needLocalTransform)n.mul(this.transform,this.parent.transform,this.transform);else n.copy(this.transform,this.parent.transform)}},setTransform:function(e){if(this.needTransform){var t=this.transform;e.transform(t[0],t[1],t[2],t[3],t[4],t[5])}},lookAt:function(){var t=i.create();return function(a){if(!this.transform)this.transform=n.create();var r=this.transform;if(i.sub(t,a,this.position),!e(t[0])||!e(t[1]))i.normalize(t,t),r[2]=t[0]*this.scale[1],r[3]=t[1]*this.scale[1],r[0]=t[1]*this.scale[0],r[1]=-t[0]*this.scale[0],r[4]=this.position[0],r[5]=this.position[1],this.decomposeTransform()}}(),decomposeTransform:function(){if(this.transform){var e=this.transform,n=e[0]*e[0]+e[1]*e[1],i=this.position,a=this.scale,r=this.rotation;if(t(n-1))n=Math.sqrt(n);var o=e[2]*e[2]+e[3]*e[3];if(t(o-1))o=Math.sqrt(o);i[0]=e[4],i[1]=e[5],a[0]=n,a[1]=o,a[2]=a[3]=0,r[0]=Math.atan2(-e[1]/o,e[0]/n),r[1]=r[2]=0}}},o});