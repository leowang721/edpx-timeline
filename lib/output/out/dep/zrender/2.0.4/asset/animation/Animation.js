/*! @2014 Leo Wang. All Rights Reserved */
define("zrender/animation/Animation",["require","./Clip","../tool/color","../tool/util","../tool/event"],function(require){"use strict";function e(e,t){return e[t]}function t(e,t,n){e[t]=n}function n(e,t,n){return(t-e)*n+e}function i(e,t,i,a,r){var o=e.length;if(1==r)for(var s=0;o>s;s++)a[s]=n(e[s],t[s],i);else for(var l=e[0].length,s=0;o>s;s++)for(var h=0;l>h;h++)a[s][h]=n(e[s][h],t[s][h],i)}function a(e){switch(typeof e){case"undefined":case"string":return!1}return"undefined"!=typeof e.length}function r(e,t,n,i,a,r,s,l,h){var d=e.length;if(1==h)for(var m=0;d>m;m++)l[m]=o(e[m],t[m],n[m],i[m],a,r,s);else for(var u=e[0].length,m=0;d>m;m++)for(var p=0;u>p;p++)l[m][p]=o(e[m][p],t[m][p],n[m][p],i[m][p],a,r,s)}function o(e,t,n,i,a,r,o){var s=.5*(n-e),l=.5*(i-t);return(2*(t-n)+s+l)*o+(-3*(t-n)-2*s-l)*r+s*a+t}function s(e){if(a(e)){var t=e.length;if(a(e[0])){for(var n=[],i=0;t>i;i++)n.push(c.call(e[i]));return n}else return c.call(e)}else return e}function l(e){return e[0]=Math.floor(e[0]),e[1]=Math.floor(e[1]),e[2]=Math.floor(e[2]),"rgba("+e.join(",")+")"}var h=require("./Clip"),d=require("../tool/color"),m=require("../tool/util"),u=require("../tool/event").Dispatcher,p=window.requestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){setTimeout(e,16)},c=Array.prototype.slice,f=function(e){e=e||{},this.stage=e.stage||{},this.onframe=e.onframe||function(){},this._clips=[],this._running=!1,this._time=0,u.call(this)};f.prototype={add:function(e){this._clips.push(e)},remove:function(e){var t=m.indexOf(this._clips,e);if(t>=0)this._clips.splice(t,1)},_update:function(){for(var e=(new Date).getTime(),t=e-this._time,n=this._clips,i=n.length,a=[],r=[],o=0;i>o;o++){var s=n[o],l=s.step(e);if(l)a.push(l),r.push(s)}if(this.stage.update)this.stage.update();for(var o=0;i>o;)if(n[o]._needsRemove)n[o]=n[i-1],n.pop(),i--;else o++;i=a.length;for(var o=0;i>o;o++)r[o].fire(a[o]);this._time=e,this.onframe(t),this.dispatch("frame",t)},start:function(){function e(){if(t._running)t._update(),p(e)}var t=this;this._running=!0,this._time=(new Date).getTime(),p(e)},stop:function(){this._running=!1},clear:function(){this._clips=[]},animate:function(e,t){t=t||{};var n=new V(e,t.loop,t.getter,t.setter);return n.animation=this,n},constructor:f},m.merge(f.prototype,u.prototype,!0);var V=function(n,i,a,r){this._tracks={},this._target=n,this._loop=i||!1,this._getter=a||e,this._setter=r||t,this._clipCount=0,this._delay=0,this._doneList=[],this._onframeList=[],this._clipList=[]};return V.prototype={when:function(e,t){for(var n in t){if(!this._tracks[n])if(this._tracks[n]=[],0!==e)this._tracks[n].push({time:0,value:s(this._getter(this._target,n))});this._tracks[n].push({time:parseInt(e,10),value:t[n]})}return this},during:function(e){return this._onframeList.push(e),this},start:function(e){var t=this,s=this._setter,m=this._getter,u=t._onframeList.length,p="spline"===e,c=function(){if(t._clipCount--,0===t._clipCount){t._tracks={};for(var e=t._doneList.length,n=0;e>n;n++)t._doneList[n].call(t)}},f=function(f,V){var U=f.length;if(U){var y=f[0].value,g=a(y),_=!1,b=g&&a(y[0])?2:1;f.sort(function(e,t){return e.time-t.time});var k;if(U){k=f[U-1].time;for(var L=[],x=[],v=0;U>v;v++){L.push(f[v].time/k);var w=f[v].value;if("string"==typeof w){if(w=d.toArray(w),0===w.length)w[0]=w[1]=w[2]=0,w[3]=1;_=!0}x.push(w)}var W,v,X,I,K,M,C,T=0,S=0;if(_)var D=[0,0,0,0];var J=function(e,a){if(S>a){for(W=Math.min(T+1,U-1),v=W;v>=0&&!(L[v]<=a);v--);v=Math.min(v,U-2)}else{for(v=T;U>v&&!(L[v]>a);v++);v=Math.min(v-1,U-2)}T=v,S=a;var h=L[v+1]-L[v];if(0!==h){if(X=(a-L[v])/h,p)if(K=x[v],I=x[0===v?v:v-1],M=x[v>U-2?U-1:v+1],C=x[v>U-3?U-1:v+2],g)r(I,K,M,C,X,X*X,X*X*X,m(e,V),b);else{var d;if(_)d=r(I,K,M,C,X,X*X,X*X*X,D,1),d=l(D);else d=o(I,K,M,C,X,X*X,X*X*X);s(e,V,d)}else if(g)i(x[v],x[v+1],X,m(e,V),b);else{var d;if(_)i(x[v],x[v+1],X,D,1),d=l(D);else d=n(x[v],x[v+1],X);s(e,V,d)}for(v=0;u>v;v++)t._onframeList[v](e,a)}},E=new h({target:t._target,life:k,loop:t._loop,delay:t._delay,onframe:J,ondestroy:c});if(e&&"spline"!==e)E.easing=e;t._clipList.push(E),t._clipCount++,t.animation.add(E)}else;}};for(var V in this._tracks)f(this._tracks[V],V);return this},stop:function(){for(var e=0;e<this._clipList.length;e++){var t=this._clipList[e];this.animation.remove(t)}this._clipList=[]},delay:function(e){return this._delay=e,this},done:function(e){return this._doneList.push(e),this}},f});