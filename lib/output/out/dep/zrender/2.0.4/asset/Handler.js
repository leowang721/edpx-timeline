/*! @2014 Leo Wang. All Rights Reserved */
define("zrender/Handler",["require","./config","./tool/env","./tool/event","./tool/util","./tool/vector","./tool/matrix","./mixin/Eventful"],function(require){"use strict";function e(e,t){return function(n){return e.call(t,n)}}function t(e,t){return function(n,i,a){return e.call(t,n,i,a)}}function n(t){for(var n=u.length;n--;){var i=u[n];t["_"+i+"Handler"]=e(p[i],t)}}function i(e,t,n){if(this._draggingTarget&&this._draggingTarget.id==e.id||e.isSilent())return!1;var i=this._event;if(e.isCover(t,n)){if(e.hoverable)this.storage.addHover(e);for(var a=e.parent;a;){if(a.clipShape&&!a.clipShape.isCover(this._mouseX,this._mouseY))return!1;a=a.parent}if(this._lastHover!=e)this._processOutShape(i),this._processDragLeave(i),this._lastHover=e,this._processDragEnter(i);return this._processOverShape(i),this._processDragOver(i),this._hasfound=1,!0}return!1}var a=require("./config"),r=require("./tool/env"),o=require("./tool/event"),s=require("./tool/util"),l=require("./tool/vector"),h=require("./tool/matrix"),d=a.EVENT,m=require("./mixin/Eventful"),u=["resize","click","dblclick","mousewheel","mousemove","mouseout","mouseup","mousedown","touchstart","touchend","touchmove"],p={resize:function(e){e=e||window.event,this._lastHover=null,this._isMouseDown=0,this.dispatch(d.RESIZE,e)},click:function(e){e=this._zrenderEventFixed(e);var t=this._lastHover;if(t&&t.clickable||!t)this._dispatchAgency(t,d.CLICK,e);this._mousemoveHandler(e)},dblclick:function(e){e=this._zrenderEventFixed(e);var t=this._lastHover;if(t&&t.clickable||!t)this._dispatchAgency(t,d.DBLCLICK,e);this._mousemoveHandler(e)},mousewheel:function(e){e=this._zrenderEventFixed(e);var t=e.wheelDelta||-e.detail,n=t>0?1.1:1/1.1,i=this.painter.getLayers(),a=!1;for(var r in i)if("hover"!==r){var o=i[r],s=o.position;if(o.zoomable){o.__zoom=o.__zoom||1;var l=o.__zoom;l*=n,l=Math.max(Math.min(o.maxZoom,l),o.minZoom),n=l/o.__zoom,o.__zoom=l,s[0]-=(this._mouseX-s[0])*(n-1),s[1]-=(this._mouseY-s[1])*(n-1),o.scale[0]*=n,o.scale[1]*=n,o.dirty=!0,a=!0}}if(a)this.painter.refresh();this._dispatchAgency(this._lastHover,d.MOUSEWHEEL,e),this._mousemoveHandler(e)},mousemove:function(e){if(!this.painter.isLoading()){e=this._zrenderEventFixed(e),this._lastX=this._mouseX,this._lastY=this._mouseY,this._mouseX=o.getX(e),this._mouseY=o.getY(e);var t=this._mouseX-this._lastX,n=this._mouseY-this._lastY;if(this._processDragStart(e),this._hasfound=0,this._event=e,this._iterateAndFindHover(),!this._hasfound){if(!this._draggingTarget||this._lastHover&&this._lastHover!=this._draggingTarget)this._processOutShape(e),this._processDragLeave(e);this._lastHover=null,this.storage.delHover(),this.painter.clearHover()}var i="default";if(this._draggingTarget)this.storage.drift(this._draggingTarget.id,t,n),this.storage.addHover(this._draggingTarget);else if(this._isMouseDown){var a=this.painter.getLayers(),r=!1;for(var s in a)if("hover"!==s){var l=a[s];if(l.panable)i="move",l.position[0]+=t,l.position[1]+=n,r=!0,l.dirty=!0}if(r)this.painter.refresh()}if(this._draggingTarget||this._hasfound&&this._lastHover.draggable)i="move";else if(this._hasfound&&this._lastHover.clickable)i="pointer";if(this.root.style.cursor=i,this._dispatchAgency(this._lastHover,d.MOUSEMOVE,e),this._draggingTarget||this._hasfound||this.storage.hasHoverShape())this.painter.refreshHover()}},mouseout:function(e){e=this._zrenderEventFixed(e);var t=e.toElement||e.relatedTarget;if(t!=this.root)for(;t&&9!=t.nodeType;){if(t==this.root)return void this._mousemoveHandler(e);t=t.parentNode}if(e.zrenderX=this._lastX,e.zrenderY=this._lastY,this.root.style.cursor="default",this._isMouseDown=0,this._processOutShape(e),this._processDrop(e),this._processDragEnd(e),!this.painter.isLoading())this.painter.refreshHover();this.dispatch(d.GLOBALOUT,e)},mousedown:function(e){if(2==this._lastDownButton)return this._lastDownButton=e.button,void(this._mouseDownTarget=null);else return this._lastMouseDownMoment=new Date,e=this._zrenderEventFixed(e),this._isMouseDown=1,this._mouseDownTarget=this._lastHover,this._dispatchAgency(this._lastHover,d.MOUSEDOWN,e),void(this._lastDownButton=e.button)},mouseup:function(e){e=this._zrenderEventFixed(e),this.root.style.cursor="default",this._isMouseDown=0,this._mouseDownTarget=null,this._dispatchAgency(this._lastHover,d.MOUSEUP,e),this._processDrop(e),this._processDragEnd(e)},touchstart:function(e){e=this._zrenderEventFixed(e,!0),this._lastTouchMoment=new Date,this._mobildFindFixed(e),this._mousedownHandler(e)},touchmove:function(e){if(e=this._zrenderEventFixed(e,!0),this._mousemoveHandler(e),this._isDragging)o.stop(e)},touchend:function(e){e=this._zrenderEventFixed(e,!0),this._mouseupHandler(e);var t=new Date;if(t-this._lastTouchMoment<d.touchClickDelay){if(this._mobildFindFixed(e),this._clickHandler(e),t-this._lastClickMoment<d.touchClickDelay/2)if(this._dblclickHandler(e),this._lastHover&&this._lastHover.clickable)o.stop(e);this._lastClickMoment=t}this.painter.clearHover()}},c=function(e,a,o){if(m.call(this),this.root=e,this.storage=a,this.painter=o,this._lastX=this._lastY=this._mouseX=this._mouseY=0,this._findHover=t(i,this),this._domHover=o.getDomHover(),n(this),window.addEventListener){if(window.addEventListener("resize",this._resizeHandler),r.os.tablet||r.os.phone)e.addEventListener("touchstart",this._touchstartHandler),e.addEventListener("touchmove",this._touchmoveHandler),e.addEventListener("touchend",this._touchendHandler);else e.addEventListener("click",this._clickHandler),e.addEventListener("dblclick",this._dblclickHandler),e.addEventListener("mousewheel",this._mousewheelHandler),e.addEventListener("mousemove",this._mousemoveHandler),e.addEventListener("mousedown",this._mousedownHandler),e.addEventListener("mouseup",this._mouseupHandler);e.addEventListener("DOMMouseScroll",this._mousewheelHandler),e.addEventListener("mouseout",this._mouseoutHandler)}else window.attachEvent("onresize",this._resizeHandler),e.attachEvent("onclick",this._clickHandler),e.attachEvent("ondblclick ",this._dblclickHandler),e.attachEvent("onmousewheel",this._mousewheelHandler),e.attachEvent("onmousemove",this._mousemoveHandler),e.attachEvent("onmouseout",this._mouseoutHandler),e.attachEvent("onmousedown",this._mousedownHandler),e.attachEvent("onmouseup",this._mouseupHandler)};c.prototype.on=function(e,t){return this.bind(e,t),this},c.prototype.un=function(e,t){return this.unbind(e,t),this},c.prototype.trigger=function(e,t){switch(e){case d.RESIZE:case d.CLICK:case d.DBLCLICK:case d.MOUSEWHEEL:case d.MOUSEMOVE:case d.MOUSEDOWN:case d.MOUSEUP:case d.MOUSEOUT:this["_"+e+"Handler"](t)}},c.prototype.dispose=function(){var e=this.root;if(window.removeEventListener){if(window.removeEventListener("resize",this._resizeHandler),r.os.tablet||r.os.phone)e.removeEventListener("touchstart",this._touchstartHandler),e.removeEventListener("touchmove",this._touchmoveHandler),e.removeEventListener("touchend",this._touchendHandler);else e.removeEventListener("click",this._clickHandler),e.removeEventListener("dblclick",this._dblclickHandler),e.removeEventListener("mousewheel",this._mousewheelHandler),e.removeEventListener("mousemove",this._mousemoveHandler),e.removeEventListener("mousedown",this._mousedownHandler),e.removeEventListener("mouseup",this._mouseupHandler);e.removeEventListener("DOMMouseScroll",this._mousewheelHandler),e.removeEventListener("mouseout",this._mouseoutHandler)}else window.detachEvent("onresize",this._resizeHandler),e.detachEvent("onclick",this._clickHandler),e.detachEvent("dblclick",this._dblclickHandler),e.detachEvent("onmousewheel",this._mousewheelHandler),e.detachEvent("onmousemove",this._mousemoveHandler),e.detachEvent("onmouseout",this._mouseoutHandler),e.detachEvent("onmousedown",this._mousedownHandler),e.detachEvent("onmouseup",this._mouseupHandler);this.root=this._domHover=this.storage=this.painter=null,this.un()},c.prototype._processDragStart=function(e){var t=this._lastHover;if(this._isMouseDown&&t&&t.draggable&&!this._draggingTarget&&this._mouseDownTarget==t){if(t.dragEnableTime&&new Date-this._lastMouseDownMoment<t.dragEnableTime)return;var n=t;this._draggingTarget=n,this._isDragging=1,n.invisible=!0,this.storage.mod(n.id),this._dispatchAgency(n,d.DRAGSTART,e),this.painter.refresh()}},c.prototype._processDragEnter=function(e){if(this._draggingTarget)this._dispatchAgency(this._lastHover,d.DRAGENTER,e,this._draggingTarget)},c.prototype._processDragOver=function(e){if(this._draggingTarget)this._dispatchAgency(this._lastHover,d.DRAGOVER,e,this._draggingTarget)},c.prototype._processDragLeave=function(e){if(this._draggingTarget)this._dispatchAgency(this._lastHover,d.DRAGLEAVE,e,this._draggingTarget)},c.prototype._processDrop=function(e){if(this._draggingTarget)this._draggingTarget.invisible=!1,this.storage.mod(this._draggingTarget.id),this.painter.refresh(),this._dispatchAgency(this._lastHover,d.DROP,e,this._draggingTarget)},c.prototype._processDragEnd=function(e){if(this._draggingTarget)this._dispatchAgency(this._draggingTarget,d.DRAGEND,e),this._lastHover=null;this._isDragging=0,this._draggingTarget=null},c.prototype._processOverShape=function(e){this._dispatchAgency(this._lastHover,d.MOUSEOVER,e)},c.prototype._processOutShape=function(e){this._dispatchAgency(this._lastHover,d.MOUSEOUT,e)},c.prototype._dispatchAgency=function(e,t,n,i){var a="on"+t,r={type:t,event:n,target:e,cancelBubble:!1},o=e;if(i)r.dragged=i;for(;o&&(o[a]&&(r.cancelBubble=o[a](r)),o.dispatch(t,r),o=o.parent,!r.cancelBubble););if(e){if(!r.cancelBubble)this.dispatch(t,r)}else if(!i)this.dispatch(t,{type:t,event:n})},c.prototype._iterateAndFindHover=function(){var e=h.create();return function(){for(var t,n,i=this.storage.getShapeList(),a=[0,0],r=i.length-1;r>=0;r--){var o=i[r];if(t!==o.zlevel)if(n=this.painter.getLayer(o.zlevel,n),a[0]=this._mouseX,a[1]=this._mouseY,n.needTransform)h.invert(e,n.transform),l.applyTransform(a,a,e);if(this._findHover(o,a[0],a[1]))break}}}();var f=[{x:10},{x:-20},{x:10,y:10},{y:-20}];return c.prototype._mobildFindFixed=function(e){this._lastHover=null,this._mouseX=e.zrenderX,this._mouseY=e.zrenderY,this._event=e,this._iterateAndFindHover();for(var t=0;!this._lastHover&&t<f.length;t++){var n=f[t];n.x&&(this._mouseX+=n.x),n.y&&(this._mouseX+=n.y),this._iterateAndFindHover()}if(this._lastHover)e.zrenderX=this._mouseX,e.zrenderY=this._mouseY},c.prototype._zrenderEventFixed=function(e,t){if(e.zrenderFixed)return e;if(!t){e=e||window.event;var n=e.toElement||e.relatedTarget||e.srcElement||e.target;if(n&&n!=this._domHover)e.zrenderX=("undefined"!=typeof e.offsetX?e.offsetX:e.layerX)+n.offsetLeft,e.zrenderY=("undefined"!=typeof e.offsetY?e.offsetY:e.layerY)+n.offsetTop}else{var i="touchend"!=e.type?e.targetTouches[0]:e.changedTouches[0];if(i){var a=this.root.getBoundingClientRect();e.zrenderX=i.clientX-a.left,e.zrenderY=i.clientY-a.top}}return e.zrenderFixed=1,e},s.merge(c.prototype,m.prototype,!0),c});