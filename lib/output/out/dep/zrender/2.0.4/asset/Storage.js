/*! @2014 Leo Wang. All Rights Reserved */
define("zrender/Storage",["require","./tool/util","./Group"],function(require){"use strict";function e(e,t){if(e.zlevel==t.zlevel)if(e.z==t.z)return e.__renderidx-t.__renderidx;else return e.z-t.z;return e.zlevel-t.zlevel}var t=require("./tool/util"),n=require("./Group"),i={hover:!1,normal:"down",update:!1},a=function(){this._elements={},this._hoverElements=[],this._roots=[],this._shapeList=[],this._shapeListOffset=0};return a.prototype.iterShape=function(e,t){if(!t)t=i;if(t.hover)for(var n=0,a=this._hoverElements.length;a>n;n++){var r=this._hoverElements[n];if(r.updateTransform(),e(r))return this}if(t.update)this.updateShapeList();switch(t.normal){case"down":for(var a=this._shapeList.length;a--;)if(e(this._shapeList[a]))return this;break;default:for(var n=0,a=this._shapeList.length;a>n;n++)if(e(this._shapeList[n]))return this}return this},a.prototype.getHoverShapes=function(e){if(e)for(var t=0,n=this._hoverElements.length;n>t;t++)this._hoverElements[t].updateTransform();return this._hoverElements},a.prototype.getShapeList=function(e){if(e)this.updateShapeList();return this._shapeList},a.prototype.updateShapeList=function(){this._shapeListOffset=0;for(var t=0,n=this._roots.length;n>t;t++){var i=this._roots[t];this._updateAndAddShape(i)}this._shapeList.length=this._shapeListOffset;for(var t=0,n=this._shapeList.length;n>t;t++)this._shapeList[t].__renderidx=t;this._shapeList.sort(e)},a.prototype._updateAndAddShape=function(e){if(!e.ignore)if(e.updateTransform(),"group"==e.type){if(e.clipShape){e.clipShape.parent=e,e.clipShape.updateTransform();var t=e._children[0];if(t)t.__startClip=e.clipShape}for(var n=0;n<e._children.length;n++){var i=e._children[n];i.__dirty=e.__dirty||i.__dirty,this._updateAndAddShape(i)}if(e.clipShape){var a=this._shapeList[this._shapeListOffset-1];if(a)a.__stopClip=!0}e.__dirty=!1}else this._shapeList[this._shapeListOffset++]=e},a.prototype.mod=function(e,n){var i=this._elements[e];if(i)if(i.modSelf(),n)if(n.parent||n._storage||n.__startClip){var a={};for(var r in n)if("parent"!=r&&"_storage"!=r&&"__startClip"!=r){if(n.hasOwnProperty(r))a[r]=n[r]}else;t.merge(i,a,!0)}else t.merge(i,n,!0);return this},a.prototype.drift=function(e,t,n){var i=this._elements[e];if(i)if(i.needTransform=!0,!i.ondrift||i.ondrift&&!i.ondrift(t,n))i.drift(t,n);return this},a.prototype.addHover=function(e){return e.updateNeedTransform(),this._hoverElements.push(e),this},a.prototype.delHover=function(){return this._hoverElements=[],this},a.prototype.hasHoverShape=function(){return this._hoverElements.length>0},a.prototype.addRoot=function(e){if(e instanceof n)e.addChildrenToStorage(this);this.addToMap(e),this._roots.push(e)},a.prototype.delRoot=function(e){if("undefined"==typeof e){for(var i=0;i<this._roots.length;i++){var a=this._roots[i];if(a instanceof n)a.delChildrenFromStorage(this)}return this._elements={},this._hoverElements=[],void(this._roots=[])}if(!(e instanceof Array)){var r;if("string"==typeof e)r=this._elements[e];else r=e;var o=t.indexOf(this._roots,r);if(o>=0)if(this.delFromMap(r.id),this._roots.splice(o,1),r instanceof n)r.delChildrenFromStorage(this)}else for(var i=0,s=e.length;s>i;i++)this.delRoot(e[i])},a.prototype.addToMap=function(e){if(e instanceof n)e._storage=this;return e.modSelf(),this._elements[e.id]=e,this},a.prototype.get=function(e){return this._elements[e]},a.prototype.delFromMap=function(e){var t=this._elements[e];if(t)if(delete this._elements[e],t instanceof n)t._storage=null;return this},a.prototype.dispose=function(){this._elements=this._renderList=this._roots=this._hoverElements=null},a});