/*! @2014 Leo Wang. All Rights Reserved */
define("zrender/Painter",["require","./config","./tool/util","./tool/log","./tool/matrix","./loadingEffect/Base","./mixin/Transformable","./shape/Image"],function(require){"use strict";function e(){return!1}function t(){}function n(e,t,n){var i=document.createElement(t),a=n._width,r=n._height;return i.style.position="absolute",i.style.left=0,i.style.top=0,i.style.width=a+"px",i.style.height=r+"px",i.setAttribute("width",a*h),i.setAttribute("height",r*h),i.setAttribute("data-zr-dom-id",e),i}var i=require("./config"),a=require("./tool/util"),r=require("./tool/log"),o=require("./tool/matrix"),s=require("./loadingEffect/Base"),l=require("./mixin/Transformable"),h=window.devicePixelRatio||1;h=Math.max(h,1);var d=window.G_vmlCanvasManager,m=function(t,i){this.root=t,this.storage=i,t.innerHTML="",this._width=this._getWidth(),this._height=this._getHeight();var a=document.createElement("div");this._domRoot=a,a.style.position="relative",a.style.overflow="hidden",a.style.width=this._width+"px",a.style.height=this._height+"px",t.appendChild(a),this._layers={},this._layerConfig={},this._loadingEffect=new s({}),this.shapeToImage=this._createShapeToImageProcessor(),this._bgDom=n("bg","div",this),a.appendChild(this._bgDom),this._bgDom.onselectstart=e,this._bgDom.style["-webkit-user-select"]="none",this._bgDom.style["user-select"]="none";var r=new u("_zrender_hover_",this);this._layers.hover=r,a.appendChild(r.dom),r.initContext(),r.dom.onselectstart=e,r.dom.style["-webkit-user-select"]="none",r.dom.style["user-select"]="none";var o=this;this.updatePainter=function(e,t){o.refreshShapes(e,t)}};m.prototype.render=function(e){if(this.isLoading())this.hideLoading();return this.refresh(e,!0),this},m.prototype.refresh=function(e,t){var n=this.storage.getShapeList(!0);if(this._paintList(n,t),"function"==typeof e)e();return this},m.prototype._paintList=function(e,t){if("undefined"==typeof t)t=!1;this._updateLayerStatus(e);var n,a,s;for(var l in this._layers)if("hover"!==l)this._layers[l].unusedCount++,this._layers[l].updateTransform();for(var h=[],m=0,u=e.length;u>m;m++){var p=e[m];if(a!==p.zlevel){if(n&&n.needTransform)s.restore();if(n=this.getLayer(p.zlevel,n),s=n.ctx,a=p.zlevel,n.unusedCount=0,n.dirty||t)n.clear();if(n.needTransform)s.save(),n.setTransform(s)}if(p.__startClip&&!d){var c=p.__startClip;if(s.save(),c.needTransform){var f=c.transform;o.invert(h,f),s.transform(f[0],f[1],f[2],f[3],f[4],f[5])}if(s.beginPath(),c.buildPath(s,c.style),s.clip(),c.needTransform){var f=h;s.transform(f[0],f[1],f[2],f[3],f[4],f[5])}}if((n.dirty||t)&&!p.invisible)if(!p.onbrush||p.onbrush&&!p.onbrush(s,!1))if(i.catchBrushException)try{p.brush(s,!1,this.updatePainter)}catch(V){r(V,"brush error of "+p.type,p)}else p.brush(s,!1,this.updatePainter);if(p.__stopClip&&!d)s.restore();p.__dirty=!1}if(n&&n.needTransform)s.restore();for(var l in this._layers)if("hover"!==l){var U=this._layers[l];if(U.dirty=!1,1==U.unusedCount)U.clear()}},m.prototype.getLayer=function(e,t){var n=this._layers[e];if(!n){n=new u(e,this);var i=t?t.dom:this._bgDom;if(i.nextSibling)i.parentNode.insertBefore(n.dom,i.nextSibling);else i.parentNode.appendChild(n.dom);if(n.initContext(),this._layers[e]=n,this._layerConfig[e])a.merge(n,this._layerConfig[e],!0);n.updateTransform()}return n},m.prototype.getLayers=function(){return this._layers},m.prototype._updateLayerStatus=function(e){var t=this._layers,n={};for(var i in t)if("hover"!==i)n[i]=t[i].elCount,t[i].elCount=0;for(var a=0,r=e.length;r>a;a++){var o=e[a],s=o.zlevel,l=t[s];if(l){if(l.elCount++,l.dirty)continue;l.dirty=o.__dirty}}for(var i in t)if("hover"!==i)if(n[i]!==t[i].elCount)t[i].dirty=!0},m.prototype.refreshShapes=function(e,t){for(var n=0,i=e.length;i>n;n++){var a=e[n];this.storage.mod(a.id)}return this.refresh(t),this},m.prototype.setLoadingEffect=function(e){return this._loadingEffect=e,this},m.prototype.clear=function(){for(var e in this._layers)if("hover"!=e)this._layers[e].clear();else;return this},m.prototype.modLayer=function(e,t){if(t){if(!this._layerConfig[e])this._layerConfig[e]=t;else a.merge(this._layerConfig[e],t,!0);var n=this._layers[e];if(n)a.merge(n,this._layerConfig[e],!0)}},m.prototype.delLayer=function(e){var t=this._layers[e];if(t)this.modLayer(e,{position:t.position,rotation:t.rotation,scale:t.scale}),t.dom.parentNode.removeChild(t.dom),delete this._layers[e]},m.prototype.refreshHover=function(){this.clearHover();for(var e=this.storage.getHoverShapes(!0),t=0,n=e.length;n>t;t++)this._brushHover(e[t]);return this.storage.delHover(),this},m.prototype.clearHover=function(){var e=this._layers.hover;return e&&e.clear(),this},m.prototype.showLoading=function(e){return this._loadingEffect&&this._loadingEffect.stop(),e&&this.setLoadingEffect(e),this._loadingEffect.start(this),this.loading=!0,this},m.prototype.hideLoading=function(){return this._loadingEffect.stop(),this.clearHover(),this.loading=!1,this},m.prototype.isLoading=function(){return this.loading},m.prototype.resize=function(){var e=this._domRoot;e.style.display="none";var t=this._getWidth(),n=this._getHeight();if(e.style.display="",this._width!=t||n!=this._height){this._width=t,this._height=n,e.style.width=t+"px",e.style.height=n+"px";for(var i in this._layers)this._layers[i].resize(t,n);this.refresh(null,!0)}return this},m.prototype.clearLayer=function(e){var t=this._layers[e];if(t)t.clear()},m.prototype.dispose=function(){if(this.isLoading())this.hideLoading();this.root.innerHTML="",this.root=this.storage=this._domRoot=this._layers=null},m.prototype.getDomHover=function(){return this._layers.hover.dom},m.prototype.toDataURL=function(e,t,a){if(d)return null;var o=n("image","canvas",this);this._bgDom.appendChild(o);var s=o.getContext("2d");1!=h&&s.scale(h,h),s.fillStyle=t||"#fff",s.rect(0,0,this._width*h,this._height*h),s.fill();var l=this;this.storage.iterShape(function(e){if(!e.invisible)if(!e.onbrush||e.onbrush&&!e.onbrush(s,!1))if(i.catchBrushException)try{e.brush(s,!1,l.updatePainter)}catch(t){r(t,"brush error of "+e.type,e)}else e.brush(s,!1,l.updatePainter)},{normal:"up",update:!0});var m=o.toDataURL(e,a);return s=null,this._bgDom.removeChild(o),m},m.prototype.getWidth=function(){return this._width},m.prototype.getHeight=function(){return this._height},m.prototype._getWidth=function(){var e=this.root,t=e.currentStyle||document.defaultView.getComputedStyle(e);return((e.clientWidth||parseInt(t.width,10))-parseInt(t.paddingLeft,10)-parseInt(t.paddingRight,10)).toFixed(0)-0},m.prototype._getHeight=function(){var e=this.root,t=e.currentStyle||document.defaultView.getComputedStyle(e);return((e.clientHeight||parseInt(t.height,10))-parseInt(t.paddingTop,10)-parseInt(t.paddingBottom,10)).toFixed(0)-0},m.prototype._brushHover=function(e){var t=this._layers.hover.ctx;if(!e.onbrush||e.onbrush&&!e.onbrush(t,!0)){var n=this.getLayer(e.zlevel);if(n.needTransform)t.save(),n.setTransform(t);if(i.catchBrushException)try{e.brush(t,!0,this.updatePainter)}catch(a){r(a,"hoverBrush error of "+e.type,e)}else e.brush(t,!0,this.updatePainter);if(n.needTransform)t.restore()}},m.prototype._shapeToImage=function(e,t,n,i,a){var r=document.createElement("canvas"),o=r.getContext("2d"),a=window.devicePixelRatio||1;r.style.width=n+"px",r.style.height=i+"px",r.setAttribute("width",n*a),r.setAttribute("height",i*a),o.clearRect(0,0,n*a,i*a);var s={position:t.position,rotation:t.rotation,scale:t.scale};if(t.position=[0,0,0],t.rotation=0,t.scale=[1,1],t)t.brush(o,!1);var l=require("./shape/Image"),h=new l({id:e,style:{x:0,y:0,image:r}});if(null!=s.position)h.position=t.position=s.position;if(null!=s.rotation)h.rotation=t.rotation=s.rotation;if(null!=s.scale)h.scale=t.scale=s.scale;return h},m.prototype._createShapeToImageProcessor=function(){if(d)return t;var e=this;return function(t,n,i,a){return e._shapeToImage(t,n,i,a,h)}};var u=function(t,i){this.dom=n(t,"canvas",i),this.dom.onselectstart=e,this.dom.style["-webkit-user-select"]="none",this.dom.style["user-select"]="none",d&&d.initElement(this.dom),this.domBack=null,this.ctxBack=null,this.painter=i,this.unusedCount=0,this.config=null,this.dirty=!0,this.elCount=0,this.clearColor=0,this.motionBlur=!1,this.lastFrameAlpha=.7,this.zoomable=!1,this.panable=!1,this.maxZoom=1/0,this.minZoom=0,l.call(this)};return u.prototype.initContext=function(){if(this.ctx=this.dom.getContext("2d"),1!=h)this.ctx.scale(h,h)},u.prototype.createBackBuffer=function(){if(!d)if(this.domBack=n("back-"+this.id,"canvas",this.painter),this.ctxBack=this.domBack.getContext("2d"),1!=h)this.ctxBack.scale(h,h)},u.prototype.resize=function(e,t){if(this.dom.style.width=e+"px",this.dom.style.height=t+"px",this.dom.setAttribute("width",e*h),this.dom.setAttribute("height",t*h),1!=h)this.ctx.scale(h,h);if(this.domBack)if(this.domBack.setAttribute("width",e*h),this.domBack.setAttribute("height",t*h),1!=h)this.ctxBack.scale(h,h)},u.prototype.clear=function(){var e=this.dom,t=this.ctx,n=e.width,i=e.height,a=this.clearColor&&!d,r=this.motionBlur&&!d,o=this.lastFrameAlpha;if(r){if(!this.domBack)this.createBackBuffer();this.ctxBack.globalCompositeOperation="copy",this.ctxBack.drawImage(e,0,0,n/h,i/h)}if(a)t.save(),t.fillStyle=this.config.clearColor,t.fillRect(0,0,n/h,i/h),t.restore();else t.clearRect(0,0,n/h,i/h);if(r){var s=this.domBack;t.save(),t.globalAlpha=o,t.drawImage(s,0,0,n/h,i/h),t.restore()}},a.merge(u.prototype,l.prototype),m});