/*! @2014 Leo Wang. All Rights Reserved */
define("esui/Dialog",["require","./Button","./Panel","./lib","./controlHelper","./Control","./main"],function(require){function e(){f.apply(this,arguments)}function t(e){var t=e.main;if(t){for(var n,i=c.getChildren(t),a=i.length,o={};a--;)if(n=i[a].getAttribute("data-role"))o[n]=i[a];e.roles=o}}function n(e,t){var n="title",i="close-icon",a='<div class="${clsClass}" id="${clsId}">&nbsp;</div>',o="";if(e.closeButton)o=c.format(a,{clsId:u.getId(e,i),clsClass:u.getPartClasses(e,i).join(" ")});var s='<div id="${titleId}" class="${titleClass}"></div>${closeIcon}',r=[].concat(u.getPartClasses(e,"head")),l={titleId:u.getId(e,n),titleClass:u.getPartClasses(e,n).join(" "),closeIcon:o},h=c.format(s,l);if(t)e.title=t.innerHTML;else if(t=document.createElement("div"),e.main.firstChild)c.insertBefore(t,e.main.firstChild);else e.main.appendChild(t);t.innerHTML=h,c.addClasses(t,r);var V={main:t,renderOptions:e.renderOptions},U=y.create("Panel",V);return U.render(),e.addChild(U,"head"),U}function i(){var e=this.fire("beforeclose");if(e.isDefaultPrevented())return!1;if(this.hide(),this.fire("close"),this.closeOnHide)this.dispose()}function a(){var e=c.page,t=this.main,n=this.left,i=this.top,a=this.right,o=this.bottom;if(void 0===n||null===n)n=(e.getViewWidth()-t.offsetWidth)/2;if(0>n)n=0;if(void 0===i||null===i)i=(e.getViewHeight()-t.offsetHeight)/2;if(i=Math.max(i,0),t.style.left=n+"px",t.style.top=e.getScrollTop()+i+"px",void 0!==a&&null!==a)t.style.right=a+"px";if(void 0!==o&&null!==o)t.style.bottom=o+"px";if("auto"===this.height){var s=e.getViewHeight()-i;t.style.height=s+"px";var r=this.getBody().main,l=this.getHead().main,h=parseInt(c.getStyle(l,"height"),10);r.style.height=s-h+"px"}}function o(e,t){var n=e,i=e.getChild("head").main;if(t===!0)u.removeDOMEvent(n,i,"mousedown",r);else u.addDOMEvent(n,i,"mousedown",r)}function s(e,t,n){if(n)u.addDOMEvent(e,t,"selectstart",function(e){e.preventDefault()});else u.removeDOMEvent(e,t,"selectstart")}function r(e){var t=e.button,n=!1;if(!e.which&&1===t||1===e.which)n=!0;if(n){var i=document;this.addState("dragging"),s(this,this.main,!0),u.addDOMEvent(this,i,"mousemove",l),u.addDOMEvent(this,i,"mouseup",h),c.event.getMousePosition(e),this.dragStartPos={x:e.pageX,y:e.pageY}}}function l(e){var t=this;c.event.getMousePosition(e);var n={x:e.pageX-t.dragStartPos.x,y:e.pageY-t.dragStartPos.y};t.dragStartPos={x:e.pageX,y:e.pageY};var i=t.main,a=c.getOffset(i),o=a.left+n.x,s=a.top+n.y,r=c.page.getWidth(),l=c.page.getHeight(),h=c.getOffset(i);if(0>s)s=0;else if(s>l-h.height)s=l-h.height;if(0>o)o=0;else if(o>r-h.width)o=r-h.width;i.style.left=o+"px",i.style.top=s+"px"}function h(){u.removeDOMEvent(this,document,"mousemove",l),u.removeDOMEvent(this,document,"mouseup",h),this.removeState("dragging"),s(this,this.main,!1)}function V(e,t){var n=p(e),i=[],a=u.getPartClasses(e,"mask").join(" ");i.push(a),n.className=i.join(" "),n.style.display="block",n.style.zIndex=t}function U(e){var t=p(e);if("undefined"!=typeof t)c.removeNode(t)}function m(e){var t=document.createElement("div");t.id=e,document.body.appendChild(t)}function p(e){var t=u.getId(e),n=b+"-"+t,i=c.g(n);if(!i)m(n);return c.g(n)}require("./Button"),require("./Panel");var d,c=require("./lib"),u=require("./controlHelper"),f=require("./Control"),y=require("./main"),b="ctrl-mask";return e.OK_TEXT="确定",e.CANCEL_TEXT="取消",e.prototype={type:"Dialog",initOptions:function(e){t(e);var n={closeButton:!0,closeOnHide:!0,draggable:!1,mask:!0,title:"我是标题",content:"<p>我是内容</p>",defaultFoot:'<div class="'+this.helper.getPartClassName("ok-btn")+'" data-ui="type:Button;id:btnFootOk;childName:btnOk;skin:spring;">确定</div><div class="'+this.helper.getPartClassName("cancel-btn")+'" data-ui="type:Button;id:btnFootCancel;childName:btnCancel;">取消</div>',needFoot:!0,roles:{}};if("false"===e.closeOnHide)e.closeOnHide=!1;if("false"===e.closeButton)e.closeButton=!1;if("false"===e.mask)e.mask=!1;if("false"===e.needFoot)e.needFoot=!1;if(c.extend(n,e),n.needFoot)if(!n.foot)n.foot=n.defaultFoot;this.setProperties(n)},initStructure:function(){var e=this.main;if(e.parentNode&&"body"!==e.parentNode.nodeName.toLowerCase())document.body.appendChild(e);if(this.addState("hidden"),n(this,this.roles.title),this.createBF("body",this.roles.content),this.needFoot)this.createBF("foot",this.roles.foot)},initEvents:function(){if(this.closeButton){var e=c.g(u.getId(this,"close-icon"));if(e)u.addDOMEvent(this,e,"click",c.curry(i,this))}},createBF:function(e,t){if(t)this.content=t.innerHTML;else if(t=document.createElement("div"),"body"==e){var n=this.getChild("head");if(n)c.insertAfter(t,n.main);else if(this.main.firstChild)c.insertBefore(t,n,this.main.firstChild);else this.main.appendChild(t)}else this.main.appendChild(t);c.addClasses(t,u.getPartClasses(this,e+"-panel"));var i={main:t,renderOptions:this.renderOptions},a=y.create("Panel",i);return a.render(),this.addChild(a,e),a},repaint:u.createRepaint(f.prototype.repaint,{name:"height",paint:function(e,t){if("auto"===t)e.main.style.height="auto";else if(t)e.main.style.height=t+"px";if(e.isShow)a.apply(e)}},{name:"width",paint:function(e,t){if("auto"===t)e.main.style.width="auto";else if(t)e.main.style.width=t+"px";if(e.isShow)a.apply(e)}},{name:"title",paint:function(e,t){var n=u.getId(e,"title");c.g(n).innerHTML=t}},{name:"content",paint:function(e,t){if(t){var n='<div class="${class}" id="${id}">${content}</div>',i=e.getBody(),a=u.getId(e,"body"),o=u.getPartClasses(e,"body"),s={"class":o.join(" "),id:a,content:t};i.setContent(c.format(n,s))}}},{name:"foot",paint:function(e,t){var n='<div class="${class}" id="${id}">${content}</div>',i=u.getId(e,"foot"),a=u.getPartClasses(e,"foot"),o=e.getFoot();if(null==t){if(e.needFoot=!1,o)e.removeChild(o)}else{e.needFoot=!0;var s={"class":a.join(" "),id:i,content:t};if(!o)o=e.createBF("foot");o.setContent(c.format(n,s))}}},{name:"draggable",paint:function(e,t){var n=!1;if(t)e.addState("draggable");else e.removeState("draggable"),n=!0;o(e,n)}}),getBody:function(){return this.getChild("body")},getHead:function(){return this.getChild("head")},getFoot:function(){return this.getChild("foot")},show:function(){var e=this.mask;if(u.isInStage(this,"INITED"))this.render();else if(u.isInStage(this,"DISPOSED"))return;d=c.curry(a,this),u.addDOMEvent(this,window,"resize",a),this.setWidth(this.width),this.removeState("hidden"),a.apply(this);for(var t=1203,n=document.body.children,i=0,o=0,s=n.length;s>o;o++)if(1===n[o].nodeType)if(c.hasClass(n[o],this.helper.getPrimaryClassName())&&!c.hasClass(n[o],this.helper.getPrimaryClassName("hidden")))i++;if(t+=10*i,this.main.style.zIndex=t,e)V(this,t-1);this.fire("show"),this.isShow=!0},hide:function(){if(this.isShow){u.removeDOMEvent(this,window,"resize",a);var e=this.mask;if(this.addState("hidden"),e)U(this)}this.fire("hide"),this.isShow=!1},setTitle:function(e){this.setProperties({title:e})},setContent:function(e){this.setProperties({content:e})},setFoot:function(e){this.setProperties({foot:e})},setHeight:function(e){this.setProperties({height:e})},setWidth:function(e){this.setProperties({width:e})},resize:function(){a.apply(this)},dispose:function(){if(!this.helper.isInStage("DISPOSED")){this.hide();var e=this.main.id;c.removeNode(e),f.prototype.dispose.apply(this,arguments)}}},e.confirm=function(t){function n(e,t){e.fire(t),e.dispose()}var i="dialog-confirm",a=c.encodeHTML(t.title)||"",o=c.encodeHTML(t.content)||"",s=c.encodeHTML(t.okText)||e.OK_TEXT,r=c.encodeHTML(t.cancelText)||e.CANCEL_TEXT,l={type:"confirm",skin:"confirm",title:""};c.extend(l,t);var h=['<div class="${prefix}-icon ${prefix}-icon-${type}"></div>','<div class="${prefix}-text">${content}</div>'].join("");l.id=u.getGUID(i),l.closeButton=!1,l.mask=!0,l.alwaysTop=!0;var V=l.type;l.type=null;var U=y.create("Dialog",l);U.appendTo(document.body),U.show();var m=U.getFoot().getChild("btnOk"),p=U.getFoot().getChild("btnCancel");if(m.setContent(s),p.setContent(r),U.setTitle(a),U.setContent(c.format(h,{type:V,content:o,prefix:U.helper.getPrimaryClassName()})),l.btnHeight)m.set("height",l.btnHeight),p.set("height",l.btnHeight);if(l.btnWidth)m.set("width",l.btnWidth),p.set("width",l.btnWidth);return m.on("click",c.curry(n,U,"ok")),p.on("click",c.curry(n,U,"cancel")),U},e.alert=function(t){function n(e,t){e.fire("ok"),t.dispose(),e.dispose()}var i="dialog-alert",a="dialog-alert-ok",o=c.encodeHTML(t.title)||"",s=c.encodeHTML(t.content)||"",r=c.encodeHTML(t.okText)||e.OK_TEXT,l={type:"warning",skin:"alert",title:""};c.extend(l,t);var h=['<div class="${prefix}-icon ${prefix}-icon-${type}"></div>','<div class="${prefix}-text">${content}</div>'].join(""),V=u.getGUID(i);l.id=V,l.closeButton=!1,l.mask=!0,l.alwaysTop=!0;var U=l.type;l.type=null;var m=y.create("Dialog",l);m.appendTo(document.body),m.setTitle(o),m.setContent(c.format(h,{type:U,content:s,prefix:m.helper.getPrimaryClassName()})),m.setFoot('<div class="'+m.helper.getPartClassName("ok-btn")+'" data-ui="type:Button;childName:okBtn;id:'+V+"-"+a+'; skin:spring;width:50;">'+r+"</div>"),m.show();var p=m.getFoot().getChild("okBtn");if(p.on("click",c.curry(n,m,p)),l.btnHeight)p.set("height",l.btnHeight);if(l.btnwidth)p.set("width",l.btnwidth);return m},c.inherits(e,f),y.register(e),e});