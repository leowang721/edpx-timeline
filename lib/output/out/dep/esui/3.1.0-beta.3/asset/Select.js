/*! @2014 Leo Wang. All Rights Reserved */
define("esui/Select",["require","underscore","./lib","./InputControl","./Layer","./painters","./main"],function(require){function e(e){for(var t=s.event.getTarget(e),i=this.layer.getElement();t&&t!==i&&!s.hasAttribute(t,"data-index");)t=t.parentNode;if(t&&!this.helper.isPart(t,"item-disabled")){var n=t.getAttribute("data-index");this.set("selectedIndex",+n),this.layer.hide()}}function t(){l.apply(this,arguments)}function i(){r.apply(this,arguments),this.layer=new t(this)}function n(e){if(null==e.selectedIndex&&null==e.rawValue&&null==e.value)e.selectedIndex=-1;if(null!=e.rawValue)e.value=null,e.selectedIndex=null;else if(null!=e.value)e.selectedIndex=null;if(null==e.selectedIndex&&(null!=e.value||null!=e.rawValue)){e.selectedIndex=-1;for(var t=e.rawValue||e.value,i=0;i<e.datasource.length;i++)if(e.datasource[i].value==t){e.selectedIndex=i;break}delete e.value,delete e.rawValue}if(e.selectedIndex<0||e.selectedIndex>=e.datasource.length)if(e.emptyText)e.selectedIndex=-1;else{e.selectedIndex=-1;for(var i=0;i<e.datasource.length;i++)if(!e.datasource[i].disabled){e.selectedIndex=i;break}}}function a(e){var t=e.helper.getPart("text"),i=-1===e.selectedIndex?null:e.datasource[e.selectedIndex];t.innerHTML=e.getDisplayHTML(i);var n=e.layer.getElement(!1);if(n)e.layer.syncState(n)}var o=require("underscore"),s=require("./lib"),r=require("./InputControl"),l=require("./Layer");s.inherits(t,l),t.prototype.nodeName="ol",t.prototype.render=function(e){for(var t="",i=0;i<this.control.datasource.length;i++){var n=this.control.datasource[i],a=this.control.helper.getPartClasses("item");if(n.disabled)a.push.apply(a,this.control.helper.getPartClasses("item-disabled"));t+='<li data-index="'+i+'" class="'+a.join(" ")+'">',t+=this.control.getItemHTML(n),t+="</li>"}e.innerHTML=t},t.prototype.initBehavior=function(t){this.control.helper.addDOMEvent(t,"click",e)},t.prototype.syncState=function(e){for(var t=this.control.helper.getPartClasses("item-selected"),i=s.getChildren(e),n=i.length-1;n>=0;n--){var a=i[n];if(n===this.control.selectedIndex)s.addClasses(a,t);else s.removeClasses(a,t)}},t.prototype.dock={strictWidth:!0},i.prototype.type="Select",i.prototype.initOptions=function(e){var t={datasource:[]},i={};if(o.extend(i,t,e),"select"===this.main.nodeName.toLowerCase()){i.datasource=[];for(var n=this.main.getElementsByTagName("option"),a=0,s=n.length;s>a;a++){var r=n[a],l={name:r.name||r.text,value:r.value};if(r.disabled)l.disabled=!0;if(i.datasource.push(l),r.selected&&null==i.selectedIndex&&null==i.value&&null==i.rawValue)i.selectedIndex=r.value?a:0}this.helper.extractOptionsFromInput(this.main,i)}if("string"==typeof i.selectedIndex)i.selectedIndex=+i.selectedIndex;this.setProperties(i)},i.prototype.itemTemplate="<span>${text}</span>",i.prototype.getItemHTML=function(e){var t={text:o.escape(e.name||e.text),value:o.escape(e.value)};return s.format(this.itemTemplate,t)},i.prototype.displayTemplate="${text}",i.prototype.getDisplayHTML=function(e){if(!e)return o.escape(this.emptyText||"");var t={text:o.escape(e.name||e.text),value:o.escape(e.value)};return s.format(this.displayTemplate,t)},i.prototype.initStructure=function(){if("select"===this.main.nodeName.toLowerCase())this.helper.replaceMain();this.main.tabIndex=0,this.main.innerHTML=this.helper.getPartHTML("text","span")},i.prototype.initEvents=function(){this.helper.addDOMEvent(this.main,"click",o.bind(this.layer.toggle,this.layer))},i.prototype.getRawValue=function(){if(this.selectedIndex<0)return null;var e=this.datasource[this.selectedIndex];return e?e.value:null};var h=require("./painters");return i.prototype.repaint=h.createRepaint(r.prototype.repaint,h.style("width"),h.style("height"),{name:"datasource",paint:function(e){e.layer.repaint()}},{name:["selectedIndex","emptyText","datasource"],paint:a},{name:["disabled","hidden","readOnly"],paint:function(e,t,i,n){if(t||i||n)e.layer.hide()}}),i.prototype.updateDatasource=function(e){if(!e)e=this.datasource;this.datasource=e;var t={name:"datasource"};this.repaint([t],{datasource:t})},i.prototype.setProperties=function(e){if(null==e.datasource)e.datasource=this.datasource;if(null==e.value&&null==e.rawValue&&null==e.selectedIndex&&e.datasource===this.datasource)e.selectedIndex=this.selectedIndex;if(!e.hasOwnProperty("emptyText"))e.emptyText=this.emptyText;n(e);var t=r.prototype.setProperties.apply(this,arguments);if(t.hasOwnProperty("selectedIndex"))this.fire("change");return t},i.prototype.dispose=function(){if(!this.helper.isInStage("DISPOSED")){if(this.layer)this.layer.dispose(),this.layer=null;r.prototype.dispose.apply(this,arguments)}},i.prototype.getSelectedItem=function(){return this.get("datasource")[this.get("selectedIndex")]},s.inherits(i,r),require("./main").register(i),i});