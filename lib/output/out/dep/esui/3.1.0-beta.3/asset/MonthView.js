/*! @2014 Leo Wang. All Rights Reserved */
define("esui/MonthView",["require","./Button","./Select","./Panel","./lib","./controlHelper","./Control","./main","moment"],function(require){function e(){P.apply(this,arguments)}function t(e){for(var t=e.viewRange||e.range,i=[],n=t.end.getFullYear(),a=t.begin.getFullYear();n>=a;a++)i.push({text:a,value:a});return i}function i(e,t){var i=e.viewRange||e.range,n=[],a=11,o=0;if(t==i.begin.getFullYear())o=i.begin.getMonth();if(t==i.end.getFullYear())a=i.end.getMonth();for(;a>=o;o++)n.push({text:o+1,value:o});return n}function n(e){var t=['<div class="${headClass}"><table><tr>','<td width="40" align="left">','<div class="${monthBackClass}"',' data-ui-type="Button"',' data-ui-child-name="monthBack"',' data-ui-id="${monthBackId}"',"></div>","</td>","<td>",'<div class="${yearSelectClass}"',' data-ui="type:Select;childName:yearSel;',' id:${yearSelId};"></div>',"</td>","<td>",'<div class="${monthSelectClass}"',' data-ui="type:Select;childName:monthSel;',' id:${monthSelId};"></div>',"</td>",'<td width="40" align="right">','<div class="${monthForClass}"',' data-ui-type="Button"',' data-ui-child-name="monthForward"',' data-ui-id="${monthForwardId}"',"></div>","</td>","</tr></table></div>",'<div id="${monthMainId}" class="${monthMainClass}"></div>'];return t=t.join(""),T.format(t,{headClass:e.helper.getPartClassName("head"),monthBackId:e.helper.getId("monthBack"),monthForwardId:e.helper.getId("monthForward"),yearSelId:e.helper.getId("yearSel"),monthSelId:e.helper.getId("monthSel"),monthMainId:e.helper.getId("monthMain"),monthMainClass:e.helper.getPartClassName("month"),monthBackClass:e.helper.getPartClassName("month-back"),monthForClass:e.helper.getPartClassName("month-forward"),yearSelectClass:e.helper.getPartClassName("year-select"),monthSelectClass:e.helper.getPartClassName("month-select")})}function a(e){var t=[];if("multi"===e.mode)t.push("");t=t.concat(["一","二","三","四","五","六","日"]);var i='<table border="0" cellpadding="0" cellspacing="0" class="${className}"><thead><tr>',n=[];n.push(T.format(i,{className:e.helper.getPartClassName("month-main")}));for(var a='<td id="${id}" data-index="${index}" class="${className}">${text}</td>',s=e.helper.getPartClassName("month-title"),r=e.helper.getId("month-title"),l=e.helper.getPartClassName("month-select-all"),h=t.length,V=0;h>V;V++)n.push(T.format(a,{className:""===t[V]?l:s,text:t[V],index:V,id:r+"-"+V}));n.push("</tr></thead><tbody><tr>");var m='<td data-year="${year}" data-month="${month}" data-date="${date}" class="${className}" id="${id}">${date}</td>',U=e.helper.getPartClassName("month-row-select"),p=e.helper.getId("row-select"),d=0,c='<td id="${id}" class="'+U+'">&gt;</td>',u=0,f=e.year,y=e.month,b=new Date(f,y,1),g=new Date(f,y+1,1),k=1-(b.getDay()+6)%7;b.setDate(k);var x=e.helper.getPartClassName("month-item"),L=e.helper.getPartClassName("month-item-today"),_=e.helper.getPartClassName("month-item-virtual"),W=e.helper.getPartClassName("month-item-disabled"),X=e.range;if("multi"===e.mode)n.push(T.format(c,{id:p+"-"+d++}));for(;g-b>0||u%7!==0;){if(k>1&&u%7===0)if(n.push("</tr><tr>"),"multi"===e.mode)n.push(T.format(c,{id:p+"-"+d++}));var K=b.getMonth()!=y,w=!1;if(b<X.begin)w=!0;else if(b>X.end)w=!0;var I=x;if(K)I+=" "+_;else if(z().isSame(b,"day"))I+=" "+L;if(w)I+=" "+W;n.push(T.format(m,{year:b.getFullYear(),month:b.getMonth(),date:b.getDate(),className:I,id:o(e,b)})),b=new Date(f,y,++k),u++}return e.rowTagNum=d,n.push("</tr></tbody></table>"),n.join("")}function o(e,t){return e.helper.getId(t.getFullYear()+"-"+t.getMonth()+"-"+t.getDate())}function s(e){for(var t=e.target||e.srcElement,i=O.getPartClasses(this,"month-select-all"),n=O.getPartClasses(this,"month-title"),a=O.getPartClasses(this,"month-item"),o=O.getPartClasses(this,"month-row-select"),s=O.getPartClasses(this,"month-item-virtual"),r=O.getPartClasses(this,"month-item-disabled");t&&t!=document.body;){if(T.hasClass(t,a[0])&&!T.hasClass(t,s[0])&&!T.hasClass(t,r[0]))return void _(this,t);else if("multi"===this.mode){if(T.hasClass(t,o[0]))return void u(this,t);if(T.hasClass(t,n[0]))return void U(this,t);if(T.hasClass(t,i[0]))return void y(this)}t=t.parentNode}}function r(e){var t=e.rawValue;e.viewValue={};for(var i=0;i<t.length;i++){var n=t[i],a=n.getFullYear(),o=n.getMonth(),s=n.getDate(),r=a+"-"+o+"-"+s;e.viewValue[r]={isSelected:!0,value:new Date(a,o,s)}}}function l(e,t){var i=O.getPartClasses(e,"month-item-virtual"),n=O.getPartClasses(e,"month-item-disabled");if(!T.hasClass(t,i[0])&&!T.hasClass(t,n[0]))return 1;else if(T.hasClass(t,i[0])&&!T.hasClass(t,n[0]))return-1;return 0}function h(e,t,i){if(O.removePartClasses(e,"month-row-select-selected",t),i)O.addPartClasses(e,"month-row-select-selected",t)}function V(e){for(var t=e.rowTagNum,i=O.getId(e,"row-select"),n=0;t>n;n++){var a=T.g(i+"-"+n);m(e,a)}}function m(e,t){for(var i=O.getPartClasses(e,"month-item-selected"),n=t.nextSibling,a=!0,o=0;n;){if(1===l(e,n))if(++o,!T.hasClass(n,i[0])){a=!1;break}n=n.nextSibling}if(0===o)a=!1;h(e,t,a)}function U(e,t){var i=t.getAttribute("data-index"),n=O.getPartClasses(e,"month-title-selected"),a=!0;if(T.hasClass(t,n[0]))a=!1,O.removePartClasses(e,"month-title-selected",t);else O.addPartClasses(e,"month-title-selected",t);for(var o=e.rowTagNum,s=O.getId(e,"row-select"),r=e.viewValue,h=[],m=0;o>m;m++){var U=T.g(s+"-"+m),p=U.parentNode.children[i];if(1===l(e,p)){var d=p.getAttribute("data-date"),c=p.getAttribute("data-month"),u=p.getAttribute("data-year"),y=u+"-"+c+"-"+d;r[y]={isSelected:a,value:new Date(u,c,d)},h.push(y)}}if(h&&h.length>0)b(e),g(e,h,a),V(e),f(e)}function p(e,t,i){if(O.removePartClasses(e,"month-title-selected",t),i)O.addPartClasses(e,"month-title-selected",t)}function d(e){for(var t=O.getId(e,"month-title"),i=1;7>=i;i++){var n=T.g(t+"-"+i);c(e,n)}}function c(e,t){for(var i=O.getPartClasses(e,"month-item-selected"),n=t.getAttribute("data-index"),a=!0,o=0,s=e.rowTagNum,r=O.getId(e,"row-select"),h=0;s>h;h++){var V=T.g(r+"-"+h),m=V.parentNode.children[n];if(1===l(e,m))if(++o,!T.hasClass(m,i[0])){a=!1;break}}if(0===o)a=!1;p(e,t,a)}function u(e,t){var i=t.parentNode,n=O.getPartClasses(e,"month-row-select"),a=O.getPartClasses(e,"month-row-select-selected"),o=O.getPartClasses(e,"month-item-virtual"),s=O.getPartClasses(e,"month-item-disabled"),r=!0;if(T.hasClass(t,a[0]))r=!1,O.removePartClasses(e,"month-row-select-selected",t);else O.addPartClasses(e,"month-row-select-selected",t);for(var l=i.children,h=e.viewValue,V=[],m=0;m<l.length;m++){var U=l[m];if(1===U.nodeType&&!T.hasClass(U,n[0])&&!T.hasClass(U,o[0])&&!T.hasClass(U,s[0])){var p=U.getAttribute("data-date"),c=U.getAttribute("data-month"),u=U.getAttribute("data-year"),y=u+"-"+c+"-"+p;h[y]={isSelected:r,value:new Date(u,c,p)},V.push(y)}}if(V&&V.length>0)b(e),g(e,V,r),d(e),f(e)}function f(e){for(var t=e.rowTagNum,i=O.getId(e,"row-select"),n=T.g(O.getId(e,"month-title-0")),a=O.getPartClasses(e,"month-row-select-selected"),o=0,s=0;t>s;s++){var r=T.g(i+"-"+s);if(T.hasClass(r,a[0]))o++}if(o===t)O.addPartClasses(e,"month-select-all-selected",n);else O.removePartClasses(e,"month-select-all-selected",n)}function y(e){for(var t=e.rowTagNum,i=O.getId(e,"row-select"),n=0;t>n;n++){var a=T.g(i+"-"+n);O.removePartClasses(e,"month-row-select-selected",a),u(e,a)}}function b(e){var t=[];for(var i in e.viewValue)if(e.viewValue[i].isSelected)t.push(e.viewValue[i].value);t.sort(function(e,t){return e-t}),e.rawValue=t,e.fire("change")}function g(e,t,i){if(i)x(e,t);else k(e,t)}function k(e,t){for(var i=e,n=0;n<t.length;n++){var a=O.getId(e,t[n]),o=T.g(a);if(o)T.removeClasses(o,O.getPartClasses(i,"month-item-selected"))}}function x(e,t){for(var i=e,n=0;n<t.length;n++){var a=O.getId(e,t[n]),o=T.g(a);if(o)T.addClasses(o,O.getPartClasses(i,"month-item-selected"))}}function L(e,t,i){if(!t)return!1;var n=O.getPartClasses(e,i);if(T.hasClass(t,n[0]))return O.removePartClasses(e,i,t),!1;else return O.addPartClasses(e,i,t),!0}function _(e,t){var i=t.getAttribute("data-date"),n=t.getAttribute("data-month"),a=t.getAttribute("data-year"),o=a+"-"+n+"-"+i;if("multi"===e.mode){var s=L(e,t,"month-item-selected");e.viewValue[o]={isSelected:s,value:new Date(a,n,i)},b(e);var r=t.parentNode.firstChild;m(e,r),d(e),f(e)}else{var l=O.getPartClasses(e,"month-item-selected");if(T.hasClass(t,l[0]))return;var h=new Date(a,n,i);K(e,e.rawValue,h),e.rawValue=h,e.fire("change"),e.fire("itemclick")}}function W(e,t,i){var n=e,a=n.viewRange||n.range,o=12*a.begin.getFullYear()+a.begin.getMonth(),s=12*a.end.getFullYear()+a.end.getMonth(),r=12*t+i,l=new Date(t,i,1);if(i=l.getMonth(),o-r>0)i+=o-r;else if(r-s>0)i-=r-s;return l.setMonth(i),i=l.getMonth(),t=l.getFullYear(),{year:t,month:i}}function X(e,i,n){if(null==i)i=e.year;if(null==n)n=e.month;var a=e,o=W(a,i,n);a.month=o.month,a.year=o.year;var s=a.getChild("yearSel"),r=s.getValue();if(s.setProperties({datasource:t(a),value:a.year}),r==a.year)s.fire("change")}function K(e,t,i){if(t!==i){if(t){var n=T.g(o(e,t));if(n)L(e,n,"month-item-selected")}var a=T.g(o(e,i));if(a)if(l(e,a))L(e,a,"month-item-selected");else return e.rawValue=null,null}return i}function w(e){var t=new Date(e.year,e.month,1),i=z(t).add("month",1);X(e,i.year(),i.month())}function I(e){var t=new Date(e.year,e.month,1),i=z(t).subtract("month",1);X(e,i.year(),i.month())}function v(e,t){var n=parseInt(t.getValue(),10);e.year=n;var a=e.month,o=W(e,n,a);a=o.month,e.month=a;var s=e.getChild("monthSel"),r=s.setProperties({datasource:i(e,e.year),value:e.month});if(!r.hasOwnProperty("rawValue"))J(e,s);e.fire("changeyear")}function J(e,t){var i=parseInt(t.getValue(),10);e.month=i,C(e),e.fire("changemonth")}function C(e){var t=O.getId(e,"monthMain"),i=T.g(t);i.innerHTML=a(e);var n=i.getElementsByTagName("tr"),o=n[n.length-1];O.addPartClasses(e,"last-row",o),F(e)}function S(e){var t,i;if("string"==typeof e){var n=e.split(",");t=E(n[0]),i=E(n[1])}else t=e.begin,i=e.end;if(t>i)return{begin:i,end:t};else return{begin:t,end:i}}function E(e){function t(e){var t=e.split("-");if(t)return new Date(parseInt(t[0],10),parseInt(t[1],10)-1,parseInt(t[2],10));else return null}e+="";var i=e.split(" "),n=t(i[0]);if(i[1]){var a=i[1].split(":");n.setHours(a[0]),n.setMinutes(a[1]),n.setSeconds(a[2])}return n}function A(e,t){if("single"===t)return E(e);else{for(var i=e.split(","),n=[],a=0;a<i.length-1;a+=2){var o,s=E(i[a]),r=E(i[a+1]);if(s&&r)if(s-r===0)n.push(s);else for(o=s;r>=o;)n.push(o),o=new Date(o.getFullYear(),o.getMonth(),o.getDate()+1);else;}return n}}function F(e){if("multi"===e.mode){var t=e.viewValue;for(var i in t){var n=T.g(O.getId(e,i));if(n){var a=l(e,n);if(1===a)if(t[i].isSelected)O.addPartClasses(e,"month-item-selected",n);else O.removePartClasses(e,"month-item-selected",n);else if(0===a)t[i].isSelected=!1,b(e)}}V(e),d(e),f(e)}else K(e,null,e.rawValue)}require("./Button"),require("./Select"),require("./Panel");var T=require("./lib"),O=require("./controlHelper"),P=require("./Control"),M=require("./main"),z=require("moment");return e.prototype={type:"MonthView",initOptions:function(e){var t={range:{begin:new Date(1982,10,4),end:new Date(2046,10,4)},dateFormat:"YYYY-MM-DD",paramFormat:"YYYY-MM-DD",viewValue:{},mode:"single"};T.extend(t,e),this.setProperties(t)},setProperties:function(e){if(e.range)e.range=S(e.range);var t=new Date,i=e.mode||this.mode;if(null==e.rawValue)if(e.value)e.rawValue=A(e.value,i);else if(null==this.rawValue)if("single"===i)e.rawValue=t;else e.rawValue=[];var n=e.year,a=e.month;if(!n&&null==a)if("single"===i){if(e.rawValue)n=e.rawValue.getFullYear(),a=e.rawValue.getMonth()+1}else n=t.getFullYear(),a=t.getMonth()+1;if(n&&a)e.year=parseInt(n,10),e.month=parseInt(a,10)-1;else if(e.hasOwnProperty("year")){if(null==this.month)delete e.year}else if(e.hasOwnProperty("month"))if(null==this.year)delete e.month;else e.month=parseInt(a,10)-1;var o=P.prototype.setProperties.apply(this,arguments);if(o.hasOwnProperty("rawValue"))this.fire("change");return o},initStructure:function(){if(this.main.innerHTML=n(this),this.initChildren(this.main),"multi"===this.mode)this.addState("multi-select")},initEvents:function(){var e=this.getChild("monthBack");e.on("click",T.curry(I,this));var t=this.getChild("monthForward");t.on("click",T.curry(w,this));var i=this.getChild("monthSel");i.on("change",T.curry(J,this,i));var n=this.getChild("yearSel");n.on("change",T.curry(v,this,n));var a=this.helper.getPart("monthMain");O.addDOMEvent(this,a,"click",s)},repaint:O.createRepaint(P.prototype.repaint,{name:["range","rawValue","year","month"],paint:function(e,t,i){if(i)if("multi"===e.mode)r(e);X(e,e.year,e.month)}},{name:"disabled",paint:function(e,t){var i=e.getChild("monthBack");i.setProperties({disabled:t});var n=e.getChild("monthForward");n.setProperties({disabled:t});var a=e.getChild("monthSel");a.setProperties({disabled:t});var o=e.getChild("yearSel");o.setProperties({disabled:t})}}),disable:function(){this.setProperties({disabled:!0}),this.addState("disabled")},enable:function(){this.setProperties({disabled:!1}),this.removeState("disabled")},setRange:function(e){this.setProperties({range:e})},setRawValue:function(e){this.setProperties({rawValue:e})},getRawValue:function(){return this.rawValue},getValue:function(){return this.stringifyValue(this.rawValue)},stringifyValue:function(e){if("single"===this.mode)return T.date.format(e,this.paramFormat)||"";else{for(var t=[],i=864e5,n=0;n<e.length;n++)if(0===n)t.push(T.date.format(e[n],this.paramFormat));else if(e[n]-e[n-1]>i)t.push(T.date.format(e[n-1],this.paramFormat)),t.push(T.date.format(e[n],this.paramFormat));else if(n==e.length-1)t.push(T.date.format(e[n],this.paramFormat));else continue;return t.join(",")}},parseValue:function(e){return A(e,this.mode)},setRawValueWithoutFireChange:function(e){this.rawValue=e,r(this)}},T.inherits(e,P),M.register(e),e});