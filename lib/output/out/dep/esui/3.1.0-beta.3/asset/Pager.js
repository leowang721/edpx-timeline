/*! @2014 Leo Wang. All Rights Reserved */
define("esui/Pager",["require","underscore","./lib","./main","./Control","./Select","./painters"],function(require){function e(e){var t=['<div id="${pagerWrapperId}" class="${pagerWrapperClass}">','<div id="${selectWrapperId}" ','class="${selectWrapperClass}">','<span id="${labelId}" class="${labelClass}">',"${labelText}</span>",'<div data-ui="type:Select;childName:select;','id:${selectId};width:40;"></div>',"</div>",'<ul id="${mainId}" class="${mainClass}"></ul>',"</div>"];return m.format(t.join(""),{pagerWrapperId:e.helper.getId("pager-wrapper"),pagerWrapperClass:e.helper.getPartClasses(e.layout)[0],selectWrapperId:e.helper.getId("select-wrapper"),selectWrapperClass:e.helper.getPartClassName("select-wrapper"),labelId:e.helper.getId("label"),labelClass:e.helper.getPartClassName("label"),labelText:"每页显示",selectId:e.helper.getId("select"),mainId:e.helper.getId("main"),mainClass:e.helper.getPartClassName("main")})}function t(e){function t(t){return m.format(e.urlTemplate,{page:t,pageSize:e.pageSize})}function i(i,n,a,o){var s={className:e.helper.getPartClassName(i)};if(arguments.length>1)s.link=t(n),s.id=e.helper.getId(a),s.page=n,s.text=o;return s}function n(t,i){if(!i){var n={anchor:s,plain:o};i=n[e.pageType]||n.anchor}return m.format(i,t)}function a(e,t){if("number"==typeof e)e=i("item",e,"page-"+e,e);var a=n(e,t);p.push(a)}var o='<li class="${className}" id="${id}" data-page="${page}">${text}</li>',s='<li class="${className}" id="${id}"><a href="${link}">${text}</a></li>',r='<li class="${className}">…</li>',l=e.page,h=e.backCount,V=e.forwardCount,U=Math.ceil(e.count/e.pageSize),p=[];if(l>1){var d=i("item-extend",l-1,"page-back",e.backText);a(d)}if(l>h+1)if(a(1),l>h+2){var d=i("item-omit");a(d,r)}for(var c=l>h?h:l-1,u=l-c;l>u;u++)a(u);var d=i("item-current",l,"page-"+l,l);a(d,o);for(var c=U-l>V?V:U-l,u=l+1;l+c+1>u;u++)a(u);if(U-V>l){if(U-V-1>l){var d=i("item-omit");a(d,r)}a(U)}if(U>l){var d=i("item-extend",l+1,"page-forward",e.forwardText);a(d)}return p.join("")}function i(e){var i=e.pageSize;i=i>0?i:1,e.pageSize=i,e.getChild("select").set("value",i+"");var n=Math.ceil(e.count/i),a=e.page;a=a>n?n:a,a=a>0?a:1,e.page=a;var o=e.helper.getPart("main");o.innerHTML=t(e)}function n(e,t){function i(){for(var t=[],i=0,n=arguments.length;n>i;i++)t.push(e.helper.getPartClasses(arguments[i])[0]);return t}var n=e.helper.getPart("pager-wrapper");m.removeClasses(n,i("alignLeft","alignLeftReversed","alignRight","alignRightReversed","distributed","distributedReversed")),m.addClass(n,e.helper.getPartClasses(t)[0])}function a(e){var t=e.target,i=this.helper.getId("page-back"),n=this.helper.getId("page-forward"),a=this.page;if(this.helper.isPart(t,"item")||this.helper.isPart(t,"item-extend")){if(t.id===i)a--;else if(t.id===n)a++;else a=+m.getAttribute(t,"data-page");this.set("page",a)}}function o(e){var t=V.map(e,function(e){return{text:e+"",value:e+""}});return t}function s(){var e=parseInt(this.getChild("select").getValue(),10);this.pageSize=e,i(this),this.fire("changepagesize"),this.fire("pagesizechange")}function r(e){var t=e.helper.getPart("select-wrapper");e.helper.removePartClasses("select-hidden",t)}function l(e){var t=e.helper.getPart("select-wrapper");e.helper.addPartClasses("select-hidden",t)}function h(){p.apply(this,arguments)}var V=require("underscore"),m=require("./lib"),U=require("./main"),p=require("./Control");return require("./Select"),h.defaultProperties={},h.prototype={type:"Pager",defaultProperties:{pageSizes:[15,30,50,100],pageSize:15},initOptions:function(e){var t={pageType:"anchor",count:0,page:1,backCount:3,forwardCount:3,backText:"上一页",forwardText:"下一页",urlTemplate:"",layout:"alignLeft"};V.extend(t,this.defaultProperties,h.defaultProperties,e),this.setProperties(t)},initStructure:function(){this.main.innerHTML=e(this),this.helper.initChildren();var t=this.getChild("select");if(!this.pageSizes||!this.pageSizes.length)l(this);else{var i={datasource:o(this.pageSizes),value:this.pageSize+""};t.setProperties(i)}s.call(this)},initEvents:function(){var e=this.getChild("select");e.on("change",s,this),this.helper.addDOMEvent("main","click",a)},setProperties:function(e){if(e=V.clone(e),e.hasOwnProperty("pageIndex")&&!e.hasOwnProperty("page"))e.page=+e.pageIndex+1;var t=["count","page","backCount","forwardCount","pageSize"];V.each(t,function(t){var i=e[t];if(V.isString(i))e[t]=+i});var i=p.prototype.setProperties.apply(this,arguments);if(i.hasOwnProperty("page"))this.fire("changepage"),this.fire("pagechange")},repaint:require("./painters").createRepaint(p.prototype.repaint,{name:"pageSizes",paint:function(e,t){var i=e.getChild("select");if(!t||!t.length)l(e);else{var n={datasource:o(t),value:e.pageSize+""};i.setProperties(n),r(e)}}},{name:"layout",paint:n},{name:["pageType","count","pageSize","page","backCount","forwardCount","backText","forwardText","urlTemplate"],paint:i}),getPageIndex:function(){return this.get("page")-1}},m.inherits(h,p),U.register(h),h});