/*! @2014 Leo Wang. All Rights Reserved */
define("esui/extension/TableSubrow",["require","../Extension","../lib","../controlHelper","../main","../Table"],function(require){function e(e,t){return x.getId(e,t)}function t(e,t){return x.getPartClasses(e,t).join(" ")}function i(e,t){return k.getAttribute(e,"data-"+t)}function n(e,t,i){k.setAttribute(e,"data-"+t,i)}function a(e){return!("undefined"==typeof e||null===e)}function o(t,i){return e(t,"subrow")+i}function r(t,i){return e(t,"subentry")+i}function s(e){return{subrow:e.subrow&&"false"!=e.subrow}}function l(e){h(this,e)}function h(e,t){var i=/subentry-opened/.test(t.className),n="subentry-hover";if(i)n="subentry-opened-hover";x.addPartClasses(e,n,t)}function d(e){m(this,e)}function m(e,t){x.removePartClasses(e,"subentry-hover",t),x.removePartClasses(e,"subentry-opened-hover",t)}function p(e){var t=this,n=i(e,"index"),a=t.datasource,o=a instanceof Array&&a.length;if(o&&!(n>=o)){if(!i(e,"subrowopened")){var r=a[n],s={index:n,item:r};if(s=t.fire("subrowopen",s),!s.isDefaultPrevented())U(t,n,e)}else V(t,n,e);h(t,e)}}function V(e,t,i){var a={index:t,item:e.datasource[t]};if(a=e.fire("subrowclose",a),!a.isDefaultPrevented())return m(e,i),e.subrowIndex=null,x.removePartClasses(e,"subentry-opened",i),x.removePartClasses(e,"row-unfolded",e.getRow(t)),n(i,"title",e.subEntryOpenTip),n(i,"subrowopened",""),k.g(o(e,t)).style.display="none",!0;else return!1}function U(e,t,i){var s=e.subrowIndex,l=1;if(a(s))l=V(e,s,k.g(r(e,s)));if(l)x.addPartClasses(e,"subentry-opened",i),x.addPartClasses(e,"row-unfolded",e.getRow(t)),n(i,"title",e.subEntryCloseTip),n(i,"subrowopened","1"),k.g(o(e,t)).style.display="",e.subrowMutex&&(e.subrowIndex=t)}function c(e,i,n,a,o,s){var l=s.subrow,h=l&&n.subEntry,d={notInText:!0,width:e.subEntryWidth,align:"right"};if(h){var m="function"==typeof n.isSubEntryShow?n.isSubEntryShow.call(e,i,a,o):!0;if(m!==!1)d.html=k.format(v,{className:t(e,"subentry"),id:r(e,a),title:e.subEntryOpenTip,index:a});d.colClass=t(e,"subentryfield")}return d}function u(e,i,n){var a=e.datasource?e.datasource.length:0;return n.subrow?'<div id="'+o(e,i)+'" class="'+t(e,"subrow")+" "+(a===i+1?t(e,"subrow-last"):"")+'" style="display:none"></div>':""}function f(e,t){return k.g(o(e,t))}function y(t,i){var n=f(t,i),a=e(t,"subrow-panel-"+i),o=t.viewContext.get(a);if(!o)n.innerHTML=k.format(W,{id:a,index:i}),t.initChildren(n),o=t.viewContext.get(a),t.addChild(o);return o}function g(){b.apply(this,arguments)}var b=require("../Extension"),k=require("../lib"),x=require("../controlHelper"),L=require("../main"),_=require("../Table"),v='<div class="${className}" id="${id}" title="${title}" data-index="${index}"></div>',W='<div data-ui="type:Panel;id:${id}" data-index="${index}"></div>';return g.prototype.type="TableSubrow",g.prototype.activate=function(){var e=this.target;if(e instanceof _){var t=x.getPartClasses,i=t(e,"subentry")[0];e.addRowBuilders([{index:0,getRowArgs:s,getColHtml:c,getSubrowHtml:u}]),e.addHandlers("click",{handler:p,matchFn:i}),e.addHandlers("mouseover",{handler:l,matchFn:i}),e.addHandlers("mouseout",{handler:d,matchFn:i}),e.getSubrow=function(e){return f(this,e)},e.setSubrowContent=function(e,t){var i=y(this,t);if(i)i.set("content",e)},e.getSubrowContainer=function(e){return y(this,e)},b.prototype.activate.apply(this,arguments)}},g.prototype.inactivate=function(){var e=this.target;if(e instanceof _)delete e.getSubrow,b.prototype.inactivate.apply(this,arguments)},k.inherits(g,b),L.registerExtension(g),g});