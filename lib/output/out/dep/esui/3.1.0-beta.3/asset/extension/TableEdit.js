/*! @2014 Leo Wang. All Rights Reserved */
define("esui/extension/TableEdit",["require","../validator/MaxLengthRule","../validator/MaxRule","../validator/MinRule","../validator/RequiredRule","../validator/PatternRule","../Extension","../lib","../controlHelper","../main","../Table","../validator/ValidityState","../validator/Validity"],function(require){function e(e,i){if(nt=e,q=i.rowIndex,j=i.columnIndex,!$)$=T.layer.create(),document.body.appendChild($),$.className=e.helper.getPartClassName("editor"),t();$.style.zIndex=e.zIndex||"",n(i)}function t(){o(),i()}function i(){var e=E.init($);tt=r(e,N),it=r(e,B),tt.on("click",m()),it.on("click",c()),k(1)}function n(e){if(e.field&&at!==e.field){et&&et.dispose(),et=null;var t=D+ot++,i=z+ot,n=S.g(M),a=S.g(H);n.innerHTML=S.format(Y,{inputId:t}),a.innerHTML=S.format(Q,{validId:i});var o={properties:{}};o.properties[t]=S.extend({id:t,width:145,height:20,validityLabel:z+ot},e.field.editRules),et=E.init(n,o)[0],E.init(a),et.on("enter",m()),at=e.field}}function a(e){if(e==nt){s(),et.dispose(),tt.dispose(),it.dispose();try{$&&document.body.removeChild($)}catch(t){}$=null,et=null,tt=null,it=null,nt=null,at=null}}function o(){$.innerHTML=S.format(O,{inputFieldId:M,okId:N,cancelId:B,okText:R,cancelText:G,optClass:nt.helper.getPartClassName("editor-opt"),errorClass:nt.helper.getPartClassName("editor-error"),errorId:H})}function r(e,t){for(var i=e.length-1;i>=0;i--){var n=e[i];if(n.id===t)return n}}function s(){$&&($.style.display="none")}function l(){$&&($.style.display="")}function h(e){if(e){var t=new F;t.addState("TableEditCustomRule",new A(!1,e)),et.showValidity(t)}}function d(){var e=new F;e.addState("TableEditCustomRule",new A(!0)),et.showValidity(e)}function m(){return function(){p()}}function p(){if(et.validate()){var e={value:L(),rowIndex:q,columnIndex:j,field:nt.realFields[j]};if(e=nt.fire("saveedit",e),K(nt,"saveedit",e),!e.isDefaultPrevented())V.call(nt,e);else U.call(nt,e)}}function V(){if(this===nt)s(),Z=0}function U(e){if(this===nt&&e.errorMsg)h(e.errorMsg)}function c(){return function(){g()}}function u(){if(this==nt)y(this)}function f(){if(this==nt)y(this)}function y(e){if($){var t=S.g(e.getBodyCellId(q,j));if(t)T.layer.attachTo($,t)}}function g(){Z=0,s(),k(1);var e={rowIndex:q,columnIndex:j,field:nt.realFields[j]};e=nt.fire("canceledit",e),K(nt,"canceledit",e)}function b(t,i){if(Z&&nt)g();Z=1,e(t,i),k(0),l();var n=S.g(t.getBodyCellId(i.rowIndex,i.columnIndex));T.layer.attachTo($,n),x(i.value),d()}function k(e){tt.setDisabled(e),it.setDisabled(e)}function x(e){et.setValue(e)}function L(){return et.getValue()}function _(e){var t=this;if(t.startEdit){var i=S.getAttribute(e,"data-row"),n=S.getAttribute(e,"data-col");t.startEdit(i,n,e)}}function W(e,t,i){if(this.editable){var n=this.realFields[t],a={rowIndex:e,columnIndex:t,field:n};if(a=this.fire("startedit",a),K(this,"startedit",a),!a.isDefaultPrevented()){var o=this.datasource[e],r=n.editContent,s="function"==typeof r?r.call(this,o,e,t):o[n.field];b(this,{field:n,rowIndex:e,columnIndex:t,element:i,value:s})}}}function v(){if(this==nt)g()}function w(){if(this===nt)s()}function X(){if(this===nt)l()}function I(e,t,i,n,a){if(e.editable&&i.editable)return{textClass:e.getClass("cell-editable"),html:S.format(rt,{className:e.getClass("cell-editentry"),row:n,col:a})};else return void 0}function K(e,t,i){var n=i.field["on"+t];if(n&&"[object Function]"==Object.prototype.toString.call(n))n.call(e,i)}function C(){J.apply(this,arguments)}require("../validator/MaxLengthRule"),require("../validator/MaxRule"),require("../validator/MinRule"),require("../validator/RequiredRule"),require("../validator/PatternRule");var J=require("../Extension"),S=require("../lib"),T=require("../controlHelper"),E=require("../main"),P=require("../Table"),A=require("../validator/ValidityState"),F=require("../validator/Validity"),O=['<div class="${optClass}">','<div id="${inputFieldId}"></div>','<div data-ui="id:${okId};type:Button;">${okText}</div>','<div data-ui="id:${cancelId};type:Button;">',"${cancelText}","</div>","</div>",'<div class="${errorClass}" id="${errorId}"></div>'].join(""),M="ctrl-table-editor-inputField",D="ctrl-table-editorInput",z="ctrl-table-editor-validityLabel",N="ctrl-table-editor-ok",B="ctrl-table-editor-cancel",H="ctrl-table-editor-error",R="确定",G="取消",Y='<input data-ui="type:TextBox;id:${inputId}"/>',Q='<label data-ui="type:Validity;id:${validId}"></label>',q=-1,j=-1,Z=0,$=null,et=null,tt=null,it=null,nt=null,at=null,ot=1,rt='<div class="${className}" data-row="${row}" data-col="${col}"></div>';return C.prototype.type="TableEdit",C.prototype.activate=function(){var e=this.target;if(e instanceof P)e.startEdit=W,e.cancelEdit=v,e.hideEditLayer=w,e.showEditError=X,e.addRowBuilders([{index:3,getColHtml:I}]),e.addHandlers("click",{handler:_,matchFn:T.getPartClasses(e,"cell-editentry")[0]}),e.on("enddrag",u),e.on("resize",f),J.prototype.activate.apply(this,arguments)},C.prototype.inactivate=function(){var e=this.target;if(e instanceof P)delete e.startEdit,delete e.cancelEdit,e.un("enddrag",u),e.un("resize",f),a(e),J.prototype.inactivate.apply(this,arguments)},S.inherits(C,J),E.registerExtension(C),C});