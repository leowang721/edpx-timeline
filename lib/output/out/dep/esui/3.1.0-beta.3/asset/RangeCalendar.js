/*! @2014 Leo Wang. All Rights Reserved */
define("esui/RangeCalendar",["require","./Button","./MonthView","./CheckBox","./Label","./lib","./InputControl","./controlHelper","./Layer","./main","moment","underscore"],function(require){function e(){_.apply(this,arguments)}function t(e,t){e.view.begin=t.begin,e.view.end=t.end,e.value=e.convertToParam(t),d(e,"begin",t.begin),d(e,"end",t.end);var i=m(e,e.view);p(e,i);var n;if(!t.end)n=!0;else n=!1;e.setProperties({isEndless:n})}function i(){this.now=new Date,x.apply(this,arguments),this.layer=new e(this)}function n(e){var t='<div class="${shortCutClass}" id="${shortcutId}">${shortCut}</div><div class="${bodyClass}">${beginCalendar}${endCalendar}</div><div class="${footClass}"><div class="${okBtnClass}" data-ui="type:Button;childName:okBtn;">确定</div><div class="${cancelBtnClass}" data-ui="type:Button;childName:cancelBtn;">取消</div></div><div data-ui="type:Button;childName:closeBtn;skin:layerClose;height:12;"></div>';return k.format(t,{bodyClass:e.helper.getPartClassName("body"),shortcutId:e.helper.getId("shortcut"),shortCutClass:e.helper.getPartClassName("shortcut"),shortCut:r(e),beginCalendar:l(e,"begin"),endCalendar:l(e,"end"),footClass:e.helper.getPartClassName("foot"),okBtnClass:e.helper.getPartClassName("okBtn"),cancelBtnClass:e.helper.getPartClassName("cancelBtn")})}function a(e){return X(e).startOf("day").toDate()}function o(e){return X(e).endOf("day").toDate()}function s(e,t){var i=e.range,n=t.getValue.call(e);if(a(i.begin)>a(i.begin)||o(n.end)<o(n.end))return!0;else return!1}function r(e){for(var t=e.shownShortCut.split(","),i={},n=0;n<t.length;n++)i[t[n]]=!0;for(var a='<span data-index="${shortIndex}" class="'+e.helper.getPartClassName("shortcut-item")+' ${shortClass}" id="${shortId}">${shortName}</span>',o=e.shortCutItems,r=o.length,l=[],h=0;r>h;h++){var V=o[h];if(i[V.name]){var m=V.name,U=[];if(0===h)U=U.concat(e.helper.getPartClasses("shortcut-item-first"));var p=s(e,V);if(p)U=U.concat(e.helper.getPartClasses("shortcut-item-disabled"));var d=e.helper.getId("shortcut-item"+h);l.push(k.format(a,{shortIndex:h,shortClass:U.join(" "),shortId:d,shortName:m}))}}return l.join("")}function l(e,t){var i="";if(e.endlessCheck&&"end"===t)i='<input type="checkbox" title="不限结束" data-ui-type="CheckBox" data-ui-child-name="endlessCheck" />';var n='<div class="${frameClass}"><div class="${labelClass}"><h3>${labelTitle}</h3>'+i+'</div><div class="${calClass}"><div data-ui="type:MonthView;childName:${calName}"></div></div></div>';return k.format(n,{frameClass:e.helper.getPartClassName(t),labelClass:e.helper.getPartClassName("label"),labelTitle:"begin"==t?"开始日期":"结束日期",titleId:e.helper.getId(t+"Label"),calClass:e.helper.getPartClassName(t+"-cal"),calName:t+"Cal"})}function h(e){var t,i=e.getChild("endCal"),n=e.helper.getPart("shortcut");if(this.isChecked())e.isEndless=!0,i.disable(),t=-1,e.view.end=null,e.helper.addPartClasses("shortcut-disabled",n);else e.isEndless=!1,i.enable(),u.apply(e,[i,"end"]),e.helper.removePartClasses("shortcut-disabled",n)}function V(e,t){if(!e&&t||e&&!t)return!1;else if(!e&&!t)return!0;return X(e).isSame(t,"day")}function m(e,t){for(var i=e.shortCutItems,n=i.length,a=0;n>a;a++){var o=i[a],s=o.getValue.call(e);if(V(t.begin,s.begin)&&V(t.end,s.end))return a}return-1}function U(e,t){var i=e,n=e.shortCutItems;if(!(0>t||t>=n.length)){var a=n[t].getValue.call(i),o=a.begin,s=a.end;e.view={begin:o,end:s},d(e,"begin",o),d(e,"end",s),p(i,t)}}function p(e,t){var i=e.shortCutItems,n=e.miniMode;if(null!==n&&n!==t)e.helper.removePartClasses("shortcut-item-selected",e.helper.getPart("shortcut-item"+n));if(e.miniMode=t,t>=0)e.helper.addPartClasses("shortcut-item-selected",e.helper.getPart("shortcut-item"+t)),e.curMiniName=i[t].name;else e.curMiniName=null}function d(e,t,i,n){var a=e.getChild(t+"Cal");if(a)if(a.setProperties({rawValue:i,range:e.range}),n===!0)a.on("change",w.bind(u,e,a,t))}function c(e){if(!this.isEndless)for(var t=e.target||e.srcElement,i=this.helper.getPartClasses("shortcut-item"),n=this.helper.getPartClasses("shortcut-item-disabled");t&&t!=document.body;){if(k.hasClass(t,i[0])&&!k.hasClass(t,n[0])){var a=t.getAttribute("data-index");return void U(this,a)}t=t.parentNode}}function u(e,t){var i=e.getRawValue();if(i){this.view[t]=i;var n=m(this,this.view);p(this,n)}}function f(e){var t=e,i=e.view,n=i.begin,a=i.end;if(e.isEndless)a=null;var o=a-n;if(!a)o=n;var s;if(o>0)s={begin:n,end:a};else if(null!==a)s={begin:a,end:n};var r=t.fire("beforechange",{value:s});if(r.isDefaultPrevented())return!1;else return t.rawValue=s,t.value=t.convertToParam(s),y(t,s),t.layer.hide(),void t.fire("change",s)}function y(e,t){var i=e.helper.getPart("text");i.innerHTML=b(e,t)}function b(e,t){var i=g(e,t);if(e.isEndless&&i)return i;var n="";if(!e.curMiniName&&null!==e.miniMode&&e.miniMode>=0&&e.miniMode<e.shortCutItems.length)e.curMiniName=e.shortCutItems[e.miniMode].name;if(e.curMiniName)n=e.curMiniName+"&nbsp;&nbsp;";if(i)return n+i;else return""}function g(e,t){t=t||e.getRawValue();var i=t.begin,n=t.end,a=e.dateFormat;if(i&&n)return X(i).format(a)+" 至 "+X(n).format(a);else if(!n)return X(i).format(a)+" 起 ";return""}require("./Button"),require("./MonthView"),require("./CheckBox"),require("./Label");var k=require("./lib"),x=require("./InputControl"),L=require("./controlHelper"),_=require("./Layer"),W=require("./main"),X=require("moment"),w=require("underscore");return k.inherits(e,_),e.prototype.render=function(e){var t=this.control;document.body.appendChild(e),e.innerHTML=n(t),t.helper.initChildren(e);var i=t.helper.getPart("shortcut");L.addDOMEvent(t,i,"click",c),d(t,"begin",t.view.begin,!0),d(t,"end",t.view.end,!0);var a=m(t,t.view);p(t,a);var o=t.getChild("endlessCheck");if(o)if(o.on("change",k.curry(h,t)),t.isEndless)o.setChecked(!0),t.helper.addPartClasses("shortcut-disabled",t.helper.getPart(t));var s=t.getChild("okBtn");s.on("click",k.curry(f,t));var r=t.getChild("cancelBtn");r.on("click",w.bind(t.layer.hide,t.layer));var l=t.getChild("closeBtn");l.on("click",w.bind(t.layer.hide,t.layer))},e.prototype.toggle=function(){var e=this.getElement();if(!e||this.control.helper.isPart(e,"layer-hidden")){var i=this.control;t(i,i.rawValue),this.show()}else this.hide()},i.prototype.convertToParam=function(e){var t=e.begin,i=e.end,n=[];if(n.push(X(t).format("YYYY-MM-DD")),i)n.push(X(i).format("YYYY-MM-DD"));return n.join(",")},i.prototype.convertToRaw=function(e){var t=e.split(",");if(1===t.length)t.push("2046-11-04");else if(""===t[0])t[0]="1983-09-03";else if(""===t[1])t[1]="2046-11-04";return{begin:X(t[0],"YYYY-MM-DD").toDate(),end:X(t[1],"YYYY-MM-DD").toDate()}},i.defaultProperties={dateFormat:"YYYY-MM-DD",endlessCheck:!1,shortCutItems:[{name:"昨天",value:0,getValue:function(){var e=new Date(this.now.getTime());return e.setDate(e.getDate()-1),{begin:e,end:e}}},{name:"最近7天",value:1,getValue:function(){var e=X(this.now);return{begin:e.clone().subtract("day",7).toDate(),end:e.clone().subtract("day",1).toDate()}}},{name:"上周",value:2,getValue:function(){var e=this.now,t=new Date(e.getTime()),i=new Date(e.getTime()),n=1;if(t.getDay()<n%7)t.setDate(t.getDate()-14+n-t.getDay());else t.setDate(t.getDate()-7-t.getDay()+n%7);return t.setHours(0,0,0,0),i.setFullYear(t.getFullYear(),t.getMonth(),t.getDate()+6),i.setHours(0,0,0,0),{begin:t,end:i}}},{name:"本月",value:3,getValue:function(){return{begin:X(this.now).startOf("month").toDate(),end:X(this.now).toDate()}}},{name:"上个月",value:4,getValue:function(){var e=X(this.now).subtract("month",1).startOf("month").toDate(),t=X(this.now).startOf("month").subtract("day",1).toDate();return{begin:e,end:t}}},{name:"上个季度",value:5,getValue:function(){var e=this.now,t=X(e).subtract("month",e.getMonth()%3+3).startOf("month").toDate(),i=X(e).subtract("month",e.getMonth()%3).startOf("month").subtract("day",1).toDate();return{begin:t,end:i}}}]},i.prototype.type="RangeCalendar",i.prototype.initOptions=function(e){var t=this.now,n={begin:t,end:t},a={range:{begin:new Date(1983,8,3),end:new Date(2046,10,4)},rawValue:n,view:w.clone(n),value:this.convertToParam(n),shownShortCut:"昨天,最近7天,上周,本月,上个月,上个季度"};if(k.extend(a,i.defaultProperties),L.extractValueFromInput(this,e),e.value)e.rawValue=this.convertToRaw(e.value),e.view={begin:e.rawValue.begin,end:e.rawValue.end},e.miniMode=null;else if(e.rawValue)e.miniMode=null;else if(!e.rawValue&&null!=e.miniMode){var o=a.shortCutItems[e.miniMode];if(o)e.rawValue=o.getValue.call(this),e.miniMode=parseInt(e.miniMode,10);else e.miniMode=null}if(k.extend(a,e),a.range&&"string"==typeof a.range)a.range=this.convertToRaw(a.range);if("false"===a.endlessCheck)a.endlessCheck=!1;if(a.endlessCheck){if("false"===a.isEndless)a.isEndless=!1}else if(!a.rawValue.end)a.endlessCheck=!0,a.isEndless=!0;if(a.isEndless)a.endlessCheck=!0,a.rawValue.end=null,a.view.end=null,a.view.value=this.convertToParam({begin:t,end:null});this.setProperties(a)},i.prototype.initStructure=function(){if(k.isInput(this.main))L.replaceMain(this);var e=['<div class="${className}" id="${id}"></div>','<div class="${arrow}"></div>'];this.main.innerHTML=k.format(e.join("\n"),{className:this.helper.getPartClassName("text"),id:L.getId(this,"text"),arrow:this.helper.getPartClassName("arrow")})},i.prototype.initEvents=function(){this.helper.addDOMEvent(this.main,"mousedown",w.bind(this.layer.toggle,this.layer))},i.prototype.repaint=L.createRepaint(x.prototype.repaint,{name:["rawValue","range"],paint:function(e,i,n){if(n){if("string"==typeof n)n=e.convertToRaw(n);if(!n.begin)n.begin=new Date(1983,8,3);else if(!n.end)n.end=new Date(2046,10,4);e.range=n}if(i)y(e,i);if(e.layer)t(e,i)}},{name:["disabled","hidden","readOnly"],paint:function(e,t,i,n){if(t||i||n)e.layer.hide()}},{name:"isEndless",paint:function(e,t){if(!e.endlessCheck)e.isEndless=!1;else{var i=e.getChild("endlessCheck");if(i)i.setChecked(t)}}}),i.prototype.setRawValue=function(e){this.setProperties({rawValue:e})},i.prototype.getRawValue=function(){return this.rawValue},i.prototype.stringifyValue=function(e){return this.convertToParam(e)||""},i.prototype.parseValue=function(e){return this.convertToRaw(e)},i.prototype.dispose=function(){if(!L.isInStage(this,"DISPOSED")){if(this.layer)this.layer.dispose(),this.layer=null;x.prototype.dispose.apply(this,arguments)}},k.inherits(i,x),W.register(i),i});