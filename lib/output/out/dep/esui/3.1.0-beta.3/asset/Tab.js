/*! @2014 Leo Wang. All Rights Reserved */
define("esui/Tab",["require","underscore","./lib","./Control","./painters","./main"],function(require){function e(){r.apply(this,arguments)}function t(e){for(var t=e.target,i=t;i&&"li"!==i.nodeName.toLowerCase();)i=i.parentNode;if(i&&"li"===i.nodeName.toLowerCase())for(var n=i.parentNode,a=s.getChildren(n),o=0;o<a.length;o++)if(a[o]===i){if(this.helper.isPart(t,"close"))this.removeAt(o);else this.set("activeIndex",o);return}}function i(e,t,i,n){var a=document.createElement("li");if(e.helper.addPartClasses("item",a),i)e.helper.addPartClasses("item-active",a);return a.innerHTML=e.getContentHTML(t,n),a}function n(e){var t=e.helper.getPart("navigator"),n=t.parentNode,a=t.nextSibling;t.innerHTML="",t.parentNode.removeChild(t);for(var o=0;o<e.tabs.length;o++){var s=e.tabs[o],r=e.activeIndex===o,l=i(e,s,r,e.allowClose);t.appendChild(l)}n.insertBefore(t,a)}function a(e,t){for(var i=0;i<e.tabs.length;i++){var n=e.tabs[i];if(n.panel){var a=s.g(n.panel);if(a)a.style.display=i===t?"":"none"}var o=e.helper.getPart("navigator"),r=s.getChildren(o),l=r[i],h=i===t?"addPartClasses":"removePartClasses";e.helper[h]("item-active",l)}var m={activeIndex:t,tab:e.tabs[t]};e.fire("activate",m)}var o=require("underscore"),s=require("./lib"),r=require("./Control");return e.prototype.type="Tab",e.prototype.initOptions=function(e){var t={tabs:[],activeIndex:0,allowClose:!1,orientation:"horizontal"};o.extend(t,e);var i=s.getChildren(this.main);if(i.length){for(var n=[],a=0;a<i.length;a++){var r=i[a];if("navigator"===r.getAttribute("data-role")){t.tabs=[],this.navigatorElement=r;for(var i=s.getChildren(r),a=0;a<i.length;a++){var l=i[a],h={title:s.getText(l),panel:l.getAttribute("data-for")};t.tabs.push(h)}break}else{var h={title:r.getAttribute("title"),panel:r.id};n.push(h)}}if(!t.tabs.length)t.tabs=n}if("string"==typeof t.activeIndex)t.activeIndex=+t.activeIndex;this.setProperties(t)},e.prototype.initStructure=function(){var e=this.navigatorElement;if(this.navigatorElement=null,!e)e=document.createElement("ul"),this.main.insertBefore(e,this.main.firstChild||null);e.id=this.helper.getId("navigator"),this.helper.addPartClasses("navigator",e)},e.prototype.initEvents=function(){this.helper.addDOMEvent("navigator","click",t)},e.prototype.contentTemplate="<span>${title}</span>",e.prototype.getContentHTML=function(e,t){var i=s.format(this.contentTemplate,{title:o.escape(e.title)});if(t)i+='<span class="'+this.helper.getPartClassName("close")+'">关闭</span>';return i},e.prototype.setProperties=function(e){if(e.tabs){if(null==e.activeIndex){for(var t=this.tabs[this.activeIndex],i=-1,n=0;n<e.tabs.length;n++)if(e.tabs[n]===t){i=n;break}if(-1===i)this.activeIndex=-1,e.activeIndex=0;else this.activeIndex=i}if(null!=e.allowClose)this.allowClose=e.allowClose,delete e.allowClose}r.prototype.setProperties.apply(this,arguments)},e.prototype.repaint=require("./painters").createRepaint(r.prototype.repaint,{name:["tabs","allowClose"],paint:n},{name:"activeIndex",paint:a},{name:"orientation",paint:function(e,t){e.removeState("vertical"),e.removeState("horizontal"),e.addState(t)}}),e.prototype.activate=function(e){for(var t=0;t<this.tabs.length;t++)if(this.tabs[t]===e)this.set("activeIndex",t)},e.prototype.add=function(e){this.insert(e,this.tabs.length)},e.prototype.insert=function(e,t){t=Math.min(t,this.tabs.length),t=Math.max(t,0),this.tabs.splice(t,0,e);var n=i(this,e,!1,this.allowClose),o=this.helper.getPart("navigator"),r=s.getChildren(o);if(o.insertBefore(n,r[t]||null),1===this.tabs.length)this.activeIndex=0,a(this,0);else{if(t<=this.activeIndex)this.activeIndex++;if(e.panel){var l=s.g(e.panel);if(l)l.style.display="none"}}this.fire("add",{tab:e,index:t})},e.prototype.remove=function(e){for(var t=0;(t=o.indexOf(this.tabs,e,t))>=0;)this.removeAt(t)},e.prototype.removeAt=function(e){var t=this.tabs.splice(e,1)[0],i=this.helper.getPart("navigator");if(t){var n=s.getChildren(i),o=n[e];if(o.parentNode.removeChild(o),e<this.activeIndex)this.activeIndex--;else if(e===this.activeIndex)this.activeIndex=Math.min(this.activeIndex,this.tabs.length-1),a(this,this.activeIndex);if(t.panel){var r=s.g(t.panel);if(r)r.style.display="none"}this.fire("remove",{tab:t,index:e})}},e.prototype.getActiveTab=function(){return this.get("tabs")[this.get("activeIndex")]},s.inherits(e,r),require("./main").register(e),e});