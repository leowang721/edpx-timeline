/*! @2014 Leo Wang. All Rights Reserved */
define("esui/Table",["require","./lib","underscore","./controlHelper","./Control","./main"],function(require){function e(e){var t={followHeightArr:[0,0],followWidthArr:[],handlers:[]};Et.call(this,Jt.extend({},e,t))}function t(e){return!("undefined"==typeof e||null===e)}function i(e){return!t(e)||!e.toString().length}function n(e,t,i){Ct.setAttribute(e,"data-"+t,i)}function a(e,t){return Ct.getAttribute(e,"data-"+t)}function o(e,t){var i=Ct.getStyle(e,t);return""===i?0:parseInt(i,10)||0}function s(e,t){return St.getId(e,t)}function r(e,t){return St.getPartClasses(e,t).join(" ")}function l(e){return Ct.g(s(e,"head"))}function h(e){return Ct.g(s(e,"body"))}function m(e){return Ct.g(s(e,"foot"))}function d(e,t){return Ct.g(s(e,"row")+t)}function V(e){return Ct.g(s(e,"select-all"))}function U(e,t){e.selectedIndex=t;for(var i={},n=t.length-1;n>=0;n--)i[t[n]]=1;e.selectedIndexMap=i}function p(e,t){if(e.selectedIndexMap)return!!e.selectedIndexMap[t];else return!1}function c(e){if(e.width)return e.width;var t=document.createElement("div"),i=e.main.parentNode;i.appendChild(t);var n=t.offsetWidth;return t.parentNode.removeChild(t),n}function u(e){if(e.fields){for(var t=e.fields,i=t.slice(0),n=i.length;n--;)if(!i[n])i.splice(n,1);if(e.realFields=i,e.select)switch(e.select.toLowerCase()){case"multi":i.unshift(mt(e));break;case"single":i.unshift(dt(e))}}}function f(e){if(e.followHead)if(g(e),!e.noFollowHeadCache)x(e)}function y(e){if(e.followHead)g(e),x(e)}function g(e){if(e.followHead){for(var t=e.followDoms=[],i=e.main.parentNode.firstChild,n=e.id;i;){if(1===i.nodeType&&a(i,"follow-thead")===n)t.push(i);i=i.nextSibling}k(e),b(e)}}function b(e){var t=e.followDoms,i=e.followHeightArr;i[0]=0;for(var n=0,a=t.length;a>n;n++){var o=t[n];i[n+1]=i[n]+o.offsetHeight}i[n+1]=i[n],i.lenght=n+2}function k(e){for(var t=e.followDoms,i=e.followWidthArr,n=0,a=t.length;a>n;n++){var s=t[n],r=o(s,"padding-left")+o(s,"padding-right")+o(s,"border-left-width")+o(s,"border-right-width");i[n]=r,t[n].style.width=e.realWidth-r+"px"}}function x(e){var t=e.followDoms,i=Ct.getOffset(t[0]||e.main);e.followTop=i.top,e.followLeft=i.left}function L(e){var t=e.realFields,i=[],n=e.fontSize,a=2*e.colPadding+5;if(!e.noHead)for(var o=0,s=t.length;s>o;o++){var r=t[o],l=r.minWidth;if(!l&&!r.breakLine)l=r.title.length*n+a+(e.sortable&&r.sortable?e.sortWidth:0)+(r.tip?e.tipWidth:0);i[o]=l}else for(var h=n+a,o=0,s=t.length;s>o;o++)i[o]=h;e.minColsWidth=i}function _(e){var t=e.realFields,i=[];e.colsWidth=[];for(var n=e.realWidth-1,a=0,o=t.length;o>a;a++){var s=t[a],r=s.width;if(r=r?parseInt(r,10):0,e.colsWidth.push(r),n-=r,!s.stable)i.push(a)}for(var o=i.length,l=Math.round(n/o),a=0;o>a;a++){var h=i[a],m=Math.abs(n)<Math.abs(l)?n:l;n-=m,e.colsWidth[h]+=m;var d=e.minColsWidth[h];if(d>e.colsWidth[h])n+=e.colsWidth[h]-d,e.colsWidth[h]=d}if(0>n)for(var a=0;o>a&&0!==n;){var h=i[a],d=e.minColsWidth[h];if(d<e.colsWidth[h]){var m=e.colsWidth[i[a]]-d;m=m>Math.abs(n)?n:-m,n+=Math.abs(m),e.colsWidth[h]+=m}a++}else if(n>0)e.colsWidth[i[0]]+=n}function W(e){var t=m(e);if(!(e.foot instanceof Array))t&&(t.style.display="none");else{if(!t)t=document.createElement("div"),t.id=s(e,"foot"),t.className=r(e,"foot"),n(t,"control-table",e.id),e.main.appendChild(t);if(t.style.display="",e.realWidth)t.style.width=e.realWidth+"px";t.innerHTML=X(e)}}function X(e){var t=[],n=e.foot,a=0,o=e.colsWidth,s=r(e,"fcell"),l=r(e,"fcell-text"),h=e.rowWidthOffset;t.push(Ct.format(Tt,{width:"100%",controlTableId:e.id}),"<tr>");for(var m=0,d=n.length;d>m;m++){var V=n[m],U=o[a],p=V.colspan||1,c=[s],u=V.content;if("function"==typeof u)u=u.call(e);if(i(u))u="&nbsp;";for(var f=1;p>f;f++)U+=o[a+f];if(a+=p,V.align)c.push(r(e,"cell-align-"+V.align));U+=h,0>U&&(U=0),t.push('<th id="'+C(e,m)+'" class="'+c.join(" ")+'"',' style="width:'+U+"px;",(U?"":"display:none;")+'">','<div class="'+l+'">',u,"</div></th>")}return t.push("</tr></table>"),t.join("")}function w(e){var t=l(e),i=s(e,"head-panel");if(!t)t=document.createElement("div"),t.id=s(e,"head"),t.className=r(e,"head"),n(t,"control-table",e.id),e.main.appendChild(t),t.innerHTML=Ct.format('<div id="${id}" data-ui="type:Panel;id:${id};"></div>',{id:i}),e.initChildren(t),e.headPanel=e.viewContext.get(i),St.addDOMEvent(e,t,"mousemove",Jt.bind(P,t,e)),St.addDOMEvent(e,t,"mousedown",Jt.bind(O,t,e));if(e.noHead)return void(t.style.display="none");if(t.style.display="",e.realWidth)t.style.width=e.realWidth+"px";Ct.g(i).innerHTML=K(e),v(e,e.viewContext.get(i))}function v(e,t){if(t.children)t.disposeChildren();if(e.hasTip)t.initChildren()}function K(e){var t=e.realFields,n=r(e,"hcell"),a=r(e,"hcell-text"),o=r(e,"cell-break"),l=r(e,"hsort"),h=r(e,"hcell-sel"),m=-1,d=-1,V=e.rowWidthOffset;if(!e.disabled){for(var U=0,p=t.length;p>U;U++)if(!t[U].stable){m=U;break}for(var U=p-1;U>=0;U--)if(!t[U].stable){d=U;break}}var c=[];c.push(Ct.format(Tt,{width:"100%",controlTableId:e.id}),"<tr>");for(var U=0,p=t.length;p>U;U++){var u=[n],f=t[U],y=f.title,g=e.sortable&&f.sortable,b=g&&f.field&&f.field==e.orderBy,k=a;if(0===U)k+=" "+r(e,"hcell-text-first");if(U===p-1)k+=" "+r(e,"hcell-text-last");var x="";if(g){if(u.push(r(e,"hcell-sort")),b)u.push(r(e,"hcell-"+e.order));x=Ct.format(At,{className:l})}if(f.align)u.push(r(e,"cell-align-"+f.align));if(e.breakLine||f.breakLine)u.push(o);var L="",_="",W=f.tip;if("function"==typeof W)_=W.call(e);else _=W;if(_)L=Ct.format(Pt,{id:s(e,"htip"+U),className:r(e,"htip"),content:_}),e.hasTip=!0;var X;if("function"==typeof y)X=y.call(e);else X=y;if(i(X))X="&nbsp;";c.push('<th id="'+I(e,U)+'"',' data-index="'+U+'"',' class="'+u.join(" ")+'"',g?' data-sortable="1"':"",U>=m&&d>U?' data-dragright="1"':"",d>=U&&U>m?' data-dragleft="1"':"",' style="',"width:"+(e.colsWidth[U]+V)+"px;",(e.colsWidth[U]?"":"display:none")+'">','<div class="'+k+(f.select?" "+h:"")+'">',L,X,x,"</div></th>")}return c.push("</tr></table>"),c.join("")}function I(e,t){return s(e,"title-cell")+t}function C(e,t){return s(e,"foot-cell")+t}function J(e){S(this,e)}function S(e,t){if(!e.isDraging&&!e.dragReady)if(St.addPartClasses(e,"hcell-hover",t),e.sortable){e.sortReady=1;var i=a(t,"index"),n=e.realFields[i];if(n&&n.sortable)St.addPartClasses(e,"hcell-sort-hover",t)}}function E(e){T(this,e)}function T(e,t){if(St.removePartClasses(e,"hcell-hover",t),e.sortable)e.sortReady=0,St.removePartClasses(e,"hcell-sort-hover",t)}function A(e){var t=this;if(t.sortable&&t.sortReady){var i=a(e,"index"),n=t.realFields[i];if(n.sortable){var o=t.orderBy,s=t.order;if(o==n.field)s=!s||"asc"==s?"desc":"asc";else s="desc";t.setProperties({order:s,orderBy:n.field}),t.fire("sort",{field:n,order:s})}}}function P(e,t){if(e.columnResizable){var i="startdrag",n=8;if(!e.isDraging){var o=t.target;if(o=F(e,o)){var s=this,r=t.pageX||t.clientX+Ct.page.getScrollLeft(),l=Ct.getOffset(o),h=a(o,"sortable");if(a(o,"dragleft")&&r-l.left<n)h&&T(e,o),St.addPartClasses(e,i,s),e.dragPoint="left",e.dragReady=1;else if(a(o,"dragright")&&l.left+o.offsetWidth-r<n)h&&T(e,o),St.addPartClasses(e,i,s),e.dragPoint="right",e.dragReady=1;else St.removePartClasses(e,i,s),h&&S(e,o),e.dragPoint="",e.dragReady=0}}}}function F(e,t){for(;1==t.nodeType;){if("TH"==t.nodeName)return t;t=t.parentNode}return null}function O(e,t){if(e.columnResizable){e.fire("startdrag"),e.fire("dragstart");var i=r(e,"startdrag"),n=t.target;if(n=F(e,n))if(!(Ct.g(s(e,"head")).className.indexOf(i)<0)){e.htmlHeight=document.documentElement.clientHeight,e.isDraging=!0,e.dragIndex=a(n,"index"),e.dragStart=t.pageX||t.clientX+Ct.page.getScrollLeft(),M(e);var o=Jt.partial(D,e),l=function(t){var i=!0;try{i=Jt.partial(R,e)(t)}catch(n){}return Ct.un(document,"mousemove",o),Ct.un(document,"mouseup",l),i};return Ct.on(document,"mousemove",o),Ct.on(document,"mouseup",l),z(e,e.dragStart),Ct.event.preventDefault(t),!1}}}function M(e){var t=Ct.getOffset(e.main);e.top=t.top,e.left=t.left}function D(e,t){var i=t||window.event;return z(e,i.pageX||i.clientX+Ct.page.getScrollLeft()),Ct.event.preventDefault(i),!1}function z(e,t){var i=H(e),n=e.left+e.realWidth,a=e.left+1,o=n-1;if(t=a>t?a:t,t=t>o?o:t,!i)i=B(e);i.style.top=e.top+"px",i.style.left=t+"px",i.style.zIndex=e.zIndex||"";var s=e.htmlHeight-e.top+Ct.page.getScrollTop(),r=e.main.offsetHeight;s=r>s?s:r,i.style.height=s+"px"}function N(e){var t=H(e);t.style.left="-10000px",t.style.top="-10000px"}function B(e){var t=document.createElement("div");return t.id=s(e,"drag-mark"),t.className=r(e,"mark "),t.style.top="-10000px",t.style.left="-10000px",document.body.appendChild(t),t}function H(e){return Ct.g(s(e,"drag-mark"))}function R(e,t){var i=t||window.event,n=parseInt(e.dragIndex,10),a=i.pageX||i.clientX+Ct.page.getScrollLeft(),o=e.realFields,s=o.length,r=0,l=e.colsWidth,h=0;if("left"==e.dragPoint)n--;var m=e.minColsWidth[n],d=a-e.dragStart,V=l[n]+d;if(m>V)d+=m-V,V=m;for(var U=[],p=[],c=n+1;s>c;c++)if(!o[c].stable&&l[c]>0)U.push(c),g=l[c],p.push(g),r+=g;for(var u=d,f=U.length,c=0;f>c;c++){var y=U[c],g=p[c],b=d*g/r,k=u>0?Math.ceil(b):Math.floor(b);if(k=Math.abs(k)<Math.abs(u)?k:u,g-=k,u-=k,m=e.minColsWidth[y],m>g)h+=m-g,g=m;l[y]=g}return V-=h,l[n]=V,ht(e),e.isDraging=!1,N(e),e.fire("enddrag"),e.fire("dragend"),Ct.event.preventDefault(i),!1}function G(e){var t=h(e),i=s(e,"body-panel");if(!t){var n="body",a=s(e,n);t=document.createElement("div"),t.id=a,t.className=r(e,n),e.main.appendChild(t),t.innerHTML=Ct.format('<div id="${id}" data-ui="type:Panel;id:${id}"></div>',{id:i}),e.initChildren(t),e.bodyPanel=e.viewContext.get(i)}var o=t.style;if(o.overflowX="hidden",o.overflowY="auto",e.realWidth)o.width=e.realWidth+"px";e.bodyPanel.disposeChildren(),Ct.g(i).innerHTML=Q(e),e.fire("bodyChange")}function Y(e){var t=h(e),i=t.style,n=e.datasource.length,a=e.bodyMaxHeight;if(a>0&&n>0){var o=a,r=Ct.g(s(e,"body-panel"));if(r)o=r.offsetHeight;if(o>=a)return void(i.height=a+"px")}i.height="auto"}function Q(e){var t=e.datasource||[],i=t.length,n=[];if(!i)return Ct.format(Ft,{className:r(e,"body-nodata"),html:e.noDataHtml});for(var a=e.rowBuilderList,o=0;i>o;o++){var s=t[o];n.push($(e,s,o,a))}return n.join("")}function q(e,t,i){return s(e,"cell")+t+"-"+i}function Z(e,i){for(var n=e.rowBuilderList||[],a=0,o=i.length;o>a;a++){var s=i[a];if(s.getColHtml){if(s.getSubrowHtml)e.hasSubrow=!0;if(!t(s.index))s.index=1e3;n.push(s)}else;}n.sort(function(e,t){return e.index-t.index}),e.rowBuilderList=n}function j(e){Z(e,[{index:1,getRowArgs:et,getColHtml:tt}])}function $(e,i,n,a){function o(e,t){return e.index-t.index}for(var r=[],l=e.realFields,h=e.rowWidthOffset,m=[],d=[],V=[],U=0,p=a.length;p>U;U++){var c=a[U],u=c.getRowArgs?c.getRowArgs(e,n)||{}:{};m.push(u),u.rowClass&&d.push(u.rowClass),u.rowAttr&&V.push(u.rowAttr)}for(var U=0,p=l.length;p>U;U++){for(var f=l[U],y=e.colsWidth[U],g=[],b=[],k=[],x=[],L=[],_=[],W=-1,X=0,w=a.length;w>X;X++){var v=a[X].getColHtml(e,i,f,n,U,m[X]);if(v){var K=v.html;if(v.colClass)g.push(v.colClass);if(v.textClass)b.push(v.textClass);if(v.colAttr)k.push(v.colAttr);if(v.textAttr)x.push(v.textAttr);if(t(K))if(v.notInText)v.index=X,_.push(v);else L.push(K),0>W&&(W=X)}else;}var I="";if(L=['<div class="'+b.join(" ")+'" ',x.join(" ")+">",L.join(""),"</div>"].join(""),_.push({html:L,index:W}),_.sort(o),_.length>1){for(var I=['<table width="100%" cellpadding="0" cellspacing="0">',"<tr>"],X=0,w=_.length;w>X;X++){var C=_[X];I.push("<td ",t(C.width)?' width="'+C.width+'" ':"",C.align?' align="'+C.align+'">':">",C.html,"</td>")}I.push("</tr></table>"),I=I.join("")}else I=L;r.push('<td id="'+q(e,n,U)+'" ','class="'+g.join(" ")+'" ',k.join(" ")+" ",'style="width:'+(y+h)+"px;",(y?"":"display:none")+'" ','data-control-table="'+e.id+'" ','data-row="'+n+'" data-col="'+U+'">',I,"</td>")}if(r.unshift(Ct.format(Ot,{id:s(e,"row")+n,className:d.join(" "),attr:V.join(" "),index:n}),Ct.format(Tt,{width:"100%",controlTableId:e.id})),r.push("</tr></table></div>"),e.hasSubrow)for(var U=0,p=a.length;p>U;U++){var J=a[U].getSubrowHtml;if(J)r.push(J(e,n,m[U]))}return r.join("")}function et(e,t){var i=e.datasource||[],n=i.length;return{tdCellClass:r(e,"cell"),tdBreakClass:r(e,"cell-break"),tdTextClass:r(e,"cell-text"),fieldLen:e.realFields.length,rowClass:[r(e,"row"),r(e,"row-"+(t%2?"odd":"even")),p(e,t)?r(e,"row-selected"):"",n-1==t?r(e,"row-last"):""].join(" ")}}function tt(e,t,n,a,o,l){var h=l.tdCellClass,m=l.tdBreakClass,d=l.tdTextClass,V=[h],U=[d],p=n.content;if(0===o)U.push(r(e,"cell-text-first"));if(o===l.fieldLen-1)U.push(r(e,"cell-text-last"));if(e.breakLine||n.breakLine)V.push(m);if(n.select)U.push(r(e,"cell-sel"));if(n.align)V.push(r(e,"cell-align-"+n.align));if(n.field&&n.field==e.orderBy)V.push(r(e,"cell-sorted"));var c="function"==typeof p?p.call(e,t,a,o):e.encode?Ct.encodeHTML(t[p]):t[p];if(i(c))c="&nbsp;";return{colClass:V.join(" "),textClass:U.join(" "),html:Ct.format(Mt,{colTextId:s(e,"cell-textfield-"+a+"-"+o),content:c})}}function it(e){if(!this.isDraging)St.addPartClasses(this,"row-hover",e)}function nt(e){St.removePartClasses(this,"row-hover",e)}function at(e,t){var i=this,n=St.getPartClasses(i,"cell-text")[0];if("line"==i.selectMode&&Ct.hasClass(t.target,n)){if(i.dontSelectLine)return void(i.dontSelectLine=!1);var o=a(e,"index");switch(i.select){case"multi":var r=Ct.g(s(i,"multi-select")+o);Ut(i,o,!r.checked),pt(i);break;case"single":gt(i,o,!0)}}}function ot(e){e.viewWidth=Ct.page.getViewWidth(),e.viewHeight=Ct.page.getViewHeight();var t=function(){var t=Ct.page.getViewWidth(),i=Ct.page.getViewHeight();if(t!=e.viewWidth||i!=e.viewHeight)e.viewWidth=t,e.viewHeight=i,st(e)};St.addDOMEvent(e,window,"resize",t)}function st(e){var t=l(e),i=m(e);e.realWidth=c(e);var n=e.realWidth+"px";if(e.realWidth)e.main.style.width=n,h(e).style.width=n,t&&(t.style.width=n),i&&(i.style.width=n);if(_(e),ht(e),e.followHead)k(e),b(e);M(e),e.fire("resize"),e.topReseter&&e.topReseter()}function rt(e,t,i,n){if(e)e.style.top=i+"px",e.style.left=n+"px",e.style.position=t}function lt(e){if(e.followHead&&!e.topReseter){var t=l(e),i=s(e,"top-placeholder"),n=document.createElement("div");n.id=i,n.style.width="100%",n.style.display="none",Ct.insertBefore(n,e.main),n=null,e.topReseter=function(){if(e.followHead){var n=Ct.page.getScrollTop(),a=Ct.ie&&Ct.ie<7?"absolute":"fixed",o=e.main.offsetHeight,s="absolute"==a,r=Ct.g(i),l=e.followDoms;if(e.noFollowHeadCache){var h=t.style.position;if("fixed"!==h&&"absolute"!==h)x(e)}if(n>e.followTop&&(s||n-e.followTop<o)){var m=Ct.page.getScrollLeft(),d=e.followHeightArr,V=d.length;M(e);var U=s?e.left:e.left-m;if(r.style.height=d[V-1]+t.offsetHeight+"px",r.style.display="",Ct.ie&&Ct.ie<8)t.style.zIndex=e.zIndex+1;if(s){for(var p=0,c=l.length;c>p;p++)rt(l[p],a,d[p]+n,U);rt(t,a,d[V-1]+n,U)}else{for(var p=0,c=l.length;c>p;p++)rt(l[p],a,d[p],U);rt(t,a,d[V-1],U)}}else{r.style.height=0,r.style.display="none",a="";for(var p=0,c=l.length;c>p;p++)rt(l[p],a,0,0);rt(t,a,0,0),t.style.zIndex=""}}},St.addDOMEvent(e,window,"scroll",e.topReseter)}}function ht(e){var t=e.colsWidth,i=e.foot,n=e.id,o=i instanceof Array&&i.length,s=h(e).getElementsByTagName("td"),r=s.length,l=e.rowWidthOffset;if(o)for(var m=0,d=0;o>d;d++){for(var V=i[d],U=t[m],p=V.colspan||1,c=1;p>c;c++)U+=t[m+c];m+=p;var u=Ct.g(C(e,d));U=Math.max(U+l,0),u.style.width=U+"px",u.style.display=U?"":"none"}if(o=t.length,!e.noHead)for(var d=0;o>d;d++){var U=Math.max(t[d]+l,0),u=Ct.g(I(e,d));u.style.width=U+"px",u.style.display=U?"":"none"}for(var c=0,d=0;r>d;d++){var u=s[d];if(a(u,"control-table")==n){var U=Math.max(t[c%o]+l,0);u.style.width=U+"px",u.style.display=U?"":"none",c++}}}function mt(e){return{width:30,stable:!0,select:!0,title:function(t,i){var n={id:s(e,"select-all"),className:r(e,"select-all"),disabled:e.disabled?'disabled="disabled"':"",index:i};return Ct.format(Dt,n)},content:function(t,i){var n={id:s(e,"multi-select")+i,className:r(e,"multi-select"),disabled:e.disabled?'disabled="disabled"':"",index:i,checked:p(e,i)?'checked="checked"':""};return Ct.format(zt,n)}}}function dt(e){return{width:30,stable:!0,title:"&nbsp;",select:!0,content:function(t,i){var n=s(e,"single-select"),a={id:n+i,name:n,className:r(e,"single-select"),index:i,disabled:e.disabled?'disabled="disabled"':"",checked:p(e,i)?'checked="checked"':""};return Ct.format(Nt,a)}}}function Vt(e){var t=a(e,"index");Ut(this,t),pt(this)}function Ut(e,i,n){var o="row-selected";if(i>=0){var r=Ct.g(s(e,"multi-select")+i);if(r){t(n)&&(r.checked=n);var l=d(e,i);if(r.checked)St.addPartClasses(e,o,l);else St.removePartClasses(e,o,l)}}else if(t(n))for(var h=ut(e,"checkbox"),m=0,V=h.length;V>m;m++){var r=h[m];r.checked=n;var U=a(r,"index"),l=d(e,U);if(n)St.addPartClasses(e,o,l);else St.removePartClasses(e,o,l)}}function pt(e){for(var t=V(e),i=ut(e,"checkbox"),n=!0,o=[],r=s(e,"multi-select"),l=0,h=i.length;h>l;l++){var m=i[l];if(m.id.indexOf(r)>=0){var d=a(m,"index");if(!m.checked)n=!1;else o.push(d)}}U(e,o),e.fire("select",{selectedIndex:o}),t.checked=n}function ct(){ft(this,V(this).checked)}function ut(e,t){for(var i=h(e).getElementsByTagName("input"),n=[],a=0,o=i.length;o>a;a++){var s=i[a],r=s.id;if(s.getAttribute("type")==t&&r)n.push(s)}return n}function ft(e,t){Ut(e,-1,t),pt(e)}function yt(e){gt(this,a(e,"index"))}function gt(e,i,n){var a=e.selectedIndex,o=Ct.g(s(e,"single-select")+i);if(o){if(t(n)&&(o.checked=n),e.fire("select",{selectedIndex:i}),a&&a.length)St.removePartClasses(e,"row-selected",d(e,a[0]));U(e,[i]),St.addPartClasses(e,"row-selected",d(e,i))}}function bt(e){e.main.style.zIndex=e.zIndex||""}function kt(e){for(var t=ut(e,"multi"==e.select?"checkbox":"radio"),i=t.length-1;i>=0;i--)if(e.disabled)t[i].setAttribute("disabled","disabled");else t[i].removeAttribute("disabled");if("multi"==e.select){var n=V(e);if(n)if(e.disabled)n.setAttribute("disabled","disabled");else n.removeAttribute("disabled")}if(e.children&&e.children.length)for(var a=e.children,i=a.length-1;i>=0;i--)a[i].setDisabled(e.disabled)}function xt(e){var t=" "+e+" ";return function(e){var i=" "+e.className+" ";return i.replace(Bt," ").indexOf(t)>=0}}function Lt(e,t){var i=null;if(t)i="function"==typeof t?t:xt(t);return{handler:e,matchFn:i}}function _t(e,t,i){var n=t.id,a=e.handlers[n];if(!a)a=e.handlers[n]={};if(i)if(a=e.handlers[i],!a)a=e.handlers[i]=[];return a}function Wt(e,t,i,n){var a=_t(e,t,i),o=[];if(!a.length)vt(e,t,i);for(var s=0,r=n.length;r>s;s++){var l=n[s],h=Lt(l.handler,l.matchFn);a.push(h),o.push(h)}return o}function Xt(e,t,i,n){for(var a=_t(e,t,i),o=0,s=n.length;s>o;o++)for(var r=n[o],l=0,h=a.length;h>l;l++)if(a[l]==r)a.splice(l,1),l--;if(!a.length)Kt(e,t,i)}function wt(e,t,i){return function(n){for(var n=n||window.event,a=n.target;a;){if(1===a.nodeType)for(var o=t.length-1;o>=0;o--){var s=t[o];if(!s.matchFn||s.matchFn(a))s.handler.call(i,a,n)}if(a==e)break;a=a.parentNode}}}function vt(e,t,i){var n=_t(e,t,i);St.addDOMEvent(e,t,i,wt(t,n,e))}function Kt(e,t,i){St.removeDOMEvent(e,t,i)}function It(e){var t=St.getPartClasses,i=t(e,"row")[0],n=t(e,"hcell")[0],a=t(e,"select-all")[0],o=t(e,"multi-select")[0],s=t(e,"single-select")[0];Wt(e,e.main,"mouseover",[{handler:it,matchFn:i},{handler:J,matchFn:n}]),Wt(e,e.main,"mouseout",[{handler:nt,matchFn:i},{handler:E,matchFn:n}]),Wt(e,e.main,"click",[{handler:at,matchFn:i},{handler:A,matchFn:n},{handler:ct,matchFn:a},{handler:Vt,matchFn:o},{handler:yt,matchFn:s}])}var Ct=require("./lib"),Jt=require("underscore"),St=require("./controlHelper"),Et=require("./Control");e.defaultProperties={noDataHtml:"没有数据",noFollowHeadCache:!1,followHead:!1,sortable:!1,encode:!1,columnResizable:!1,rowWidthOffset:-1,select:"",selectMode:"box",subrowMutex:1,subEntryOpenTip:"点击展开",subEntryCloseTip:"点击收起",subEntryWidth:18,breakLine:!1,hasTip:!1,hasSubrow:!1,tipWidth:18,sortWidth:9,fontSize:13,colPadding:8,zIndex:0};var Tt='<table cellpadding="0" cellspacing="0" width="${width}" data-control-table="${controlTableId}">',At='<div class="${className}"></div>',Pt='<div id="${id}" class="${className}" data-ui="type:Tip;id:${id};content:${content}"></div>',Ft='<div class="${className}">${html}</div>',Ot='<div id="${id}" class="${className}" data-index="${index}" ${attr}>',Mt='<span id="${colTextId}">${content}</span>',Dt='<input type="checkbox" id="${id}" class="${className}" data-index="${index}" ${disabled}/>',zt='<input type="checkbox" id="${id}" class="${className}" data-index="${index}" ${disabled} ${checked} />',Nt='<input type="radio" id="${id}" name="${name}" class="${className}" data-index="${index}" ${disabled} ${checked} />',Bt=/[\t\r\n]/g;return e.prototype={type:"Table",initOptions:function(t){var i={};Jt.extend(i,e.defaultProperties,t),this.setProperties(i)},initStructure:function(){if(this.realWidth=c(this),this.realWidth)this.main.style.width=this.realWidth+"px";bt(this),j(this),ot(this),It(this)},repaint:function(t,i){Et.prototype.repaint.apply(this,arguments);var n=this;if(!n.realWidth)if(n.realWidth=c(n),n.realWidth)n.main.style.width=n.realWidth+"px";var a=e.defaultProperties,o={};if(!t){for(var s in a)if(a.hasOwnProperty(s))o[s]=!0}else for(var r=0;r<t.length;r++){var l=t[r];o[l.name]=!0}var h=!1,m=!1,d=!1;if(o.fields||o.select||o.selectMode||o.sortable)u(n),h=!0;if(h||o.breakLine||o.colPadding||o.fontSize)L(n),_(n),m=!0;if(h||m||o.noHead||o.order||o.orderBy||o.selectedIndex)w(n);if(o.followHead||o.noFollowHeadCache)f(n),lt(n);if(h||m||o.encode||o.noDataHtml||o.datasource||o.selectedIndex)G(n),d=!0;if(d||o.bodyMaxHeight)Y(n);if(h||m||o.foot)W(n);if(n.extraRepaint=St.createRepaint([{name:"disabled",paint:kt},{name:"width",paint:st},{name:"zIndex",paint:bt}]),n.extraRepaint(t,i),d&&St.isInStage(n,"RENDERED"))switch(n.select){case"multi":U(n,[]),n.fire("select",{selectedIndex:n.selectedIndex})}if(n.realWidth!=c(n))st(n)},getId:function(e){return s(this,e)},getBodyCellId:function(e,t){return q(this,e,t)},setCellText:function(e,t,n,a){if(a)e=Ct.encodeHTML(e);e=i(e)?"&nbsp":e,Ct.g(s(this,"cell-textfield-"+t+"-"+n)).innerHTML=e},getClass:function(e){return r(this,e)},getRow:function(e){return d(this,e)},addRowBuilders:function(e){Z(this,e)},addHandlers:function(e,t){if(!t.length)t=[t];return Wt(this,this.main,e,t)},removeHandlers:function(e,t){if(!t.length)t=[t];Xt(this,this.main,e,t)},adjustWidth:function(){st(this)},setDatasource:function(e){this.datasource=e,U(this,[]);var t={name:"datasource"},i={name:"selectedIndex"};this.repaint([t,i],{datasource:t,selectedIndex:i})},updateRowAt:function(e,t){t&&(this.datasource[e]=t);var i=this.datasource[e],n=d(this,e);if(i&&n){this.fire("beforerowupdate",{index:e,data:i});var a=document.createElement("div");a.innerHTML=$(this,t,e,this.rowBuilderList);var o=a.children[0];n.parentNode.replaceChild(o,n),this.fire("afterrowupdate",{index:e,data:i})}},getSelectedItems:function(){var e=this.selectedIndex,t=[];if(e){var i=this.datasource;if(i)for(var n=0;n<e.length;n++)t.push(i[e[n]])}return t},setRowSelected:function(e,t){var i=this,n="multi"===i.select,a=n?Ut:gt;if(Jt.isArray(e))if(n)Jt.each(e,function(e){a(i,e,t)});else a(i,e[0],t);else a(i,e,t);if(n)pt(i)},setAllRowSelected:function(e){this.setRowSelected(-1,e)},resetFollowHead:function(){y(this)},dispose:function(){if(!St.isInStage(this,"DISPOSED")){St.beforeDispose(this);var e=this.main;if(e){this.followDoms=null;var t=Ct.g(s(this,"drag-mark"));if(t)document.body.removeChild(t)}this.rowBuilderList=null,this.headPanel.disposeChildren(),this.bodyPanel.disposeChildren(),this.headPanel=null,this.bodyPanel=null,St.dispose(this),St.afterDispose(this)}}},Ct.inherits(e,Et),require("./main").register(e),e});