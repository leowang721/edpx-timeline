/*! @2014 Leo Wang. All Rights Reserved */
define("esui/TipLayer",["require","./Button","./Label","./Panel","./lib","./controlHelper","./Control","./main","./painters"],function(require){function e(){m.apply(this,arguments)}function t(e){var t=e.main;if(t){for(var i,n=l.getChildren(t),a=n.length,o={};a--;)if(i=n[a].getAttribute("data-role"))o[i]=n[a];e.roles=o}}function i(e,t){if(t)e.title=t.innerHTML;else if(t=document.createElement("h3"),e.main.firstChild)l.insertBefore(t,e.main.firstChild);else e.main.appendChild(t);var i=[].concat(h.getPartClasses(e,"title"));l.addClasses(t,i);var n={main:t,childName:"title"},a=d.create("Label",n);return a.render(),e.addChild(a),a}function n(e,t,i){if(i)e.content=i.innerHTML;else if(i=document.createElement("div"),"body"==t){var n=e.getChild("title");if(n)l.insertAfter(i,n.main);else if(e.main.firstChild)l.insertBefore(i,n,e.main.firstChild);else e.main.appendChild(i)}else e.main.appendChild(i);l.addClasses(i,h.getPartClasses(e,t+"-panel"));var a={main:i,renderOptions:e.renderOptions},o=d.create("Panel",a);return o.render(),e.addChild(o,t),o}function a(e,t,i){if(e.isShow)e.autoPosition(t,i)}function o(e,t,i,n){if(t)clearTimeout(e.showTimeout),clearTimeout(e.hideTimeout),e.showTimeout=setTimeout(l.bind(e.show,e,i,n),t);else e.show(i,n)}function r(e,t){clearTimeout(e.showTimeout),clearTimeout(e.hideTimeout),e.hideTimeout=setTimeout(l.bind(e.hide,e),t)}function s(e,t){if("string"==typeof t)t=e.viewContext.get(t);return t.main}require("./Button"),require("./Label"),require("./Panel");var l=require("./lib"),h=require("./controlHelper"),m=require("./Control"),d=require("./main"),V=require("./painters");return e.prototype={type:"TipLayer",initOptions:function(e){t(e);var i={roles:{}};l.extend(i,e),this.setProperties(i)},initStructure:function(){var e=this.main;if(e.parentNode&&"body"!==e.parentNode.nodeName.toLowerCase())document.body.appendChild(e);if(this.main.style.left="-10000px",this.title||this.roles.title)i(this,this.roles.title);if(n(this,"body",this.roles.content),this.foot||this.roles.foot)n(this,"foot",this.roles.foot);if(this.arrow){var t=document.createElement("div");t.id=h.getId(this,"arrow"),t.className=h.getPartClasses(this,"arrow").join(" "),this.main.appendChild(t)}},repaint:h.createRepaint(m.prototype.repaint,V.style("width"),{name:"title",paint:function(e,t){var n=e.getHead();if(null==t){if(n)e.removeChild(n)}else{if(!n)n=i(e);n.setText(t)}}},{name:"content",paint:function(e,t){var i='<div class="${class}" id="${id}">${content}</div>',n=e.getBody(),a=h.getId(e,"body"),o=h.getPartClasses(e,"body"),r={"class":o.join(" "),id:a,content:t};n.setContent(l.format(i,r))}},{name:"foot",paint:function(e,t){var i='<div class="${class}" id="${id}">${content}</div>',a=h.getId(e,"foot"),o=h.getPartClasses(e,"foot"),r=e.getFoot();if(null==t){if(r)e.removeChild(r)}else{var s={"class":o.join(" "),id:a,content:t};if(!r)r=n(e,"foot");r.setContent(l.format(i,s))}}},{name:["targetDOM","targetControl","showMode","positionOpt","delayTime"],paint:function(e,t,i,n,a,o){var r={targetDOM:t,targetControl:i,showMode:n,delayTime:o};if(a)a=a.split("|"),r.positionOpt={top:a[0]||"top",right:a[1]||"left"};e.attachTo(r)}}),autoPosition:function(e,t){var i=this,n=this.main;t=t||{left:"right",top:"top"};var a=e.getBoundingClientRect(),o=l.getOffset(e),r={top:a.top,right:a.right,bottom:a.bottom,left:a.left,width:a.right-a.left,height:a.bottom-a.top},s=n.style.display;n.style.display="block";var m=n.offsetHeight,d=n.offsetWidth;n.style.display="none";var V=l.clone(t),p=l.page.getViewWidth(),U=l.page.getViewHeight(),c=r.left-d,u=p-r.right-d,f=U-r.top-m,y=r.bottom-m;if(c>=0)if(u>=0){if(!V.right&&!V.left)if(c>u)V.left="right",V.right=null;else V.right="left",V.left=null}else V.left="right",V.right=null;else V.right="left",V.left=null;if(f>=0)if(y>=0){if(!V.bottom&&!V.top)if(f>y)V.top="top",V.bottom=null;else V.bottom="bottom",V.top=null}else V.top="top",V.bottom=null;else V.bottom="bottom",V.top=null;var g,b={};if(V.right)if(b.left=o.right,V.top)g="lt";else g="lb";else if(V.left)if(b.left=o.left-d,V.top)g="rt";else g="rb";if(V.top)b.top=o.top;else if(V.bottom)b.top=o.bottom-m;n.style.display=s,n.className=""+h.getPartClasses(i).join(" ")+" "+h.getPartClasses(i,g).join(" ");var k=l.g(h.getId(i,"arrow"));if(k)k.className=""+h.getPartClasses(i,"arrow").join(" ")+" "+h.getPartClasses(i,"arrow-"+g).join(" ");i.renderLayer(n,b)},renderLayer:function(e,t){var i=l.clone(t||{});if(i.hasOwnProperty("top")&&i.hasOwnProperty("bottom"))i.height=i.bottom-i.top,delete i.bottom;if(i.hasOwnProperty("left")&&i.hasOwnProperty("right"))i.width=i.right-i.left,delete i.right;if(i.hasOwnProperty("top")||i.hasOwnProperty("bottom"))e.style.top="",e.style.bottom="";if(i.hasOwnProperty("left")||i.hasOwnProperty("right"))e.style.left="",e.style.right="";for(var n in i)if(i.hasOwnProperty(n))e.style[n]=i[n]+"px"},attachTo:function(e){var t,i,n=e.showMode||"over";if("over"===n)t="mouseover",i="mouseout";else if("click"===n)t="click",i="click";var a;if(e.targetDOM)a=l.g(e.targetDOM);else if(e.targetControl)a=s(this,e.targetControl);if(a){if("auto"===n)this.show(a,e);else h.addDOMEvent(this,a,t,l.curry(o,this,e.delayTime,a,e.positionOpt)),h.addDOMEvent(this,this.main,"mouseover",l.bind(this.show,this,a,e.positionOpt)),h.addDOMEvent(this,this.main,"mouseout",l.curry(r,this,150));if("mouseout"===i)h.addDOMEvent(this,a,i,l.curry(r,this,150))}},getHead:function(){return this.getChild("title")},getBody:function(){return this.getChild("body")},getFoot:function(){return this.getChild("foot")},show:function(e,t){if(h.isInStage(this,"INITED"))this.render();else if(h.isInStage(this,"DISPOSED"))return;clearTimeout(this.hideTimeout),h.addDOMEvent(this,window,"resize",l.curry(a,this,e,t)),this.main.style.zIndex=h.layer.getZIndex(e),this.removeState("hidden"),this.autoPosition(e,t),this.fire("show"),this.isShow=!0},hide:function(){if(this.isShow)this.addState("hidden");this.fire("hide"),this.isShow=!1},setTitle:function(e){this.setProperties({title:e})},setContent:function(e){this.setProperties({content:e})},setFoot:function(e){this.setProperties({foot:e})},dispose:function(){if(!h.isInStage(this,"DISPOSED")){this.hide();var e=this.main.id;l.removeNode(e),m.prototype.dispose.apply(this,arguments)}}},e.onceNotice=function(e){function t(e){var t=e.onok,i="function"==typeof t;if(i)t(e);e.fire("ok"),e.dispose()}var i="tipLayer-once-notice",n="tipLayer-notice-ok",a=l.encodeHTML(e.content)||"",o={type:"onceNotice",skin:"onceNotice",arrow:!0};l.extend(o,e);var r=document.createElement("div");document.body.appendChild(r);var s=h.getGUID(i);o.id=s,o.main=r,o.type=null;var m=d.create("TipLayer",o);m.setContent(a);var V=e.okText||"知道了";m.setFoot('<div data-ui="type:Button;childName:okBtn;id:'+s+"-"+n+';width:50;"class="'+h.getPartClasses(m,"once-notice")+'">'+V+"</div>"),m.render();var p=m.getFoot().getChild("okBtn");return p.on("click",l.curry(t,m,"ok")),m.attachTo({targetDOM:e.targetDOM,targetControl:e.targetControl,showMode:"auto",positionOpt:{top:"top",right:"left"}}),m},l.inherits(e,m),d.register(e),e});