/*! @2014 Leo Wang. All Rights Reserved */
define("esui/Form",["require","underscore","./lib","./main","./Panel"],function(require){function e(e){this.length=e.length;for(var t=0;t<e.length;t++)this[t]=e[t]}function t(e,t){for(var n={},i=0;i<e.length;i++){var a=e[i];if("check"!==a.getCategory()||a.isChecked())if(!a.isDisabled()){var o=a.get("name"),s=t(a);if(n.hasOwnProperty(o))n[o]=[].concat(n[o],s);else n[o]=s}else;else;}return n}function n(){r.apply(this,arguments)}function i(e){var t=e.getCategory();return"input"===t||"check"===t}var a=require("underscore"),o=require("./lib"),s=require("./main"),r=require("./Panel");return e.prototype.splice=Array.prototype.splice,e.prototype.getData=function(){return t(this,function(e){return e.getRawValue()})},e.prototype.getDataAsString=function(){var e=t(this,function(e){var t=e.getValue();return encodeURIComponent(t)}),n="";return a.each(e,function(e,t){n+=encodeURIComponent(t)+"="+e}),n},e.prototype.getValueAsString=function(e){var t=this.getData(),n=t[e],i=n?"string"==typeof n?n:n.join(","):"";return i},e.prototype.checkAll=function(){for(var e=0;e<this.length;e++){var t=this[e];if("check"===t.getCategory())t.setChecked(!0)}},e.prototype.uncheckAll=function(){for(var e=0;e<this.length;e++){var t=this[e];if("check"===t.getCategory())t.setChecked(!1)}},e.prototype.checkInverse=function(){for(var e=0;e<this.length;e++){var t=this[e];if("check"===t.getCategory())t.setChecked(!t.isChecked())}},e.prototype.checkByValue=function(e){for(var t=o.toDictionary(e),n=0;n<this.length;n++){var i=this[n];if("check"===i.getCategory()){var a=t.hasOwnProperty(i.getValue());i.setChecked(a)}}},n.defaultProperties={autoValidate:!1},n.prototype.type="Form",n.prototype.validateAndSubmit=function(){var e=this.fire("beforevalidate");if(!e.isDefaultPrevented())try{var t=this.get("autoValidate")?this.validate():!0,e=this.fire("aftervalidate",{isValid:t});if(e.isDefaultPrevented())return;var n={triggerSource:this};if(t)this.fire("submit",n);else this.fire("invalid",n)}catch(i){this.fire("submitfail",{error:i})}},n.prototype.initEvents=function(){if("form"===this.main.nodeName.toLowerCase())this.helper.addDOMEvent(this.main,"submit",function(e){return this.validateAndSubmit(),e.preventDefault(),!1})},n.prototype.createMain=function(e){var t=document.createElement("form");return t.method="POST",t.action=e.action||"",t},n.prototype.initOptions=function(e){var t=a.extend({},n.defaultProperties,e);if("form"===this.main.nodeName.toLowerCase())t.action=this.main.getAttribute("action"),t.method=this.main.getAttribute("method");else t.method=this.method||"POST";if("false"===e.autoValidate)t.autoValidate=!1;else t.autoValidate=!!t.autoValidate;r.prototype.initOptions.call(this,t)},n.prototype.getInputControls=function(t,n){function a(e,r){for(var l=r.children,h=l.length,V=0;h>V;V++){var U=l[V];if(1===U.nodeType){var m=s.getControlByDOM(U);if(m&&i(m)&&m.viewContext===e.viewContext&&m.get("name")&&(!t||m.get("name")===t)&&(!n||m.get("type")===n))o.push(m);else a(e,U)}else;}}var o=[];return a(this,this.main),new e(o)},n.prototype.getData=function(){var e=this.getInputControls();return e.getData()},n.prototype.getDataAsString=function(){var e=this.getInputControls();return e.getDataAsString()},n.prototype.validate=function(){for(var e=this.getInputControls(),t=!0,n=0;n<e.length;n++){var i=e[n];if(!i.isDisabled())t&=i.validate();else;}return!!t},n.prototype.repaint=function(e,t){r.prototype.repaint.apply(this,arguments);var n=!1;if(!t&&this.submitButton)n=!0;if(t&&t.hasOwnProperty("submitButton")){var i=t.submitButton;if(i.oldValue){for(var a=0;a<i.oldValue.length;a++){var o=this.viewContext.get(i.oldValue[a]);if(o)o.un("click",this.validateAndSubmit,this)}n=!!this.submitButton}}if(n)for(var a=0;a<this.submitButton.length;a++){var s=this.viewContext.get(this.submitButton[a]);if(s)s.on("click",this.validateAndSubmit,this)}},n.prototype.setProperties=function(e){e=a.clone(e),e.submitButton=o.splitTokenList(e.submitButton),r.prototype.setProperties.call(this,e)},o.inherits(n,r),s.register(n),n});