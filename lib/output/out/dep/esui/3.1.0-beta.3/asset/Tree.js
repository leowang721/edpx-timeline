/*! @2014 Leo Wang. All Rights Reserved */
define("esui/Tree",["require","./Control","./lib","./controlHelper","./TreeStrategy","./main"],function(require){function e(){u.apply(this,arguments)}function t(){p.apply(this,arguments)}function i(e,t,i,n,a){var o=a-n,r=0===o?"current":1===o?"previous":"far-previous",s=[].concat(c.getPartClasses(e,"node-indicator"),c.getPartClasses(e,"node-indicator-"+i),c.getPartClasses(e,"node-indicator-level-"+n),c.getPartClasses(e,"node-indicator-"+r)),l=0===o?f[i||"collapsed"]:"第"+n+"级",h="<span ";if(0===o)h+='id="'+c.getId(e,"indicator-"+t.id)+'" ';return h+='class="'+s.join(" ")+'">'+l+"</span>"}function n(e,t,n,a){var r=c.getPartClasses(e,"content-wrapper");if(e.selectedNodeIndex[t.id])r=r.concat(c.getPartClasses(e,"content-wrapper-selected"));r=r.join(" ");for(var s=c.getId(e,"content-wrapper-"+t.id),l='<div id="'+s+'" class="'+r+'">',h=e.strategy.isLeafNode(t)?"empty":a?"expanded":"collapsed",m=0;n>=m;m++)l+=i(e,t,h,m,n);var d=c.getPartClasses(e,"item-content");if(l+='<div class="'+d.join(" ")+'">'+e.getItemHTML(t)+"</div>",l+="</div>",a&&!e.strategy.isLeafNode(t)){var V=[].concat(c.getPartClasses(e,"sub-root"),c.getPartClasses(e,"sub-root-"+h));l+='<ul class="'+V.join(" ")+'">';for(var m=0;m<t.children.length;m++){var p=t.children[m];l+=o(e,p,n+1,e.strategy.shouldExpand(p))}l+="</ul>"}return l}function a(e,t,i,n){var a=e.strategy.isLeafNode(t)?"empty":n?"expanded":"collapsed",o=[].concat(c.getPartClasses(e,"node"),c.getPartClasses(e,"node-"+a),c.getPartClasses(e,"node-level-"+i));if(t===e.datasource)o=[].concat(c.getPartClasses(e,"root"),c.getPartClasses(e,"root-"+a),o);return o}function o(e,t,i,o,r){r=r||"li";var s=a(e,t,i,o),l="<"+r+' class="'+s.join(" ")+'" id="'+c.getId(e,"node-"+t.id)+'" data-id="'+t.id+'" data-level="'+i+'">';return l+=n(e,t,i,o),l+="</"+r+">"}function r(e){var t=e.target,i=c.getPartClasses(this,"node-indicator")[0],n=U.hasClass(t,i),a=!n;if(!n){for(var o=c.getPartClasses(this,"content-wrapper")[0];t&&t!==this.main&&!U.hasClass(t,o);)t=t.parentNode;if(U.hasClass(t,o))n=this.wideToggleArea,a=a&&!0}if(n||a){for(;t&&t!==this.main&&!U.hasAttribute(t,"data-id");)t=t.parentNode;var r=t.getAttribute("data-id");if(n)this.triggerToggleStrategy(r);if(a)this.triggerSelectStrategy(r)}}function s(e,t){if(t=t||{},t[e.id]=e,e.children)for(var i=0;i<e.children.length;i++)s(e.children[i],t);return t}function l(e,t){if(e.selectedNodeIndex[t.id])return!1;else return e.selectedNodes.push(t),e.selectedNodeIndex[t.id]=t,!0}function h(e,t){if(e.selectedNodeIndex[t.id]){delete e.selectedNodeIndex[t.id];for(var i=0;i<e.selectedNodes.length;i++)if(e.selectedNodes[i]===t)e.selectedNodes.splice(i,1);return!0}return!1}function m(e,t,i){if(i.force||e.allowUnselectNode){var n=e.nodeIndex[t];if(n){var a=h(e,n);if(a){if(i.modifyDOM){var o=U.g(c.getId(e,"content-wrapper-"+t));c.removePartClasses(e,"content-wrapper-selected",o)}if(!i.silent)e.fire("unselectnode",{node:n}),e.fire("selectionchange")}}}}function d(e,t){var i=c.getPartClasses(e,"node-empty")[0];return U.hasClass(t,i)}function V(e,t){var i=c.getPartClasses(e,"node-expanded")[0];return U.hasClass(t,i)}var p=require("./Control"),U=require("./lib"),c=require("./controlHelper"),u=require("./TreeStrategy");e.prototype.attachTo=function(){},U.inherits(e,u),t.prototype.type="Tree",t.defaultProperties={selectMode:"single",hideRoot:!1},t.prototype.initOptions=function(i){var n={datasource:{},strategy:new e,selectedNodes:[],selectedNodeIndex:{}},a=U.extend(n,t.defaultProperties,i);if(null==a.allowUnselectNode)a.allowUnselectNode="single"!==a.selectMode;this.setProperties(a)},t.prototype.itemTemplate="<span>${text}</span>",t.prototype.getItemHTML=function(e){var t={id:U.encodeHTML(e.id),text:U.encodeHTML(e.text)};return U.format(this.itemTemplate,t)};var f={collapsed:"展开",expanded:"收起",busy:"加载中",empty:"无内容"};return t.prototype.clickNode=function(){r.apply(this,arguments)},t.prototype.initStructure=function(){this.strategy.attachTo(this)},t.prototype.initEvents=function(){c.addDOMEvent(this,this.main,"click",this.clickNode)},t.prototype.repaint=c.createRepaint(p.prototype.repaint,{name:"datasource",paint:function(e,t){e.selectedNodes=[],e.selectedNodeIndex={},e.nodeIndex=s(t),e.main.innerHTML=o(e,t,0,!0,"div")}},{name:"hideRoot",paint:function(e,t){var i=t?"addState":"removeState";e[i]("hide-root")}}),t.prototype.triggerSelectStrategy=function(e){var t=this.nodeIndex[e];if(t)if(this.selectedNodeIndex[e])this.fire("unselect",{node:t});else this.fire("select",{node:t})},t.prototype.getSelectedNodes=function(){return this.selectedNodes.slice()},t.prototype.toggleNodeSelection=function(e){var t=this.selectedNodeIndex[e]?"unselectNode":"selectNode";this[t](e)},t.prototype.selectNode=function(e,t){var i=this.nodeIndex[e];if(i){var n=l(this,i);if(n){if("single"===this.selectMode&&this.selectedNodes.length>1)m(this,this.selectedNodes[0].id,{force:!0,silent:!0,modifyDOM:!0});var a=U.g(c.getId(this,"content-wrapper-"+e));if(c.addPartClasses(this,"content-wrapper-selected",a),!t)this.fire("selectnode",{node:i}),this.fire("selectionchange")}}},t.prototype.unselectNode=function(e){m(this,e,{force:!0,silent:!1,modifyDOM:!0})},t.prototype.expandNode=function(e,t){var i=U.g(c.getId(this,"node-"+e));if(i){var o=+U.getAttribute(i,"data-level");if(t||"ul"!==i.lastChild.nodeName.toLowerCase()){var r=this.nodeIndex[e];if(!r)return;if(t){if(r.children)for(var l=0;l<r.children.length;l++)m(this,r.children[l].id,{force:!0,silent:!0,modifyDOM:!1}),this.nodeIndex[r.children[l].id]=void 0;r.children=t,s(r,this.nodeIndex)}i.innerHTML=n(this,r,o,!0)}else{var h=U.g(c.getId(this,"indicator-"+e));h.innerHTML=f.expanded;var d=[].concat(c.getPartClasses(this,"node-indicator"),c.getPartClasses(this,"node-indicator-level-"+o),c.getPartClasses(this,"node-indicator-current"),c.getPartClasses(this,"node-indicator-expanded"));h.className=d.join(" ");var V=[].concat(c.getPartClasses(this,"sub-root"),c.getPartClasses(this,"sub-root-expanded"));i.lastChild.className=V.join(" ")}var r=this.nodeIndex[e],p=a(this,r,o,!0);i.className=p.join(" ")}},t.prototype.collapseNode=function(e,t){var i=U.g(c.getId(this,"node-"+e));if(i){var n=this.nodeIndex[e],o=i.getElementsByTagName("ul")[0];if(o)if(t){if(o.parentNode.removeChild(o),n.children)for(var r=0;r<n.children.length;r++)m(this,n.children[r].id,{force:!0,silent:!1,modifyDOM:!1})}else{var s=[].concat(c.getPartClasses(this,"sub-root"),c.getPartClasses(this,"sub-root-collapsed"));o.className=s.join(" ")}var l=+U.getAttribute(i,"data-level"),h=a(this,n,l,!1);i.className=h.join(" ");var d=U.g(c.getId(this,"indicator-"+e)),V=[].concat(c.getPartClasses(this,"node-indicator"),c.getPartClasses(this,"node-indicator-level-"+l),c.getPartClasses(this,"node-indicator-current"),c.getPartClasses(this,"node-indicator-collapsed"));d.className=V.join(" "),d.innerHTML=f.collapsed}},t.prototype.toggleNode=function(e,t,i){if(this.nodeIndex[e]){var n=U.g(c.getId(this,"node-"+e));if(n)if(!d(this,n))if(V(this,n))this.collapseNode(e,i);else this.expandNode(e,t)}},t.prototype.triggerToggleStrategy=function(e){var t=this.nodeIndex[e];if(t){var i=U.g(c.getId(this,"node-"+e));if(i)if(!d(this,i))if(V(this,i))this.fire("collapse",{node:t});else this.fire("expand",{node:t})}},t.prototype.indicateNodeLoading=function(e){var t=U.g(c.getId(this,"node-"+e));if(t){for(var i=U.getChildren(t),n=0;!this.helper.isPart(i[n],"item-content");)n++;var a=i[n];a.innerHTML=f.busy;var o=[].concat(c.getPartClasses(this,"node-indicator"),c.getPartClasses(this,"node-indicator-level-"+n),c.getPartClasses(this,"node-indicator-current"),c.getPartClasses(this,"node-indicator-busy"));a.className=o.join(" ")}},t.prototype.dispose=function(){p.prototype.dispose.apply(this,arguments),this.nodeIndex=null,this.selectedNodes=null,this.selectedNodeIndex=null},require("./main").register(t),U.inherits(t,p),t});