/*! @2014 Leo Wang. All Rights Reserved */
define("esui/RichCalendar",["require","./Button","./MonthView","./TextBox","./lib","./controlHelper","./InputControl","./main","moment"],function(require){function e(){x.apply(this,arguments)}function t(e){for(var t=e.displayNum,n='<div id="${id}" class="${className}">${monthView}</div>',a=[],o=0;t>o;o++)a.push(g.format(n,{id:k.getId(e,"month-"+o),className:k.getPartClasses(e,"month-container"),monthView:i(e,o)}));return a.join("")}function i(e,t){var i='<div data-ui-type="MonthView" data-ui-child-name="${calName}" data-ui-mode="multi"></div>';return g.format(i,{calName:"monthView"+t})}function n(e){var t=e.layer;t.style.zIndex=k.layer.getZIndex(e.main),k.layer.attachTo(t,e.main,{top:"bottom",left:"left",spaceDetection:"both"}),k.removePartClasses(e,"layer-hidden",e.layer),e.addState("active")}function a(e){if(e.layer)k.addPartClasses(e,"layer-hidden",e.layer),e.removeState("active")}function o(e){for(var t=e.target||e.srcElement;t&&t!=document.body;){if(t==this.layer)return;var i=this.getChild("modifyBtn").main;if(t==i)return;t=t.parentNode}a(this)}function s(e){var i=e.layer;if(!i)i=k.layer.create("div"),k.addPartClasses(e,"layer",i),i.innerHTML=t(e),e.layer=i,a(e),document.body.appendChild(i),e.initChildren(i);h(e,!0),n(e)}function r(e,t){for(var i=this.getRawValue(),n=e.displayNum,a=0;n>a;a++)if(a!==t){var o=e.getChild("monthView"+a);o.setRawValueWithoutFireChange(i)}e.rawValue=i,V(e,i)}function l(e,t){for(var i=e.displayNum,n=new Date(this.year,this.month,1),a=0;i>a;a++)if(a!==t){var o=e.getChild("monthView"+a);o.un("changemonth"),o.un("changeyear");var s,r=t-a;if(r>0)s=_(n).subtract("month",r);else s=_(n).add("month",-r);o.setProperties({month:s.month()+1,year:s.year()}),o.on("changeyear",g.curry(l,e,a)),o.on("changemonth",g.curry(l,e,a))}}function h(e,t){for(var i=e.displayNum,n=e.startMonth,a=e.startYear,o=0;i>o;o++){var s,r,l,h=e.range.begin,V=e.range.end,U=h.getFullYear(),d=h.getMonth(),p=V.getFullYear(),c=V.getMonth();if(0===o)r=new Date(p,c-i+2,0),s={begin:e.range.begin,end:r};else if(o==i-1)l=new Date(U,d+i-1,1),s={begin:l,end:e.range.end};else l=new Date(U,d+o,1),r=new Date(p,c-i-o+2,0),s={begin:l,end:r};var u={year:a,month:n+o,rawValue:e.rawValue,range:e.range,viewRange:s};m(e,u,o,t)}}function m(e,t,i,n){var a=e.getChild("monthView"+i);if(a.setProperties(t),n===!0)a.on("change",g.curry(r,e,i)),a.on("changeyear",g.curry(l,e,i)),a.on("changemonth",g.curry(l,e,i))}function V(e,t){var i=k.getId(e,"param-value");g.g(i).value=e.stringifyValue(t);var n=e.getChild("textInput"),a=f(e,t);n.setProperties({rawValue:a}),U(e,t),e.fire("change")}function U(e,t){var i=g.g(k.getId(e,"total-num"));i.innerHTML=t.length}function d(e){e.set("rawValue",[])}function p(e){if(!e.disabled)if(!e.layer)s(e);else{var t=e.layer,i=k.getPartClasses(e,"layer-hidden");if(g.hasClass(t,i[0]))s(e);else a(e)}}function c(e){var t=e.split(",");if(1===t.length)t.push("2046-11-04");else if(""===t[0])t[0]="1983-09-03";else if(""===t[1])t[1]="2046-11-04";return{begin:u(t[0]),end:u(t[1])}}function u(e){function t(e){var t=e.split("-");if(t)return new Date(parseInt(t[0],10),parseInt(t[1],10)-1,parseInt(t[2],10));else return null}if(!e)return null;e+="";var i=e.split(" "),n=t(i[0]);if(i[1]){var a=i[1].split(":");n.setHours(a[0]),n.setMinutes(a[1]),n.setSeconds(a[2])}return n}function f(e,t){for(var i=[],n=[],a=0,o=864e5,s=0;s<t.length;s++)if(0===s)i.push(g.date.format(t[s],e.paramFormat)),n.push(t[s]),a++;else if(t[s]-t[s-1]>o){if(t[s-1]-n[a-1]!==0)i.push("至"),i.push(g.date.format(t[s-1],e.paramFormat)),n.push(t[s-1]),a++;i.push("\n"),i.push(g.date.format(t[s],e.paramFormat)),n.push(t[s]),a++}else if(s==t.length-1)i.push("至"),i.push(g.date.format(t[s],e.paramFormat));else continue;return i.join("")}function y(e){for(var t=this.getValue(),i=t.replace(/\n{2,}/g,"\n").split("\n"),n=[],a={},o=!1,s=0,r=i.length;r>s;s++){var l=g.trim(i[s]);if(0!==l.length&&!a[l]){a[l]=1;var h=l.split("至"),m=h[0],V=m;if(h.length>1)V=h[1];if(b(m)&&b(V))n.push(m),n.push(V);else o=!0}else;}var U=n.join(",");e.rawValue=e.parseValue(U),this.setProperties({rawValue:f(e,e.rawValue)}),e.fire("change")}function b(e){var t=/^(\d{4})(-)(\d{2})\2(\d{2})$/,i=e.match(t);if(null==i)return!1;var n=new Date(i[1],i[3]-1,i[4]),a=""+n.getFullYear()+i[2]+(n.getMonth()+1)+i[2]+n.getDate();return e=i[1]+i[2]+(i[3]-1+1)+i[2]+(i[4]-1+1),a==e}require("./Button"),require("./MonthView"),require("./TextBox");var g=require("./lib"),k=require("./controlHelper"),x=require("./InputControl"),L=require("./main"),_=require("moment");return e.prototype={type:"RichCalendar",initOptions:function(e){var t=new Date,i={now:t,range:{begin:new Date(1983,8,3),end:new Date(2046,10,4)},paramFormat:"YYYY-MM-DD",rawValue:[],displayNum:2,startYear:t.getFullYear(),startMonth:t.getMonth()+1};if(k.extractValueFromInput(this,e),e.range&&"string"==typeof e.range)e.range=c(e.range);g.extend(i,e),this.setProperties(i)},setProperties:function(e){if(null==e.rawValue||0===e.rawValue.length)if(e.value)e.rawValue=this.parseValue(e.value);if(e.rawValue&&e.rawValue.length){var t=e.rawValue[0];e.startYear=t.getFullYear(),e.startMonth=t.getMonth()+1}var i=x.prototype.setProperties.apply(this,arguments);return i},initStructure:function(){if(g.isInput(this.main))k.replaceMain(this);var e=['<div class="${className}" id="${id}">','<textarea data-ui-type="TextBox"',' data-ui-mode="textarea"',' data-ui-height="100"',' data-ui-child-name="textInput"></textarea>','<div data-ui-type="Panel" class="${generalPanelClass}"',' data-ui-child-name="generalPanel">','共<span id="${totalNumId}" ','class="${totalNumClass}"></span>天,','<span data-ui-type="Button" data-ui-skin="link"',' data-ui-child-name="deleteBtn">全部删除</span>',"</div>",'<div data-ui-type="Button" data-ui-skin="calendar"',' data-ui-child-name="modifyBtn">修改时间</div>',"</div>",'<input type="hidden" id="${inputId}" name="${name}"',' value="" />'],t=k.getPartClasses;this.main.innerHTML=g.format(e.join("\n"),{className:t(this,"text").join(" "),id:k.getId(this,"text"),name:this.name,inputId:k.getId(this,"param-value"),generalPanelClass:t(this,"general-info").join(" "),totalNumId:k.getId(this,"total-num"),totalNumClass:t(this,"total-num").join(" ")}),this.initChildren(this.main)},initEvents:function(){var e=this.getChild("modifyBtn");e.on("click",g.curry(p,this));var t=this.getChild("generalPanel").getChild("deleteBtn");t.on("click",g.curry(d,this));var i=this.getChild("textInput");i.on("blur",g.curry(y,this)),k.addDOMEvent(this,document,"mousedown",o)},repaint:k.createRepaint(x.prototype.repaint,{name:["rawValue","range"],paint:function(e,t,i){if(i){if("string"==typeof i)i=c(i);if(!i.begin)i.begin=new Date(1983,8,3);else if(!i.end)i.end=new Date(2046,10,4);e.range=i}if(t)V(e,t);if(e.layer)h(e)}},{name:["disabled","hidden","readOnly"],paint:function(e,t,i,n){if(t||i||n)a(e)}}),setRawValue:function(e){this.setProperties({rawValue:e})},getRawValue:function(){return this.rawValue},stringifyValue:function(e){for(var t=[],i=864e5,n=0;n<e.length;n++){if(0===n)t.push(g.date.format(e[n],this.paramFormat));else if(e[n]-e[n-1]>i)t.push(g.date.format(e[n-1],this.paramFormat)),t.push(g.date.format(e[n],this.paramFormat));if(n===e.length-1)t.push(g.date.format(e[n],this.paramFormat))}return t.join(",")},getRanges:function(){for(var e=this.rawValue,t=this.stringifyValue(e).split(","),i=[],n=0;n<t.length-1;n+=2){var a=u(t[n]),o=u(t[n+1]);i.push({begin:a,end:o})}return i},setRanges:function(e){for(var t={},i=0;i<e.length;i++){var n,a=e[i].begin,o=e[i].end;if(a&&o)if(a-o===0)t[a]=a;else for(n=a;o>=n;)t[n]=n,n=new Date(n.getFullYear(),n.getMonth(),n.getDate()+1);else;}var s=[];for(var r in t)s.push(t[r]);s.sort(function(e,t){return e-t}),this.set("rawValue",s)},parseValue:function(e){for(var t=e.split(","),i={},n=0;n<t.length-1;n+=2){var a,o=u(t[n]),s=u(t[n+1]);if(o&&s)if(o-s===0)i[o]=o;else for(a=o;s>=a;)i[a]=a,a=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1);else;}var r=[];for(var l in i)r.push(i[l]);return r.sort(function(e,t){return e-t}),r},dispose:function(){if(!k.isInStage(this,"DISPOSED")){var e=this.layer;if(e)e.parentNode.removeChild(e),this.layer=null;x.prototype.dispose.apply(this,arguments)}}},g.inherits(e,x),L.register(e),e});