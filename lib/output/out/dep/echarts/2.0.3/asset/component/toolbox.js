/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/component/toolbox",["require","./base","zrender/shape/Line","zrender/shape/Image","zrender/shape/Rectangle","../util/shape/Icon","../config","zrender/tool/util","zrender/config","zrender/tool/event","./dataView","../component"],function(require){function e(e,i,s,o,a){t.call(this,e,i,s,o,a),this.dom=a.dom,this._magicType={},this._magicMap={},this._isSilence=!1,this._iconList,this._iconShapeMap={},this._featureTitle={},this._featureIcon={},this._featureColor={},this._enableColor="red",this._disableColor="#ccc",this._markShapeList=[];var n=this;n._onMark=function(e){n.__onMark(e)},n._onMarkUndo=function(e){n.__onMarkUndo(e)},n._onMarkClear=function(e){n.__onMarkClear(e)},n._onDataZoom=function(e){n.__onDataZoom(e)},n._onDataZoomReset=function(e){n.__onDataZoomReset(e)},n._onDataView=function(e){n.__onDataView(e)},n._onRestore=function(e){n.__onRestore(e)},n._onSaveAsImage=function(e){n.__onSaveAsImage(e)},n._onMagicType=function(e){n.__onMagicType(e)},n._onCustomHandler=function(e){n.__onCustomHandler(e)},n._onmousemove=function(e){return n.__onmousemove(e)},n._onmousedown=function(e){return n.__onmousedown(e)},n._onmouseup=function(e){return n.__onmouseup(e)},n._onclick=function(e){return n.__onclick(e)}}var t=require("./base"),i=require("zrender/shape/Line"),s=require("zrender/shape/Image"),o=require("zrender/shape/Rectangle"),a=require("../util/shape/Icon"),n=require("../config"),h=require("zrender/tool/util"),r=require("zrender/config"),l=require("zrender/tool/event"),d="stack",p="tiled";return e.prototype={type:n.COMPONENT_TYPE_TOOLBOX,_buildShape:function(){this._iconList=[];var e=this.option.toolbox;this._enableColor=e.effectiveColor,this._disableColor=e.disableColor;var t=e.feature,i=[];for(var s in t)if(t[s].show)switch(s){case"mark":i.push({key:s,name:"mark"}),i.push({key:s,name:"markUndo"}),i.push({key:s,name:"markClear"});break;case"magicType":for(var o=0,a=t[s].type.length;a>o;o++)t[s].title[t[s].type[o]+"Chart"]=t[s].title[t[s].type[o]],i.push({key:s,name:t[s].type[o]+"Chart"});break;case"dataZoom":i.push({key:s,name:"dataZoom"}),i.push({key:s,name:"dataZoomReset"});break;case"saveAsImage":if(this.canvasSupported)i.push({key:s,name:"saveAsImage"});break;default:i.push({key:s,name:s})}if(i.length>0){for(var n,s,o=0,a=i.length;a>o;o++){if(n=i[o].name,s=i[o].key,this._iconList.push(n),this._featureTitle[n]=t[s].title[n]||t[s].title,t[s].icon)this._featureIcon[n]=t[s].icon[n]||t[s].icon;if(t[s].color)this._featureColor[n]=t[s].color[n]||t[s].color}this._itemGroupLocation=this._getItemGroupLocation(),this._buildBackground(),this._buildItem();for(var o=0,a=this.shapeList.length;a>o;o++)this.zr.addShape(this.shapeList[o]);if(this._iconShapeMap.mark)this._iconDisable(this._iconShapeMap.markUndo),this._iconDisable(this._iconShapeMap.markClear);if(this._iconShapeMap.dataZoomReset&&0===this._zoomQueue.length)this._iconDisable(this._iconShapeMap.dataZoomReset)}},_buildItem:function(){var e,t,i,o,n=this.option.toolbox,h=this._iconList.length,r=this._itemGroupLocation.x,l=this._itemGroupLocation.y,d=n.itemSize,p=n.itemGap,c=n.color instanceof Array?n.color:[n.color],f=this.getFont(n.textStyle);if("horizontal"==n.orient)t=this._itemGroupLocation.y/this.zr.getHeight()<.5?"bottom":"top",i=this._itemGroupLocation.x/this.zr.getWidth()<.5?"left":"right",o=this._itemGroupLocation.y/this.zr.getHeight()<.5?"top":"bottom";else t=this._itemGroupLocation.x/this.zr.getWidth()<.5?"right":"left";this._iconShapeMap={};for(var u=this,g=0;h>g;g++){if(e={type:"icon",zlevel:this._zlevelBase,style:{x:r,y:l,width:d,height:d,iconType:this._iconList[g],lineWidth:1,strokeColor:this._featureColor[this._iconList[g]]||c[g%c.length],brushType:"stroke"},highlightStyle:{lineWidth:1,text:n.showTitle?this._featureTitle[this._iconList[g]]:void 0,textFont:f,textPosition:t,strokeColor:this._featureColor[this._iconList[g]]||c[g%c.length]},hoverable:!0,clickable:!0},this._featureIcon[this._iconList[g]])e.style.image=this._featureIcon[this._iconList[g]].replace(new RegExp("^image:\\/\\/"),""),e.style.opacity=.8,e.highlightStyle.opacity=1,e.type="image";if("horizontal"==n.orient){if(0===g&&"left"==i)e.highlightStyle.textPosition="specific",e.highlightStyle.textAlign=i,e.highlightStyle.textBaseline=o,e.highlightStyle.textX=r,e.highlightStyle.textY="top"==o?l+d+10:l-10;if(g==h-1&&"right"==i)e.highlightStyle.textPosition="specific",e.highlightStyle.textAlign=i,e.highlightStyle.textBaseline=o,e.highlightStyle.textX=r+d,e.highlightStyle.textY="top"==o?l+d+10:l-10}switch(this._iconList[g]){case"mark":e.onclick=u._onMark;break;case"markUndo":e.onclick=u._onMarkUndo;break;case"markClear":e.onclick=u._onMarkClear;break;case"dataZoom":e.onclick=u._onDataZoom;break;case"dataZoomReset":e.onclick=u._onDataZoomReset;break;case"dataView":if(!this._dataView){var y=require("./dataView");this._dataView=new y(this.ecTheme,this.messageCenter,this.zr,this.option,this.myChart)}e.onclick=u._onDataView;break;case"restore":e.onclick=u._onRestore;break;case"saveAsImage":e.onclick=u._onSaveAsImage;break;default:if(this._iconList[g].match("Chart"))e._name=this._iconList[g].replace("Chart",""),e.onclick=u._onMagicType;else e.onclick=u._onCustomHandler}if("icon"==e.type)e=new a(e);else if("image"==e.type)e=new s(e);if(this.shapeList.push(e),this._iconShapeMap[this._iconList[g]]=e,"horizontal"==n.orient)r+=d+p;else l+=d+p}},_buildBackground:function(){var e=this.option.toolbox,t=e.padding[0],i=e.padding[1],s=e.padding[2],a=e.padding[3];this.shapeList.push(new o({zlevel:this._zlevelBase,hoverable:!1,style:{x:this._itemGroupLocation.x-a,y:this._itemGroupLocation.y-t,width:this._itemGroupLocation.width+a+i,height:this._itemGroupLocation.height+t+s,brushType:0===e.borderWidth?"fill":"both",color:e.backgroundColor,strokeColor:e.borderColor,lineWidth:e.borderWidth}}))},_getItemGroupLocation:function(){var e=this.option.toolbox,t=this._iconList.length,i=e.itemGap,s=e.itemSize,o=0,a=0;if("horizontal"==e.orient)o=(s+i)*t-i,a=s;else a=(s+i)*t-i,o=s;var n,h=this.zr.getWidth();switch(e.x){case"center":n=Math.floor((h-o)/2);break;case"left":n=e.padding[3]+e.borderWidth;break;case"right":n=h-o-e.padding[1]-e.borderWidth;break;default:n=e.x-0,n=isNaN(n)?0:n}var r,l=this.zr.getHeight();switch(e.y){case"top":r=e.padding[0]+e.borderWidth;break;case"bottom":r=l-a-e.padding[2]-e.borderWidth;break;case"center":r=Math.floor((l-a)/2);break;default:r=e.y-0,r=isNaN(r)?0:r}return{x:n,y:r,width:o,height:a}},__onmousemove:function(e){if(this._marking)this._markShape.style.xEnd=l.getX(e.event),this._markShape.style.yEnd=l.getY(e.event),this.zr.addHoverShape(this._markShape);if(this._zooming)this._zoomShape.style.width=l.getX(e.event)-this._zoomShape.style.x,this._zoomShape.style.height=l.getY(e.event)-this._zoomShape.style.y,this.zr.addHoverShape(this._zoomShape),this.dom.style.cursor="crosshair";if(this._zoomStart&&"pointer"!=this.dom.style.cursor&&"move"!=this.dom.style.cursor)this.dom.style.cursor="crosshair"},__onmousedown:function(e){if(!e.target){this._zooming=!0;var t=l.getX(e.event),i=l.getY(e.event),s=this.option.dataZoom||{};return this._zoomShape=new o({zlevel:this._zlevelBase,style:{x:t,y:i,width:1,height:1,brushType:"both"},highlightStyle:{lineWidth:2,color:s.fillerColor||n.dataZoom.fillerColor,strokeColor:s.handleColor||n.dataZoom.handleColor,brushType:"both"}}),this.zr.addHoverShape(this._zoomShape),!0}},__onmouseup:function(){if(!this._zoomShape||Math.abs(this._zoomShape.style.width)<10||Math.abs(this._zoomShape.style.height)<10)return this._zooming=!1,!0;if(this._zooming&&this.component.dataZoom){this._zooming=!1;var e=this.component.dataZoom.rectZoom(this._zoomShape.style);if(e)this._zoomQueue.push({start:e.start,end:e.end,start2:e.start2,end2:e.end2}),this._iconEnable(this._iconShapeMap.dataZoomReset),this.zr.refresh()}return!0},__onclick:function(e){if(!e.target)if(this._marking)this._marking=!1,this._markShapeList.push(this._markShape),this._iconEnable(this._iconShapeMap.markUndo),this._iconEnable(this._iconShapeMap.markClear),this.zr.addShape(this._markShape),this.zr.refresh();else if(this._markStart){this._marking=!0;var t=l.getX(e.event),s=l.getY(e.event);this._markShape=new i({zlevel:this._zlevelBase,style:{xStart:t,yStart:s,xEnd:t,yEnd:s,lineWidth:this.query(this.option,"toolbox.feature.mark.lineStyle.width"),strokeColor:this.query(this.option,"toolbox.feature.mark.lineStyle.color"),lineType:this.query(this.option,"toolbox.feature.mark.lineStyle.type")}}),this.zr.addHoverShape(this._markShape)}},__onMark:function(e){var t=e.target;if(this._marking||this._markStart)this._resetMark(),this.zr.refresh();else{this._resetZoom(),this.zr.modShape(t.id,{style:{strokeColor:this._enableColor}}),this.zr.refresh(),this._markStart=!0;var i=this;setTimeout(function(){i.zr&&i.zr.on(r.EVENT.CLICK,i._onclick)&&i.zr.on(r.EVENT.MOUSEMOVE,i._onmousemove)},10)}return!0},__onMarkUndo:function(){if(this._marking)this._marking=!1;else{var e=this._markShapeList.length;if(e>=1){var t=this._markShapeList[e-1];if(this.zr.delShape(t.id),this.zr.refresh(),this._markShapeList.pop(),1==e)this._iconDisable(this._iconShapeMap.markUndo),this._iconDisable(this._iconShapeMap.markClear)}}return!0},__onMarkClear:function(){if(this._marking)this._marking=!1;var e=this._markShapeList.length;if(e>0){for(;e--;)this.zr.delShape(this._markShapeList.pop().id);this._iconDisable(this._iconShapeMap.markUndo),this._iconDisable(this._iconShapeMap.markClear),this.zr.refresh()}return!0},__onDataZoom:function(e){var t=e.target;if(this._zooming||this._zoomStart)this._resetZoom(),this.zr.refresh(),this.dom.style.cursor="default";else{this._resetMark(),this.zr.modShape(t.id,{style:{strokeColor:this._enableColor}}),this.zr.refresh(),this._zoomStart=!0;var i=this;setTimeout(function(){i.zr&&i.zr.on(r.EVENT.MOUSEDOWN,i._onmousedown)&&i.zr.on(r.EVENT.MOUSEUP,i._onmouseup)&&i.zr.on(r.EVENT.MOUSEMOVE,i._onmousemove)},10),this.dom.style.cursor="crosshair"}return!0},__onDataZoomReset:function(){if(this._zooming)this._zooming=!1;if(this._zoomQueue.pop(),this._zoomQueue.length>0)this.component.dataZoom.absoluteZoom(this._zoomQueue[this._zoomQueue.length-1]);else this.component.dataZoom.rectZoom(),this._iconDisable(this._iconShapeMap.dataZoomReset),this.zr.refresh();return!0},_resetMark:function(){if(this._marking=!1,this._markStart){if(this._markStart=!1,this._iconShapeMap.mark)this.zr.modShape(this._iconShapeMap.mark.id,{style:{strokeColor:this._iconShapeMap.mark.highlightStyle.strokeColor}});this.zr.un(r.EVENT.CLICK,this._onclick),this.zr.un(r.EVENT.MOUSEMOVE,this._onmousemove)}},_resetZoom:function(){if(this._zooming=!1,this._zoomStart){if(this._zoomStart=!1,this._iconShapeMap.dataZoom)this.zr.modShape(this._iconShapeMap.dataZoom.id,{style:{strokeColor:this._iconShapeMap.dataZoom.highlightStyle.strokeColor}});this.zr.un(r.EVENT.MOUSEDOWN,this._onmousedown),this.zr.un(r.EVENT.MOUSEUP,this._onmouseup),this.zr.un(r.EVENT.MOUSEMOVE,this._onmousemove)}},_iconDisable:function(e){if("image"!=e.type)this.zr.modShape(e.id,{hoverable:!1,clickable:!1,style:{strokeColor:this._disableColor}});else this.zr.modShape(e.id,{hoverable:!1,clickable:!1,style:{opacity:.3}})},_iconEnable:function(e){if("image"!=e.type)this.zr.modShape(e.id,{hoverable:!0,clickable:!0,style:{strokeColor:e.highlightStyle.strokeColor}});else this.zr.modShape(e.id,{hoverable:!0,clickable:!0,style:{opacity:.8}})},__onDataView:function(){return this._dataView.show(this.option),!0},__onRestore:function(){return this._resetMark(),this._resetZoom(),this.messageCenter.dispatch(n.EVENT.RESTORE,null,null,this.myChart),!0},__onSaveAsImage:function(){var e=this.option.toolbox.feature.saveAsImage,t=e.type||"png";if("png"!=t&&"jpeg"!=t)t="png";var i;if(!this.myChart.isConnected())i=this.zr.toDataURL("image/"+t,this.option.backgroundColor&&"rgba(0,0,0,0)"==this.option.backgroundColor.replace(" ","")?"#fff":this.option.backgroundColor);else i=this.myChart.getConnectedDataURL(t);var s=document.createElement("div");s.id="__echarts_download_wrap__",s.style.cssText="position:fixed;z-index:99999;display:block;top:0;left:0;background-color:rgba(33,33,33,0.5);text-align:center;width:100%;height:100%;line-height:"+document.documentElement.clientHeight+"px;";var o=document.createElement("a");o.href=i,o.setAttribute("download",(e.name?e.name:this.option.title&&(this.option.title.text||this.option.title.subtext)?this.option.title.text||this.option.title.subtext:"ECharts")+"."+t),o.innerHTML='<img style="vertical-align:middle" src="'+i+'" title="'+(window.attachEvent&&-1===navigator.userAgent.indexOf("Opera")?"右键->图片另存为":e.lang?e.lang[0]:"点击保存")+'"/>',s.appendChild(o),document.body.appendChild(s),o=null,s=null,setTimeout(function(){var e=document.getElementById("__echarts_download_wrap__");if(e)e.onclick=function(){var e=document.getElementById("__echarts_download_wrap__");e.onclick=null,e.innerHTML="",document.body.removeChild(e),e=null},e=null},500)},__onMagicType:function(e){this._resetMark();var t=e.target._name;if(!this._magicType[t]){if(this._magicType[t]=!0,t==n.CHART_TYPE_LINE)this._magicType[n.CHART_TYPE_BAR]=!1;else if(t==n.CHART_TYPE_BAR)this._magicType[n.CHART_TYPE_LINE]=!1;if(t==d)this._magicType[p]=!1;else if(t==p)this._magicType[d]=!1;this.messageCenter.dispatch(n.EVENT.MAGIC_TYPE_CHANGED,e.event,{magicType:this._magicType},this.myChart)}return!0},setMagicType:function(e){this._resetMark(),this._magicType=e,!this._isSilence&&this.messageCenter.dispatch(n.EVENT.MAGIC_TYPE_CHANGED,null,{magicType:this._magicType},this.myChart)},__onCustomHandler:function(e){var t=e.target.style.iconType,i=this.option.toolbox.feature[t].onclick;if("function"==typeof i)i(this.option)},reset:function(e,t){if(t&&this.clear(),this.query(e,"toolbox.show")&&this.query(e,"toolbox.feature.magicType.show")){var i=e.toolbox.feature.magicType.type,s=i.length;for(this._magicMap={};s--;)this._magicMap[i[s]]=!0;s=e.series.length;for(var o,a;s--;){if(o=e.series[s].type,this._magicMap[o]){if(a=e.xAxis instanceof Array?e.xAxis[e.series[s].xAxisIndex||0]:e.xAxis,a&&"category"==(a.type||"category"))a.__boundaryGap="undefined"!=typeof a.boundaryGap?a.boundaryGap:!0;if(a=e.yAxis instanceof Array?e.yAxis[e.series[s].yAxisIndex||0]:e.yAxis,a&&"category"==a.type)a.__boundaryGap="undefined"!=typeof a.boundaryGap?a.boundaryGap:!0;e.series[s].__type=o,e.series[s].__itemStyle=h.clone(e.series[s].itemStyle||{})}if(this._magicMap[d]||this._magicMap[p])e.series[s].__stack=e.series[s].stack}}this._magicType=t?{}:this._magicType||{};for(var n in this._magicType)if(this._magicType[n]){this.option=e,this.getMagicOption();break}var r=e.dataZoom;if(r&&r.show){var l="undefined"!=typeof r.start&&r.start>=0&&r.start<=100?r.start:0,c="undefined"!=typeof r.end&&r.end>=0&&r.end<=100?r.end:100;if(l>c)l+=c,c=l-c,l-=c;this._zoomQueue=[{start:l,end:c,start2:0,end2:100}]}else this._zoomQueue=[]},getMagicOption:function(){var e;if(this._magicType[n.CHART_TYPE_LINE]||this._magicType[n.CHART_TYPE_BAR])for(var t=this._magicType[n.CHART_TYPE_LINE]?!1:!0,i=0,s=this.option.series.length;s>i;i++)if(this._magicMap[this.option.series[i].type]){if(this.option.series[i].type=this._magicType[n.CHART_TYPE_LINE]?n.CHART_TYPE_LINE:n.CHART_TYPE_BAR,this.option.series[i].itemStyle=h.clone(this.option.series[i].__itemStyle),e=this.option.xAxis instanceof Array?this.option.xAxis[this.option.series[i].xAxisIndex||0]:this.option.xAxis,e&&"category"==(e.type||"category"))e.boundaryGap=t?!0:e.__boundaryGap;if(e=this.option.yAxis instanceof Array?this.option.yAxis[this.option.series[i].yAxisIndex||0]:this.option.yAxis,e&&"category"==e.type)e.boundaryGap=t?!0:e.__boundaryGap}if(this._magicType[d]||this._magicType[p])for(var i=0,s=this.option.series.length;s>i;i++)if(this._magicType[d])this.option.series[i].stack="_ECHARTS_STACK_KENER_2014_";else if(this._magicType[p])this.option.series[i].stack=null;return this.option},silence:function(e){this._isSilence=e},resize:function(){if(this._resetMark(),this.clear(),this.option&&this.option.toolbox&&this.option.toolbox.show)this._buildShape();if(this._dataView)this._dataView.resize()},hideDataView:function(){if(this._dataView)this._dataView.hide()},clear:function(e){if(this.zr)if(this.zr.delShape(this.shapeList),this.shapeList=[],!e)this.zr.delShape(this._markShapeList),this._markShapeList=[]},dispose:function(){if(this._dataView)this._dataView.dispose(),this._dataView=null;this.clear(),this.shapeList=null,this._markShapeList=null},refresh:function(e){if(e){if(this._resetMark(),this._resetZoom(),e.toolbox=this.reformOption(e.toolbox),e.toolbox.padding=this.reformCssArray(e.toolbox.padding),this.option=e,this.clear(!0),e.toolbox.show)this._buildShape();this.hideDataView()}}},h.inherits(e,t),require("../component").define("toolbox",e),e});