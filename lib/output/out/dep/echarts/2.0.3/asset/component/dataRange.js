/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/component/dataRange",["require","./base","zrender/shape/Text","zrender/shape/Rectangle","../util/shape/HandlePolygon","../config","zrender/tool/util","zrender/tool/area","zrender/tool/color","../component"],function(require){function e(e,i,s,a,o){if("undefined"==typeof this.query(a,"dataRange.min")||"undefined"==typeof this.query(a,"dataRange.max"))return void console.error("option.dataRange.min or option.dataRange.max has not been defined.");t.call(this,e,i,s,a,o);var r=this;r._ondrift=function(e,t){return r.__ondrift(this,e,t)},r._ondragend=function(){return r.__ondragend()},r._dataRangeSelected=function(e){return r.__dataRangeSelected(e)},this._selectedMap={},this._range={},this.refresh(a)}var t=require("./base"),i=require("zrender/shape/Text"),s=require("zrender/shape/Rectangle"),a=require("../util/shape/HandlePolygon"),o=require("../config"),r=require("zrender/tool/util"),n=require("zrender/tool/area"),h=require("zrender/tool/color");return e.prototype={type:o.COMPONENT_TYPE_DATARANGE,_textGap:10,_buildShape:function(){if(this._itemGroupLocation=this._getItemGroupLocation(),this._buildBackground(),this.dataRangeOption.splitNumber<=0||this.dataRangeOption.calculable)this._buildGradient();else this._buildItem();for(var e=0,t=this.shapeList.length;t>e;e++)this.zr.addShape(this.shapeList[e]);this._syncShapeFromRange()},_buildItem:function(){var e,t,a,o,r=this._valueTextList,h=r.length,l=this.getFont(this.dataRangeOption.textStyle),d=this._itemGroupLocation.x,p=this._itemGroupLocation.y,c=this.dataRangeOption.itemWidth,f=this.dataRangeOption.itemHeight,g=this.dataRangeOption.itemGap,u=n.getTextHeight("国",l);if("vertical"==this.dataRangeOption.orient&&"right"==this.dataRangeOption.x)d=this._itemGroupLocation.x+this._itemGroupLocation.width-c;var y=!0;if(this.dataRangeOption.text)if(y=!1,this.dataRangeOption.text[0]){if(a=this._getTextShape(d,p,this.dataRangeOption.text[0]),"horizontal"==this.dataRangeOption.orient)d+=n.getTextWidth(this.dataRangeOption.text[0],l)+this._textGap;else p+=u+this._textGap,a.style.y+=u/2+this._textGap,a.style.textBaseline="bottom";this.shapeList.push(new i(a))}for(var m=0;h>m;m++){if(e=r[m],o=this.getColor((h-m)*this._gap+this.dataRangeOption.min),t=this._getItemShape(d,p,c,f,this._selectedMap[m]?o:"#ccc"),t._idx=m,t.onclick=this._dataRangeSelected,this.shapeList.push(new s(t)),y){if(a={zlevel:this._zlevelBase,style:{x:d+c+5,y:p,color:this._selectedMap[m]?this.dataRangeOption.textStyle.color:"#ccc",text:r[m],textFont:l,textBaseline:"top"},highlightStyle:{brushType:"fill"},clickable:!0},"vertical"==this.dataRangeOption.orient&&"right"==this.dataRangeOption.x)a.style.x-=c+10,a.style.textAlign="right";a._idx=m,a.onclick=this._dataRangeSelected,this.shapeList.push(new i(a))}if("horizontal"==this.dataRangeOption.orient)d+=c+(y?5:0)+(y?n.getTextWidth(e,l):0)+g;else p+=f+g}if(!y&&this.dataRangeOption.text[1]){if("horizontal"==this.dataRangeOption.orient)d=d-g+this._textGap;else p=p-g+this._textGap;if(a=this._getTextShape(d,p,this.dataRangeOption.text[1]),"horizontal"!=this.dataRangeOption.orient)a.style.y-=5,a.style.textBaseline="top";this.shapeList.push(new i(a))}},_buildGradient:function(){var e,t,a=this.getFont(this.dataRangeOption.textStyle),o=this._itemGroupLocation.x,r=this._itemGroupLocation.y,h=this.dataRangeOption.itemWidth,l=this.dataRangeOption.itemHeight,d=n.getTextHeight("国",a),p=!0;if(this.dataRangeOption.text)if(p=!1,this.dataRangeOption.text[0]){if(t=this._getTextShape(o,r,this.dataRangeOption.text[0]),"horizontal"==this.dataRangeOption.orient)o+=n.getTextWidth(this.dataRangeOption.text[0],a)+this._textGap;else r+=d+this._textGap,t.style.y+=d/2+this._textGap,t.style.textBaseline="bottom";this.shapeList.push(new i(t))}for(var c=require("zrender/tool/color"),f=1/(this.dataRangeOption.color.length-1),g=[],u=0,y=this.dataRangeOption.color.length;y>u;u++)g.push([u*f,this.dataRangeOption.color[u]]);if("horizontal"==this.dataRangeOption.orient)e={zlevel:this._zlevelBase,style:{x:o,y:r,width:10*h,height:l,color:c.getLinearGradient(o,r,o+10*h,r,g)},hoverable:!1},o+=10*h+this._textGap;else e={zlevel:this._zlevelBase,style:{x:o,y:r,width:h,height:10*l,color:c.getLinearGradient(o,r,o,r+10*l,g)},hoverable:!1},r+=10*l+this._textGap;if(this.shapeList.push(new s(e)),this.dataRangeOption.calculable)this._calculableLocation=e.style,this._buildFiller(),this._bulidMask(),this._bulidHandle();if(!p&&this.dataRangeOption.text[1])t=this._getTextShape(o,r,this.dataRangeOption.text[1]),this.shapeList.push(new i(t))},_buildFiller:function(){this._fillerShae={zlevel:this._zlevelBase+1,style:{x:this._calculableLocation.x,y:this._calculableLocation.y,width:this._calculableLocation.width,height:this._calculableLocation.height,color:"rgba(255,255,255,0)"},highlightStyle:{strokeColor:"rgba(255,255,255,0.5)",lineWidth:1},draggable:!0,ondrift:this._ondrift,ondragend:this._ondragend,_type:"filler"},this._fillerShae=new s(this._fillerShae),this.shapeList.push(this._fillerShae)},_bulidHandle:function(){var e,t,i,s,o,r,h,l,d=this._calculableLocation.x,p=this._calculableLocation.y,c=this._calculableLocation.width,f=this._calculableLocation.height,g=this.getFont(this.dataRangeOption.textStyle),u=n.getTextHeight("国",g),y=Math.max(n.getTextWidth(this._textFormat(this.dataRangeOption.max),g),n.getTextWidth(this._textFormat(this.dataRangeOption.min),g))+2;if("horizontal"==this.dataRangeOption.orient)if("bottom"!=this.dataRangeOption.y)e=[[d,p],[d,p+f+u],[d-u,p+f+u],[d-1,p+f],[d-1,p]],t=d-y/2-u,i=p+f+u/2+2,s={x:d-y-u,y:p+f,width:y+u,height:u},o=[[d+c,p],[d+c,p+f+u],[d+c+u,p+f+u],[d+c+1,p+f],[d+c+1,p]],r=d+c+y/2+u,h=i,l={x:d+c,y:p+f,width:y+u,height:u};else e=[[d,p+f],[d,p-u],[d-u,p-u],[d-1,p],[d-1,p+f]],t=d-y/2-u,i=p-u/2-2,s={x:d-y-u,y:p-u,width:y+u,height:u},o=[[d+c,p+f],[d+c,p-u],[d+c+u,p-u],[d+c+1,p],[d+c+1,p+f]],r=d+c+y/2+u,h=i,l={x:d+c,y:p-u,width:y+u,height:u};else if(y+=u,"right"!=this.dataRangeOption.x)e=[[d,p],[d+c+u,p],[d+c+u,p-u],[d+c,p-1],[d,p-1]],t=d+c+y/2+u/2,i=p-u/2,s={x:d+c,y:p-u,width:y+u,height:u},o=[[d,p+f],[d+c+u,p+f],[d+c+u,p+u+f],[d+c,p+1+f],[d,p+f+1]],r=t,h=p+f+u/2,l={x:d+c,y:p+f,width:y+u,height:u};else e=[[d+c,p],[d-u,p],[d-u,p-u],[d,p-1],[d+c,p-1]],t=d-y/2-u/2,i=p-u/2,s={x:d-y-u,y:p-u,width:y+u,height:u},o=[[d+c,p+f],[d-u,p+f],[d-u,p+u+f],[d,p+1+f],[d+c,p+f+1]],r=t,h=p+f+u/2,l={x:d-y-u,y:p+f,width:y+u,height:u};this._startShape={style:{pointList:e,text:this._textFormat(this.dataRangeOption.max),textX:t,textY:i,color:this.getColor(this.dataRangeOption.max),rect:s,x:e[0][0],y:e[0][1],_x:e[0][0],_y:e[0][1]}},this._startShape.highlightStyle={strokeColor:this._startShape.style.color,lineWidth:1},this._endShape={style:{pointList:o,text:this._textFormat(this.dataRangeOption.min),textX:r,textY:h,color:this.getColor(this.dataRangeOption.min),rect:l,x:o[0][0],y:o[0][1],_x:o[0][0],_y:o[0][1]}},this._endShape.highlightStyle={strokeColor:this._endShape.style.color,lineWidth:1},this._startShape.zlevel=this._endShape.zlevel=this._zlevelBase+1,this._startShape.draggable=this._endShape.draggable=!0,this._startShape.ondrift=this._endShape.ondrift=this._ondrift,this._startShape.ondragend=this._endShape.ondragend=this._ondragend,this._startShape.style.textColor=this._endShape.style.textColor=this.dataRangeOption.textStyle.color,this._startShape.style.textAlign=this._endShape.style.textAlign="center",this._startShape.style.textPosition=this._endShape.style.textPosition="specific",this._startShape.style.textBaseline=this._endShape.style.textBaseline="middle",this._startShape.style.width=this._endShape.style.width=0,this._startShape.style.height=this._endShape.style.height=0,this._startShape.style.textPosition=this._endShape.style.textPosition="specific",this._startShape=new a(this._startShape),this._endShape=new a(this._endShape),this.shapeList.push(this._startShape),this.shapeList.push(this._endShape)},_bulidMask:function(){var e=this._calculableLocation.x,t=this._calculableLocation.y,i=this._calculableLocation.width,a=this._calculableLocation.height;this._startMask={zlevel:this._zlevelBase+1,style:{x:e,y:t,width:"horizontal"==this.dataRangeOption.orient?0:i,height:"horizontal"==this.dataRangeOption.orient?a:0,color:"#ccc"},hoverable:!1},this._endMask={zlevel:this._zlevelBase+1,style:{x:"horizontal"==this.dataRangeOption.orient?e+i:e,y:"horizontal"==this.dataRangeOption.orient?t:t+a,width:"horizontal"==this.dataRangeOption.orient?0:i,height:"horizontal"==this.dataRangeOption.orient?a:0,color:"#ccc"},hoverable:!1},this._startMask=new s(this._startMask),this._endMask=new s(this._endMask),this.shapeList.push(this._startMask),this.shapeList.push(this._endMask)},_buildBackground:function(){var e=this.dataRangeOption.padding[0],t=this.dataRangeOption.padding[1],i=this.dataRangeOption.padding[2],a=this.dataRangeOption.padding[3];this.shapeList.push(new s({zlevel:this._zlevelBase,hoverable:!1,style:{x:this._itemGroupLocation.x-a,y:this._itemGroupLocation.y-e,width:this._itemGroupLocation.width+a+t,height:this._itemGroupLocation.height+e+i,brushType:0===this.dataRangeOption.borderWidth?"fill":"both",color:this.dataRangeOption.backgroundColor,strokeColor:this.dataRangeOption.borderColor,lineWidth:this.dataRangeOption.borderWidth}}))},_getItemGroupLocation:function(){var e=this._valueTextList,t=e.length,i=this.dataRangeOption.itemGap,s=this.dataRangeOption.itemWidth,a=this.dataRangeOption.itemHeight,o=0,r=0,h=this.getFont(this.dataRangeOption.textStyle),l=n.getTextHeight("国",h);if("horizontal"==this.dataRangeOption.orient){if(this.dataRangeOption.text||this.dataRangeOption.splitNumber<=0||this.dataRangeOption.calculable)o=(this.dataRangeOption.splitNumber<=0||this.dataRangeOption.calculable?10*s+i:t*(s+i))+(this.dataRangeOption.text&&"undefined"!=typeof this.dataRangeOption.text[0]?n.getTextWidth(this.dataRangeOption.text[0],h)+this._textGap:0)+(this.dataRangeOption.text&&"undefined"!=typeof this.dataRangeOption.text[1]?n.getTextWidth(this.dataRangeOption.text[1],h)+this._textGap:0);else{s+=5;for(var d=0;t>d;d++)o+=s+n.getTextWidth(e[d],h)+i}o-=i,r=Math.max(l,a)}else{var p;if(this.dataRangeOption.text||this.dataRangeOption.splitNumber<=0||this.dataRangeOption.calculable)r=(this.dataRangeOption.splitNumber<=0||this.dataRangeOption.calculable?10*a+i:t*(a+i))+(this.dataRangeOption.text&&"undefined"!=typeof this.dataRangeOption.text[0]?this._textGap+l:0)+(this.dataRangeOption.text&&"undefined"!=typeof this.dataRangeOption.text[1]?this._textGap+l:0),p=Math.max(n.getTextWidth(this.dataRangeOption.text&&this.dataRangeOption.text[0]||"",h),n.getTextWidth(this.dataRangeOption.text&&this.dataRangeOption.text[1]||"",h)),o=Math.max(s,p);else{r=(a+i)*t,s+=5,p=0;for(var d=0;t>d;d++)p=Math.max(p,n.getTextWidth(e[d],h));o=s+p}r-=i}var c,f=this.zr.getWidth();switch(this.dataRangeOption.x){case"center":c=Math.floor((f-o)/2);break;case"left":c=this.dataRangeOption.padding[3]+this.dataRangeOption.borderWidth;break;case"right":c=f-o-this.dataRangeOption.padding[1]-this.dataRangeOption.borderWidth;break;default:c=this.parsePercent(this.dataRangeOption.x,f),c=isNaN(c)?0:c}var g,u=this.zr.getHeight();switch(this.dataRangeOption.y){case"top":g=this.dataRangeOption.padding[0]+this.dataRangeOption.borderWidth;break;case"bottom":g=u-r-this.dataRangeOption.padding[2]-this.dataRangeOption.borderWidth;break;case"center":g=Math.floor((u-r)/2);break;default:g=this.parsePercent(this.dataRangeOption.y,u),g=isNaN(g)?0:g}if(this.dataRangeOption.calculable){var y=Math.max(n.getTextWidth(this.dataRangeOption.max,h),n.getTextWidth(this.dataRangeOption.min,h))+l;if("horizontal"==this.dataRangeOption.orient){if(y>c)c=y;if(c+o+y>f)c-=y}else{if(l>g)g=l;if(g+r+l>u)g-=l}}return{x:c,y:g,width:o,height:r}},_getTextShape:function(e,t,i){return{zlevel:this._zlevelBase,style:{x:"horizontal"==this.dataRangeOption.orient?e:this._itemGroupLocation.x+this._itemGroupLocation.width/2,y:"horizontal"==this.dataRangeOption.orient?this._itemGroupLocation.y+this._itemGroupLocation.height/2:t,color:this.dataRangeOption.textStyle.color,text:i,textFont:this.getFont(this.dataRangeOption.textStyle),textBaseline:"horizontal"==this.dataRangeOption.orient?"middle":"top",textAlign:"horizontal"==this.dataRangeOption.orient?"left":"center"},hoverable:!1}},_getItemShape:function(e,t,i,s,a){return{zlevel:this._zlevelBase,style:{x:e,y:t+1,width:i,height:s-2,color:a},highlightStyle:{strokeColor:a,lineWidth:1},clickable:!0}},__ondrift:function(e,t,i){var s=this._calculableLocation.x,a=this._calculableLocation.y,o=this._calculableLocation.width,r=this._calculableLocation.height;if("horizontal"==this.dataRangeOption.orient)if(e.style.x+t<=s)e.style.x=s;else if(e.style.x+t+e.style.width>=s+o)e.style.x=s+o-e.style.width;else e.style.x+=t;else if(e.style.y+i<=a)e.style.y=a;else if(e.style.y+i+e.style.height>=a+r)e.style.y=a+r-e.style.height;else e.style.y+=i;if("filler"==e._type)this._syncHandleShape();else this._syncFillerShape(e);if(this.dataRangeOption.realtime)this._syncData();return!0},__ondragend:function(){this.isDragend=!0},ondragend:function(e,t){if(this.isDragend&&e.target){if(!this.dataRangeOption.realtime&&this._syncData(),t.dragOut=!0,t.dragIn=!0,false)this.messageCenter.dispatch(o.EVENT.DATA_RANGE,null,{range:{start:this._range.end,end:this._range.start}},this.myChart);t.needRefresh=!1,this.isDragend=!1}},_syncShapeFromRange:function(){var e=this.dataRangeOption.range||{};if(this._range.end="undefined"!=typeof this._range.end?this._range.end:"undefined"!=typeof e.start?e.start:0,this._range.start="undefined"!=typeof this._range.start?this._range.start:"undefined"!=typeof e.end?e.end:100,100!=this._range.start||0!==this._range.end){if("horizontal"==this.dataRangeOption.orient){var t=this._fillerShae.style.width;this._fillerShae.style.x+=t*(100-this._range.start)/100,this._fillerShae.style.width=t*(this._range.start-this._range.end)/100}else{var i=this._fillerShae.style.height;this._fillerShae.style.y+=i*(100-this._range.start)/100,this._fillerShae.style.height=i*(this._range.start-this._range.end)/100}this.zr.modShape(this._fillerShae.id),this._syncHandleShape()}},_syncHandleShape:function(){var e=this._calculableLocation.x,t=this._calculableLocation.y,i=this._calculableLocation.width,s=this._calculableLocation.height;if("horizontal"==this.dataRangeOption.orient)this._startShape.style.x=this._fillerShae.style.x,this._startMask.style.width=this._startShape.style.x-e,this._endShape.style.x=this._fillerShae.style.x+this._fillerShae.style.width,this._endMask.style.x=this._endShape.style.x,this._endMask.style.width=e+i-this._endShape.style.x,this._range.start=Math.ceil(100-(this._startShape.style.x-e)/i*100),this._range.end=Math.floor(100-(this._endShape.style.x-e)/i*100);else this._startShape.style.y=this._fillerShae.style.y,this._startMask.style.height=this._startShape.style.y-t,this._endShape.style.y=this._fillerShae.style.y+this._fillerShae.style.height,this._endMask.style.y=this._endShape.style.y,this._endMask.style.height=t+s-this._endShape.style.y,this._range.start=Math.ceil(100-(this._startShape.style.y-t)/s*100),this._range.end=Math.floor(100-(this._endShape.style.y-t)/s*100);this._syncShape()},_syncFillerShape:function(e){var t,i,s=this._calculableLocation.x,a=this._calculableLocation.y,o=this._calculableLocation.width,r=this._calculableLocation.height;if("horizontal"==this.dataRangeOption.orient){if(t=this._startShape.style.x,i=this._endShape.style.x,e.id==this._startShape.id&&t>=i)i=t,this._endShape.style.x=t;else if(e.id==this._endShape.id&&t>=i)t=i,this._startShape.style.x=t;this._fillerShae.style.x=t,this._fillerShae.style.width=i-t,this._startMask.style.width=t-s,this._endMask.style.x=i,this._endMask.style.width=s+o-i,this._range.start=Math.ceil(100-(t-s)/o*100),this._range.end=Math.floor(100-(i-s)/o*100)}else{if(t=this._startShape.style.y,i=this._endShape.style.y,e.id==this._startShape.id&&t>=i)i=t,this._endShape.style.y=t;else if(e.id==this._endShape.id&&t>=i)t=i,this._startShape.style.y=t;this._fillerShae.style.y=t,this._fillerShae.style.height=i-t,this._startMask.style.height=t-a,this._endMask.style.y=i,this._endMask.style.height=a+r-i,this._range.start=Math.ceil(100-(t-a)/r*100),this._range.end=Math.floor(100-(i-a)/r*100)}this._syncShape()},_syncShape:function(){this._startShape.position=[this._startShape.style.x-this._startShape.style._x,this._startShape.style.y-this._startShape.style._y],this._startShape.style.text=this._textFormat(this._gap*this._range.start+this.dataRangeOption.min),this._startShape.style.color=this._startShape.highlightStyle.strokeColor=this.getColor(this._gap*this._range.start+this.dataRangeOption.min),this._endShape.position=[this._endShape.style.x-this._endShape.style._x,this._endShape.style.y-this._endShape.style._y],this._endShape.style.text=this._textFormat(this._gap*this._range.end+this.dataRangeOption.min),this._endShape.style.color=this._endShape.highlightStyle.strokeColor=this.getColor(this._gap*this._range.end+this.dataRangeOption.min),this.zr.modShape(this._startShape.id),this.zr.modShape(this._endShape.id),this.zr.modShape(this._startMask.id),this.zr.modShape(this._endMask.id),this.zr.modShape(this._fillerShae.id),this.zr.refresh()},_syncData:function(){if(this.dataRangeOption.realtime)this.messageCenter.dispatch(o.EVENT.DATA_RANGE,null,{range:{start:this._range.end,end:this._range.start}},this.myChart)},__dataRangeSelected:function(e){var t=e.target._idx;this._selectedMap[t]=!this._selectedMap[t],this.messageCenter.dispatch(o.EVENT.REFRESH,null,null,this.myChart)},_textFormat:function(e,t){if(e=e.toFixed(this.dataRangeOption.precision),t="undefined"!=typeof t?t.toFixed(this.dataRangeOption.precision):"",this.dataRangeOption.formatter)if("string"==typeof this.dataRangeOption.formatter)return this.dataRangeOption.formatter.replace("{value}",e).replace("{value2}",t);else if("function"==typeof this.dataRangeOption.formatter)return this.dataRangeOption.formatter.call(this.myChart,e,t);if(""!==t)return e+" - "+t;else return e},refresh:function(e){if(e){this.option=e,this.option.dataRange=this.reformOption(this.option.dataRange),this.option.dataRange.padding=this.reformCssArray(this.option.dataRange.padding),this.dataRangeOption=this.option.dataRange;var t=this.dataRangeOption.splitNumber<=0||this.dataRangeOption.calculable?100:this.dataRangeOption.splitNumber;if(this._colorList=h.getGradientColors(this.dataRangeOption.color,Math.max((t-this.dataRangeOption.color.length)/(this.dataRangeOption.color.length-1),0)+1),this._colorList.length>t){for(var i=this._colorList.length,s=[this._colorList[0]],a=i/(t-1),o=1;t-1>o;o++)s.push(this._colorList[Math.floor(o*a)]);s.push(this._colorList[i-1]),this._colorList=s}var r=this.dataRangeOption.precision;for(this._gap=(this.dataRangeOption.max-this.dataRangeOption.min)/t;this._gap.toFixed(r)-0!=this._gap&&5>r;)r++;this.dataRangeOption.precision=r,this._gap=((this.dataRangeOption.max-this.dataRangeOption.min)/t).toFixed(r)-0,this._valueTextList=[];for(var o=0;t>o;o++)this._selectedMap[o]=!0,this._valueTextList.unshift(this._textFormat(o*this._gap+this.dataRangeOption.min,(o+1)*this._gap+this.dataRangeOption.min))}this.clear(),this._buildShape()},getColor:function(e){if(isNaN(e))return null;if(e<this.dataRangeOption.min)e=this.dataRangeOption.min;else if(e>this.dataRangeOption.max)e=this.dataRangeOption.max;if(this.dataRangeOption.calculable)if(e-(this._gap*this._range.start+this.dataRangeOption.min)>5e-5||e-(this._gap*this._range.end+this.dataRangeOption.min)<-5e-5)return null;var t=this._colorList.length-Math.ceil((e-this.dataRangeOption.min)/(this.dataRangeOption.max-this.dataRangeOption.min)*this._colorList.length);if(t==this._colorList.length)t--;if(this._selectedMap[t])return this._colorList[t];else return null}},r.inherits(e,t),require("../component").define("dataRange",e),e});