/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/component/polar",["require","./base","zrender/shape/Text","zrender/shape/Line","zrender/shape/Polygon","zrender/shape/Circle","zrender/shape/Ring","../config","zrender/tool/util","../util/coordinates","../component"],function(require){function e(e,i,s,a,o){t.call(this,e,i,s,a,o),this.refresh(a)}var t=require("./base"),i=require("zrender/shape/Text"),s=require("zrender/shape/Line"),a=require("zrender/shape/Polygon"),o=require("zrender/shape/Circle"),n=require("zrender/shape/Ring"),h=require("../config"),r=require("zrender/tool/util"),l=require("../util/coordinates");return e.prototype={type:h.COMPONENT_TYPE_POLAR,_buildShape:function(){for(var e=0;e<this.polar.length;e++)this._index=e,this.reformOption(this.polar[e]),this._queryTarget=[this.polar[e],this.option],this._createVector(e),this._buildSpiderWeb(e),this._buildText(e),this._adjustIndicatorValue(e),this._addAxisLabel(e);for(var e=0;e<this.shapeList.length;e++)this.zr.addShape(this.shapeList[e])},_createVector:function(e){for(var t,i=this.polar[e],s=this.deepQuery(this._queryTarget,"indicator"),a=s.length,o=i.startAngle,n=2*Math.PI/a,h=this._getRadius(),r=i.__ecIndicator=[],d=0;a>d;d++)t=l.polar2cartesian(h,o*Math.PI/180+n*d),r.push({vector:[t[1],-t[0]]})},_getRadius:function(){var e=this.polar[this._index];return this.parsePercent(e.radius,Math.min(this.zr.getWidth(),this.zr.getHeight())/2)},_buildSpiderWeb:function(e){var t=this.polar[e],i=t.__ecIndicator,s=t.splitArea,a=t.splitLine,o=this.getCenter(e),n=t.splitNumber,h=a.lineStyle.color,r=a.lineStyle.width,l=a.show,d=this.deepQuery(this._queryTarget,"axisLine");this._addArea(i,n,o,s,h,r,l),d.show&&this._addLine(i,o,d)},_addAxisLabel:function(e){for(var t,s,a,o,s,n,h,l,d,p,c=this.polar[e],f=this.deepQuery(this._queryTarget,"indicator"),g=c.__ecIndicator,u=this.deepQuery(this._queryTarget,"splitNumber"),y=this.getCenter(e),m=this.deepQuery(this._queryTarget,"precision"),_=0;_<f.length;_++)if(t=this.deepQuery([f[_],c,this.option],"axisLabel"),t.show){if(a={},a.textFont=this.getFont(),a=r.merge(a,t),a.lineWidth=a.width,s=g[_].vector,n=g[_].value,l=_/f.length*2*Math.PI,d=t.offset||10,p=t.interval||0,!n)return;for(var x=1;u>=x;x+=p+1){if(o=r.merge({},a),h=x*(n.max-n.min)/u+n.min,m)h=h.toFixed(m);o.text=this.numAddCommas(h),o.x=x*s[0]/u+Math.cos(l)*d+y[0],o.y=x*s[1]/u+Math.sin(l)*d+y[1],this.shapeList.push(new i({zlevel:this._zlevelBase,style:o,draggable:!1,hoverable:!1}))}}},_buildText:function(e){for(var t,s,a,o,n,h,r,l=this.polar[e],d=l.__ecIndicator,p=this.deepQuery(this._queryTarget,"indicator"),c=this.getCenter(e),f=0,g=0,u=0;u<p.length;u++)if(o=this.deepQuery([p[u],l,this.option],"name"),o.show){if(r=this.deepQuery([o,l,this.option],"textStyle"),s={},s.textFont=this.getFont(r),s.color=r.color,"function"==typeof o.formatter)s.text=o.formatter.call(this.myChart,p[u].text,u);else if("string"==typeof o.formatter)s.text=o.formatter.replace("{value}",p[u].text);else s.text=p[u].text;if(d[u].text=s.text,t=d[u].vector,Math.round(t[0])>0)a="left";else if(Math.round(t[0])<0)a="right";else a="center";if(!o.margin)t=this._mapVector(t,c,1.2);else h=o.margin,f=t[0]>0?h:-h,g=t[1]>0?h:-h,f=0===t[0]?0:f,g=0===t[1]?0:g,t=this._mapVector(t,c,1);if(s.textAlign=a,s.x=t[0]+f,s.y=t[1]+g,o.rotate)n=[o.rotate/180*Math.PI,t[0],t[1]];else n=[0,0,0];this.shapeList.push(new i({zlevel:this._zlevelBase,style:s,draggable:!1,hoverable:!1,rotation:n}))}else;},getIndicatorText:function(e,t){return this.polar[e]&&this.polar[e].__ecIndicator[t]&&this.polar[e].__ecIndicator[t].text},getDropBox:function(e){var t,i,e=e||0,s=this.polar[e],a=this.getCenter(e),o=s.__ecIndicator,n=o.length,h=[],r=s.type;if("polygon"==r){for(var l=0;n>l;l++)t=o[l].vector,h.push(this._mapVector(t,a,1.2));i=this._getShape(h,"fill","rgba(0,0,0,0)","",1)}else if("circle"==r)i=this._getCircle("",1,1.2,a,"fill","rgba(0,0,0,0)");return i},_addArea:function(e,t,i,s,a,o,n){for(var h,r,l,d,p=this.deepQuery(this._queryTarget,"type"),c=0;t>c;c++){if(r=(t-c)/t,n){if("polygon"==p)d=this._getPointList(e,r,i),h=this._getShape(d,"stroke","",a,o);else if("circle"==p)h=this._getCircle(a,o,r,i,"stroke");this.shapeList.push(h)}if(s.show)l=(t-c-1)/t,this._addSplitArea(e,s,r,l,i,c)}},_getCircle:function(e,t,i,s,a,n){var h=this._getRadius();return new o({zlevel:this._zlevelBase,style:{x:s[0],y:s[1],r:h*i,brushType:a,strokeColor:e,lineWidth:t,color:n},hoverable:!1,draggable:!1})},_getRing:function(e,t,i,s){var a=this._getRadius();return new n({zlevel:this._zlevelBase,style:{x:s[0],y:s[1],r:t*a,r0:i*a,color:e,brushType:"fill"},hoverable:!1,draggable:!1})},_getPointList:function(e,t,i){for(var s,a=[],o=e.length,n=0;o>n;n++)s=e[n].vector,a.push(this._mapVector(s,i,t));return a},_getShape:function(e,t,i,s,o){return new a({zlevel:this._zlevelBase,style:{pointList:e,brushType:t,color:i,strokeColor:s,lineWidth:o},hoverable:!1,draggable:!1})},_addSplitArea:function(e,t,i,s,a,o){var n,h,r,l,d,p=e.length,c=t.areaStyle.color,f=[],p=e.length,g=this.deepQuery(this._queryTarget,"type");if("string"==typeof c)c=[c];if(h=c.length,n=c[o%h],"polygon"==g)for(var u=0;p>u;u++)f=[],r=e[u].vector,l=e[(u+1)%p].vector,f.push(this._mapVector(r,a,i)),f.push(this._mapVector(r,a,s)),f.push(this._mapVector(l,a,s)),f.push(this._mapVector(l,a,i)),d=this._getShape(f,"fill",n,"",1),this.shapeList.push(d);else if("circle"==g)d=this._getRing(n,i,s,a),this.shapeList.push(d)},_mapVector:function(e,t,i){return[e[0]*i+t[0],e[1]*i+t[1]]},getCenter:function(e){var e=e||0;return this.parseCenter(this.zr,this.polar[e].center)},_addLine:function(e,t,i){for(var s,a,o=e.length,n=i.lineStyle,h=n.color,r=n.width,l=n.type,d=0;o>d;d++)a=e[d].vector,s=this._getLine(t[0],t[1],a[0]+t[0],a[1]+t[1],h,r,l),this.shapeList.push(s)},_getLine:function(e,t,i,a,o,n,h){return new s({zlevel:this._zlevelBase,style:{xStart:e,yStart:t,xEnd:i,yEnd:a,strokeColor:o,lineWidth:n,lineType:h},hoverable:!1})},_adjustIndicatorValue:function(e){for(var t,i,s,a=this.polar[e],o=this.deepQuery(this._queryTarget,"indicator"),n=o.length,h=a.__ecIndicator,r=this._getSeriesData(e),l=a.splitNumber,d=this.deepQuery(this._queryTarget,"boundaryGap"),p=this.deepQuery(this._queryTarget,"precision"),c=this.deepQuery(this._queryTarget,"power"),f=this.deepQuery(this._queryTarget,"scale"),g=0;n>g;g++){if("number"==typeof o[g].max)i=o[g].max,s=o[g].min||0,t={max:i,min:s};else t=this._findValue(r,g,l,d,p,c,f);h[g].value=t}},_getSeriesData:function(e){for(var t,i,s,a=[],o=this.component.legend,n=0;n<this.series.length;n++)if(t=this.series[n],t.type==h.CHART_TYPE_RADAR){i=t.data||[];for(var r=0;r<i.length;r++)if(s=this.deepQuery([i[r],t,this.option],"polarIndex")||0,s==e&&(!o||o.isSelected(i[r].name)))a.push(i[r])}else;return a},_findValue:function(e,t,i,s,a,o,n){function h(e){(e>r||void 0===r)&&(r=e),(l>e||void 0===l)&&(l=e)}var r,l,d,p,c,f,g,u,y=0;if(e&&0!==e.length){if(1==e.length)l=0;if(1!=e.length)for(var m=0;m<e.length;m++)d="undefined"!=typeof e[m].value[t].value?e[m].value[t].value:e[m].value[t],h(d);else{u=e[0];for(var m=0;m<u.value.length;m++)h("undefined"!=typeof u.value[m].value?u.value[m].value:u.value[m])}if(1!=e.length)if(n){if(p=this._getDelta(r,l,i,a,o),p>=1)l=Math.floor(l/p)*p-p;else if(0===p){if(r>0)g=0,f=2*r;else if(0===r)g=0,f=100;else f=0,g=2*l;return{max:f,min:g}}else c=(p+"").split(".")[1],y=c.length,l=Math.floor(l*Math.pow(10,y))/Math.pow(10,y)-p;if(Math.abs(l)<=p)l=0;r=l+Math.floor(p*Math.pow(10,y)*(i+1))/Math.pow(10,y)}else l=l>0?0:l;if(s)r=r>0?1.2*r:.8*r,l=l>0?.8*l:1.2*l;return{max:r,min:l}}},_getDelta:function(e,t,i,s,a){var o,n,h=(e-t)/i;if(h>1)if(!a)if(o=(h+"").split(".")[0],n=o.length,o.charAt(0)>=5)return Math.pow(10,n);else return(o.charAt(0)-0+1)*Math.pow(10,n-1);else if(h=Math.ceil(h),h%a>0)return(Math.ceil(h/a)+1)*a;else return h;else if(1==h)return 1;else if(0===h)return 0;else if(!s){for(o=(h+"").split(".")[1],n=0;"0"==o[n];)n++;if(o[n]>=5)return"0."+o.substring(0,n+1)-0+1/Math.pow(10,n);else return"0."+o.substring(0,n+1)-0+1/Math.pow(10,n+1)}else return Math.ceil(h*Math.pow(10,s))/Math.pow(10,s)},getVector:function(e,t,i){e=e||0,t=t||0;var s=this.polar[e].__ecIndicator;if(!(t>=s.length)){var a,o=this.polar[e].__ecIndicator[t],n=this.getCenter(e),h=o.vector,r=o.value.max,l=o.value.min;if("undefined"==typeof i)return n;switch(i){case"min":i=l;break;case"max":i=r;break;case"center":i=(r+l)/2}if(r!=l)a=(i-l)/(r-l);else a=.5;return this._mapVector(h,n,a)}},isInside:function(e){var t=this.getNearestIndex(e);if(t)return t.polarIndex;else return-1},getNearestIndex:function(e){for(var t,i,s,a,o,n,h,r,d,p=0;p<this.polar.length;p++){if(t=this.polar[p],i=this.getCenter(p),e[0]==i[0]&&e[1]==i[1])return{polarIndex:p,valueIndex:0};if(s=this._getRadius(),o=t.startAngle,n=t.indicator,h=n.length,r=2*Math.PI/h,a=l.cartesian2polar(e[0]-i[0],i[1]-e[1]),e[0]-i[0]<0)a[1]+=Math.PI;if(a[1]<0)a[1]+=2*Math.PI;if(d=a[1]-o/180*Math.PI+2*Math.PI,Math.abs(Math.cos(d%(r/2)))*s>a[0])return{polarIndex:p,valueIndex:Math.floor((d+r/2)/r)%h}}},getIndicator:function(e){var e=e||0;return this.polar[e].indicator},refresh:function(e){if(e)this.option=e,this.polar=this.option.polar,this.series=this.option.series;this.clear(),this._buildShape()}},r.inherits(e,t),require("../component").define("polar",e),e});