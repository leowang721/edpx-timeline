/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/component/timeline",["require","./base","zrender/shape/Rectangle","../util/shape/Icon","../util/shape/Chain","../config","zrender/tool/util","zrender/tool/area","zrender/tool/event","../component"],function(require){function e(e,t,s,a,o){i.call(this,e,t,s,a,o);var r=this;if(r._onclick=function(e){return r.__onclick(e)},r._ondrift=function(e,t){return r.__ondrift(this,e,t)},r._ondragend=function(){return r.__ondragend()},r._setCurrentOption=function(){var e=r.timelineOption;r.currentIndex%=e.data.length;var t=r.options[r.currentIndex]||{};r.myChart.setOption(t,e.notMerge),r.messageCenter.dispatch(n.EVENT.TIMELINE_CHANGED,null,{currentIndex:r.currentIndex,data:"undefined"!=typeof e.data[r.currentIndex].name?e.data[r.currentIndex].name:e.data[r.currentIndex]},r.myChart)},r._onFrame=function(){if(r._setCurrentOption(),r._syncHandleShape(),r.timelineOption.autoPlay)r.playTicket=setTimeout(function(){if(r.currentIndex+=1,!r.timelineOption.loop&&r.currentIndex>=r.timelineOption.data.length)return r.currentIndex=r.timelineOption.data.length-1,void r.stop();else return void r._onFrame()},r.timelineOption.playInterval)},this.setTheme(!1),this.options=this.option.options,this.currentIndex=this.timelineOption.currentIndex%this.timelineOption.data.length,!this.timelineOption.notMerge&&0!==this.currentIndex)this.options[this.currentIndex]=h.merge(this.options[this.currentIndex],this.options[0]);if(this.timelineOption.show)this._buildShape(),this._syncHandleShape();if(this._setCurrentOption(),this.timelineOption.autoPlay){var r=this;this.playTicket=setTimeout(function(){r.play()},this.ecTheme.animationDuration)}}function t(e,t){var i=2,s=t.x+i,o=t.y+i+2,n=t.width-i,h=t.height-i,r=t.symbol;if("last"==r)e.moveTo(s+n-2,o+h/3),e.lineTo(s+n-2,o),e.lineTo(s+2,o+h/2),e.lineTo(s+n-2,o+h),e.lineTo(s+n-2,o+h/3*2),e.moveTo(s,o),e.lineTo(s,o);else if("next"==r)e.moveTo(s+2,o+h/3),e.lineTo(s+2,o),e.lineTo(s+n-2,o+h/2),e.lineTo(s+2,o+h),e.lineTo(s+2,o+h/3*2),e.moveTo(s,o),e.lineTo(s,o);else if("play"==r)if("stop"==t.status)e.moveTo(s+2,o),e.lineTo(s+n-2,o+h/2),e.lineTo(s+2,o+h),e.lineTo(s+2,o);else{var l="both"==t.brushType?2:3;e.rect(s+2,o,l,h),e.rect(s+n-l-2,o,l,h)}else if(r.match("image")){var d="";d=r.replace(new RegExp("^image:\\/\\/"),""),r=a.prototype.iconLibrary.image,r(e,{x:s,y:o,width:n,height:h,image:d})}}var i=require("./base"),s=require("zrender/shape/Rectangle"),a=require("../util/shape/Icon"),o=require("../util/shape/Chain"),n=require("../config"),h=require("zrender/tool/util"),r=require("zrender/tool/area"),l=require("zrender/tool/event");return e.prototype={type:n.COMPONENT_TYPE_TIMELINE,_buildShape:function(){if(this._location=this._getLocation(),this._buildBackground(),this._buildControl(),this._chainPoint=this._getChainPoint(),this.timelineOption.label.show)for(var e=this._getInterval(),t=0,i=this._chainPoint.length;i>t;t+=e)this._chainPoint[t].showLabel=!0;this._buildChain(),this._buildHandle();for(var t=0,s=this.shapeList.length;s>t;t++)this.zr.addShape(this.shapeList[t])},_getLocation:function(){var e,t=this.timelineOption,i=t.padding,s=this.zr.getWidth(),a=this.parsePercent(t.x,s),o=this.parsePercent(t.x2,s);if("undefined"==typeof t.width)e=s-a-o,o=s-o;else e=this.parsePercent(t.width,s),o=a+e;var n,h,r=this.zr.getHeight(),l=this.parsePercent(t.height,r);if("undefined"!=typeof t.y)n=this.parsePercent(t.y,r),h=n+l;else h=r-this.parsePercent(t.y2,r),n=h-l;return{x:a+i[3],y:n+i[0],x2:o-i[1],y2:h-i[2],width:e-i[1]-i[3],height:l-i[0]-i[2]}},_getReformedLabel:function(e){var t=this.timelineOption,i="undefined"!=typeof t.data[e].name?t.data[e].name:t.data[e],s=t.data[e].formatter||t.label.formatter;if(s)if("function"==typeof s)i=s.call(this.myChart,i);else if("string"==typeof s)i=s.replace("{value}",i);return i},_getInterval:function(){var e=this._chainPoint,t=this.timelineOption,i=t.label.interval;if("auto"==i){var s=t.label.textStyle.fontSize,a=t.data,o=t.data.length;if(o>3){var n,h,l=!1;for(i=0;!l&&o>i;){i++,l=!0;for(var d=i;o>d;d+=i){if(n=e[d].x-e[d-i].x,0!==t.label.rotate)h=s;else if(a[d].textStyle)h=r.getTextWidth(e[d].name,e[d].textFont);else{var p=e[d].name+"",c=(p.match(/\w/g)||"").length,f=p.length-c;h=c*s*2/3+f*s}if(h>n){l=!1;break}}}}else i=1}else i=i-0+1;return i},_getChainPoint:function(){function e(e){return"undefined"!=typeof l[e].name?l[e].name:l[e]}var t,i=this.timelineOption,s=i.symbol.toLowerCase(),a=i.symbolSize,o=i.label.rotate,n=i.label.textStyle,r=this.getFont(n),l=i.data,d=this._location.x,p=this._location.y+this._location.height/4*3,c=this._location.x2-this._location.x,f=l.length,u=[];if(f>1){var g=c/f;if(g=g>50?50:20>g?5:g,c-=2*g,"number"==i.type)for(var y=0;f>y;y++)u.push(d+g+c/(f-1)*y);else{u[0]=new Date(e(0).replace(/-/g,"/")),u[f-1]=new Date(e(f-1).replace(/-/g,"/"))-u[0];for(var y=1;f>y;y++)u[y]=d+g+c*(new Date(e(y).replace(/-/g,"/"))-u[0])/u[f-1];u[0]=d+g}}else u.push(d+c/2);for(var m,_,x,v,S,b=[],y=0;f>y;y++){if(d=u[y],m=l[y].symbol&&l[y].symbol.toLowerCase()||s,m.match("empty"))m=m.replace("empty",""),x=!0;else x=!1;if(m.match("star"))_=m.replace("star","")-0||5,m="star";if(t=l[y].textStyle?h.merge(l[y].textStyle||{},n):n,v=t.align||"center",o)v=o>0?"right":"left",S=[o*Math.PI/180,d,p-5];else S=!1;b.push({x:d,n:_,isEmpty:x,symbol:m,symbolSize:l[y].symbolSize||a,color:l[y].color,borderColor:l[y].borderColor,borderWidth:l[y].borderWidth,name:this._getReformedLabel(y),textColor:t.color,textAlign:v,textBaseline:t.baseline||"middle",textX:d,textY:p-(o?5:0),textFont:l[y].textStyle?this.getFont(t):r,rotation:S,showLabel:!1})}return b},_buildBackground:function(){var e=this.timelineOption,t=e.padding,i=this._location.width,a=this._location.height;if(0!==e.borderWidth||"rgba(0,0,0,0)"!=e.backgroundColor.replace(/\s/g,""))this.shapeList.push(new s({zlevel:this._zlevelBase,hoverable:!1,style:{x:this._location.x-t[3],y:this._location.y-t[0],width:i+t[1]+t[3],height:a+t[0]+t[2],brushType:0===e.borderWidth?"fill":"both",color:e.backgroundColor,strokeColor:e.borderColor,lineWidth:e.borderWidth}}))},_buildControl:function(){var e=this,t=this.timelineOption,i=t.lineStyle,s=t.controlStyle;if("none"!=t.controlPosition){var o,n=15,r=5;if("left"==t.controlPosition)o=this._location.x,this._location.x+=3*(n+r);else o=this._location.x2-(3*(n+r)-r),this._location.x2-=3*(n+r);var l=this._location.y,d={zlevel:this._zlevelBase+1,style:{iconType:"timelineControl",symbol:"last",x:o,y:l,width:n,height:n,brushType:"stroke",color:s.normal.color,strokeColor:s.normal.color,lineWidth:i.width},highlightStyle:{color:s.emphasis.color,strokeColor:s.emphasis.color,lineWidth:i.width+1},clickable:!0};this._ctrLastShape=new a(d),this._ctrLastShape.onclick=function(){e.last()},this.shapeList.push(this._ctrLastShape),o+=n+r,this._ctrPlayShape=new a(h.clone(d)),this._ctrPlayShape.style.brushType="fill",this._ctrPlayShape.style.symbol="play",this._ctrPlayShape.style.status=this.timelineOption.autoPlay?"playing":"stop",this._ctrPlayShape.style.x=o,this._ctrPlayShape.onclick=function(){if("stop"==e._ctrPlayShape.style.status)e.play();else e.stop()},this.shapeList.push(this._ctrPlayShape),o+=n+r,this._ctrNextShape=new a(h.clone(d)),this._ctrNextShape.style.symbol="next",this._ctrNextShape.style.x=o,this._ctrNextShape.onclick=function(){e.next()},this.shapeList.push(this._ctrNextShape)}},_buildChain:function(){var e=this.timelineOption,t=e.lineStyle;this._timelineShae={zlevel:this._zlevelBase,style:{x:this._location.x,y:this.subPixelOptimize(this._location.y,t.width),width:this._location.x2-this._location.x,height:this._location.height,chainPoint:this._chainPoint,brushType:"both",strokeColor:t.color,lineWidth:t.width,lineType:t.type},hoverable:!1,clickable:!0,onclick:this._onclick},this._timelineShae=new o(this._timelineShae),this.shapeList.push(this._timelineShae)},_buildHandle:function(){var e=this._chainPoint[this.currentIndex],t=e.symbolSize+1;t=5>t?5:t,this._handleShape={zlevel:this._zlevelBase+1,hoverable:!1,draggable:!0,style:{iconType:"diamond",n:e.n,x:e.x-t,y:this._location.y+this._location.height/4-t,width:2*t,height:2*t,brushType:"both",textPosition:"specific",textX:e.x,textY:this._location.y-this._location.height/4,textAlign:"center",textBaseline:"middle"},highlightStyle:{},ondrift:this._ondrift,ondragend:this._ondragend},this._handleShape=new a(this._handleShape),this.shapeList.push(this._handleShape)},_syncHandleShape:function(){if(this.timelineOption.show){var e=this.timelineOption,t=e.checkpointStyle,i=this._chainPoint[this.currentIndex];if(this._handleShape.style.text=t.label.show?i.name:"",this._handleShape.style.textFont=i.textFont,this._handleShape.style.n=i.n,"auto"==t.symbol)this._handleShape.style.iconType="none"!=i.symbol?i.symbol:"diamond";else if(this._handleShape.style.iconType=t.symbol,t.symbol.match("star"))this._handleShape.style.n=t.symbol.replace("star","")-0||5,this._handleShape.style.iconType="star";var s;if("auto"==t.symbolSize)s=i.symbolSize+2,s=5>s?5:s;else s=t.symbolSize-0;this._handleShape.style.color="auto"==t.color?i.color?i.color:e.controlStyle.emphasis.color:t.color,this._handleShape.style.textColor="auto"==t.label.textStyle.color?this._handleShape.style.color:t.label.textStyle.color,this._handleShape.highlightStyle.strokeColor=this._handleShape.style.strokeColor="auto"==t.borderColor?i.borderColor?i.borderColor:"#fff":t.borderColor,this._handleShape.style.lineWidth="auto"==t.borderWidth?i.borderWidth?i.borderWidth:0:t.borderWidth-0,this._handleShape.highlightStyle.lineWidth=this._handleShape.style.lineWidth+1,this.zr.animate(this._handleShape.id,"style").when(500,{x:i.x-s,textX:i.x,y:this._location.y+this._location.height/4-s,width:2*s,height:2*s}).start("ExponentialOut")}},_findChainIndex:function(e){var t=this._chainPoint,i=t.length;if(e<=t[0].x)return 0;else if(e>=t[i-1].x)return i-1;for(var s=0;i-1>s;s++)if(e>=t[s].x&&e<=t[s+1].x)return Math.abs(e-t[s].x)<Math.abs(e-t[s+1].x)?s:s+1},__onclick:function(e){var t=l.getX(e.event),i=this._findChainIndex(t);if(i==this.currentIndex)return!0;else return this.currentIndex=i,this.timelineOption.autoPlay&&this.stop(),clearTimeout(this.playTicket),void this._onFrame()},__ondrift:function(e,t){this.timelineOption.autoPlay&&this.stop();var i,s=this._chainPoint,a=s.length;if(e.style.x+t<=s[0].x-s[0].symbolSize)e.style.x=s[0].x-s[0].symbolSize,i=0;else if(e.style.x+t>=s[a-1].x-s[a-1].symbolSize)e.style.x=s[a-1].x-s[a-1].symbolSize,i=a-1;else e.style.x+=t,i=this._findChainIndex(e.style.x);var o=s[i],n=o.symbolSize+2;if(e.style.iconType=o.symbol,e.style.n=o.n,e.style.textX=e.style.x+n/2,e.style.y=this._location.y+this._location.height/4-n,e.style.width=2*n,e.style.height=2*n,e.style.text=o.name,i==this.currentIndex)return!0;if(this.currentIndex=i,this.timelineOption.realtime){clearTimeout(this.playTicket);var h=this;this.playTicket=setTimeout(function(){h._setCurrentOption()},200)}return!0},__ondragend:function(){this.isDragend=!0},ondragend:function(e,t){if(this.isDragend&&e.target)!this.timelineOption.realtime&&this._setCurrentOption(),t.dragOut=!0,t.dragIn=!0,t.needRefresh=!1,this.isDragend=!1,this._syncHandleShape()},last:function(){if(this.timelineOption.autoPlay&&this.stop(),this.currentIndex-=1,this.currentIndex<0)this.currentIndex=this.timelineOption.data.length-1;return this._onFrame(),this.currentIndex},next:function(){if(this.timelineOption.autoPlay&&this.stop(),this.currentIndex+=1,this.currentIndex>=this.timelineOption.data.length)this.currentIndex=0;return this._onFrame(),this.currentIndex},play:function(e,t){if(this._ctrPlayShape&&"playing"!=this._ctrPlayShape.style.status)this._ctrPlayShape.style.status="playing",this.zr.modShape(this._ctrPlayShape.id),this.zr.refresh();if(this.timelineOption.autoPlay="undefined"!=typeof t?t:!0,!this.timelineOption.autoPlay)clearTimeout(this.playTicket);if(this.currentIndex="undefined"!=typeof e?e:this.currentIndex+1,this.currentIndex>=this.timelineOption.data.length)this.currentIndex=0;return this._onFrame(),this.currentIndex},stop:function(){if(this._ctrPlayShape&&"stop"!=this._ctrPlayShape.style.status)this._ctrPlayShape.style.status="stop",this.zr.modShape(this._ctrPlayShape.id),this.zr.refresh();return this.timelineOption.autoPlay=!1,clearTimeout(this.playTicket),this.currentIndex},resize:function(){if(this.timelineOption.show)this.clear(),this._buildShape(),this._syncHandleShape()},setTheme:function(e){if(this.timelineOption=this.reformOption(h.clone(this.option.timeline)),this.timelineOption.padding=this.reformCssArray(this.timelineOption.padding),this.timelineOption.label.textStyle=h.merge(this.timelineOption.label.textStyle||{},this.ecTheme.textStyle),this.timelineOption.checkpointStyle.label.textStyle=h.merge(this.timelineOption.checkpointStyle.label.textStyle||{},this.ecTheme.textStyle),this.timelineOption.show&&e)this.clear(),this._buildShape(),this._syncHandleShape()},dispose:function(){this.clear(),this.shapeList=null,clearTimeout(this.playTicket)}},a.prototype.iconLibrary.timelineControl=t,h.inherits(e,i),require("../component").define("timeline",e),e});