/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/component/legend",["require","./base","zrender/shape/Text","zrender/shape/Rectangle","zrender/shape/Sector","../util/shape/Icon","../util/shape/Candle","../config","zrender/tool/util","zrender/tool/area","../component"],function(require){function e(e,i,s,a,o){if(!this.query(a,"legend.data"))return void console.error("option.legend.data has not been defined.");t.call(this,e,i,s,a,o);var n=this;n._legendSelected=function(e){n.__legendSelected(e)},this._colorIndex=0,this._colorMap={},this._selectedMap={},this.refresh(a)}var t=require("./base"),i=require("zrender/shape/Text"),s=require("zrender/shape/Rectangle"),a=require("zrender/shape/Sector"),o=require("../util/shape/Icon"),n=require("../util/shape/Candle"),h=require("../config"),r=require("zrender/tool/util"),l=require("zrender/tool/area");e.prototype={type:h.COMPONENT_TYPE_LEGEND,_buildShape:function(){this._itemGroupLocation=this._getItemGroupLocation(),this._buildBackground(),this._buildItem();for(var e=0,t=this.shapeList.length;t>e;e++)this.zr.addShape(this.shapeList[e])},_buildItem:function(){var e,t,s,a,n,h,d,p,c=this.legendOption.data,f=c.length,g=this.legendOption.textStyle,u=this.zr.getWidth(),y=this.zr.getHeight(),m=this._itemGroupLocation.x,_=this._itemGroupLocation.y,x=this.legendOption.itemWidth,v=this.legendOption.itemHeight,S=this.legendOption.itemGap;if("vertical"==this.legendOption.orient&&"right"==this.legendOption.x)m=this._itemGroupLocation.x+this._itemGroupLocation.width-x;for(var b=0;f>b;b++)if(n=r.merge(c[b].textStyle||{},g),h=this.getFont(n),e=this._getName(c[b]),d=this._getFormatterName(e),""!==e){if(t=c[b].icon||this._getSomethingByName(e).type,p=this.getColor(e),"horizontal"==this.legendOption.orient){if(200>u-m&&x+5+l.getTextWidth(d,h)+(b==f-1||""===c[b+1]?0:S)>=u-m)m=this._itemGroupLocation.x,_+=v+S}else if(200>y-_&&v+(b==f-1||""===c[b+1]?0:S)>=y-_)"right"==this.legendOption.x?m-=this._itemGroupLocation.maxWidth+S:m+=this._itemGroupLocation.maxWidth+S,_=this._itemGroupLocation.y;if(s=this._getItemShapeByType(m,_,x,v,this._selectedMap[e]?p:"#ccc",t,p),s._name=e,s=new o(s),a={zlevel:this._zlevelBase,style:{x:m+x+5,y:_+v/2,color:this._selectedMap[e]?"auto"===n.color?p:n.color:"#ccc",text:d,textFont:h,textBaseline:"middle"},highlightStyle:{color:p,brushType:"fill"},hoverable:!!this.legendOption.selectedMode,clickable:!!this.legendOption.selectedMode},"vertical"==this.legendOption.orient&&"right"==this.legendOption.x)a.style.x-=x+10,a.style.textAlign="right";if(a._name=e,a=new i(a),this.legendOption.selectedMode)s.onclick=a.onclick=this._legendSelected,s.onmouseover=a.onmouseover=this.hoverConnect,s.hoverConnect=a.id,a.hoverConnect=s.id;if(this.shapeList.push(s),this.shapeList.push(a),"horizontal"==this.legendOption.orient)m+=x+5+l.getTextWidth(d,h)+S;else _+=v+S}else if("horizontal"==this.legendOption.orient)m=this._itemGroupLocation.x,_+=v+S;else"right"==this.legendOption.x?m-=this._itemGroupLocation.maxWidth+S:m+=this._itemGroupLocation.maxWidth+S,_=this._itemGroupLocation.y;if("horizontal"==this.legendOption.orient&&"center"==this.legendOption.x&&_!=this._itemGroupLocation.y)this._mLineOptimize()},_getName:function(e){return"undefined"!=typeof e.name?e.name:e},_getFormatterName:function(e){var t,i=this.legendOption.formatter;if("function"==typeof i)t=i.call(this.myChart,e);else if("string"==typeof i)t=i.replace("{name}",e);else t=e;return t},_getFormatterNameFromData:function(e){var t=this._getName(e);return this._getFormatterName(t)},_mLineOptimize:function(){for(var e=[],t=this._itemGroupLocation.x,i=2,s=this.shapeList.length;s>i;i++)if(this.shapeList[i].style.x==t)e.push((this._itemGroupLocation.width-(this.shapeList[i-1].style.x+l.getTextWidth(this.shapeList[i-1].style.text,this.shapeList[i-1].style.textFont)-t))/2);else if(i==s-1)e.push((this._itemGroupLocation.width-(this.shapeList[i].style.x+l.getTextWidth(this.shapeList[i].style.text,this.shapeList[i].style.textFont)-t))/2);for(var a=-1,i=1,s=this.shapeList.length;s>i;i++){if(this.shapeList[i].style.x==t)a++;if(0!==e[a])this.shapeList[i].style.x+=e[a];else;}},_buildBackground:function(){var e=this.legendOption.padding[0],t=this.legendOption.padding[1],i=this.legendOption.padding[2],a=this.legendOption.padding[3];this.shapeList.push(new s({zlevel:this._zlevelBase,hoverable:!1,style:{x:this._itemGroupLocation.x-a,y:this._itemGroupLocation.y-e,width:this._itemGroupLocation.width+a+t,height:this._itemGroupLocation.height+e+i,brushType:0===this.legendOption.borderWidth?"fill":"both",color:this.legendOption.backgroundColor,strokeColor:this.legendOption.borderColor,lineWidth:this.legendOption.borderWidth}}))},_getItemGroupLocation:function(){var e=this.legendOption.data,t=e.length,i=this.legendOption.itemGap,s=this.legendOption.itemWidth+5,a=this.legendOption.itemHeight,o=this.legendOption.textStyle,n=this.getFont(o),h=0,d=0,p=this.legendOption.padding,c=this.zr.getWidth()-p[1]-p[3],f=this.zr.getHeight()-p[0]-p[2],g=0,u=0;if("horizontal"==this.legendOption.orient){d=a;for(var y=0;t>y;y++)if(""!==this._getName(e[y]))g+=s+l.getTextWidth(this._getFormatterNameFromData(e[y]),e[y].textStyle?this.getFont(r.merge(e[y].textStyle||{},o)):n)+i;else{if(g-=i,g>c)h=c,d+=a+i;else h=Math.max(h,g);d+=a+i,g=0}if(d=Math.max(d,a),g-=i,g>c)h=c,d+=a+i;else h=Math.max(h,g)}else{for(var y=0;t>y;y++)u=Math.max(u,l.getTextWidth(this._getFormatterNameFromData(e[y]),e[y].textStyle?this.getFont(r.merge(e[y].textStyle||{},o)):n));u+=s,h=u;for(var y=0;t>y;y++)if(""!==this._getName(e[y]))g+=a+i;else{if(g-=i,g>f)d=f,h+=u+i;else d=Math.max(d,g);h+=u+i,g=0}if(h=Math.max(h,u),g-=i,g>f)d=f,h+=u+i;else d=Math.max(d,g)}c=this.zr.getWidth(),f=this.zr.getHeight();var m;switch(this.legendOption.x){case"center":m=Math.floor((c-h)/2);break;case"left":m=this.legendOption.padding[3]+this.legendOption.borderWidth;break;case"right":m=c-h-this.legendOption.padding[1]-this.legendOption.padding[3]-2*this.legendOption.borderWidth;break;default:m=this.parsePercent(this.legendOption.x,c)}var _;switch(this.legendOption.y){case"top":_=this.legendOption.padding[0]+this.legendOption.borderWidth;break;case"bottom":_=f-d-this.legendOption.padding[0]-this.legendOption.padding[2]-2*this.legendOption.borderWidth;break;case"center":_=Math.floor((f-d)/2);break;default:_=this.parsePercent(this.legendOption.y,f)}return{x:m,y:_,width:h,height:d,maxWidth:u}},_getSomethingByName:function(e){for(var t,i=this.option.series,s=0,a=i.length;a>s;s++){if(i[s].name==e)return{type:i[s].type,series:i[s],seriesIndex:s,data:null,dataIndex:-1};if(i[s].type==h.CHART_TYPE_PIE||i[s].type==h.CHART_TYPE_RADAR||i[s].type==h.CHART_TYPE_CHORD||i[s].type==h.CHART_TYPE_FORCE||i[s].type==h.CHART_TYPE_FUNNEL){t=i[s].type!=h.CHART_TYPE_FORCE?i[s].data:i[s].categories;for(var o=0,n=t.length;n>o;o++)if(t[o].name==e)return{type:i[s].type,series:i[s],seriesIndex:s,data:t[o],dataIndex:o}}}return{type:"bar",series:null,seriesIndex:-1,data:null,dataIndex:-1}},_getItemShapeByType:function(e,t,i,s,a,o,n){var h,r="#ccc"===a?n:a,l={zlevel:this._zlevelBase,style:{iconType:"legendicon"+o,x:e,y:t,width:i,height:s,color:a,strokeColor:a,lineWidth:2},highlightStyle:{color:r,strokeColor:r,lineWidth:1},hoverable:this.legendOption.selectedMode,clickable:this.legendOption.selectedMode};if(o.match("image")){var h=o.replace(new RegExp("^image:\\/\\/"),"");o="image"}switch(o){case"line":l.style.brushType="stroke",l.highlightStyle.lineWidth=3;break;case"radar":case"scatter":l.highlightStyle.lineWidth=3;break;case"k":l.style.brushType="both",l.highlightStyle.lineWidth=3,l.highlightStyle.color=l.style.color=this.query(this.ecTheme,"k.itemStyle.normal.color")||"#fff",l.style.strokeColor="#ccc"!=a?this.query(this.ecTheme,"k.itemStyle.normal.lineStyle.color")||"#ff3200":a;break;case"image":if(l.style.iconType="image",l.style.image=h,"#ccc"===a)l.style.opacity=.5}return l},__legendSelected:function(e){var t=e.target._name;if("single"===this.legendOption.selectedMode)for(var i in this._selectedMap)this._selectedMap[i]=!1;this._selectedMap[t]=!this._selectedMap[t],this.messageCenter.dispatch(h.EVENT.LEGEND_SELECTED,e.event,{selected:this._selectedMap,target:t},this.myChart)},refresh:function(e){if(e){this.option=e||this.option,this.option.legend=this.reformOption(this.option.legend),this.option.legend.padding=this.reformCssArray(this.option.legend.padding),this.legendOption=this.option.legend;var t,i,s,a,o=this.legendOption.data||[];if(this.legendOption.selected)for(var n in this.legendOption.selected)this._selectedMap[n]="undefined"!=typeof this._selectedMap[n]?this._selectedMap[n]:this.legendOption.selected[n];for(var r=0,l=o.length;l>r;r++)if(t=this._getName(o[r]),""!==t)if(i=this._getSomethingByName(t),!i.series)this._selectedMap[t]=!1;else{if(i.data&&(i.type==h.CHART_TYPE_PIE||i.type==h.CHART_TYPE_FORCE||i.type==h.CHART_TYPE_FUNNEL))a=[i.data,i.series];else a=[i.series];if(s=this.getItemStyleColor(this.deepQuery(a,"itemStyle.normal.color"),i.seriesIndex,i.dataIndex,i.data),s&&i.type!=h.CHART_TYPE_K)this.setColor(t,s);this._selectedMap[t]="undefined"!=typeof this._selectedMap[t]?this._selectedMap[t]:!0}else;}this.clear(),this._buildShape()},getRelatedAmount:function(e){for(var t,i=0,s=this.option.series,a=0,o=s.length;o>a;a++){if(s[a].name==e)i++;if(s[a].type==h.CHART_TYPE_PIE||s[a].type==h.CHART_TYPE_RADAR||s[a].type==h.CHART_TYPE_CHORD||s[a].type==h.CHART_TYPE_FORCE||s[a].type==h.CHART_TYPE_FUNNEL){t=s[a].type!=h.CHART_TYPE_FORCE?s[a].data:s[a].categories;for(var n=0,r=t.length;r>n;n++)if(t[n].name==e&&"-"!=t[n].value)i++}}return i},setColor:function(e,t){this._colorMap[e]=t},getColor:function(e){if(!this._colorMap[e])this._colorMap[e]=this.zr.getColor(this._colorIndex++);return this._colorMap[e]},hasColor:function(e){return this._colorMap[e]?this._colorMap[e]:!1},add:function(e,t){for(var i=this.legendOption.data,s=0,a=i.length;a>s;s++)if(this._getName(i[s])==e)return;this.legendOption.data.push(e),this.setColor(e,t),this._selectedMap[e]=!0},del:function(e){for(var t=this.legendOption.data,i=0,s=t.length;s>i;i++)if(this._getName(t[i])==e)return this.legendOption.data.splice(i,1)},getItemShape:function(e){if("undefined"!=typeof e)for(var t,i=0,s=this.shapeList.length;s>i;i++)if(t=this.shapeList[i],t._name==e&&"text"!=t.type)return t},setItemShape:function(e,t){for(var i,s=0,a=this.shapeList.length;a>s;s++)if(i=this.shapeList[s],i._name==e&&"text"!=i.type){if(!this._selectedMap[e])t.style.color="#ccc",t.style.strokeColor="#ccc";this.zr.modShape(i.id,t)}},isSelected:function(e){if("undefined"!=typeof this._selectedMap[e])return this._selectedMap[e];else return!0},getSelectedMap:function(){return this._selectedMap},setSelected:function(e,t){if("single"===this.legendOption.selectedMode)for(var i in this._selectedMap)this._selectedMap[i]=!1;this._selectedMap[e]=t,this.messageCenter.dispatch(h.EVENT.LEGEND_SELECTED,null,{selected:this._selectedMap,target:e},this.myChart)},onlegendSelected:function(e,t){var i=e.selected;for(var s in i){if(this._selectedMap[s]!=i[s])t.needRefresh=!0;this._selectedMap[s]=i[s]}}};var d={line:function(e,t){var i=t.height/2;e.moveTo(t.x,t.y+i),e.lineTo(t.x+t.width,t.y+i)},pie:function(e,t){var i=t.x,s=t.y,o=t.width,n=t.height;a.prototype.buildPath(e,{x:i+o/2,y:s+n+2,r:n+2,r0:6,startAngle:45,endAngle:135})},k:function(e,t){var i=t.x,s=t.y,a=t.width,o=t.height;n.prototype.buildPath(e,{x:i+a/2,y:[s+1,s+1,s+o-6,s+o],width:a-6})},bar:function(e,t){var i=t.x,s=t.y+1,a=t.width,o=t.height-2,n=3;e.moveTo(i+n,s),e.lineTo(i+a-n,s),e.quadraticCurveTo(i+a,s,i+a,s+n),e.lineTo(i+a,s+o-n),e.quadraticCurveTo(i+a,s+o,i+a-n,s+o),e.lineTo(i+n,s+o),e.quadraticCurveTo(i,s+o,i,s+o-n),e.lineTo(i,s+n),e.quadraticCurveTo(i,s,i+n,s)},force:function(e,t){o.prototype.iconLibrary.circle(e,t)},radar:function(e,t){var i=6,s=t.x+t.width/2,a=t.y+t.height/2,o=t.height/2,n=2*Math.PI/i,h=-Math.PI/2,r=s+o*Math.cos(h),l=a+o*Math.sin(h);e.moveTo(r,l),h+=n;for(var d=0,p=i-1;p>d;d++)e.lineTo(s+o*Math.cos(h),a+o*Math.sin(h)),h+=n;e.lineTo(r,l)}};d.chord=d.pie,d.map=d.bar;for(var p in d)o.prototype.iconLibrary["legendicon"+p]=d[p];return r.inherits(e,t),require("../component").define("legend",e),e});