/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/chart/force",["require","../component/base","./base","./forceLayoutWorker","zrender/shape/Line","../util/shape/Icon","../config","../util/ecData","zrender/tool/util","zrender/config","zrender/tool/vector","../util/ndarray","../chart"],function(require){"use strict";function e(){return Math.round((new Date).getTime()/100)%1e7}function t(e,t,o,a,n){var d=this;h.call(this,e,t,o,a,n),l.call(this),this.__nodePositionMap={},this._nodeShapes=[],this._linkShapes=[],this._updating=!0,this._filteredNodes=null,this._filteredLinks=null,this._rawNodes=null,this._rawLinks=null,this._steps=1,this._coolDown=.99,this.ondragstart=function(){i.apply(d,arguments)},this.ondragend=function(){r.apply(d,arguments)},this.ondrop=function(){},this.shapeHandler.ondragstart=function(){d.isDragstart=!0},this.onmousemove=function(){s.apply(d,arguments)},this._init()}function i(e){if(this.isDragstart&&e.target){var t=e.target;t.fixed=!0,this.isDragstart=!1,this.zr.on(g.EVENT.MOUSEMOVE,this.onmousemove)}}function s(){this._temperature=.8}function r(e,t){if(this.isDragend&&e.target){var i=e.target;i.fixed=!1,t.dragIn=!0,t.needRefresh=!1,this.isDragend=!1,this.zr.un(g.EVENT.MOUSEMOVE,this.onmousemove)}}function o(e,t,i){return[(Math.random()-.5)*i+e,(Math.random()-.5)*i+t]}function a(e,t){for(var i=e.length,s=[],r=0;i>r;r++)if(t(e[r],r))s.push(e[r]);return s}var n,h=require("../component/base"),l=require("./base"),d=require("./forceLayoutWorker"),p=require("zrender/shape/Line"),f=require("../util/shape/Icon"),c=require("../config"),y=require("../util/ecData"),u=require("zrender/tool/util"),g=require("zrender/config"),m=require("zrender/tool/vector"),S=require("../util/ndarray"),v="undefined"==typeof Float32Array?Array:Float32Array,_=window.requestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){setTimeout(e,16)};if("undefined"!=typeof Worker&&"undefined"!=typeof Blob)try{var b=new Blob([d.getWorkerCode()]);n=window.URL.createObjectURL(b)}catch(x){n=""}return t.prototype={constructor:t,type:c.CHART_TYPE_FORCE,_init:function(){var e=this;if(this.clear(),this._updating=!0,this._buildShape(),this._layoutWorker)this._layoutWorker.onmessage=function(t){if(e._temperature<.01)_(function(){e._step.call(e,t)});else e._step.call(e,t)},this._layoutWorker.postMessage({cmd:"update",steps:this._steps,temperature:this._temperature,coolDown:this._coolDown});else{var t=function(){if(e._updating)e._step(),_(t)};_(t)}},_buildShape:function(){var e,t=this.component.legend,i=this.series;this._temperature=1,this.shapeList.length=0;for(var s=0,r=i.length;r>s;s++){var o=i[s];if(o.type===c.CHART_TYPE_FORCE){if(i[s]=this.reformOption(i[s]),e=i[s].name||"",n&&o.useWorker)try{if(!this._layoutWorker)this._layoutWorker=new Worker(n);this._layout=null}catch(a){if(this._layoutWorker=null,!this._layout)this._layout=new d}else{if(!this._layout)this._layout=new d;if(this._layoutWorker)this._layoutWorker.terminate(),this._layoutWorker=null}if(this.selectedMap[e]=t?t.isSelected(e):!0,!this.selectedMap[e])continue;this.buildMark(s);for(var h=o.categories,l=0,p=h.length;p>l;l++)if(h[l].name)if(t)this.selectedMap[l]=t.isSelected(h[l].name);else this.selectedMap[l]=!0;this._preProcessData(o),this._nodeShapes.length=0,this._linkShapes.length=0,this._buildLinkShapes(o),this._buildNodeShapes(o),this._initLayout(o),this._updateLinkShapes(),this._forceSerie=o;break}}},_preProcessData:function(e){this._rawNodes=this.query(e,"nodes"),this._rawLinks=u.clone(this.query(e,"links"));var t=[],i={},s=0,r=this;this._filteredNodes=a(this._rawNodes,function(e,o){if(e)if(!e.ignore){var a=-1;if("undefined"==typeof e.category||r.selectedMap[e.category])a=s++;if(e.name)i[e.name]=a;return t[o]=a,a>=0}});var o,n;this._filteredLinks=a(this._rawLinks,function(e,s){o=e.source,n=e.target;var r=!0,a="string"==typeof o?i[o]:t[o];if("undefined"==typeof a)a=-1;if(a>=0)e.source=a;else r=!1;var a="string"==typeof n?i[n]:t[n];if("undefined"==typeof a)a=-1;if(a>=0)e.target=a;else r=!1;return e.rawIndex=s,r})},_initLayout:function(t){var i=this._filteredNodes,s=this._filteredLinks,r=this._nodeShapes,a=i.length,n=this.query(t,"minRadius"),h=this.query(t,"maxRadius");this._steps=t.steps||1,this._coolDown=t.coolDown||.99;for(var l=this.parseCenter(this.zr,t.center),d=this.parsePercent(t.size,this.zr.getWidth()),p=this.parsePercent(t.size,this.zr.getHeight()),f=Math.min(d,p),c=[],y=0;a>y;y++){var g=i[y];c.push(g.value||1)}var _=new S(c);c=_.map(n,h).toArray();var b=_.max();if(0!==b){for(var x=_.mul(1/b,_).toArray(),k=new v(2*a),y=0;a>y;y++){var C,g=i[y];if("undefined"!=typeof this.__nodePositionMap[g.name])C=m.create(),m.copy(C,this.__nodePositionMap[g.name]);else if("undefined"!=typeof g.initial)C=Array.prototype.slice.call(g.initial);else C=o(l[0],l[1],.8*f);var z=r[y].style;z.width=z.width||2*c[y],z.height=z.height||2*c[y],z.x=-z.width/2,z.y=-z.height/2,r[y].position=C,k[2*y]=C[0],k[2*y+1]=C[1]}a=s.length;for(var w=new v(2*a),M=new v(a),y=0;a>y;y++){var A=s[y];w[2*y]=A.source,w[2*y+1]=A.target,M[y]=A.weight||1}_=new S(M);var b=_.max();if(0!==b){var M=_.mul(1/b,_)._array,L={center:l,width:t.ratioScaling?d:f,height:t.ratioScaling?p:f,scaling:t.scaling||1,gravity:t.gravity||1,barnesHutOptimize:t.large};if(this._layoutWorker)this._token=e(),this._layoutWorker.postMessage({cmd:"init",nodesPosition:k,nodesMass:x,nodesSize:c,edges:w,edgesWeight:M,token:this._token}),this._layoutWorker.postMessage({cmd:"updateConfig",config:L});else u.merge(this._layout,L,!0),this._layout.initNodes(k,x,c),this._layout.initEdges(w,M)}}},_buildNodeShapes:function(e){for(var t=this.query(e,"categories"),i=this._filteredNodes,s=i.length,r=this.component.legend,o=0;s>o;o++){var a=i[o],n=new f({style:{x:0,y:0},clickable:this.query(e,"clickable"),highlightStyle:{}}),h=[],l=[],d=[];if(h.push(a),a.itemStyle)l.push(a.itemStyle.normal),d.push(a.itemStyle.emphasis);if("undefined"!=typeof a.category){var p=t[a.category];if(p)p.itemStyle=p.itemStyle||{},p.itemStyle.normal=p.itemStyle.normal||{},p.itemStyle.normal.color=p.itemStyle.normal.color||r.getColor(p.name),h.push(p),l.unshift(p.itemStyle.normal),d.unshift(p.itemStyle.emphasis)}h.push(e),l.unshift(e.itemStyle.normal.nodeStyle),d.unshift(e.itemStyle.emphasis.nodeStyle),n.style.iconType=this.deepQuery(h,"symbol"),n.style.width=n.style.height=2*(this.deepQuery(h,"symbolSize")||0);for(var c=0;c<l.length;c++)if(l[c])u.merge(n.style,l[c],!0);for(var c=0;c<d.length;c++)if(d[c])u.merge(n.highlightStyle,d[c],!0);if(this.deepQuery(h,"itemStyle.normal.label.show")){n.style.text=a.name,n.style.textPosition="inside";var g=this.deepQuery(h,"itemStyle.normal.label.textStyle")||{};n.style.textColor=g.color||"#fff",n.style.textAlign=g.align||"center",n.style.textBaseline=g.baseline||"middle",n.style.textFont=this.getFont(g)}if(this.deepQuery(h,"itemStyle.emphasis.label.show")){n.highlightStyle.text=a.name,n.highlightStyle.textPosition="inside";var g=this.deepQuery(h,"itemStyle.emphasis.label.textStyle")||{};n.highlightStyle.textColor=g.color||"#fff",n.highlightStyle.textAlign=g.align||"center",n.highlightStyle.textBaseline=g.baseline||"middle",n.highlightStyle.textFont=this.getFont(g)}if(this.deepQuery(h,"draggable"))this.setCalculable(n),n.dragEnableTime=0,n.draggable=!0,n.ondragstart=this.shapeHandler.ondragstart,n.ondragover=null;var m="";if("undefined"!=typeof a.category){var p=t[a.category];m=p&&p.name||""}y.pack(n,{name:m},0,a,u.indexOf(this._rawNodes,a),a.name||"",a.value),this._nodeShapes.push(n),this.shapeList.push(n),this.zr.addShape(n)}},_buildLinkShapes:function(e){for(var t=this._filteredNodes,i=this._filteredLinks,s=i.length,r=0;s>r;r++){var o=i[r],a=t[o.source],n=t[o.target],h=new p({style:{xStart:0,yStart:0,xEnd:0,yEnd:0,lineWidth:1},clickable:this.query(e,"clickable"),highlightStyle:{}});if(u.merge(h.style,this.query(e,"itemStyle.normal.linkStyle"),!0),u.merge(h.highlightStyle,this.query(e,"itemStyle.emphasis.linkStyle"),!0),"undefined"!=typeof o.itemStyle){if(o.itemStyle.normal)u.merge(h.style,o.itemStyle.normal,!0);if(o.itemStyle.emphasis)u.merge(h.highlightStyle,o.itemStyle.emphasis,!0)}var o=this._rawLinks[o.rawIndex];if(y.pack(h,e,0,{source:o.source,target:o.target,weight:o.weight||0},o.rawIndex,a.name+" - "+n.name,o.weight||0,!0),this._linkShapes.push(h),this.shapeList.push(h),this.zr.addShape(h),e.linkSymbol&&"none"!==e.linkSymbol){var l=new f({style:{x:-5,y:0,width:e.linkSymbolSize[0],height:e.linkSymbolSize[1],iconType:e.linkSymbol,brushType:"fill",color:h.style.strokeColor,opacity:h.style.opacity,shadowBlur:h.style.shadowBlur,shadowColor:h.style.shadowColor,shadowOffsetX:h.style.shadowOffsetX,shadowOffsetY:h.style.shadowOffsetY},highlightStyle:{brushType:"fill"},position:[0,0],rotation:0});h._symbolShape=l,this.shapeList.push(l),this.zr.addShape(l)}}},_updateLinkShapes:function(){for(var e=m.create(),t=this._filteredLinks,i=0,s=t.length;s>i;i++){var r=t[i],o=this._linkShapes[i],a=this._nodeShapes[r.source],n=this._nodeShapes[r.target];if(o.style.xStart=a.position[0],o.style.yStart=a.position[1],o.style.xEnd=n.position[0],o.style.yEnd=n.position[1],this.zr.modShape(o.id),o._symbolShape){var h=o._symbolShape;m.copy(h.position,n.position),m.sub(e,a.position,n.position),m.normalize(e,e),m.scaleAndAdd(h.position,h.position,e,n.style.width/2+2);var l;if(e[1]<0)l=2*Math.PI-Math.acos(-e[0]);else l=Math.acos(-e[0]);h.rotation=l-Math.PI/2,this.zr.modShape(h.id)}}},_update:function(){this._layout.temperature=this._temperature,this._layout.update();for(var e=0;e<this._layout.nodes.length;e++){var t=this._layout.nodes[e].position,i=this._nodeShapes[e],s=this._filteredNodes[e];if(i.fixed||s.fixX&&s.fixY)m.copy(t,i.position);else if(s.fixX)t[0]=i.position[0],i.position[1]=t[1];else if(s.fixY)t[1]=i.position[1],i.position[0]=t[0];else m.copy(i.position,t);var r=s.name;if(r){var o=this.__nodePositionMap[r];if(!o)o=this.__nodePositionMap[r]=m.create();m.copy(o,t)}}this._temperature*=this._coolDown},_updateWorker:function(e){if(this._updating){var t=new Float32Array(e.data),i=t[0],s=i===this._token;if(s){for(var r=(t.length-1)/2,o=0;r>o;o++){var a=this._nodeShapes[o],n=this._filteredNodes[o],h=t[2*o+1],l=t[2*o+2];if(a.fixed||n.fixX&&n.fixY)t[2*o+1]=a.position[0],t[2*o+2]=a.position[1];else if(n.fixX)t[2*o+1]=a.position[0],a.position[1]=l;else if(n.fixY)t[2*o+2]=a.position[1],a.position[0]=h;else a.position[0]=h,a.position[1]=l;var d=n.name;if(d){var p=this.__nodePositionMap[d];if(!p)p=this.__nodePositionMap[d]=m.create();m.copy(p,a.position)}}this._layoutWorker.postMessage(t.buffer,[t.buffer])}var f=this;f._layoutWorker.postMessage({cmd:"update",steps:this._steps,temperature:this._temperature,coolDown:this._coolDown});for(var o=0;o<this._steps;o++)this._temperature*=this._coolDown;return s}},_step:function(e){if(this._layoutWorker){var t=this._updateWorker(e);if(!t)return}else{if(this._temperature<.01)return;this._update()}this._updateLinkShapes();for(var i=0;i<this._nodeShapes.length;i++)this.zr.modShape(this._nodeShapes[i].id);this.zr.refresh()},refresh:function(e){if(e)this.option=e,this.series=this.option.series;this.clear(),this._buildShape()},dispose:function(){if(this._updating=!1,this.clear(),this.shapeList=null,this.effectList=null,this._layoutWorker)this._layoutWorker.terminate();this._layoutWorker=null,this.__nodePositionMap={}}},u.inherits(t,l),u.inherits(t,h),require("../chart").define("force",t),t});