/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/chart/funnel",["require","../component/base","./base","zrender/shape/Text","zrender/shape/Line","zrender/shape/Polygon","../config","../util/ecData","../util/number","zrender/tool/util","zrender/tool/color","zrender/tool/area","../chart"],function(require){function e(e,s,r,o,a){t.call(this,e,s,r,o,a),i.call(this),this.refresh(o)}var t=require("../component/base"),i=require("./base"),s=require("zrender/shape/Text"),r=require("zrender/shape/Line"),o=require("zrender/shape/Polygon"),a=require("../config"),n=require("../util/ecData"),h=require("../util/number"),l=require("zrender/tool/util"),d=require("zrender/tool/color"),p=require("zrender/tool/area");return e.prototype={type:a.CHART_TYPE_FUNNEL,_buildShape:function(){var e=this.series,t=this.component.legend;this._paramsMap={},this._selected={},this.selectedMap={};for(var i,s=0,r=e.length;r>s;s++)if(e[s].type==a.CHART_TYPE_FUNNEL){if(e[s]=this.reformOption(e[s]),i=e[s].name||"",this.selectedMap[i]=t?t.isSelected(i):!0,!this.selectedMap[i])continue;this._buildSingleFunnel(s),this.buildMark(s)}this.addShapeList()},_buildSingleFunnel:function(e){var t=this.component.legend,i=this.series[e],s=this._mapData(e),r=this._getLocation(e);this._paramsMap[e]={location:r,data:s};for(var o,a=0,n=[],l=0,d=s.length;d>l;l++){if(o=s[l].name,t)this.selectedMap[o]=t.isSelected(o);else this.selectedMap[o]=!0;if(this.selectedMap[o]&&!isNaN(s[l].value))n.push(s[l]),a++}if(0!==a){for(var p,f=this._buildFunnelCase(e),c=i.gap,u=a>1?(r.height-(a-1)*c)/a:r.height,y=r.y,g="descending"==i.sort?this._getItemWidth(e,n[0].value):h.parsePercent(i.minSize,r.width),m="descending"==i.sort?1:0,v=r.centerX,b=[[v-g/2-(0===g?0:10),y-(0===g?10:5)],[v+g/2+(0===g?0:10),y-(0===g?10:5)]],l=0,d=n.length;d>l;l++)if(o=n[l].name,this.selectedMap[o]&&!isNaN(n[l].value))p=d-2>=l?this._getItemWidth(e,n[l+m].value):"descending"==i.sort?h.parsePercent(i.minSize,r.width):h.parsePercent(i.maxSize,r.width),this._buildItem(e,n[l]._index,t?t.getColor(o):this.zr.getColor(n[l]._index),v-g/2,y,g,p,u),y+=u+c,g=p,b.unshift([v-g/2-10,y]),b.push([v+g/2+10,y]);if(f){if(0===g)b.pop(),b[0][0]+=10,b[0][1]+=10;else b[b.length-1][1]+=5,b[0][1]+=5;f.style.pointList=b}}},_buildFunnelCase:function(e){var t=this.series[e];if(this.deepQuery([t,this.option],"calculable")){var i=this._paramsMap[e].location,s=10,r={hoverable:!1,style:{pointListd:[[i.x-s,i.y-s],[i.x+i.width+s,i.y-s],[i.x+i.width+s,i.y+i.height+s],[i.x-s,i.y+i.height+s]],brushType:"stroke",lineWidth:1,strokeColor:t.calculableHolderColor||this.ecTheme.calculableHolderColor}};return n.pack(r,t,e,void 0,-1),this.setCalculable(r),r=new o(r),this.shapeList.push(r),r}},_getLocation:function(e){var t,i=this.series[e],s=this.zr.getWidth(),r=this.zr.getHeight(),o=this.parsePercent(i.x,s),a=this.parsePercent(i.y,r);if("undefined"==typeof i.width)t=s-o-this.parsePercent(i.x2,s);else t=this.parsePercent(i.width,s);var n;if("undefined"==typeof i.height)n=r-a-this.parsePercent(i.y2,r);else n=this.parsePercent(i.height,r);return{x:o,y:a,width:t,height:n,centerX:o+t/2}},_mapData:function(e){function t(e,t){if("-"==e.value)return 1;else if("-"==t.value)return-1;return t.value-e.value}function i(e,i){return-t(e,i)}for(var s=this.series[e],r=l.clone(s.data),o=0,a=r.length;a>o;o++)r[o]._index=o;if("none"!=s.sort)r.sort("descending"==s.sort?t:i);return r},_buildItem:function(e,t,i,s,r,o,a,h){var l=this.series,d=l[e],p=d.data[t],f=this.getPolygon(e,t,i,s,r,o,a,h);n.pack(f,l[e],e,l[e].data[t],t,l[e].data[t].name),this.shapeList.push(f);var c=this.getLabel(e,t,i,s,r,o,a,h);if(n.pack(c,l[e],e,l[e].data[t],t,l[e].data[t].name),this.shapeList.push(c),!this._needLabel(d,p,!1))c.invisible=!0;var u=this.getLabelLine(e,t,i,s,r,o,a,h);if(this.shapeList.push(u),!this._needLabelLine(d,p,!1))u.invisible=!0;var y=[],g=[];if(this._needLabelLine(d,p,!0))y.push(u.id),g.push(u.id);if(this._needLabel(d,p,!0))y.push(c.id),g.push(f.id);f.hoverConnect=y,c.hoverConnect=g,f.onmouseover=c.onmouseover=this.hoverConnect},_getItemWidth:function(e,t){var i=this.series[e],s=this._paramsMap[e].location,r=i.min,o=i.max,a=h.parsePercent(i.minSize,s.width),n=h.parsePercent(i.maxSize,s.width);return t*(n-a)/(o-r)},getPolygon:function(e,t,i,s,r,a,n,h){var l=this.series[e],p=l.data[t],f=[p,l],c=this.deepMerge(f,"itemStyle.normal")||{},u=this.deepMerge(f,"itemStyle.emphasis")||{},y=this.getItemStyleColor(c.color,e,t,p)||i,g=this.getItemStyleColor(u.color,e,t,p)||("string"==typeof y?d.lift(y,-.2):y),m={zlevel:this._zlevelBase,clickable:this.deepQuery(f,"clickable"),style:{pointList:[[s,r],[s+a,r],[s+a-(a-n)/2,r+h],[s+(a-n)/2,r+h]],brushType:"both",color:y,lineWidth:c.borderWidth,strokeColor:c.borderColor},highlightStyle:{color:g,lineWidth:u.borderWidth,strokeColor:u.borderColor}};if(this.deepQuery([p,l,this.option],"calculable"))this.setCalculable(m),m.draggable=!0;return new o(m)},getLabel:function(e,t,i,r,o,a,n,h){var f,c,u=this.series[e],y=u.data[t],g=this._paramsMap[e].location,m=l.merge(l.clone(y.itemStyle)||{},u.itemStyle),v="normal",b=m[v].label,S=b.textStyle||{},x=m[v].labelLine.length,_=this.getLabelText(e,t,v),k=this.getFont(S),M=i;if(b.position=b.position||m.normal.label.position,"inner"==b.position||"inside"==b.position)if(f="center",c=r+a/2,Math.max(a,n)/2>p.getTextWidth(_,k))M="#fff";else M=d.reverse(i);else if("left"==b.position)f="right",c="auto"==x?g.x-10:g.centerX-Math.max(a,n)/2-x;else f="left",c="auto"==x?g.x+g.width+10:g.centerX+Math.max(a,n)/2+x;var w={zlevel:this._zlevelBase+1,style:{x:c,y:o+h/2,color:S.color||M,text:_,textAlign:S.align||f,textBaseline:S.baseline||"middle",textFont:k}};if(v="emphasis",b=m[v].label||b,S=b.textStyle||S,x=m[v].labelLine.length||x,b.position=b.position||m.normal.label.position,_=this.getLabelText(e,t,v),k=this.getFont(S),M=i,"inner"==b.position||"inside"==b.position)if(f="center",c=r+a/2,Math.max(a,n)/2>p.getTextWidth(_,k))M="#fff";else M=d.reverse(i);else if("left"==b.position)f="right",c="auto"==x?g.x-10:g.centerX-Math.max(a,n)/2-x;else f="left",c="auto"==x?g.x+g.width+10:g.centerX+Math.max(a,n)/2+x;return w.highlightStyle={x:c,color:S.color||M,text:_,textAlign:S.align||f,textFont:k,brushType:"fill"},new s(w)},getLabelText:function(e,t,i){var s=this.series,r=s[e],o=r.data[t],a=this.deepQuery([o,r],"itemStyle."+i+".label.formatter");if(a){if("function"==typeof a)return a.call(this.myChart,r.name,o.name,o.value);else if("string"==typeof a)return a=a.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}"),a=a.replace("{a0}",r.name).replace("{b0}",o.name).replace("{c0}",o.value)}else return o.name},getLabelLine:function(e,t,i,s,o,a,n,h){var d=this.series[e],p=d.data[t],f=this._paramsMap[e].location,c=l.merge(l.clone(p.itemStyle)||{},d.itemStyle),u="normal",y=c[u].labelLine,g=c[u].labelLine.length,m=y.lineStyle||{},v=c[u].label;v.position=v.position||c.normal.label.position;var b;if("inner"==v.position||"inside"==v.position)b=s+a/2;else if("left"==v.position)b="auto"==g?f.x-10:f.centerX-Math.max(a,n)/2-g;else b="auto"==g?f.x+f.width+10:f.centerX+Math.max(a,n)/2+g;var S={zlevel:this._zlevelBase+1,hoverable:!1,style:{xStart:f.centerX,yStart:o+h/2,xEnd:b,yEnd:o+h/2,strokeColor:m.color||i,lineType:m.type,lineWidth:m.width}};if(u="emphasis",y=c[u].labelLine||y,g=c[u].labelLine.length||g,m=y.lineStyle||m,v=c[u].label||v,v.position=v.position,"inner"==v.position||"inside"==v.position)b=s+a/2;else if("left"==v.position)b="auto"==g?f.x-10:f.centerX-Math.max(a,n)/2-g;else b="auto"==g?f.x+f.width+10:f.centerX+Math.max(a,n)/2+g;return S.highlightStyle={xEnd:b,strokeColor:m.color||i,lineType:m.type,lineWidth:m.width},new r(S)},_needLabel:function(e,t,i){return this.deepQuery([t,e],"itemStyle."+(i?"emphasis":"normal")+".label.show")},_needLabelLine:function(e,t,i){return this.deepQuery([t,e],"itemStyle."+(i?"emphasis":"normal")+".labelLine.show")},refresh:function(e){if(e)this.option=e,this.series=e.series;this.backupShapeList(),this._buildShape()}},l.inherits(e,i),l.inherits(e,t),require("../chart").define("funnel",e),e});