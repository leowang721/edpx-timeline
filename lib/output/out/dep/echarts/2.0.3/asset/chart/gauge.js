/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/chart/gauge",["require","../component/base","./base","../util/shape/GaugePointer","zrender/shape/Text","zrender/shape/Line","zrender/shape/Rectangle","zrender/shape/Circle","zrender/shape/Sector","../config","../util/ecData","../util/accMath","zrender/tool/util","../chart"],function(require){function e(e,s,r,o,a){t.call(this,e,s,r,o,a),i.call(this),this.refresh(o)}var t=require("../component/base"),i=require("./base"),s=require("../util/shape/GaugePointer"),r=require("zrender/shape/Text"),o=require("zrender/shape/Line"),a=require("zrender/shape/Rectangle"),n=require("zrender/shape/Circle"),h=require("zrender/shape/Sector"),l=require("../config"),d=require("../util/ecData"),p=require("../util/accMath"),f=require("zrender/tool/util");return e.prototype={type:l.CHART_TYPE_GAUGE,_buildShape:function(){var e=this.series;this._paramsMap={};for(var t=0,i=e.length;i>t;t++)if(e[t].type==l.CHART_TYPE_GAUGE)e[t]=this.reformOption(e[t]),this._buildSingleGauge(t),this.buildMark(t);this.addShapeList()},_buildSingleGauge:function(e){var t=this.series[e];this._paramsMap[e]={center:this.parseCenter(this.zr,t.center),radius:this.parseRadius(this.zr,t.radius),startAngle:t.startAngle.toFixed(2)-0,endAngle:t.endAngle.toFixed(2)-0},this._paramsMap[e].totalAngle=this._paramsMap[e].startAngle-this._paramsMap[e].endAngle,this._colorMap(e),this._buildAxisLine(e),this._buildSplitLine(e),this._buildAxisTick(e),this._buildAxisLabel(e),this._buildPointer(e),this._buildTitle(e),this._buildDetail(e)},_buildAxisLine:function(e){var t=this.series[e];if(t.axisLine.show)for(var i,s,r=t.min,o=t.max-r,a=this._paramsMap[e],n=a.center,h=a.startAngle,l=a.totalAngle,p=a.colorArray,f=t.axisLine.lineStyle,c=this.parsePercent(f.width,a.radius[1]),u=a.radius[1],g=u-c,y=h,m=0,v=p.length;v>m;m++)s=h-l*(p[m][0]-r)/o,i=this._getSector(n,g,u,s,y,p[m][1],f),y=s,i._animationAdd="r",d.set(i,"seriesIndex",e),d.set(i,"dataIndex",m),this.shapeList.push(i)},_buildSplitLine:function(e){var t=this.series[e];if(t.splitLine.show)for(var i,s,r,a=this._paramsMap[e],n=t.splitNumber,h=t.min,l=t.max-h,d=t.splitLine,p=this.parsePercent(d.length,a.radius[1]),f=d.lineStyle,c=f.color,u=a.center,g=a.startAngle*Math.PI/180,y=a.totalAngle*Math.PI/180,m=a.radius[1],v=m-p,b=0;n>=b;b++)i=g-y/n*b,s=Math.sin(i),r=Math.cos(i),this.shapeList.push(new o({zlevel:this._zlevelBase+1,hoverable:!1,style:{xStart:u[0]+r*m,yStart:u[1]-s*m,xEnd:u[0]+r*v,yEnd:u[1]-s*v,strokeColor:"auto"==c?this._getColor(e,h+l/n*b):c,lineType:f.type,lineWidth:f.width,shadowColor:f.shadowColor,shadowBlur:f.shadowBlur,shadowOffsetX:f.shadowOffsetX,shadowOffsetY:f.shadowOffsetY}}))},_buildAxisTick:function(e){var t=this.series[e];if(t.axisTick.show)for(var i,s,r,a=this._paramsMap[e],n=t.splitNumber,h=t.min,l=t.max-h,d=t.axisTick,p=d.splitNumber,f=this.parsePercent(d.length,a.radius[1]),c=d.lineStyle,u=c.color,g=a.center,y=a.startAngle*Math.PI/180,m=a.totalAngle*Math.PI/180,v=a.radius[1],b=v-f,S=0,_=n*p;_>=S;S++)if(S%p!==0)i=y-m/_*S,s=Math.sin(i),r=Math.cos(i),this.shapeList.push(new o({zlevel:this._zlevelBase+1,hoverable:!1,style:{xStart:g[0]+r*v,yStart:g[1]-s*v,xEnd:g[0]+r*b,yEnd:g[1]-s*b,strokeColor:"auto"==u?this._getColor(e,h+l/_*S):u,lineType:c.type,lineWidth:c.width,shadowColor:c.shadowColor,shadowBlur:c.shadowBlur,shadowOffsetX:c.shadowOffsetX,shadowOffsetY:c.shadowOffsetY}}));else;},_buildAxisLabel:function(e){var t=this.series[e];if(t.axisLabel.show)for(var i,s,o,a,n=t.splitNumber,h=t.min,l=t.max-h,d=t.axisLabel.textStyle,f=this.getFont(d),c=d.color,u=this._paramsMap[e],g=u.center,y=u.startAngle,m=u.totalAngle,v=u.radius[1]-this.parsePercent(t.splitLine.length,u.radius[1])-10,b=0;n>=b;b++)a=p.accAdd(h,p.accMul(p.accDiv(l,n),b)),i=y-m/n*b,s=Math.sin(i*Math.PI/180),o=Math.cos(i*Math.PI/180),i=(i+360)%360,this.shapeList.push(new r({zlevel:this._zlevelBase+1,hoverable:!1,style:{x:g[0]+o*v,y:g[1]-s*v,color:"auto"==c?this._getColor(e,a):c,text:this._getLabelText(t.axisLabel.formatter,a),textAlign:i>=110&&250>=i?"left":70>=i||i>=290?"right":"center",textBaseline:i>=10&&170>=i?"top":i>=190&&350>=i?"bottom":"middle",textFont:f,shadowColor:d.shadowColor,shadowBlur:d.shadowBlur,shadowOffsetX:d.shadowOffsetX,shadowOffsetY:d.shadowOffsetY}}))},_buildPointer:function(e){var t=this.series[e];if(t.pointer.show){var i=t.max-t.min,r=t.pointer,o=this._paramsMap[e],a=this.parsePercent(r.length,o.radius[1]),h=this.parsePercent(r.width,o.radius[1]),l=o.center,p=this._getValue(e);p=p<t.max?p:t.max;var f=(o.startAngle-o.totalAngle/i*(p-t.min))*Math.PI/180,c="auto"==r.color?this._getColor(e,p):r.color,u=new s({zlevel:this._zlevelBase+1,style:{x:l[0],y:l[1],r:a,startAngle:o.startAngle*Math.PI/180,angle:f,color:c,width:h,shadowColor:r.shadowColor,shadowBlur:r.shadowBlur,shadowOffsetX:r.shadowOffsetX,shadowOffsetY:r.shadowOffsetY},highlightStyle:{brushType:"fill",width:h>2?2:h/2,color:"#fff"}});d.pack(u,this.series[e],e,this.series[e].data[0],0,this.series[e].data[0].name,p),this.shapeList.push(u),this.shapeList.push(new n({zlevel:this._zlevelBase+2,hoverable:!1,style:{x:l[0],y:l[1],r:r.width/2.5,color:"#fff"}}))}},_buildTitle:function(e){var t=this.series[e];if(t.title.show){var i=t.data[0],s="undefined"!=typeof i.name?i.name:"";if(""!==s){var o=t.title,a=o.offsetCenter,n=o.textStyle,h=n.color,l=this._paramsMap[e],d=l.center[0]+this.parsePercent(a[0],l.radius[1]),p=l.center[1]+this.parsePercent(a[1],l.radius[1]);this.shapeList.push(new r({zlevel:this._zlevelBase+(Math.abs(d-l.center[0])+Math.abs(p-l.center[1]))<2*n.fontSize?2:1,hoverable:!1,style:{x:d,y:p,color:"auto"==h?this._getColor(e):h,text:s,textAlign:"center",textFont:this.getFont(n),shadowColor:n.shadowColor,shadowBlur:n.shadowBlur,shadowOffsetX:n.shadowOffsetX,shadowOffsetY:n.shadowOffsetY}}))}}},_buildDetail:function(e){var t=this.series[e];if(t.detail.show){var i=t.detail,s=i.offsetCenter,r=i.backgroundColor,o=i.textStyle,n=o.color,h=this._paramsMap[e],l=this._getValue(e),d=h.center[0]-i.width/2+this.parsePercent(s[0],h.radius[1]),p=h.center[1]+this.parsePercent(s[1],h.radius[1]);this.shapeList.push(new a({zlevel:this._zlevelBase+(Math.abs(d+i.width/2-h.center[0])+Math.abs(p+i.height/2-h.center[1]))<o.fontSize?2:1,hoverable:!1,style:{x:d,y:p,width:i.width,height:i.height,brushType:"both",color:"auto"==r?this._getColor(e,l):r,lineWidth:i.borderWidth,strokeColor:i.borderColor,shadowColor:i.shadowColor,shadowBlur:i.shadowBlur,shadowOffsetX:i.shadowOffsetX,shadowOffsetY:i.shadowOffsetY,text:this._getLabelText(i.formatter,l),textFont:this.getFont(o),textPosition:"inside",textColor:"auto"==n?this._getColor(e,l):n}}))}},_getValue:function(e){var t=this.series[e].data[0];return"undefined"!=typeof t.value?t.value:t},_colorMap:function(e){var t=this.series[e],i=t.min,s=t.max-i,r=t.axisLine.lineStyle.color;if(!(r instanceof Array))r=[[1,r]];for(var o=[],a=0,n=r.length;n>a;a++)o.push([r[a][0]*s+i,r[a][1]]);this._paramsMap[e].colorArray=o},_getColor:function(e,t){if("undefined"==typeof t)t=this._getValue(e);for(var i=this._paramsMap[e].colorArray,s=0,r=i.length;r>s;s++)if(i[s][0]>=t)return i[s][1];return i[i.length-1][1]},_getSector:function(e,t,i,s,r,o,a){return new h({zlevel:this._zlevelBase,hoverable:!1,style:{x:e[0],y:e[1],r0:t,r:i,startAngle:s,endAngle:r,brushType:"fill",color:o,shadowColor:a.shadowColor,shadowBlur:a.shadowBlur,shadowOffsetX:a.shadowOffsetX,shadowOffsetY:a.shadowOffsetY}})},_getLabelText:function(e,t){if(e)if("function"==typeof e)return e.call(this.myChart,t);else if("string"==typeof e)return e.replace("{value}",t);return t},refresh:function(e){if(e)this.option=e,this.series=e.series;this.backupShapeList(),this._buildShape()}},f.inherits(e,i),f.inherits(e,t),require("../chart").define("gauge",e),e});