/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/chart/bar",["require","../component/base","./base","zrender/shape/Rectangle","../component/axis","../component/grid","../component/dataZoom","../config","../util/ecData","zrender/tool/util","zrender/tool/color","../chart"],function(require){function e(e,o,n,s,r){t.call(this,e,o,n,s,r),i.call(this),this.refresh(s)}var t=require("../component/base"),i=require("./base"),o=require("zrender/shape/Rectangle");require("../component/axis"),require("../component/grid"),require("../component/dataZoom");var n=require("../config"),s=require("../util/ecData"),r=require("zrender/tool/util"),a=require("zrender/tool/color");return e.prototype={type:n.CHART_TYPE_BAR,_buildShape:function(){var e=this.series;this.selectedMap={},this.xMarkMap={},this._sIndex2colorMap={};for(var t,i,o,s,r={top:[],bottom:[],left:[],right:[]},a=0,l=e.length;l>a;a++)if(e[a].type==n.CHART_TYPE_BAR)if(e[a]=this.reformOption(e[a]),t=e[a].xAxisIndex,i=e[a].yAxisIndex,o=this.component.xAxis.getAxis(t),s=this.component.yAxis.getAxis(i),o.type==n.COMPONENT_TYPE_AXIS_CATEGORY)r[o.getPosition()].push(a);else if(s.type==n.COMPONENT_TYPE_AXIS_CATEGORY)r[s.getPosition()].push(a);for(var h in r)if(r[h].length>0)this._buildSinglePosition(h,r[h],this.xMarkMap);this.addShapeList()},_buildSinglePosition:function(e,t,i){var o=this._mapData(t),n=o.locationMap,s=o.maxDataLength;if(0!==s&&0!==n.length)switch(e){case"bottom":case"top":this._buildHorizontal(s,n,t,i);break;case"left":case"right":this._buildVertical(s,n,t,i)}},_mapData:function(e){for(var t,i,o,n,s=this.series,r=0,a={},l="__kener__stack__",h=this.component.legend,d=[],p=0,g=0,f=e.length;f>g;g++){if(t=s[e[g]],o=t.name,h){if(this.selectedMap[o]=h.isSelected(o),this._sIndex2colorMap[e[g]]=h.getColor(o),n=h.getItemShape(o)){if(t.itemStyle.normal.barBorderWidth>0)n.style.x+=1,n.style.y+=1,n.style.width-=2,n.style.height-=2,n.style.strokeColor=n.highlightStyle.strokeColor=t.itemStyle.normal.barBorderColor,n.highlightStyle.lineWidth=3,n.style.brushType="both";h.setItemShape(o,n)}}else this.selectedMap[o]=!0,this._sIndex2colorMap[e[g]]=this.zr.getColor(e[g]);if(this.selectedMap[o])if(i=t.stack||l+e[g],"undefined"==typeof a[i])a[i]=r,d[r]=[e[g]],r++;else d[a[i]].push(e[g]);p=Math.max(p,t.data.length)}return{locationMap:d,maxDataLength:p}},_buildHorizontal:function(e,t,i,n){for(var s,r,a,l,h,d,p,g,f,y,c,x,m=this.series,u=t[0][0],v=m[u],_=v.xAxisIndex,b=this.component.xAxis.getAxis(_),A=this._mapSize(b,t),C=A.gap,I=A.barGap,M=A.barWidthMap,S=A.barWidth,B=A.barMinHeightMap,z=A.interval,T=0,P=e;P>T&&"undefined"!=typeof b.getNameByIndex(T);T++){l=b.getCoordByIndex(T)-C/2;for(var L=0,N=t.length;N>L;L++){s=m[t[L][0]].yAxisIndex||0,r=this.component.yAxis.getAxis(s),p=d=f=g=r.getCoord(0);for(var Y=0,k=t[L].length;k>Y;Y++)if(u=t[L][Y],v=m[u],c=v.data[T],x="undefined"!=typeof c?"undefined"!=typeof c.value?c.value:c:"-",n[u]=n[u]||{min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,sum:0,counter:0,average:0},"-"!=x){if(x>0){if(a=Y>0?r.getCoordSize(x):p-r.getCoord(x),1==k&&B[u]>a)a=B[u];d-=a,h=d}else if(0>x){if(a=Y>0?r.getCoordSize(x):r.getCoord(x)-f,1==k&&B[u]>a)a=B[u];h=g,g+=a}else a=0,d-=a,h=d;if(n[u][T]=l+(M[u]||S)/2,n[u].min>x)n[u].min=x,n[u].minY=h,n[u].minX=n[u][T];if(n[u].max<x)n[u].max=x,n[u].maxY=h,n[u].maxX=n[u][T];if(n[u].sum+=x,n[u].counter++,T%z===0)y=this._getBarItem(u,T,b.getNameByIndex(T),l,h,M[u]||S,a,"vertical"),this.shapeList.push(new o(y))}else;for(var Y=0,k=t[L].length;k>Y;Y++)if(u=t[L][Y],v=m[u],c=v.data[T],x="undefined"!=typeof c?"undefined"!=typeof c.value?c.value:c:"-","-"==x){if(this.deepQuery([c,v,this.option],"calculable"))d-=this.ecTheme.island.r,h=d,y=this._getBarItem(u,T,b.getNameByIndex(T),l+.5,h+.5,(M[u]||S)-1,this.ecTheme.island.r-1,"vertical"),y.hoverable=!1,y.draggable=!1,y.style.lineWidth=1,y.style.brushType="stroke",y.style.strokeColor=v.calculableHolderColor||this.ecTheme.calculableHolderColor,this.shapeList.push(new o(y))}else;l+=(M[u]||S)+I}}for(var L=0,N=t.length;N>L;L++)for(var Y=0,k=t[L].length;k>Y;Y++){if(u=t[L][Y],n[u].counter>0)n[u].average=(n[u].sum/n[u].counter).toFixed(2)-0;h=this.component.yAxis.getAxis(m[u].yAxisIndex||0).getCoord(n[u].average),n[u].averageLine=[[this.component.grid.getX(),h],[this.component.grid.getXend(),h]],n[u].minLine=[[this.component.grid.getX(),n[u].minY],[this.component.grid.getXend(),n[u].minY]],n[u].maxLine=[[this.component.grid.getX(),n[u].maxY],[this.component.grid.getXend(),n[u].maxY]],n[u].isHorizontal=!0,this.buildMark(u)}},_buildVertical:function(e,t,i,n){for(var s,r,a,l,h,d,p,g,f,y,c,x,m=this.series,u=t[0][0],v=m[u],_=v.yAxisIndex,b=this.component.yAxis.getAxis(_),A=this._mapSize(b,t),C=A.gap,I=A.barGap,M=A.barWidthMap,S=A.barWidth,B=A.barMinHeightMap,z=A.interval,T=0,P=e;P>T&&"undefined"!=typeof b.getNameByIndex(T);T++){h=b.getCoordByIndex(T)+C/2;for(var L=0,N=t.length;N>L;L++){s=m[t[L][0]].xAxisIndex||0,r=this.component.xAxis.getAxis(s),p=d=f=g=r.getCoord(0);for(var Y=0,k=t[L].length;k>Y;Y++)if(u=t[L][Y],v=m[u],c=v.data[T],x="undefined"!=typeof c?"undefined"!=typeof c.value?c.value:c:"-",n[u]=n[u]||{min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,sum:0,counter:0,average:0},"-"!=x){if(x>0){if(a=Y>0?r.getCoordSize(x):r.getCoord(x)-p,1==k&&B[u]>a)a=B[u];l=d,d+=a}else if(0>x){if(a=Y>0?r.getCoordSize(x):f-r.getCoord(x),1==k&&B[u]>a)a=B[u];g-=a,l=g}else a=0,l=d,d+=a;if(n[u][T]=h-(M[u]||S)/2,n[u].min>x)n[u].min=x,n[u].minX=l+a,n[u].minY=n[u][T];if(n[u].max<x)n[u].max=x,n[u].maxX=l+a,n[u].maxY=n[u][T];if(n[u].sum+=x,n[u].counter++,T%z===0)y=this._getBarItem(u,T,b.getNameByIndex(T),l,h-(M[u]||S),a,M[u]||S,"horizontal"),this.shapeList.push(new o(y))}else;for(var Y=0,k=t[L].length;k>Y;Y++)if(u=t[L][Y],v=m[u],c=v.data[T],x="undefined"!=typeof c?"undefined"!=typeof c.value?c.value:c:"-","-"==x){if(this.deepQuery([c,v,this.option],"calculable"))l=d,d+=this.ecTheme.island.r,y=this._getBarItem(u,T,b.getNameByIndex(T),l+.5,h+.5-(M[u]||S),this.ecTheme.island.r-1,(M[u]||S)-1,"horizontal"),y.hoverable=!1,y.draggable=!1,y.style.lineWidth=1,y.style.brushType="stroke",y.style.strokeColor=v.calculableHolderColor||this.ecTheme.calculableHolderColor,this.shapeList.push(new o(y))}else;h-=(M[u]||S)+I}}for(var L=0,N=t.length;N>L;L++)for(var Y=0,k=t[L].length;k>Y;Y++){if(u=t[L][Y],n[u].counter>0)n[u].average=(n[u].sum/n[u].counter).toFixed(2)-0;l=this.component.xAxis.getAxis(m[u].xAxisIndex||0).getCoord(n[u].average),n[u].averageLine=[[l,this.component.grid.getYend()],[l,this.component.grid.getY()]],n[u].minLine=[[n[u].minX,this.component.grid.getYend()],[n[u].minX,this.component.grid.getY()]],n[u].maxLine=[[n[u].maxX,this.component.grid.getYend()],[n[u].maxX,this.component.grid.getY()]],n[u].isHorizontal=!1,this.buildMark(u)}},_mapSize:function(e,t,i){for(var o,n,s,r,a,l,h=this.series,d={},p={},g=0,f=0,y=1,c=0,x=t.length;x>c;c++){a=!1;for(var m=0,u=t[c].length;u>m;m++){if(o=t[c][m],l=h[o],!i)if(!a){if(n=this.query(l,"barWidth"),"undefined"!=typeof n){d[o]=n,f+=n,g++,a=!0;for(var v=0,_=m;_>v;v++){var b=t[c][v];d[b]=n}}}else d[o]=n;p[o]=this.query(l,"barMinHeight"),s="undefined"!=typeof s?s:this.query(l,"barGap"),r="undefined"!=typeof r?r:this.query(l,"barCategoryGap")}}var A,C;if(t.length!=g){if(!i){if(A="string"==typeof r&&r.match(/%$/)?Math.floor(e.getGap()*(100-parseFloat(r))/100):e.getGap()-r,"string"==typeof s&&s.match(/%$/))s=parseFloat(s)/100,C=Math.floor((A-f)/((t.length-1)*s+t.length-g)),s=Math.floor(C*s);else s=parseFloat(s),C=Math.floor((A-f-s*(t.length-1))/(t.length-g));if(0>=C)return this._mapSize(e,t,!0)}else if(A=e.getGap(),s=0,C=Math.floor(A/t.length),0>=C)y=Math.floor(t.length/A),C=1}else if(A=g>1?"string"==typeof r&&r.match(/%$/)?Math.floor(e.getGap()*(100-parseFloat(r))/100):e.getGap()-r:f,C=0,s=g>1?Math.floor((A-f)/(g-1)):0,0>s)return this._mapSize(e,t,!0);return{barWidthMap:d,barMinHeightMap:p,gap:A,barWidth:C,barGap:s,interval:y}},_getBarItem:function(e,t,i,o,n,r,l,h){var d,p=this.series,g=p[e],f=g.data[t],y=this._sIndex2colorMap[e],c=[f,g],x=this.deepQuery(c,"itemStyle.normal.color")||y,m=this.deepQuery(c,"itemStyle.emphasis.color"),u=this.deepMerge(c,"itemStyle.normal"),v=u.barBorderWidth,_=this.deepMerge(c,"itemStyle.emphasis");if(d={zlevel:this._zlevelBase,clickable:this.deepQuery(c,"clickable"),style:{x:o,y:n,width:r,height:l,brushType:"both",color:this.getItemStyleColor(x,e,t,f),radius:u.barBorderRadius,lineWidth:v,strokeColor:u.barBorderColor},highlightStyle:{color:this.getItemStyleColor(m,e,t,f),radius:_.barBorderRadius,lineWidth:_.barBorderWidth,strokeColor:_.barBorderColor},_orient:h},d.highlightStyle.color=d.highlightStyle.color||("string"==typeof d.style.color?a.lift(d.style.color,-.3):d.style.color),v>0&&d.style.height>v&&d.style.width>v)d.style.y+=v/2,d.style.height-=v,d.style.x+=v/2,d.style.width-=v;else d.style.brushType="fill";if(d.highlightStyle.textColor=d.highlightStyle.color,d=this.addLabel(d,g,f,i,h),"insideLeft"==d.style.textPosition||"insideRight"==d.style.textPosition||"insideTop"==d.style.textPosition||"insideBottom"==d.style.textPosition){var b=5;switch(d.style.textPosition){case"insideLeft":d.style.textX=d.style.x+b,d.style.textY=d.style.y+d.style.height/2,d.style.textAlign="left",d.style.textBaseline="middle";break;case"insideRight":d.style.textX=d.style.x+d.style.width-b,d.style.textY=d.style.y+d.style.height/2,d.style.textAlign="right",d.style.textBaseline="middle";break;case"insideTop":d.style.textX=d.style.x+d.style.width/2,d.style.textY=d.style.y+b/2,d.style.textAlign="center",d.style.textBaseline="top";break;case"insideBottom":d.style.textX=d.style.x+d.style.width/2,d.style.textY=d.style.y+d.style.height-b/2,d.style.textAlign="center",d.style.textBaseline="bottom"}d.style.textPosition="specific",d.style.textColor=d.style.textColor||"#fff"}if(this.deepQuery([f,g,this.option],"calculable"))this.setCalculable(d),d.draggable=!0;return s.pack(d,p[e],e,p[e].data[t],t,i),d},getMarkCoord:function(e,t){var i,o,n=this.series[e],s=this.xMarkMap[e],r=this.component.xAxis.getAxis(n.xAxisIndex),a=this.component.yAxis.getAxis(n.yAxisIndex);if(t.type&&("max"==t.type||"min"==t.type||"average"==t.type))o=[s[t.type+"X"],s[t.type+"Y"],s[t.type+"Line"],s[t.type]];else if(s.isHorizontal){i="string"==typeof t.xAxis&&r.getIndexByName?r.getIndexByName(t.xAxis):t.xAxis||0;var l=s[i];l="undefined"!=typeof l?l:"string"!=typeof t.xAxis&&r.getCoordByIndex?r.getCoordByIndex(t.xAxis||0):r.getCoord(t.xAxis||0),o=[l,a.getCoord(t.yAxis||0)]}else{i="string"==typeof t.yAxis&&a.getIndexByName?a.getIndexByName(t.yAxis):t.yAxis||0;var h=s[i];h="undefined"!=typeof h?h:"string"!=typeof t.yAxis&&a.getCoordByIndex?a.getCoordByIndex(t.yAxis||0):a.getCoord(t.yAxis||0),o=[r.getCoord(t.xAxis||0),h]}return o},refresh:function(e){if(e)this.option=e,this.series=e.series;this.backupShapeList(),this._buildShape()},addDataAnimation:function(e){for(var t=this.series,i={},o=0,n=e.length;n>o;o++)i[e[o][0]]=e[o];for(var r,a,l,h,d,p,g,o=this.shapeList.length-1;o>=0;o--)if(p=s.get(this.shapeList[o],"seriesIndex"),i[p]&&!i[p][3])if("rectangle"==this.shapeList[o].type){if(g=s.get(this.shapeList[o],"dataIndex"),d=t[p],i[p][2]&&g==d.data.length-1){this.zr.delShape(this.shapeList[o].id);continue}else if(!i[p][2]&&0===g){this.zr.delShape(this.shapeList[o].id);continue}if("horizontal"==this.shapeList[o]._orient)h=this.component.yAxis.getAxis(d.yAxisIndex||0).getGap(),l=i[p][2]?-h:h,r=0;else a=this.component.xAxis.getAxis(d.xAxisIndex||0).getGap(),r=i[p][2]?a:-a,l=0;this.shapeList[o].position=[0,0],this.zr.animate(this.shapeList[o].id,"").when(500,{position:[r,l]}).start()}}},r.inherits(e,i),r.inherits(e,t),require("../chart").define("bar",e),e});