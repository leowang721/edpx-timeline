/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/chart/scatter",["require","../component/base","./base","../util/shape/Symbol","../component/axis","../component/grid","../component/dataZoom","../component/dataRange","../config","zrender/tool/util","zrender/tool/color","../chart"],function(require){function e(e,s,a,r,o){t.call(this,e,s,a,r,o),i.call(this),this.refresh(r)}var t=require("../component/base"),i=require("./base"),s=require("../util/shape/Symbol");require("../component/axis"),require("../component/grid"),require("../component/dataZoom"),require("../component/dataRange");var a=require("../config"),r=require("zrender/tool/util"),o=require("zrender/tool/color");return e.prototype={type:a.CHART_TYPE_SCATTER,_buildShape:function(){var e=this.series;this._sIndex2ColorMap={},this._symbol=this.option.symbolList,this._sIndex2ShapeMap={},this.selectedMap={},this.xMarkMap={};for(var t,i,s,r,n=this.component.legend,h=[],l=0,p=e.length;p>l;l++)if(t=e[l],i=t.name,t.type==a.CHART_TYPE_SCATTER){if(e[l]=this.reformOption(e[l]),this._sIndex2ShapeMap[l]=this.query(t,"symbol")||this._symbol[l%this._symbol.length],n){if(this.selectedMap[i]=n.isSelected(i),this._sIndex2ColorMap[l]=o.alpha(n.getColor(i),.5),s=n.getItemShape(i)){var r=this._sIndex2ShapeMap[l];if(s.style.brushType=r.match("empty")?"stroke":"both",r=r.replace("empty","").toLowerCase(),r.match("rectangle"))s.style.x+=Math.round((s.style.width-s.style.height)/2),s.style.width=s.style.height;if(r.match("star"))s.style.n=r.replace("star","")-0||5,r="star";if(r.match("image"))s.style.image=r.replace(new RegExp("^image:\\/\\/"),""),s.style.x+=Math.round((s.style.width-s.style.height)/2),s.style.width=s.style.height,r="image";s.style.iconType=r,n.setItemShape(i,s)}}else this.selectedMap[i]=!0,this._sIndex2ColorMap[l]=this.zr.getColor(l);if(this.selectedMap[i])h.push(l)}this._buildSeries(h),this.addShapeList()},_buildSeries:function(e){if(0!==e.length){for(var t,i,s,a,r,o,n,h,l=this.series,p={},d=0,c=e.length;c>d;d++)if(t=e[d],i=l[t],0!==i.data.length){r=this.component.xAxis.getAxis(i.xAxisIndex||0),o=this.component.yAxis.getAxis(i.yAxisIndex||0),p[t]=[];for(var f=0,u=i.data.length;u>f;f++)if(s=i.data[f],a="undefined"!=typeof s?"undefined"!=typeof s.value?s.value:s:"-",!("-"==a||a.length<2))n=r.getCoord(a[0]),h=o.getCoord(a[1]),p[t].push([n,h,f,s.name||""]);else;this.xMarkMap[t]=this._markMap(r,o,i.data,p[t]),this.buildMark(t)}else;this._buildPointList(p)}},_markMap:function(e,t,i,s){for(var a,r={min0:Number.POSITIVE_INFINITY,max0:Number.NEGATIVE_INFINITY,sum0:0,counter0:0,average0:0,min1:Number.POSITIVE_INFINITY,max1:Number.NEGATIVE_INFINITY,sum1:0,counter1:0,average1:0},o=0,n=s.length;n>o;o++){if(a=i[s[o][2]].value||i[s[o][2]],r.min0>a[0])r.min0=a[0],r.minY0=s[o][1],r.minX0=s[o][0];if(r.max0<a[0])r.max0=a[0],r.maxY0=s[o][1],r.maxX0=s[o][0];if(r.sum0+=a[0],r.counter0++,r.min1>a[1])r.min1=a[1],r.minY1=s[o][1],r.minX1=s[o][0];if(r.max1<a[1])r.max1=a[1],r.maxY1=s[o][1],r.maxX1=s[o][0];r.sum1+=a[1],r.counter1++}var h=this.component.grid.getX(),l=this.component.grid.getXend(),p=this.component.grid.getY(),d=this.component.grid.getYend();r.average0=(r.sum0/r.counter0).toFixed(2)-0;var c=e.getCoord(r.average0);r.averageLine0=[[c,d],[c,p]],r.minLine0=[[r.minX0,d],[r.minX0,p]],r.maxLine0=[[r.maxX0,d],[r.maxX0,p]],r.average1=(r.sum1/r.counter1).toFixed(2)-0;var f=t.getCoord(r.average1);return r.averageLine1=[[h,f],[l,f]],r.minLine1=[[h,r.minY1],[l,r.minY1]],r.maxLine1=[[h,r.maxY1],[l,r.maxY1]],r},_buildPointList:function(e){var t,i,s,a,r=this.series;for(var o in e)if(t=r[o],i=e[o],!(t.large&&t.data.length>t.largeThreshold))for(var n=0,h=i.length;h>n;n++)s=i[n],a=this._getSymbol(o,s[2],s[3],s[0],s[1]),a&&this.shapeList.push(a);else this.shapeList.push(this._getLargeSymbol(i,this.getItemStyleColor(this.query(t,"itemStyle.normal.color"),o,-1)||this._sIndex2ColorMap[o]))},_getSymbol:function(e,t,i,s,a){var r,o=this.series,n=o[e],h=n.data[t],l=this.component.dataRange;if(l){if(r=isNaN(h[2])?this._sIndex2ColorMap[e]:l.getColor(h[2]),!r)return null}else r=this._sIndex2ColorMap[e];var p=this.getSymbolShape(n,e,h,t,i,s,a,this._sIndex2ShapeMap[e],r,"rgba(0,0,0,0)","vertical");return p.zlevel=this._zlevelBase,p._main=!0,p},_getLargeSymbol:function(e,t){return new s({zlevel:this._zlevelBase,_main:!0,hoverable:!1,style:{pointList:e,color:t,strokeColor:t},highlightStyle:{pointList:[]}})},getMarkCoord:function(e,t){var i,s=this.series[e],a=this.xMarkMap[e],r=this.component.xAxis.getAxis(s.xAxisIndex),o=this.component.yAxis.getAxis(s.yAxisIndex);if(t.type&&("max"==t.type||"min"==t.type||"average"==t.type)){var n="undefined"!=typeof t.valueIndex?t.valueIndex:1;i=[a[t.type+"X"+n],a[t.type+"Y"+n],a[t.type+"Line"+n],a[t.type+n]]}else i=["string"!=typeof t.xAxis&&r.getCoordByIndex?r.getCoordByIndex(t.xAxis||0):r.getCoord(t.xAxis||0),"string"!=typeof t.yAxis&&o.getCoordByIndex?o.getCoordByIndex(t.yAxis||0):o.getCoord(t.yAxis||0)];return i},refresh:function(e){if(e)this.option=e,this.series=e.series;this.backupShapeList(),this._buildShape()},ondataRange:function(e,t){if(this.component.dataRange)this.refresh(),t.needRefresh=!0}},r.inherits(e,i),r.inherits(e,t),require("../chart").define("scatter",e),e});