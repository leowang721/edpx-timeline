/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/chart/pie",["require","../component/base","./base","zrender/shape/Text","zrender/shape/Ring","zrender/shape/Circle","zrender/shape/Sector","zrender/shape/BrokenLine","../config","../util/ecData","zrender/tool/util","zrender/tool/math","zrender/tool/color","../chart"],function(require){function e(e,s,a,r,o){t.call(this,e,s,a,r,o),i.call(this);var n=this;n.shapeHandler.onmouseover=function(e){var t=e.target,i=l.get(t,"seriesIndex"),s=l.get(t,"dataIndex"),a=l.get(t,"special"),r=t._lastAddRadius,o=t.style.startAngle,h=t.style.endAngle,p=t.highlightStyle.color,d=n.getLabel(i,s,a,r,o,h,p,!0);if(d)n.zr.addHoverShape(d);var c=n.getLabelLine(i,s,r,t.style.r0,t.style.r,o,h,p,!0);if(c)n.zr.addHoverShape(c)},this.refresh(r)}var t=require("../component/base"),i=require("./base"),s=require("zrender/shape/Text"),a=require("zrender/shape/Ring"),r=require("zrender/shape/Circle"),o=require("zrender/shape/Sector"),n=require("zrender/shape/BrokenLine"),h=require("../config"),l=require("../util/ecData"),p=require("zrender/tool/util"),d=require("zrender/tool/math"),c=require("zrender/tool/color");return e.prototype={type:h.CHART_TYPE_PIE,_buildShape:function(){var e=this.series,t=this.component.legend;this.selectedMap={},this._selected={};var i,s,o;this._selectedMode=!1;for(var n,p=0,d=e.length;d>p;p++)if(e[p].type==h.CHART_TYPE_PIE){if(e[p]=this.reformOption(e[p]),n=e[p].name||"",this.selectedMap[n]=t?t.isSelected(n):!0,!this.selectedMap[n])continue;if(i=this.parseCenter(this.zr,e[p].center),s=this.parseRadius(this.zr,e[p].radius),this._selectedMode=this._selectedMode||e[p].selectedMode,this._selected[p]=[],this.deepQuery([e[p],this.option],"calculable"))o={zlevel:this._zlevelBase,hoverable:!1,style:{x:i[0],y:i[1],r0:s[0]<=10?0:s[0]-10,r:s[1]+10,brushType:"stroke",lineWidth:1,strokeColor:e[p].calculableHolderColor||this.ecTheme.calculableHolderColor}},l.pack(o,e[p],p,void 0,-1),this.setCalculable(o),o=s[0]<=10?new r(o):new a(o),this.shapeList.push(o);this._buildSinglePie(p),this.buildMark(p)}this.addShapeList()},_buildSinglePie:function(e){for(var t,i=this.series,s=i[e],a=s.data,r=this.component.legend,o=0,n=0,h=0,l=Number.NEGATIVE_INFINITY,p=0,d=a.length;d>p;p++){if(t=a[p].name,r)this.selectedMap[t]=r.isSelected(t);else this.selectedMap[t]=!0;if(this.selectedMap[t]&&!isNaN(a[p].value)){if(0!==+a[p].value)o++;else n++;h+=+a[p].value,l=Math.max(l,+a[p].value)}}for(var c,f,u,y,m,g,_=100,v=0,b=s.clockWise,x=s.startAngle.toFixed(2)-0,S=s.minAngle||.01,M=360-S*o-.01*n,L=s.roseType,p=0,d=a.length;d>p;p++)if(t=a[p].name,this.selectedMap[t]&&!isNaN(a[p].value)){if(r)u=r.getColor(t);else u=this.zr.getColor(p);if(c=_,_=a[p].value/h,"area"!=L)f=b?x-_*M-(0!==_?S:.01):_*M+x+(0!==_?S:.01);else f=b?x-360/d:360/d+x;if(f=f.toFixed(2)-0,_=(100*_).toFixed(2),y=this.parseRadius(this.zr,s.radius),m=+y[0],g=+y[1],"radius"==L)g=a[p].value/l*(g-m)*.8+.2*(g-m)+m;else if("area"==L)g=Math.sqrt(a[p].value/l)*(g-m)+m;if(b){var C;C=x,x=f,f=C}if(p>0&&Math.abs(x-f)<15&&4>c&&this._needLabel(s,a[p],!1)&&"center"!=this.deepQuery([a[p],s],"itemStyle.normal.label.position"))v+=4>_?20:-20;else v=0;if(this._buildItem(e,p,_,v,a[p].selected,m,g,x,f,u),!b)x=f}else;},_buildItem:function(e,t,i,s,a,r,o,n,h,p){var d=this.series,c=this.getSector(e,t,i,a,r,o,n,h,p);l.pack(c,d[e],e,d[e].data[t],t,d[e].data[t].name,i),c._lastAddRadius=s,this.shapeList.push(c);var f=this.getLabel(e,t,i,s,n,h,p,!1);if(f)l.pack(f,d[e],e,d[e].data[t],t,d[e].data[t].name,i),f._dataIndex=t,this.shapeList.push(f);var u=this.getLabelLine(e,t,s,r,o,n,h,p,!1);if(u)l.pack(u,d[e],e,d[e].data[t],t,d[e].data[t].name,i),u._dataIndex=t,this.shapeList.push(u)},getSector:function(e,t,i,s,a,r,n,h,l){var p=this.series,f=p[e],u=f.data[t],y=[u,f],m=this.parseCenter(this.zr,f.center),g=this.deepMerge(y,"itemStyle.normal")||{},_=this.deepMerge(y,"itemStyle.emphasis")||{},v=this.getItemStyleColor(g.color,e,t,u)||l,b=this.getItemStyleColor(_.color,e,t,u)||("string"==typeof v?c.lift(v,-.2):v),x={zlevel:this._zlevelBase,clickable:this.deepQuery(y,"clickable"),style:{x:m[0],y:m[1],r0:a,r:r,startAngle:n,endAngle:h,brushType:"both",color:v,lineWidth:g.borderWidth,strokeColor:g.borderColor,lineJoin:"round"},highlightStyle:{color:b,lineWidth:_.borderWidth,strokeColor:_.borderColor,lineJoin:"round"},_seriesIndex:e,_dataIndex:t};if(s){var S=((x.style.startAngle+x.style.endAngle)/2).toFixed(2)-0;x.style._hasSelected=!0,x.style._x=x.style.x,x.style._y=x.style.y;var M=this.query(f,"selectedOffset");x.style.x+=d.cos(S,!0)*M,x.style.y-=d.sin(S,!0)*M,this._selected[e][t]=!0}else this._selected[e][t]=!1;if(this._selectedMode)x.onclick=this.shapeHandler.onclick;if(this.deepQuery([u,f,this.option],"calculable"))this.setCalculable(x),x.draggable=!0;if(this._needLabel(f,u,!0)||this._needLabelLine(f,u,!0))x.onmouseover=this.shapeHandler.onmouseover;return x=new o(x)},getLabel:function(e,t,i,a,r,o,n,h){var l=this.series,c=l[e],f=c.data[t];if(this._needLabel(c,f,h)){var u,y,m,g=h?"emphasis":"normal",_=p.merge(p.clone(f.itemStyle)||{},c.itemStyle),v=_[g].label,b=v.textStyle||{},x=this.parseCenter(this.zr,c.center),S=x[0],M=x[1],L=((o+r)/2+360)%360,C=this.parseRadius(this.zr,c.radius),z="middle";if(v.position=v.position||_.normal.label.position,"center"==v.position)C=C[1],u=S,y=M,m="center";else if("inner"==v.position)C=(C[0]+C[1])/2+a,u=Math.round(S+C*d.cos(L,!0)),y=Math.round(M-C*d.sin(L,!0)),n="#fff",m="center";else C=C[1]- -_[g].labelLine.length+a,u=S+C*d.cos(L,!0),y=M-C*d.sin(L,!0),m=L>=90&&270>=L?"right":"left";if("center"!=v.position&&"inner"!=v.position)u+="left"==m?20:-20;return f.__labelX=u-("left"==m?5:-5),f.__labelY=y,new s({zlevel:this._zlevelBase+1,hoverable:!1,style:{x:u,y:y,color:b.color||n,text:this.getLabelText(e,t,i,g),textAlign:b.align||m,textBaseline:b.baseline||z,textFont:this.getFont(b)},highlightStyle:{brushType:"fill"},_seriesIndex:e,_dataIndex:t})}},getLabelText:function(e,t,i,s){var a=this.series,r=a[e],o=r.data[t],n=this.deepQuery([o,r],"itemStyle."+s+".label.formatter");if(n){if("function"==typeof n)return n.call(this.myChart,r.name,o.name,o.value,i);else if("string"==typeof n)return n=n.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}").replace("{d}","{d0}"),n=n.replace("{a0}",r.name).replace("{b0}",o.name).replace("{c0}",o.value).replace("{d0}",i)}else return o.name},getLabelLine:function(e,t,i,s,a,r,o,h,l){var c=this.series,f=c[e],u=f.data[t];if(this._needLabelLine(f,u,l)){var y=l?"emphasis":"normal",m=p.merge(p.clone(u.itemStyle)||{},f.itemStyle),g=m[y].labelLine,_=g.lineStyle||{},v=this.parseCenter(this.zr,f.center),b=v[0],x=v[1],S=a,M=this.parseRadius(this.zr,f.radius)[1]- -g.length+i,L=(o+r)/2%360,C=d.cos(L,!0),z=d.sin(L,!0);return new n({zlevel:this._zlevelBase+1,hoverable:!1,style:{pointList:[[b+S*C,x-S*z],[b+M*C,x-M*z],[u.__labelX,u.__labelY]],strokeColor:_.color||h,lineType:_.type,lineWidth:_.width},_seriesIndex:e,_dataIndex:t})}else;},_needLabel:function(e,t,i){return this.deepQuery([t,e],"itemStyle."+(i?"emphasis":"normal")+".label.show")},_needLabelLine:function(e,t,i){return this.deepQuery([t,e],"itemStyle."+(i?"emphasis":"normal")+".labelLine.show")},reformOption:function(e){var t=p.merge;return e=t(e||{},this.ecTheme.pie),e.itemStyle.normal.label.textStyle=t(e.itemStyle.normal.label.textStyle||{},this.ecTheme.textStyle),e.itemStyle.emphasis.label.textStyle=t(e.itemStyle.emphasis.label.textStyle||{},this.ecTheme.textStyle),e},refresh:function(e){if(e)this.option=e,this.series=e.series;this.backupShapeList(),this._buildShape()},addDataAnimation:function(e){for(var t=this.series,i={},s=0,a=e.length;a>s;s++)i[e[s][0]]=e[s];var r={},o={},n={},l=this.shapeList;this.shapeList=[];for(var p,d,c,f={},s=0,a=e.length;a>s;s++)if(p=e[s][0],d=e[s][2],c=e[s][3],t[p]&&t[p].type==h.CHART_TYPE_PIE){if(d){if(!c)r[p+"_"+t[p].data.length]="delete";f[p]=1}else if(!c)r[p+"_-1"]="delete",f[p]=-1;else f[p]=0;this._buildSinglePie(p)}for(var u,y,s=0,a=this.shapeList.length;a>s;s++)switch(p=this.shapeList[s]._seriesIndex,u=this.shapeList[s]._dataIndex,y=p+"_"+u,this.shapeList[s].type){case"sector":r[y]=this.shapeList[s];break;case"text":o[y]=this.shapeList[s];break;case"broken-line":n[y]=this.shapeList[s]}this.shapeList=[];for(var m,s=0,a=l.length;a>s;s++)if(p=l[s]._seriesIndex,i[p]){if(u=l[s]._dataIndex+f[p],y=p+"_"+u,m=r[y],!m)continue;if("sector"==l[s].type)if("delete"!=m)this.zr.animate(l[s].id,"style").when(400,{startAngle:m.style.startAngle,endAngle:m.style.endAngle}).start();else this.zr.animate(l[s].id,"style").when(400,f[p]<0?{startAngle:l[s].style.startAngle}:{endAngle:l[s].style.endAngle}).start();else if("text"==l[s].type||"broken-line"==l[s].type)if("delete"==m)this.zr.delShape(l[s].id);else switch(l[s].type){case"text":m=o[y],this.zr.animate(l[s].id,"style").when(400,{x:m.style.x,y:m.style.y}).start();break;case"broken-line":m=n[y],this.zr.animate(l[s].id,"style").when(400,{pointList:m.style.pointList}).start()}}this.shapeList=l},onclick:function(e){var t=this.series;if(this.isClick&&e.target){this.isClick=!1;for(var i,s=e.target,a=s.style,r=l.get(s,"seriesIndex"),o=l.get(s,"dataIndex"),n=0,p=this.shapeList.length;p>n;n++)if(this.shapeList[n].id==s.id){if(r=l.get(s,"seriesIndex"),o=l.get(s,"dataIndex"),!a._hasSelected){var c=((a.startAngle+a.endAngle)/2).toFixed(2)-0;s.style._hasSelected=!0,this._selected[r][o]=!0,s.style._x=s.style.x,s.style._y=s.style.y,i=this.query(t[r],"selectedOffset"),s.style.x+=d.cos(c,!0)*i,s.style.y-=d.sin(c,!0)*i}else s.style.x=s.style._x,s.style.y=s.style._y,s.style._hasSelected=!1,this._selected[r][o]=!1;this.zr.modShape(s.id,s)}else if(this.shapeList[n].style._hasSelected&&"single"==this._selectedMode)r=l.get(this.shapeList[n],"seriesIndex"),o=l.get(this.shapeList[n],"dataIndex"),this.shapeList[n].style.x=this.shapeList[n].style._x,this.shapeList[n].style.y=this.shapeList[n].style._y,this.shapeList[n].style._hasSelected=!1,this._selected[r][o]=!1,this.zr.modShape(this.shapeList[n].id,this.shapeList[n]);this.messageCenter.dispatch(h.EVENT.PIE_SELECTED,e.event,{selected:this._selected,target:l.get(s,"name")},this.myChart),this.zr.refresh()}}},p.inherits(e,i),p.inherits(e,t),require("../chart").define("pie",e),e});