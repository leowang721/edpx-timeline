/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/chart/chord",["require","../component/base","./base","zrender/shape/Text","zrender/shape/Line","zrender/shape/Sector","../util/shape/Chord","../config","../util/ecData","zrender/tool/util","zrender/tool/vector","../util/ndarray","../chart"],function(require){"use strict";function e(e,r,s,o,a){t.call(this,e,r,s,o,a),i.call(this),this.refresh(o)}var t=require("../component/base"),i=require("./base"),r=require("zrender/shape/Text"),s=require("zrender/shape/Line"),o=require("zrender/shape/Sector"),a=require("../util/shape/Chord"),n=require("../config"),l=require("../util/ecData"),h=require("zrender/tool/util"),d=require("zrender/tool/vector"),p=require("../util/ndarray"),c=window.devicePixelRatio||1;return e.prototype={type:n.CHART_TYPE_CHORD,_buildShape:function(){var e=this.series;this.selectedMap={},this.chordSeries=[],this.chordSerieSample=null;for(var t=[],i=0,r=0,s=e.length;s>r;r++)if(e[r].type===this.type){if(!this.chordSerieSample)this.chordSerieSample=e[r],this.reformOption(this.chordSerieSample);var o=this.isSelected(e[r].name);if(this.selectedMap[e[r].name]=o,!o)continue;this.chordSeries.push(e[r]),this.buildMark(r),t.push(e[r].matrix),i++}if(this.chordSerieSample){if(!this.chordSeries.length)return void this.addShapeList();var a=this.zr.getWidth(),n=this.zr.getHeight(),l=Math.min(a,n);if(this.groups=this.chordSerieSample.data,this.startAngle=this.chordSerieSample.startAngle,this.startAngle=this.startAngle%360,this.startAngle<0)this.startAngle=this.startAngle+360;this.clockWise=this.chordSerieSample.clockWise,this.innerRadius=this.parsePercent(this.chordSerieSample.radius[0],l/2),this.outerRadius=this.parsePercent(this.chordSerieSample.radius[1],l/2),this.padding=this.chordSerieSample.padding,this.sortGroups=this.chordSerieSample.sort,this.sortSubGroups=this.chordSerieSample.sortSub,this.showScale=this.chordSerieSample.showScale,this.showScaleText=this.chordSerieSample.showScaleText,this.center=[this.parsePercent(this.chordSerieSample.center[0],a),this.parsePercent(this.chordSerieSample.center[1],n)];var h=this.chordSerieSample.itemStyle.normal.chordStyle.lineStyle.width-this.chordSerieSample.itemStyle.normal.lineStyle.width;this.strokeFix=h/c/this.innerRadius/Math.PI*180,this.dataMat=new p(t),this.dataMat=this.dataMat._transposelike([1,2,0]);var d=this._filterData(this.dataMat,this.groups);this.dataMat=d[0],this.groups=d[1];var f=this.dataMat.shape();if(f[0]!==f[1]||f[0]!==this.groups.length)throw new Error("Data not valid");if(0===f[0]||0===f[2])return void this.addShapeList();this.dataMat.reshape(f[0],f[1]*f[2]);var y=this.dataMat.sum(1),g=y.mul(1/y.sum()),u=f[0],m=f[1]*f[2],S=g.mul(360-this.padding*u),v=this.dataMat.div(this.dataMat.sum(1).reshape(u,1));switch(v=v.mul(S.sub(2*this.strokeFix).reshape(u,1)),this.sortGroups){case"ascending":case"descending":var b=S.argsort(0,this.sortGroups);S.sort(0,this.sortGroups),y.sort(0,this.sortGroups);break;default:var b=p.range(f[0])}switch(this.sortSubGroups){case"ascending":case"descending":var x=v.argsort(1,this.sortSubGroups);v.sort(1,this.sortSubGroups);break;default:var x=p.range(m).reshape(1,m).repeat(u,0)}for(var _=b.toArray(),C=S.toArray(),k=x.toArray(),A=v.toArray(),z=y.toArray(),M=[],L=new p(u,m).toArray(),I=[],T=0,w=0,r=0;u>r;r++){var P=_[r];I[P]=z[r],w=T+C[r],M[P]=[T,w];for(var R=T+this.strokeFix,E=R,B=0;m>B;B++){E=R+A[P][B];var W=k[P][B];L[P][W]=[R,E],R=E}T=w+this.padding}this.chordShapes=new p(u,u,i).toArray(),this.sectorShapes=[],this._buildSectors(M,I),L=new p(L).reshape(u,u,i,2).toArray(),this._buildChords(L,this.dataMat.reshape(f).toArray());var d=this.normalizeValue(I);if(this.showScale)this._buildScales(d[0],d[1],M,new p(d[0]).sum()/(360-this.padding*u));this.addShapeList()}},_filterData:function(e,t){for(var i=[],r=[],s=0;s<t.length;s++){var o=t[s].name;if(this.selectedMap[o]=this.isSelected(o),!this.selectedMap[o])i.push(s);else r.push(t[s])}if(i.length)e=e["delete"](i,0),e=e["delete"](i,1);if(!e.size())return[e,r];i=[];var a=[],n=e.shape();e.reshape(n[0],n[1]*n[2]);var l=e.sum(1).toArray();e.reshape(n);for(var s=0;s<r.length;s++)if(0===l[s])i.push(s);else a.push(r[s]);if(i.length)e=e["delete"](i,0),e=e["delete"](i,1);return[e,a]},_buildSectors:function(e,t){function i(e){return function(){if(a)clearTimeout(a);a=setTimeout(function(){for(var t=0;n>t;t++){g.sectorShapes[t].style.opacity=t===e?1:.1,g.zr.modShape(g.sectorShapes[t].id);for(var i=0;n>i;i++)for(var r=0;h>r;r++){var s=g.chordShapes[t][i][r];if(s)s.style.opacity=t===e||i===e?.5:.03,g.zr.modShape(s.id)}}g.zr.refresh()},50)}}function s(){return function(){if(a)clearTimeout(a);a=setTimeout(function(){for(var e=0;n>e;e++){g.sectorShapes[e].style.opacity=1,g.zr.modShape(g.sectorShapes[e].id);for(var t=0;n>t;t++)for(var i=0;h>i;i++){var r=g.chordShapes[e][t][i];if(r)r.style.opacity=.5,g.zr.modShape(r.id)}}g.zr.refresh()},50)}}for(var a,n=this.groups.length,h=this.chordSeries.length,p=this.query(this.chordSerieSample,"itemStyle.normal.label.show"),c=this.query(this.chordSerieSample,"itemStyle.normal.label.color"),f=this.query(this.chordSerieSample,"itemStyle.normal.label.rotate"),y=this.query(this.chordSerieSample,"itemStyle.normal.label.distance"),g=this,u=0;n>u;u++){var m=this.groups[u],S=e[u],v=(this.clockWise?360-S[1]:S[0])+this.startAngle,b=(this.clockWise?360-S[0]:S[1])+this.startAngle,x={zlevel:this._zlevelBase,style:{x:this.center[0],y:this.center[1],r0:this.innerRadius,r:this.outerRadius,startAngle:v,endAngle:b,brushType:"fill",opacity:1,color:this.getColor(m.name)},clickable:this.chordSerieSample.clickable,highlightStyle:{brushType:"fill"}};if(x.style.lineWidth=this.deepQuery([m,this.chordSerieSample],"itemStyle.normal.lineStyle.width"),x.highlightStyle.lineWidth=this.deepQuery([m,this.chordSerieSample],"itemStyle.emphasis.lineStyle.width"),x.style.strokeColor=this.deepQuery([m,this.chordSerieSample],"itemStyle.normal.lineStyle.color"),x.highlightStyle.strokeColor=this.deepQuery([m,this.chordSerieSample],"itemStyle.emphasis.lineStyle.color"),x.style.lineWidth>0)x.style.brushType="both";if(x.highlightStyle.lineWidth>0)x.highlightStyle.brushType="both";if(l.pack(x,this.chordSeries[0],0,t[u],u,m.name),p){var _=[v+b]/2;_%=360;var C=90>=_||_>=270;_=_*Math.PI/180;var k=[Math.cos(_),-Math.sin(_)],A=this.showScaleText?35+y:y,z=d.scale([],k,this.outerRadius+A);d.add(z,z,this.center);var M={zlevel:this._zlevelBase-1,hoverable:!1,style:{text:m.name,textAlign:C?"left":"right",color:c}};if(f){if(M.rotation=C?_:Math.PI+_,C)M.style.x=this.outerRadius+A;else M.style.x=-this.outerRadius-A;M.style.y=0,M.position=this.center}else M.style.x=z[0],M.style.y=z[1];M.style.textColor=this.deepQuery([m,this.chordSerieSample],"itemStyle.normal.label.textStyle.color")||"#fff",M.style.textFont=this.getFont(this.deepQuery([m,this.chordSerieSample],"itemStyle.normal.label.textStyle")),M=new r(M),this.shapeList.push(M)}x.onmouseover=i(u),x.onmouseout=s(),x=new o(x),this.shapeList.push(x),this.sectorShapes.push(x)}},_buildChords:function(e,t){var i=e.length;if(i)for(var r=e[0][0].length,s=this.chordSerieSample.itemStyle.normal.chordStyle.lineStyle,o=this.chordSerieSample.itemStyle.emphasis.chordStyle.lineStyle,n=0;i>n;n++)for(var h=0;i>h;h++)for(var d=0;r>d;d++)if(!this.chordShapes[h][n][d]){var p=e[n][h][d][0],c=e[h][n][d][0],f=e[n][h][d][1],y=e[h][n][d][1];if(p-y!==0&&c-y!==0){var g;if(1===r)if(y-c>=f-p)g=this.getColor(this.groups[n].name);else g=this.getColor(this.groups[h].name);else g=this.getColor(this.chordSeries[d].name);var u=!this.clockWise?360-f:p,m=!this.clockWise?360-p:f,S=!this.clockWise?360-y:c,v=!this.clockWise?360-c:y,b={zlevel:this._zlevelBase,style:{center:this.center,r:this.innerRadius,source0:u-this.startAngle,source1:m-this.startAngle,target0:S-this.startAngle,target1:v-this.startAngle,brushType:"both",opacity:.5,color:g,lineWidth:s.width,strokeColor:s.color},clickable:this.chordSerieSample.clickable,highlightStyle:{brushType:"both",lineWidth:o.width,strokeColor:o.color}};l.pack(b,this.chordSeries[d],d,t[n][h][d],n+"-"+h,this.groups[n].name,this.groups[h].name,t[h][n][d]),b=new a(b),this.chordShapes[n][h][d]=b,this.shapeList.push(b)}else this.chordShapes[n][h][d]=null}else;},_buildScales:function(e,t,i,o){for(var a=0;a<i.length;a++){for(var n=i[a][0],l=i[a][1],h=n;l>h;){var c=((this.clockWise?360-h:h)+this.startAngle)/180*Math.PI,f=[Math.cos(c),-Math.sin(c)],y=d.scale([],f,this.outerRadius+1);d.add(y,y,this.center);var g=d.scale([],f,this.outerRadius+this.scaleLineLength);d.add(g,g,this.center);var u={zlevel:this._zlevelBase-1,hoverable:!1,style:{xStart:y[0],yStart:y[1],xEnd:g[0],yEnd:g[1],lineCap:"round",brushType:"stroke",strokeColor:"#666",lineWidth:1}};u=new s(u),this.shapeList.push(u),h+=this.scaleUnitAngle}if(this.showScaleText)for(var m=n,S=5*o*this.scaleUnitAngle,v=p.range(0,e[a],S).toArray();l>m;){var c=this.clockWise?360-m:m;c=(c+this.startAngle)%360;var b=90>=c||c>=270,x={zlevel:this._zlevelBase-1,hoverable:!1,style:{x:b?this.outerRadius+this.scaleLineLength+4:-this.outerRadius-this.scaleLineLength-4,y:0,text:Math.round(10*v.shift())/10+t,textAlign:b?"left":"right"},position:this.center.slice(),rotation:b?[c/180*Math.PI,0,0]:[(c+180)/180*Math.PI,0,0]};x=new r(x),this.shapeList.push(x),m+=5*this.scaleUnitAngle}else;}},normalizeValue:function(e){var t,i,r=[],s=new p(e).max();if(s>1e4)t="k",i=.001;else if(s>1e7)t="m",i=1e-6;else if(s>1e10)t="b",i=1e-9;else t="",i=1;for(var o=0;o<e.length;o++)r[o]=e[o]*i;return[r,t]},refresh:function(e){if(e)this.option=e,this.series=e.series;if(this.chordSeries=[],this.strokeFix=0,this.sectorShapes=[],this.chordShapes=[],this.scaleLineLength=4,this.scaleUnitAngle=4,this.legend=this.component.legend,this.legend)this.getColor=function(e){return this.legend.getColor(e)},this.isSelected=function(e){return this.legend.isSelected(e)};else{var t={},i={},r=0;this.getColor=function(e){if(i[e])return i[e];if(void 0===t[e])t[e]=r++;for(var s=0;s<this.chordSeries.length;s++)if(this.chordSeries[s].name===e){i[e]=this.query(this.chordSeries[s],"itemStyle.normal.color");break}if(!i[e])for(var o=this.groups.length,s=0;o>s;s++)if(this.groups[s].name===e){i[e]=this.query(this.groups[s],"itemStyle.normal.color");break}if(!i[e])i[e]=this.zr.getColor(t[e]);return i[e]},this.isSelected=function(){return!0}}this.backupShapeList(),this._buildShape()},reformOption:function(e){var t=h.merge;e=t(e||{},this.ecTheme.chord),e.itemStyle.normal.label.textStyle=t(e.itemStyle.normal.label.textStyle||{},this.ecTheme.textStyle)}},h.inherits(e,i),h.inherits(e,t),require("../chart").define("chord",e),e});