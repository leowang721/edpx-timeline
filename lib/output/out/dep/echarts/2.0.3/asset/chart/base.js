/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/chart/base",["require","zrender/shape/Image","../util/shape/Icon","../util/shape/MarkLine","../util/shape/Symbol","../config","../util/ecData","../util/ecAnimation","../util/ecEffect","../util/accMath","zrender/tool/util","zrender/tool/area"],function(require){function e(){var e=this;this.selectedMap={},this.lastShapeList=[],this.shapeHandler={onclick:function(){e.isClick=!0},ondragover:function(t){var i=t.target;i.highlightStyle=i.highlightStyle||{};var o=i.highlightStyle,a=o.brushTyep,r=o.strokeColor,s=o.lineWidth;o.brushType="stroke",o.strokeColor=e.ecTheme.calculableColor,o.lineWidth="icon"==i.type?30:10,e.zr.addHoverShape(i),setTimeout(function(){if(i.highlightStyle)i.highlightStyle.brushType=a,i.highlightStyle.strokeColor=r,i.highlightStyle.lineWidth=s},20)},ondrop:function(t){if("undefined"!=typeof s.get(t.dragged,"data"))e.isDrop=!0},ondragend:function(){e.isDragend=!0}}}var t=require("zrender/shape/Image"),i=require("../util/shape/Icon"),o=require("../util/shape/MarkLine"),a=require("../util/shape/Symbol"),r=require("../config"),s=require("../util/ecData"),n=require("../util/ecAnimation"),l=require("../util/ecEffect"),h=require("../util/accMath"),d=require("zrender/tool/util"),p=require("zrender/tool/area");return e.prototype={setCalculable:function(e){return e.dragEnableTime=this.ecTheme.DRAG_ENABLE_TIME,e.ondragover=this.shapeHandler.ondragover,e.ondragend=this.shapeHandler.ondragend,e.ondrop=this.shapeHandler.ondrop,e},ondrop:function(e,t){if(this.isDrop&&e.target){var i,o=e.target,a=e.dragged,n=s.get(o,"seriesIndex"),l=s.get(o,"dataIndex"),d=this.series,p=this.component.legend;if(-1==l){if(i={value:s.get(a,"value"),name:s.get(a,"name")},this.type==r.CHART_TYPE_PIE&&i.value<0)i.value=0;for(var f=!1,y=d[n].data,g=0,c=y.length;c>g;g++)if(y[g].name==i.name&&"-"==y[g].value)d[n].data[g].value=i.value,f=!0;!f&&d[n].data.push(i),p&&p.add(i.name,a.style.color||a.style.strokeColor)}else if(i=this.option.series[n].data[l]||"-","undefined"!=typeof i.value){if("-"!=i.value)this.option.series[n].data[l].value=h.accAdd(this.option.series[n].data[l].value,s.get(a,"value"));else this.option.series[n].data[l].value=s.get(a,"value");if(this.type==r.CHART_TYPE_FUNNEL||this.type==r.CHART_TYPE_PIE)p&&1==p.getRelatedAmount(i.name)&&this.component.legend.del(i.name),i.name+=this.option.nameConnector+s.get(a,"name"),p&&p.add(i.name,a.style.color||a.style.strokeColor)}else if("-"!=i)this.option.series[n].data[l]=h.accAdd(this.option.series[n].data[l],s.get(a,"value"));else this.option.series[n].data[l]=s.get(a,"value");t.dragIn=t.dragIn||!0,this.isDrop=!1;var m=this;setTimeout(function(){m.zr.trigger("mousemove",e.event)},300)}},ondragend:function(e,t){if(this.isDragend&&e.target){var i=e.target,o=s.get(i,"seriesIndex"),a=s.get(i,"dataIndex"),r=this.series;if("undefined"!=typeof r[o].data[a].value){r[o].data[a].value="-";var n=r[o].data[a].name;if(this.component.legend&&0===this.component.legend.getRelatedAmount(n))this.component.legend.del(n)}else r[o].data[a]="-";t.dragOut=!0,t.needRefresh=!0,this.isDragend=!1}},onlegendSelected:function(e,t){var i=e.selected;for(var o in this.selectedMap){if(this.selectedMap[o]!=i[o])t.needRefresh=!0;this.selectedMap[o]=i[o]}},addLabel:function(e,t,i,o,a){var r=[i,t],s=this.deepMerge(r,"itemStyle.normal.label"),n=this.deepMerge(r,"itemStyle.emphasis.label"),l=s.textStyle||{},h=n.textStyle||{};if(s.show)e.style.text=this._getLabelText(t,i,o,"normal"),e.style.textPosition="undefined"==typeof s.position?"horizontal"==a?"right":"top":s.position,e.style.textColor=l.color,e.style.textFont=this.getFont(l);if(n.show)e.highlightStyle.text=this._getLabelText(t,i,o,"emphasis"),e.highlightStyle.textPosition=s.show?e.style.textPosition:"undefined"==typeof n.position?"horizontal"==a?"right":"top":n.position,e.highlightStyle.textColor=h.color,e.highlightStyle.textFont=this.getFont(h);return e},_getLabelText:function(e,t,i,o){var a=this.deepQuery([t,e],"itemStyle."+o+".label.formatter");if(!a&&"emphasis"==o)a=this.deepQuery([t,e],"itemStyle.normal.label.formatter");var r="undefined"!=typeof t?"undefined"!=typeof t.value?t.value:t:"-";if(a){if("function"==typeof a)return a.call(this.myChart,e.name,i,r);else if("string"==typeof a)return a=a.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}"),a=a.replace("{a0}",e.name).replace("{b0}",i).replace("{c0}",r)}else return r},buildMark:function(e){var t=this.series[e];if(this.selectedMap[t.name])t.markPoint&&this._buildMarkPoint(e),t.markLine&&this._buildMarkLine(e)},_buildMarkPoint:function(e){for(var t,i,o=(this.markAttachStyle||{})[e],a=this.series[e],s=this.getZlevelBase(),n=d.clone(a.markPoint),l=0,h=n.data.length;h>l;l++)if(t=n.data[l],i=this.getMarkCoord(e,t),n.data[l].x="undefined"!=typeof t.x?t.x:i[0],n.data[l].y="undefined"!=typeof t.y?t.y:i[1],t.type&&("max"==t.type||"min"==t.type))n.data[l].value=i[3],n.data[l].name=t.name||t.type,n.data[l].symbolSize=n.data[l].symbolSize||p.getTextWidth(i[3],this.getFont())/2+5;for(var f=this._markPoint(e,n),l=0,h=f.length;h>l;l++){f[l].zlevel=s+1;for(var y in o)f[l][y]=d.clone(o[y]);this.shapeList.push(f[l])}if(this.type==r.CHART_TYPE_FORCE||this.type==r.CHART_TYPE_CHORD)for(var l=0,h=f.length;h>l;l++)this.zr.addShape(f[l])},_buildMarkLine:function(e){for(var t,i,o=(this.markAttachStyle||{})[e],a=this.series[e],s=this.getZlevelBase(),n=d.clone(a.markLine),l=0,h=n.data.length;h>l;l++){if(t=n.data[l],t.type&&("max"==t.type||"min"==t.type||"average"==t.type))i=this.getMarkCoord(e,t),n.data[l]=[d.clone(t),{}],n.data[l][0].name=t.name||t.type,n.data[l][0].value=i[3],i=i[2],t=[{},{}];else i=[this.getMarkCoord(e,t[0]),this.getMarkCoord(e,t[1])];n.data[l][0].x="undefined"!=typeof t[0].x?t[0].x:i[0][0],n.data[l][0].y="undefined"!=typeof t[0].y?t[0].y:i[0][1],n.data[l][1].x="undefined"!=typeof t[1].x?t[1].x:i[1][0],n.data[l][1].y="undefined"!=typeof t[1].y?t[1].y:i[1][1]}for(var p=this._markLine(e,n),l=0,h=p.length;h>l;l++){p[l].zlevel=s+1;for(var f in o)p[l][f]=d.clone(o[f]);this.shapeList.push(p[l])}if(this.type==r.CHART_TYPE_FORCE||this.type==r.CHART_TYPE_CHORD)for(var l=0,h=p.length;h>l;l++)this.zr.addShape(p[l])},_markPoint:function(e,t){var i=this.series[e],o=this.component;d.merge(t,this.ecTheme.markPoint),t.name=i.name;var a,n,l,h,p,f,y,g=[],c=t.data,m=o.dataRange,u=o.legend,x=this.zr.getWidth(),b=this.zr.getHeight();if(!t.large)for(var v=0,_=c.length;_>v;v++)if("undefined"!=typeof c[v].x&&"undefined"!=typeof c[v].y){if(l="undefined"!=typeof c[v]&&"undefined"!=typeof c[v].value?c[v].value:"",u)n=u.getColor(i.name);if(m)if(n=isNaN(l)?n:m.getColor(l),h=[c[v],t],p=this.deepQuery(h,"itemStyle.normal.color")||n,f=this.deepQuery(h,"itemStyle.emphasis.color")||p,null==p&&null==f)continue;if(c[v].tooltip=c[v].tooltip||{trigger:"item"},c[v].name="undefined"!=typeof c[v].name?c[v].name:"",c[v].value=l,a=this.getSymbolShape(t,e,c[v],v,c[v].name,this.parsePercent(c[v].x,x),this.parsePercent(c[v].y,b),"pin",n,"rgba(0,0,0,0)","horizontal"),a._mark="point",y=this.deepMerge([c[v],t],"effect"),y.show)a.effect=y;if(i.type==r.CHART_TYPE_MAP)a._geo=this.getMarkGeo(c[v]);s.pack(a,i,e,c[v],v,c[v].name,l),g.push(a)}else;else a=this.getLargeMarkPoingShape(e,t),a._mark="largePoint",a&&g.push(a);return g},_markLine:function(e,t){var i=this.series[e],o=this.component;d.merge(t,this.ecTheme.markLine),t.symbol=t.symbol instanceof Array?t.symbol.length>1?t.symbol:[t.symbol[0],t.symbol[0]]:[t.symbol,t.symbol],t.symbolSize=t.symbolSize instanceof Array?t.symbolSize.length>1?t.symbolSize:[t.symbolSize[0],t.symbolSize[0]]:[t.symbolSize,t.symbolSize],t.symbolRotate=t.symbolRotate instanceof Array?t.symbolRotate.length>1?t.symbolRotate:[t.symbolRotate[0],t.symbolRotate[0]]:[t.symbolRotate,t.symbolRotate],t.name=i.name;for(var a,n,l,h,p,f,y,g,c=[],m=t.data,u=o.dataRange,x=o.legend,b=this.zr.getWidth(),v=this.zr.getHeight(),_=0,C=m.length;C>_;_++)if("undefined"!=typeof m[_][0].x&&"undefined"!=typeof m[_][0].y&&"undefined"!=typeof m[_][1].x&&"undefined"!=typeof m[_][1].y){if(x)n=x.getColor(i.name);if(g=this.deepMerge(m[_]),l="undefined"!=typeof g&&"undefined"!=typeof g.value?g.value:"",u)if(n=isNaN(l)?n:u.getColor(l),h=[g,t],p=this.deepQuery(h,"itemStyle.normal.color")||n,f=this.deepQuery(h,"itemStyle.emphasis.color")||p,null==p&&null==f)continue;if(m[_][0].tooltip=g.tooltip||{trigger:"item"},m[_][0].name="undefined"!=typeof m[_][0].name?m[_][0].name:"",m[_][1].name="undefined"!=typeof m[_][1].name?m[_][1].name:"",m[_][0].value="undefined"!=typeof m[_][0].value?m[_][0].value:"",a=this.getLineMarkShape(t,e,m[_],_,this.parsePercent(m[_][0].x,b),this.parsePercent(m[_][0].y,v),this.parsePercent(m[_][1].x,b),this.parsePercent(m[_][1].y,v),n),a._mark="line",y=this.deepMerge([g,t],"effect"),y.show)a.effect=y;if(i.type==r.CHART_TYPE_MAP)a._geo=[this.getMarkGeo(m[_][0]),this.getMarkGeo(m[_][1])];s.pack(a,i,e,m[_][0],_,m[_][0].name+(""!==m[_][1].name?" > "+m[_][1].name:""),l),c.push(a)}else;return c},getMarkCoord:function(){return[0,0]},getSymbolShape:function(e,o,a,r,n,l,h,d,p,f,y){var g=[a,e],c="undefined"!=typeof a?"undefined"!=typeof a.value?a.value:a:"-";d=this.deepQuery(g,"symbol")||d;var m=this.deepQuery(g,"symbolSize");m="function"==typeof m?m(c):m;var u=this.deepQuery(g,"symbolRotate"),x=this.deepMerge(g,"itemStyle.normal"),b=this.deepMerge(g,"itemStyle.emphasis"),v="undefined"!=typeof x.borderWidth?x.borderWidth:x.lineStyle&&x.lineStyle.width;if("undefined"==typeof v)v=d.match("empty")?2:0;var _="undefined"!=typeof b.borderWidth?b.borderWidth:b.lineStyle&&b.lineStyle.width;if("undefined"==typeof _)_=v+2;var C=new i({style:{iconType:d.replace("empty","").toLowerCase(),x:l-m,y:h-m,width:2*m,height:2*m,brushType:"both",color:d.match("empty")?f:this.getItemStyleColor(x.color,o,r,a)||p,strokeColor:x.borderColor||this.getItemStyleColor(x.color,o,r,a)||p,lineWidth:v},highlightStyle:{color:d.match("empty")?f:this.getItemStyleColor(b.color,o,r,a),strokeColor:b.borderColor||x.borderColor||this.getItemStyleColor(x.color,o,r,a)||p,lineWidth:_},clickable:this.deepQuery(g,"clickable")});if(d.match("image"))C.style.image=d.replace(new RegExp("^image:\\/\\/"),""),C=new t({style:C.style,highlightStyle:C.highlightStyle,clickable:this.deepQuery(g,"clickable")});if("undefined"!=typeof u)C.rotation=[u*Math.PI/180,l,h];if(d.match("star"))C.style.iconType="star",C.style.n=d.replace("empty","").replace("star","")-0||5;if("none"==d)C.invisible=!0,C.hoverable=!1;if(C=this.addLabel(C,e,a,n,y),d.match("empty")){if("undefined"==typeof C.style.textColor)C.style.textColor=C.style.strokeColor;if("undefined"==typeof C.highlightStyle.textColor)C.highlightStyle.textColor=C.highlightStyle.strokeColor}return s.pack(C,e,o,a,r,n),C._x=l,C._y=h,C._dataIndex=r,C._seriesIndex=o,C},getLineMarkShape:function(e,t,i,a,r,s,n,l,h){var d="undefined"!=typeof i[0]?"undefined"!=typeof i[0].value?i[0].value:i[0]:"-",p="undefined"!=typeof i[1]?"undefined"!=typeof i[1].value?i[1].value:i[1]:"-",f=[this.query(i[0],"symbol")||e.symbol[0],this.query(i[1],"symbol")||e.symbol[1]],y=[this.query(i[0],"symbolSize")||e.symbolSize[0],this.query(i[1],"symbolSize")||e.symbolSize[1]];y[0]="function"==typeof y[0]?y[0](d):y[0],y[1]="function"==typeof y[1]?y[1](p):y[1];var g=[this.query(i[0],"symbolRotate")||e.symbolRotate[0],this.query(i[1],"symbolRotate")||e.symbolRotate[1]],c=[i[0],e],m=this.deepMerge(c,"itemStyle.normal");m.color=this.getItemStyleColor(m.color,t,a,i);var u=this.deepMerge(c,"itemStyle.emphasis");u.color=this.getItemStyleColor(u.color,t,a,i);var x=m.lineStyle,b=u.lineStyle,v=x.width;if("undefined"==typeof v)v=m.borderWidth;var _=b.width;if("undefined"==typeof _)if("undefined"!=typeof u.borderWidth)_=u.borderWidth;else _=v+2;var C=new o({style:{smooth:e.smooth?"spline":!1,symbol:f,symbolSize:y,symbolRotate:g,xStart:r,yStart:s,xEnd:n,yEnd:l,brushType:"both",lineType:x.type,shadowColor:x.shadowColor||x.color||m.borderColor||m.color||h,shadowBlur:x.shadowBlur,shadowOffsetX:x.shadowOffsetX,shadowOffsetY:x.shadowOffsetY,color:m.color||h,strokeColor:x.color||m.borderColor||m.color||h,lineWidth:v,symbolBorderColor:m.borderColor||m.color||h,symbolBorder:m.borderWidth},highlightStyle:{shadowColor:b.shadowColor,shadowBlur:b.shadowBlur,shadowOffsetX:b.shadowOffsetX,shadowOffsetY:b.shadowOffsetY,color:u.color||m.color||h,strokeColor:b.color||x.color||u.borderColor||m.borderColor||u.color||m.color||h,lineWidth:_,symbolBorderColor:u.borderColor||m.borderColor||u.color||m.color||h,symbolBorder:"undefined"==typeof u.borderWidth?m.borderWidth+2:u.borderWidth},clickable:this.deepQuery(c,"clickable")});return C=this.addLabel(C,e,i[0],i[0].name+" : "+i[1].name),C._x=n,C._y=l,C},getLargeMarkPoingShape:function(e,t){var i,o,r,s,n,l,h=this.series[e],d=this.component,p=t.data,f=d.dataRange,y=d.legend,g=[p[0],t];if(y)o=y.getColor(h.name);if(f)if(r="undefined"!=typeof p[0]?"undefined"!=typeof p[0].value?p[0].value:p[0]:"-",o=isNaN(r)?o:f.getColor(r),s=this.deepQuery(g,"itemStyle.normal.color")||o,n=this.deepQuery(g,"itemStyle.emphasis.color")||s,null==s&&null==n)return;o=this.deepMerge(g,"itemStyle.normal").color||o;var c=this.deepQuery(g,"symbol")||"circle";c=c.replace("empty","").replace(/\d/g,""),l=this.deepMerge([p[0],t],"effect");var m=window.devicePixelRatio||1;if(i=new a({style:{pointList:p,color:o,strokeColor:o,shadowColor:l.shadowColor||o,shadowBlur:("undefined"!=typeof l.shadowBlur?l.shadowBlur:8)*m,size:this.deepQuery(g,"symbolSize"),iconType:c,brushType:"fill",lineWidth:1},draggable:!1,hoverable:!1}),l.show)i.effect=l;return i},backupShapeList:function(){if(this.shapeList&&this.shapeList.length>0)this.lastShapeList=this.shapeList,this.shapeList=[];else this.lastShapeList=[]},addShapeList:function(){var e,t=this.option.animationThreshold/(this.canvasSupported?2:4),i=this.lastShapeList,o=this.shapeList,a=i.length>0?500:this.query(this.option,"animationDuration"),r=this.query(this.option,"animationEasing"),s={},n={};if(this.option.animation&&!this.option.renderAsImage&&o.length<t&&!this.motionlessOnce){for(var l=0,h=i.length;h>l;l++)if(e=this._getAnimationKey(i[l]),e.match("undefined"))this.zr.delShape(i[l].id);else e+=i[l].type,s[e]=i[l];for(var l=0,h=o.length;h>l;l++)if(e=this._getAnimationKey(o[l]),e.match("undefined"))this.zr.addShape(o[l]);else e+=o[l].type,n[e]=o[l];for(e in s)if(!n[e])this.zr.delShape(s[e].id);for(e in n)if(s[e])this.zr.delShape(s[e].id),this._animateMod(s[e],n[e],a,r);else this._animateMod(!1,n[e],a,r);this.zr.refresh(),this.animationEffect()}else{this.motionlessOnce=!1,this.zr.delShape(i);for(var l=0,h=o.length;h>l;l++)this.zr.addShape(o[l])}},_getAnimationKey:function(e){if(this.type!=r.CHART_TYPE_MAP)return s.get(e,"seriesIndex")+"_"+s.get(e,"dataIndex")+(e._mark?e._mark:"")+(this.type==r.CHART_TYPE_RADAR?s.get(e,"special"):"");else return s.get(e,"seriesIndex")+"_"+s.get(e,"dataIndex")+(e._mark?e._mark:"undefined")},_animateMod:function(e,t,i,o){switch(t.type){case"broken-line":case"half-smooth-polygon":n.pointList(this.zr,e,t,i,o);break;case"rectangle":n.rectangle(this.zr,e,t,i,o);break;case"icon":n.icon(this.zr,e,t,i,o);break;case"candle":if(i>500)n.candle(this.zr,e,t,i,o);else this.zr.addShape(t);break;case"ring":case"sector":case"circle":if(i>500)n.ring(this.zr,e,t,i+(s.get(t,"dataIndex")||0)%20*100,o);else if("sector"==t.type)n.sector(this.zr,e,t,i,o);else this.zr.addShape(t);break;case"text":n.text(this.zr,e,t,i,o);break;case"polygon":if(i>500)n.polygon(this.zr,e,t,i,o);else n.pointList(this.zr,e,t,i,o);break;case"chord":n.chord(this.zr,e,t,i,o);break;case"gauge-pointer":n.gaugePointer(this.zr,e,t,i,o);break;case"mark-line":n.markline(this.zr,e,t,i,o);break;case"line":n.line(this.zr,e,t,i,o);break;default:this.zr.addShape(t)}},animationMark:function(e,t,i){for(var o=i||this.shapeList,a=0,r=o.length;r>a;a++)if(o[a]._mark)this._animateMod(!1,o[a],e,t);else;this.animationEffect(i)},animationEffect:function(e){!e&&this.clearEffectShape();var t=e||this.shapeList,i=r.EFFECT_ZLEVEL;if(this.canvasSupported)this.zr.modLayer(i,{motionBlur:!0,lastFrameAlpha:.95});for(var o,a=0,s=t.length;s>a;a++)if(o=t[a],o._mark&&o.effect&&o.effect.show&&l[o._mark])l[o._mark](this.zr,this.effectList,o,i),this.effectList[this.effectList.length-1]._mark=o._mark;else;},clearEffectShape:function(e){if(this.zr&&this.effectList&&this.effectList.length>0)e&&this.zr.modLayer(r.EFFECT_ZLEVEL,{motionBlur:!1}),this.zr.delShape(this.effectList);this.effectList=[]},addMark:function(e,t,i){var o=this.series[e];if(this.selectedMap[o.name]){var a=500,r=this.query(this.option,"animationEasing"),s=o[i].data,n=this.shapeList.length;o[i].data=t.data,this["_build"+i.replace("m","M")](e);for(var l=n,h=this.shapeList.length;h>l;l++)this.zr.addShape(this.shapeList[l]);if(this.zr.refresh(),this.option.animation&&!this.option.renderAsImage)this.animationMark(a,r,this.shapeList.slice(n));o[i].data=s}},delMark:function(e,t,i){i=i.replace("mark","").replace("large","").toLowerCase();var o=this.series[e];if(this.selectedMap[o.name]){for(var a=!1,r=[this.shapeList,this.effectList],n=2;n--;)for(var l=0,h=r[n].length;h>l;l++)if(r[n][l]._mark==i&&s.get(r[n][l],"seriesIndex")==e&&s.get(r[n][l],"name")==t){this.zr.delShape(r[n][l].id),r[n].splice(l,1),a=!0;break}a&&this.zr.refresh()}}},e});