/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/chart/k",["require","../component/base","./base","../util/shape/Candle","../component/axis","../component/grid","../component/dataZoom","../config","../util/ecData","zrender/tool/util","../chart"],function(require){function e(e,s,r,o,a){t.call(this,e,s,r,o,a),i.call(this),this.refresh(o)}var t=require("../component/base"),i=require("./base"),s=require("../util/shape/Candle");require("../component/axis"),require("../component/grid"),require("../component/dataZoom");var r=require("../config"),o=require("../util/ecData"),a=require("zrender/tool/util");return e.prototype={type:r.CHART_TYPE_K,_buildShape:function(){var e=this.series;this.selectedMap={};for(var t,i={top:[],bottom:[]},s=0,o=e.length;o>s;s++)if(e[s].type==r.CHART_TYPE_K)if(e[s]=this.reformOption(e[s]),t=this.component.xAxis.getAxis(e[s].xAxisIndex),t.type==r.COMPONENT_TYPE_AXIS_CATEGORY)i[t.getPosition()].push(s);for(var a in i)if(i[a].length>0)this._buildSinglePosition(a,i[a]);this.addShapeList()},_buildSinglePosition:function(e,t){var i=this._mapData(t),s=i.locationMap,r=i.maxDataLength;if(0!==r&&0!==s.length){this._buildHorizontal(t,r,s);for(var o=0,a=t.length;a>o;o++)this.buildMark(t[o])}},_mapData:function(e){for(var t,i,s=this.series,r=this.component.legend,o=[],a=0,n=0,h=e.length;h>n;n++){if(t=s[e[n]],i=t.name,r)this.selectedMap[i]=r.isSelected(i);else this.selectedMap[i]=!0;if(this.selectedMap[i])o.push(e[n]);a=Math.max(a,t.data.length)}return{locationMap:o,maxDataLength:a}},_buildHorizontal:function(e,t,i){for(var s,r,o,a,n,h,l,d,p,c,f=this.series,u={},g=0,y=i.length;y>g;g++){if(s=i[g],r=f[s],o=r.xAxisIndex||0,a=this.component.xAxis.getAxis(o),l=r.barWidth||Math.floor(a.getGap()/2),c=r.barMaxWidth,c&&l>c)l=c;n=r.yAxisIndex||0,h=this.component.yAxis.getAxis(n),u[s]=[];for(var m=0,v=t;v>m&&"undefined"!=typeof a.getNameByIndex(m);m++)if(d=r.data[m],p="undefined"!=typeof d?"undefined"!=typeof d.value?d.value:d:"-","-"!=p&&4==p.length)u[s].push([a.getCoordByIndex(m),l,h.getCoord(p[0]),h.getCoord(p[1]),h.getCoord(p[2]),h.getCoord(p[3]),m,a.getNameByIndex(m)]);else;}this._buildKLine(e,u)},_buildKLine:function(e,t){for(var i,s,o,a,n,h,l,d,p,c,f,u,g,y,m,v,b,S=this.series,x=0,_=e.length;_>x;x++){if(b=e[x],f=S[b],y=t[b],this._isLarge(y))y=this._getLargePointList(y);if(f.type==r.CHART_TYPE_K&&"undefined"!=typeof y){u=f,i=this.query(u,"itemStyle.normal.lineStyle.width"),s=this.query(u,"itemStyle.normal.lineStyle.color"),o=this.query(u,"itemStyle.normal.lineStyle.color0"),a=this.query(u,"itemStyle.normal.color"),n=this.query(u,"itemStyle.normal.color0"),h=this.query(u,"itemStyle.emphasis.lineStyle.width"),l=this.query(u,"itemStyle.emphasis.lineStyle.color"),d=this.query(u,"itemStyle.emphasis.lineStyle.color0"),p=this.query(u,"itemStyle.emphasis.color"),c=this.query(u,"itemStyle.emphasis.color0");for(var w=0,C=y.length;C>w;w++)m=y[w],g=f.data[m[6]],u=g,v=m[3]<m[2],this.shapeList.push(this._getCandle(b,m[6],m[7],m[0],m[1],m[2],m[3],m[4],m[5],v?this.query(u,"itemStyle.normal.color")||a:this.query(u,"itemStyle.normal.color0")||n,this.query(u,"itemStyle.normal.lineStyle.width")||i,v?this.query(u,"itemStyle.normal.lineStyle.color")||s:this.query(u,"itemStyle.normal.lineStyle.color0")||o,v?this.query(u,"itemStyle.emphasis.color")||p||a:this.query(u,"itemStyle.emphasis.color0")||c||n,this.query(u,"itemStyle.emphasis.lineStyle.width")||h||i,v?this.query(u,"itemStyle.emphasis.lineStyle.color")||l||s:this.query(u,"itemStyle.emphasis.lineStyle.color0")||d||o))}}},_isLarge:function(e){return e[0][1]<.5},_getLargePointList:function(e){for(var t=this.component.grid.getWidth(),i=e.length,s=[],r=0;t>r;r++)s[r]=e[Math.floor(i/t*r)];return s},_getCandle:function(e,t,i,r,a,n,h,l,d,p,c,f,u,g,y){var m=this.series,v={zlevel:this._zlevelBase,clickable:this.deepQuery([m[e].data[t],m[e]],"clickable"),style:{x:r,y:[n,h,l,d],width:a,color:p,strokeColor:f,lineWidth:c,brushType:"both"},highlightStyle:{color:u,strokeColor:y,lineWidth:g},_seriesIndex:e};return o.pack(v,m[e],e,m[e].data[t],t,i),v=new s(v)},getMarkCoord:function(e,t){var i=this.series[e],s=this.component.xAxis.getAxis(i.xAxisIndex),r=this.component.yAxis.getAxis(i.yAxisIndex);return["string"!=typeof t.xAxis&&s.getCoordByIndex?s.getCoordByIndex(t.xAxis||0):s.getCoord(t.xAxis||0),"string"!=typeof t.yAxis&&r.getCoordByIndex?r.getCoordByIndex(t.yAxis||0):r.getCoord(t.yAxis||0)]},refresh:function(e){if(e)this.option=e,this.series=e.series;this.backupShapeList(),this._buildShape()},addDataAnimation:function(e){for(var t=this.series,i={},s=0,r=e.length;r>s;s++)i[e[s][0]]=e[s];for(var a,n,h,l,d,p,s=0,r=this.shapeList.length;r>s;s++)if(d=this.shapeList[s]._seriesIndex,i[d]&&!i[d][3])if("candle"==this.shapeList[s].type){if(p=o.get(this.shapeList[s],"dataIndex"),l=t[d],i[d][2]&&p==l.data.length-1){this.zr.delShape(this.shapeList[s].id);continue}else if(!i[d][2]&&0===p){this.zr.delShape(this.shapeList[s].id);continue}n=this.component.xAxis.getAxis(l.xAxisIndex||0).getGap(),a=i[d][2]?n:-n,h=0,this.zr.animate(this.shapeList[s].id,"").when(500,{position:[a,h]}).start()}}},a.inherits(e,i),a.inherits(e,t),require("../chart").define("k",e),e});