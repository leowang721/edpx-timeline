/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/chart/forceLayoutWorker",["require","zrender/tool/vector"],function e(require){"use strict";function t(){this.subRegions=[],this.nSubRegions=0,this.node=null,this.mass=0,this.centerOfMass=null,this.bbox=new n(4),this.size=0}function i(){this.position=r.create(),this.force=r.create(),this.forcePrev=r.create(),this.speed=r.create(),this.speedPrev=r.create(),this.mass=1,this.inDegree=0,this.outDegree=0}function s(e,t){this.source=e,this.target=t,this.weight=1}function o(){this.barnesHutOptimize=!1,this.barnesHutTheta=1.5,this.repulsionByDegree=!1,this.preventOverlap=!1,this.strongGravity=!0,this.gravity=1,this.scaling=1,this.edgeWeightInfluence=1,this.center=[0,0],this.width=500,this.height=500,this.maxSpeedIncrease=1,this.nodes=[],this.edges=[],this.bbox=new n(4),this._rootRegion=new t,this._rootRegion.centerOfMass=r.create(),this._massArr=null,this._k=0}var r,a="undefined"==typeof window&&"undefined"==typeof require;if(a)r={create:function(e,t){var i=new Float32Array(2);return i[0]=e||0,i[1]=t||0,i},dist:function(e,t){var i=t[0]-e[0],s=t[1]-e[1];return Math.sqrt(i*i+s*s)},len:function(e){var t=e[0],i=e[1];return Math.sqrt(t*t+i*i)},scaleAndAdd:function(e,t,i,s){return e[0]=t[0]+i[0]*s,e[1]=t[1]+i[1]*s,e},scale:function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e},add:function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e},sub:function(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e},normalize:function(e,t){var i=t[0],s=t[1],o=i*i+s*s;if(o>0)o=1/Math.sqrt(o),e[0]=t[0]*o,e[1]=t[1]*o;return e},negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e},set:function(e,t,i){return e[0]=t,e[1]=i,e}};else r=require("zrender/tool/vector");var n="undefined"==typeof Float32Array?Array:Float32Array;if(t.prototype.beforeUpdate=function(){for(var e=0;e<this.nSubRegions;e++)this.subRegions[e].beforeUpdate();if(this.mass=0,this.centerOfMass)this.centerOfMass[0]=0,this.centerOfMass[1]=0;this.nSubRegions=0,this.node=null},t.prototype.afterUpdate=function(){this.subRegions.length=this.nSubRegions;for(var e=0;e<this.nSubRegions;e++)this.subRegions[e].afterUpdate()},t.prototype.addNode=function(e){if(0===this.nSubRegions)if(null==this.node)return void(this.node=e);else this._addNodeToSubRegion(this.node),this.node=null;this._addNodeToSubRegion(e),this._updateCenterOfMass(e)},t.prototype.findSubRegion=function(e,t){for(var i=0;i<this.nSubRegions;i++){var s=this.subRegions[i];if(s.contain(e,t))return s}},t.prototype.contain=function(e,t){return this.bbox[0]<=e&&this.bbox[2]>=e&&this.bbox[1]<=t&&this.bbox[3]>=t},t.prototype.setBBox=function(e,t,i,s){this.bbox[0]=e,this.bbox[1]=t,this.bbox[2]=i,this.bbox[3]=s,this.size=(i-e+s-t)/2},t.prototype._newSubRegion=function(){var e=this.subRegions[this.nSubRegions];if(!e)e=new t,this.subRegions[this.nSubRegions]=e;return this.nSubRegions++,e},t.prototype._addNodeToSubRegion=function(e){var t=this.findSubRegion(e.position[0],e.position[1]),i=this.bbox;if(!t){var s=(i[0]+i[2])/2,o=(i[1]+i[3])/2,r=(i[2]-i[0])/2,a=(i[3]-i[1])/2,n=e.position[0]>=s?1:0,h=e.position[1]>=o?1:0,t=this._newSubRegion();t.setBBox(n*r+i[0],h*a+i[1],(n+1)*r+i[0],(h+1)*a+i[1])}t.addNode(e)},t.prototype._updateCenterOfMass=function(e){if(null==this.centerOfMass)this.centerOfMass=r.create();var t=this.centerOfMass[0]*this.mass,i=this.centerOfMass[1]*this.mass;t+=e.position[0]*e.mass,i+=e.position[1]*e.mass,this.mass+=e.mass,this.centerOfMass[0]=t/this.mass,this.centerOfMass[1]=i/this.mass},o.prototype.initNodes=function(e,t,s){this.temperature=1;var o=e.length/2;this.nodes.length=0;for(var r="undefined"!=typeof s,a=0;o>a;a++){var n=new i;if(n.position[0]=e[2*a],n.position[1]=e[2*a+1],n.mass=t[a],r)n.size=s[a];this.nodes.push(n)}if(this._massArr=t,r)this._sizeArr=s},o.prototype.initEdges=function(e,t){var i=e.length/2;this.edges.length=0;for(var o="undefined"!=typeof t,r=0;i>r;r++){var a=e[2*r],n=e[2*r+1],h=this.nodes[a],l=this.nodes[n];if(h&&l){h.outDegree++,l.inDegree++;var d=new s(h,l);if(o)d.weight=t[r];this.edges.push(d)}else;}},o.prototype.update=function(){var e=this.nodes.length;if(this.updateBBox(),this._k=.4*this.scaling*Math.sqrt(this.width*this.height/e),this.barnesHutOptimize){this._rootRegion.setBBox(this.bbox[0],this.bbox[1],this.bbox[2],this.bbox[3]),this._rootRegion.beforeUpdate();for(var t=0;e>t;t++)this._rootRegion.addNode(this.nodes[t]);this._rootRegion.afterUpdate()}else{var i=0,s=this._rootRegion.centerOfMass;r.set(s,0,0);for(var t=0;e>t;t++){var o=this.nodes[t];i+=o.mass,r.scaleAndAdd(s,s,o.position,o.mass)}r.scale(s,s,1/i)}for(var t=0;e>t;t++){var o=this.nodes[t];r.copy(o.forcePrev,o.force),r.copy(o.speedPrev,o.speed),r.set(o.force,0,0)}for(var t=0;e>t;t++){var a=this.nodes[t];if(this.barnesHutOptimize)this.applyRegionToNodeRepulsion(this._rootRegion,a);else for(var n=t+1;e>n;n++){var h=this.nodes[n];this.applyNodeToNodeRepulsion(a,h,!1)}if(this.gravity>0)this.applyNodeGravity(a)}for(var t=0;t<this.edges.length;t++)this.applyEdgeAttraction(this.edges[t]);for(var l=r.create(),t=0;e>t;t++){var o=this.nodes[t],d=o.speed;r.scale(o.force,o.force,1/30);var p=r.len(o.force)+.1,f=Math.min(p,500)/p;r.scale(o.force,o.force,f),r.add(d,d,o.force),r.scale(d,d,this.temperature),r.sub(l,d,o.speedPrev);var c=r.len(l);if(c>0){r.scale(l,l,1/c);var u=r.len(o.speedPrev);if(u>0)c=Math.min(c/u,this.maxSpeedIncrease)*u,r.scaleAndAdd(d,o.speedPrev,l,c)}var y=r.len(d),f=Math.min(y,100)/(y+.1);r.scale(d,d,f),r.add(o.position,o.position,d)}},o.prototype.applyRegionToNodeRepulsion=function(){var e=r.create();return function(t,i){if(t.node)this.applyNodeToNodeRepulsion(t.node,i,!0);else{r.sub(e,i.position,t.centerOfMass);var s=e[0]*e[0]+e[1]*e[1];if(s>this.barnesHutTheta*t.size*t.size){var o=this._k*this._k*(i.mass+t.mass)/(s+1);r.scaleAndAdd(i.force,i.force,e,2*o)}else for(var a=0;a<t.nSubRegions;a++)this.applyRegionToNodeRepulsion(t.subRegions[a],i)}}}(),o.prototype.applyNodeToNodeRepulsion=function(){var e=r.create();return function(t,i,s){if(t!=i){r.sub(e,t.position,i.position);var o=e[0]*e[0]+e[1]*e[1];if(0!==o){var a,n=this._k*this._k,h=t.mass+i.mass;if(this.preventOverlap){var l=Math.sqrt(o);if(l=l-t.size-i.size,l>0)a=n*h/(l*l);else if(0>=l)a=10*n*h}else a=n*h/o;if(!s)r.scaleAndAdd(t.force,t.force,e,2*a);r.scaleAndAdd(i.force,i.force,e,2*-a)}}}}(),o.prototype.applyEdgeAttraction=function(){var e=r.create();return function(t){var i=t.source,s=t.target;r.sub(e,i.position,s.position);var o,a=r.len(e);if(0===this.edgeWeightInfluence)o=1;else if(1==this.edgeWeightInfluence)o=t.weight;else o=Math.pow(t.weight,this.edgeWeightInfluence);var n;if(this.preventOverlap)if(a=a-i.size-s.size,0>=a)return;var n=-o*a/this._k;r.scaleAndAdd(i.force,i.force,e,n),r.scaleAndAdd(s.force,s.force,e,-n)}}(),o.prototype.applyNodeGravity=function(){var e=r.create();return function(t){if(r.sub(e,this.center,t.position),this.width>this.height)e[1]*=this.width/this.height;else e[0]*=this.height/this.width;var i=r.len(e)/100;if(this.strongGravity)r.scaleAndAdd(t.force,t.force,e,i*this.gravity*t.mass);else r.scaleAndAdd(t.force,t.force,e,this.gravity*t.mass/(i+1))}}(),o.prototype.updateBBox=function(){for(var e=1/0,t=1/0,i=-1/0,s=-1/0,o=0;o<this.nodes.length;o++){var r=this.nodes[o].position;e=Math.min(e,r[0]),t=Math.min(t,r[1]),i=Math.max(i,r[0]),s=Math.max(s,r[1])}this.bbox[0]=e,this.bbox[1]=t,this.bbox[2]=i,this.bbox[3]=s},o.getWorkerCode=function(){var t=e.toString();return t.slice(t.indexOf("{")+1,t.lastIndexOf("return"))},a){var h=null;self.onmessage=function(e){if(!(e.data instanceof ArrayBuffer))switch(e.data.cmd){case"init":if(!h)h=new o;h.initNodes(e.data.nodesPosition,e.data.nodesMass,e.data.nodesSize),h.initEdges(e.data.edges,e.data.edgesWeight),h._token=e.data.token;break;case"updateConfig":if(h)for(var t in e.data.config)h[t]=e.data.config[t];break;case"update":var i=e.data.steps;if(h){var s=h.nodes.length,r=new Float32Array(2*s+1);if(h.temperature=e.data.temperature,e.data.temperature>.01){for(var a=0;i>a;a++)h.update(),h.temperature*=e.data.coolDown;for(var a=0;s>a;a++){var n=h.nodes[a];r[2*a+1]=n.position[0],r[2*a+2]=n.position[1]}r[0]=h._token}self.postMessage(r.buffer,[r.buffer])}else{var l=new Float32Array;self.postMessage(l.buffer,[l.buffer])}}else{if(!h)return;for(var r=new Float32Array(e.data),s=(r.length-1)/2,a=0;s>a;a++){var n=h.nodes[a];n.position[0]=r[2*a+1],n.position[1]=r[2*a+2]}}}}return o});