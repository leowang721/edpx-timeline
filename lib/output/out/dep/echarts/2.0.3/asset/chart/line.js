/*! @2014 Leo Wang. All Rights Reserved */
define("echarts/chart/line",["require","../component/base","./base","zrender/shape/BrokenLine","../util/shape/Icon","../util/shape/HalfSmoothPolygon","../component/axis","../component/grid","../component/dataZoom","../config","../util/ecData","zrender/tool/util","zrender/tool/color","../chart"],function(require){function e(e,t,o,r,a){i.call(this,e,t,o,r,a),s.call(this),this.refresh(r)}function t(e,t){var i=t.x,s=t.y,o=t.width,a=t.height,n=a/2;if(t.symbol.match("empty"))e.fillStyle="#fff";t.brushType="both";var h=t.symbol.replace("empty","").toLowerCase();if(h.match("star"))n=h.replace("star","")-0||5,s-=1,h="star";else if("rectangle"==h||"arrow"==h)i+=(o-a)/2,o=a;var l="";if(h.match("image"))l=h.replace(new RegExp("^image:\\/\\/"),""),h="image",i+=Math.round((o-a)/2)-1,o=a+=2;if(h=r.prototype.iconLibrary[h]){var d=t.x,p=t.y;e.moveTo(d,p+n),e.lineTo(d+5,p+n),e.moveTo(d+t.width-5,p+n),e.lineTo(d+t.width,p+n),h(e,{x:i+4,y:s+4,width:o-8,height:a-8,n:n,image:l})}else e.moveTo(i,s+n),e.lineTo(i+o,s+n)}var i=require("../component/base"),s=require("./base"),o=require("zrender/shape/BrokenLine"),r=require("../util/shape/Icon"),a=require("../util/shape/HalfSmoothPolygon");require("../component/axis"),require("../component/grid"),require("../component/dataZoom");var n=require("../config"),h=require("../util/ecData"),l=require("zrender/tool/util"),d=require("zrender/tool/color");return e.prototype={type:n.CHART_TYPE_LINE,_buildShape:function(){var e=this.series;this.finalPLMap={},this._sIndex2ColorMap={},this._symbol=this.option.symbolList,this._sIndex2ShapeMap={},this.selectedMap={},this.xMarkMap={};for(var t,i,s,o,r={top:[],bottom:[],left:[],right:[]},a=0,h=e.length;h>a;a++)if(e[a].type==this.type)if(e[a]=this.reformOption(e[a]),t=e[a].xAxisIndex,i=e[a].yAxisIndex,s=this.component.xAxis.getAxis(t),o=this.component.yAxis.getAxis(i),s.type==n.COMPONENT_TYPE_AXIS_CATEGORY)r[s.getPosition()].push(a);else if(o.type==n.COMPONENT_TYPE_AXIS_CATEGORY)r[o.getPosition()].push(a);for(var l in r)if(r[l].length>0)this._buildSinglePosition(l,r[l]);this.addShapeList()},_buildSinglePosition:function(e,t){var i=this._mapData(t),s=i.locationMap,o=i.maxDataLength;if(0!==o&&0!==s.length){switch(e){case"bottom":case"top":this._buildHorizontal(t,o,s,this.xMarkMap);break;case"left":case"right":this._buildVertical(t,o,s,this.xMarkMap)}for(var r=0,a=t.length;a>r;r++)this.buildMark(t[r])}},_mapData:function(e){for(var t,i,s,o,r=this.series,a=0,n={},h="__kener__stack__",l=this.component.legend,d=[],p=0,f=0,c=e.length;c>f;f++){if(t=r[e[f]],s=t.name,this._sIndex2ShapeMap[e[f]]=this._sIndex2ShapeMap[e[f]]||this.query(t,"symbol")||this._symbol[f%this._symbol.length],l){if(this.selectedMap[s]=l.isSelected(s),this._sIndex2ColorMap[e[f]]=l.getColor(s),o=l.getItemShape(s))o.style.iconType="legendLineIcon",o.style.symbol=this._sIndex2ShapeMap[e[f]],l.setItemShape(s,o)}else this.selectedMap[s]=!0,this._sIndex2ColorMap[e[f]]=this.zr.getColor(e[f]);if(this.selectedMap[s])if(i=t.stack||h+e[f],"undefined"==typeof n[i])n[i]=a,d[a]=[e[f]],a++;else d[n[i]].push(e[f]);p=Math.max(p,t.data.length)}return{locationMap:d,maxDataLength:p}},_buildHorizontal:function(e,t,i,s){for(var o,r,a,n,h,l,d,p,f,c,u=this.series,g=i[0][0],y=u[g],m=y.xAxisIndex,v=this.component.xAxis.getAxis(m),x={},b=0,S=t;S>b&&"undefined"!=typeof v.getNameByIndex(b);b++){a=v.getCoordByIndex(b);for(var _=0,L=i.length;L>_;_++){o=u[i[_][0]].yAxisIndex||0,r=this.component.yAxis.getAxis(o),l=h=p=d=r.getCoord(0);for(var C=0,w=i[_].length;w>C;C++)if(g=i[_][C],y=u[g],f=y.data[b],c="undefined"!=typeof f?"undefined"!=typeof f.value?f.value:f:"-",x[g]=x[g]||[],s[g]=s[g]||{min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,sum:0,counter:0,average:0},"-"!=c){if(c>=0)h-=C>0?r.getCoordSize(c):l-r.getCoord(c),n=h;else if(0>c)d+=C>0?r.getCoordSize(c):r.getCoord(c)-p,n=d;if(x[g].push([a,n,b,v.getNameByIndex(b),a,l]),s[g].min>c)s[g].min=c,s[g].minY=n,s[g].minX=a;if(s[g].max<c)s[g].max=c,s[g].maxY=n,s[g].maxX=a;s[g].sum+=c,s[g].counter++}else if(x[g].length>0)this.finalPLMap[g]=this.finalPLMap[g]||[],this.finalPLMap[g].push(x[g]),x[g]=[]}h=this.component.grid.getY();for(var M,_=0,L=i.length;L>_;_++)for(var C=0,w=i[_].length;w>C;C++)if(g=i[_][C],y=u[g],f=y.data[b],c="undefined"!=typeof f?"undefined"!=typeof f.value?f.value:f:"-","-"==c){if(this.deepQuery([f,y,this.option],"calculable"))M=this.deepQuery([f,y],"symbolSize"),h+=2*M+5,n=h,this.shapeList.push(this._getCalculableItem(g,b,v.getNameByIndex(b),a,n,"horizontal"))}else;}for(var A in x)if(x[A].length>0)this.finalPLMap[A]=this.finalPLMap[A]||[],this.finalPLMap[A].push(x[A]),x[A]=[];for(var _=0,L=i.length;L>_;_++)for(var C=0,w=i[_].length;w>C;C++){if(g=i[_][C],s[g].counter>0)s[g].average=(s[g].sum/s[g].counter).toFixed(2)-0;n=this.component.yAxis.getAxis(u[g].yAxisIndex||0).getCoord(s[g].average),s[g].averageLine=[[this.component.grid.getX(),n],[this.component.grid.getXend(),n]],s[g].minLine=[[this.component.grid.getX(),s[g].minY],[this.component.grid.getXend(),s[g].minY]],s[g].maxLine=[[this.component.grid.getX(),s[g].maxY],[this.component.grid.getXend(),s[g].maxY]]}this._buildBorkenLine(e,this.finalPLMap,v,"horizontal")},_buildVertical:function(e,t,i,s){for(var o,r,a,n,h,l,d,p,f,c,u=this.series,g=i[0][0],y=u[g],m=y.yAxisIndex,v=this.component.yAxis.getAxis(m),x={},b=0,S=t;S>b&&"undefined"!=typeof v.getNameByIndex(b);b++){n=v.getCoordByIndex(b);for(var _=0,L=i.length;L>_;_++){o=u[i[_][0]].xAxisIndex||0,r=this.component.xAxis.getAxis(o),l=h=p=d=r.getCoord(0);for(var C=0,w=i[_].length;w>C;C++)if(g=i[_][C],y=u[g],f=y.data[b],c="undefined"!=typeof f?"undefined"!=typeof f.value?f.value:f:"-",x[g]=x[g]||[],s[g]=s[g]||{min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,sum:0,counter:0,average:0},"-"!=c){if(c>=0)h+=C>0?r.getCoordSize(c):r.getCoord(c)-l,a=h;else if(0>c)d-=C>0?r.getCoordSize(c):p-r.getCoord(c),a=d;if(x[g].push([a,n,b,v.getNameByIndex(b),l,n]),s[g].min>c)s[g].min=c,s[g].minX=a,s[g].minY=n;if(s[g].max<c)s[g].max=c,s[g].maxX=a,s[g].maxY=n;s[g].sum+=c,s[g].counter++}else if(x[g].length>0)this.finalPLMap[g]=this.finalPLMap[g]||[],this.finalPLMap[g].push(x[g]),x[g]=[]}h=this.component.grid.getXend();for(var M,_=0,L=i.length;L>_;_++)for(var C=0,w=i[_].length;w>C;C++)if(g=i[_][C],y=u[g],f=y.data[b],c="undefined"!=typeof f?"undefined"!=typeof f.value?f.value:f:"-","-"==c){if(this.deepQuery([f,y,this.option],"calculable"))M=this.deepQuery([f,y],"symbolSize"),h-=2*M+5,a=h,this.shapeList.push(this._getCalculableItem(g,b,v.getNameByIndex(b),a,n,"vertical"))}else;}for(var A in x)if(x[A].length>0)this.finalPLMap[A]=this.finalPLMap[A]||[],this.finalPLMap[A].push(x[A]),x[A]=[];for(var _=0,L=i.length;L>_;_++)for(var C=0,w=i[_].length;w>C;C++){if(g=i[_][C],s[g].counter>0)s[g].average=(s[g].sum/s[g].counter).toFixed(2)-0;a=this.component.xAxis.getAxis(u[g].xAxisIndex||0).getCoord(s[g].average),s[g].averageLine=[[a,this.component.grid.getYend()],[a,this.component.grid.getY()]],s[g].minLine=[[s[g].minX,this.component.grid.getYend()],[s[g].minX,this.component.grid.getY()]],s[g].maxLine=[[s[g].maxX,this.component.grid.getYend()],[s[g].maxX,this.component.grid.getY()]]}this._buildBorkenLine(e,this.finalPLMap,v,"vertical")},_buildBorkenLine:function(e,t,i,s){for(var r,n,p,f,c,u,g,y,m,v,x,b,S,_,L,C=this.series,w=e.length-1;w>=0;w--)if(L=e[w],y=C[L],v=t[L],y.type==this.type&&"undefined"!=typeof v){r=this._sIndex2ColorMap[L],n=this.query(y,"itemStyle.normal.lineStyle.width"),p=this.query(y,"itemStyle.normal.lineStyle.type"),f=this.query(y,"itemStyle.normal.lineStyle.color"),c=this.getItemStyleColor(this.query(y,"itemStyle.normal.color"),L,-1),u="undefined"!=typeof this.query(y,"itemStyle.normal.areaStyle"),g=this.query(y,"itemStyle.normal.areaStyle.color");for(var M=0,A=v.length;A>M;M++){if(x=v[M],_=this._isLarge(s,x),!_){for(var z=0,k=x.length;k>z;z++)if(m=y.data[x[z][2]],this.deepQuery([m,y],"showAllSymbol")||i.isMainAxis(x[z][2])&&"none"!=this.deepQuery([m,y],"symbol")||this.deepQuery([m,y,this.option],"calculable"))this.shapeList.push(this._getSymbol(L,x[z][2],x[z][3],x[z][0],x[z][1],s))}else x=this._getLargePointList(s,x);if(b=new o({zlevel:this._zlevelBase,style:{miterLimit:n,pointList:x,strokeColor:f||c||r,lineWidth:n,lineType:p,smooth:this._getSmooth(y.smooth),shadowColor:this.query(y,"itemStyle.normal.lineStyle.shadowColor"),shadowBlur:this.query(y,"itemStyle.normal.lineStyle.shadowBlur"),shadowOffsetX:this.query(y,"itemStyle.normal.lineStyle.shadowOffsetX"),shadowOffsetY:this.query(y,"itemStyle.normal.lineStyle.shadowOffsetY")},hoverable:!1,_main:!0,_seriesIndex:L,_orient:s}),h.pack(b,C[L],L,0,M,C[L].name),this.shapeList.push(b),u)S=new a({zlevel:this._zlevelBase,style:{miterLimit:n,pointList:l.clone(x).concat([[x[x.length-1][4],x[x.length-1][5]],[x[0][4],x[0][5]]]),brushType:"fill",smooth:this._getSmooth(y.smooth),color:g?g:d.alpha(r,.5)},hoverable:!1,_main:!0,_seriesIndex:L,_orient:s}),h.pack(S,C[L],L,0,M,C[L].name),this.shapeList.push(S)}}},_isLarge:function(e,t){if(t.length<2)return!1;else return"horizontal"==e?Math.abs(t[0][0]-t[1][0])<.5:Math.abs(t[0][1]-t[1][1])<.5},_getLargePointList:function(e,t){var i;if("horizontal"==e)i=this.component.grid.getWidth();else i=this.component.grid.getHeight();for(var s=t.length,o=[],r=0;i>r;r++)o[r]=t[Math.floor(s/i*r)];return o},_getSmooth:function(e){if(e)return.3;else return 0},_getCalculableItem:function(e,t,i,s,o,r){var a=this.series,n=a[e].calculableHolderColor||this.ecTheme.calculableHolderColor,h=this._getSymbol(e,t,i,s,o,r);return h.style.color=n,h.style.strokeColor=n,h.rotation=[0,0],h.hoverable=!1,h.draggable=!1,h.style.text=void 0,h},_getSymbol:function(e,t,i,s,o,r){var a=this.series,n=a[e],h=n.data[t],l=this.getSymbolShape(n,e,h,t,i,s,o,this._sIndex2ShapeMap[e],this._sIndex2ColorMap[e],"#fff","vertical"==r?"horizontal":"vertical");if(l.zlevel=this._zlevelBase+1,this.deepQuery([h,n,this.option],"calculable"))this.setCalculable(l),l.draggable=!0;return l},getMarkCoord:function(e,t){var i=this.series[e],s=this.xMarkMap[e],o=this.component.xAxis.getAxis(i.xAxisIndex),r=this.component.yAxis.getAxis(i.yAxisIndex);if(t.type&&("max"==t.type||"min"==t.type||"average"==t.type))return[s[t.type+"X"],s[t.type+"Y"],s[t.type+"Line"],s[t.type]];else return["string"!=typeof t.xAxis&&o.getCoordByIndex?o.getCoordByIndex(t.xAxis||0):o.getCoord(t.xAxis||0),"string"!=typeof t.yAxis&&r.getCoordByIndex?r.getCoordByIndex(t.yAxis||0):r.getCoord(t.yAxis||0)]},refresh:function(e){if(e)this.option=e,this.series=e.series;this.backupShapeList(),this._buildShape()},ontooltipHover:function(e,t){for(var i,s,o=e.seriesIndex,r=e.dataIndex,a=o.length;a--;)if(i=this.finalPLMap[o[a]])for(var n=0,h=i.length;h>n;n++){s=i[n];for(var l=0,d=s.length;d>l;l++)if(r==s[l][2])t.push(this._getSymbol(o[a],s[l][2],s[l][3],s[l][0],s[l][1],"horizontal"))}},addDataAnimation:function(e){for(var t=this.series,i={},s=0,o=e.length;o>s;s++)i[e[s][0]]=e[s];for(var r,a,n,h,l,d,p,s=this.shapeList.length-1;s>=0;s--)if(l=this.shapeList[s]._seriesIndex,i[l]&&!i[l][3]){if(this.shapeList[s]._main&&this.shapeList[s].style.pointList.length>1){if(d=this.shapeList[s].style.pointList,a=Math.abs(d[0][0]-d[1][0]),h=Math.abs(d[0][1]-d[1][1]),p="horizontal"==this.shapeList[s]._orient,i[l][2]){if("polygon"==this.shapeList[s].type){var f=d.length;this.shapeList[s].style.pointList[f-3]=d[f-2],p?this.shapeList[s].style.pointList[f-3][0]=d[f-4][0]:this.shapeList[s].style.pointList[f-3][1]=d[f-4][1],this.shapeList[s].style.pointList[f-2]=d[f-1]}this.shapeList[s].style.pointList.pop(),p?(r=a,n=0):(r=0,n=-h)}else{if(this.shapeList[s].style.pointList.shift(),"polygon"==this.shapeList[s].type){var c=this.shapeList[s].style.pointList.pop();p?c[0]=d[0][0]:c[1]=d[0][1],this.shapeList[s].style.pointList.push(c)}p?(r=-a,n=0):(r=0,n=h)}this.zr.modShape(this.shapeList[s].id,{style:{pointList:this.shapeList[s].style.pointList}},!0)}else if(i[l][2]&&this.shapeList[s]._dataIndex==t[l].data.length-1){this.zr.delShape(this.shapeList[s].id);continue}else if(!i[l][2]&&0===this.shapeList[s]._dataIndex){this.zr.delShape(this.shapeList[s].id);continue}this.shapeList[s].position=[0,0],this.zr.animate(this.shapeList[s].id,"").when(500,{position:[r,n]}).start()}}},r.prototype.iconLibrary.legendLineIcon=t,l.inherits(e,s),l.inherits(e,i),require("../chart").define("line",e),e});