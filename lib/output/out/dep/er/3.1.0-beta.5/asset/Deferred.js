/*! @2014 Leo Wang. All Rights Reserved */
define("er/Deferred",["require","./util","./assert","eoo","mini-event/EventTarget"],function(require){function e(e){function t(){for(var t=0;t<n.length;t++){var i=n[t];try{i.apply(e.promise,e._args)}catch(a){}}}if("pending"!==e.state){var n="resolved"===e.state?e._doneCallbacks.slice():e._failCallbacks.slice();if(e.syncModeEnabled)t();else a(t);e._doneCallbacks=[],e._failCallbacks=[]}}function t(e,t,n,i){return function(){if("function"==typeof n){var a=t.resolver;try{var s=n.apply(e.promise,arguments);if(o.isPromise(s))s.then(a.resolve,a.reject);else a.resolve(s)}catch(l){o.fire("exception",{deferred:e,args:[l],reason:l}),a.reject(l)}}else t[i].apply(t,e._args)}}var n=require("./util"),i=require("./assert"),a="function"==typeof window.setImmediate?function(e){window.setImmediate(e)}:function(e){window.setTimeout(e,0)},exports={};exports.constructor=function(){this.state="pending",this._args=null,this._doneCallbacks=[],this._failCallbacks=[],this.promise={done:n.bind(this.done,this),fail:n.bind(this.fail,this),ensure:n.bind(this.ensure,this),then:n.bind(this.then,this)},this.promise.promise=this.promise,this.resolver={resolve:n.bind(this.resolve,this),reject:n.bind(this.reject,this)}},exports.syncModeEnabled=!1,exports.resolve=function(){if("pending"===this.state)this.state="resolved",this._args=[].slice.call(arguments),o.fire("resolve",{deferred:this,args:this._args,reason:this._args[0]}),e(this)},exports.reject=function(){if("pending"===this.state)this.state="rejected",this._args=[].slice.call(arguments),o.fire("reject",{deferred:this,args:this._args,reason:this._args[0]}),e(this)},exports.done=function(e){return this.then(e)},exports.fail=function(e){return this.then(null,e)},exports.ensure=function(e){return this.then(e,e)},exports.then=function(n,i){var a=new o;return a.syncModeEnabled=this.syncModeEnabled,this._doneCallbacks.push(t(this,a,n,"resolve")),this._failCallbacks.push(t(this,a,i,"reject")),e(this),a.promise};var o=require("eoo").create(exports);return require("mini-event/EventTarget").enable(o),o.isPromise=function(e){return e&&"function"==typeof e.then},o.all=function(){function e(e){s--,i.greaterThanOrEquals(s,0,"workingCount should be positive");var t=[].slice.call(arguments,1);if(t.length<=1)t=t[0];if(r[e]=t,0===s)V[l].apply(V,r)}function t(){l="reject",e.apply(this,arguments)}var a=[].concat.apply([],arguments),s=a.length;if(!s)return o.resolved();for(var l="resolve",r=[],V=new o,h=0;h<a.length;h++){var U=a[h];U.then(n.bind(e,U,h),n.bind(t,U,h))}return V.promise},o.resolved=function(){var e=new o;return e.resolve.apply(e,arguments),e.promise},o.rejected=function(){var e=new o;return e.reject.apply(e,arguments),e.promise},o.when=function(e){if(o.isPromise(e))return e;var t=new o;return t.syncModeEnabled=!0,t.resolve(e),t.promise},o.require=function(e){var t=new o;return window.require(e,t.resolver.resolve),t.promise.abort=t.resolver.reject,t.promise},o});