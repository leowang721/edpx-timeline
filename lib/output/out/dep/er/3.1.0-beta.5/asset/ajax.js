/*! @2014 Leo Wang. All Rights Reserved */
define("er/ajax",["require","./assert","./util","./Deferred","eoo","mini-event/EventTarget"],function(require){function e(e,t){for(var n=e?encodeURIComponent(e):"",i=[],a=0;a<t.length;a++){var o=t[a];i[a]=this.serializeData("",o)}return n?n+"="+i.join(","):i.join(",")}function t(e,t){if(1===arguments.length)t=e,e="";if(null==t)t="";var n=this.serializeData.getKey,i=e?encodeURIComponent(e):"",a=Object.prototype.toString.call(t);switch(a){case"[object Array]":return this.serializeArray(e,t);case"[object Object]":var o=[];for(var s in t){var r=n(s,e),l=this.serializeData(r,t[s]);o.push(l)}return o.join("&");default:return i?i+"="+encodeURIComponent(t):encodeURIComponent(t)}}var n="_";t.getKey=function(e,t){return t?t+"."+e:e};var exports={};exports.constructor=function(){this.hooks={serializeData:t,serializeArray:e},this.config={cache:!1,timeout:0,charset:""}},exports.request=function(e){if("function"==typeof this.hooks.beforeExecute)this.hooks.beforeExecute(e);var t=require("./assert");t.hasProperty(e,"url","url property is required");var i={method:"POST",data:{},cache:this.config.cache,timeout:this.config.timeout,charset:this.config.charset},a=require("./util");e=a.mix(i,e);var o=require("./Deferred"),s=new o;if("function"==typeof this.hooks.beforeCreate){var r=this.hooks.beforeCreate(e,s);if(r===!0){var l=s.promise;return l.abort=function(){},l.setRequestHeader=function(){},l}}var h=window.XMLHttpRequest?new XMLHttpRequest:new window.ActiveXObject("Microsoft.XMLHTTP");a.mix(h,e.xhrFields);var l=s.promise,V={abort:function(){h.onreadystatechange=null;try{h.abort()}catch(e){}if(!l.status)l.status=0;l.readyState=h.readyState,l.responseText="",l.responseXML="",s.reject(l)},setRequestHeader:function(e,t){h.setRequestHeader(e,t)},getAllResponseHeaders:function(){return h.getAllResponseHeaders()},getResponseHeader:function(e){return h.getResponseHeader(e)},getRequestOption:function(t){return e[t]}};a.mix(l,V);var U={xhr:l,options:e};l.then(a.bind(this.fire,this,"done",U),a.bind(this.fire,this,"fail",U));var m=function(){if(4===h.readyState){var t=l.status||h.status;if(1223===t)t=204;if(l.status=l.status||t,l.readyState=h.readyState,l.responseText=h.responseText,l.responseXML=h.responseXML,"function"==typeof this.hooks.afterReceive)this.hooks.afterReceive(l,e);if(200>t||t>=300&&304!==t)return void s.reject(l);var n=h.responseText;if("json"===e.dataType)try{n=a.parseJSON(n)}catch(i){return l.error=i,void s.reject(l)}if("function"==typeof this.hooks.afterParse)try{n=this.hooks.afterParse(n,l,e)}catch(i){return l.error=i,void s.reject(l)}s.resolve(n)}};h.onreadystatechange=a.bind(m,this);var p=e.method.toUpperCase(),d={};if("GET"===p)a.mix(d,e.data);if(e.cache===!1)d[n]=+new Date;var c=this.hooks.serializeData("",d,"application/x-www-form-urlencoded"),y=e.url;if(c){var f=y.indexOf("?")>=0?"&":"?";y+=f+c}if(h.open(p,y,!0),"function"==typeof this.hooks.beforeSend)this.hooks.beforeSend(l,e);if("GET"===p)h.send();else{var u=e.contentType||"application/x-www-form-urlencoded",c=this.hooks.serializeData("",e.data,u,l);if(e.charset)u+=";charset="+e.charset;h.setRequestHeader("Content-Type",u),h.send(c)}if(e.timeout>0){var b=function(){this.fire("timeout",{xhr:l,options:e}),l.status=408,l.abort()},k=setTimeout(a.bind(b,this),e.timeout);l.ensure(function(){clearTimeout(k)})}return l},exports.get=function(e,t,n){var i={method:"GET",url:e,data:t,cache:n||this.config.cache};return this.request(i)},exports.getJSON=function(e,t,n){var i={method:"GET",url:e,data:t,dataType:"json",cache:n||this.config.cache};return this.request(i)},exports.post=function(e,t,n){var i={method:"POST",url:e,data:t,dataType:n||"json"};return this.request(i)},exports.log=function(e,t){var n=new Image,i=window.ER_LOG_POOL||(window.ER_LOG_POOL={}),a=+new Date;i[a]=n,n.onload=n.onerror=n.onabort=function(){n.onload=n.onerror=n.onabort=null,i[a]=null,n=null};var o=this.hooks.serializeData("",t,"application/x-www-form-urlencoded");if(o){var s=e.indexOf("?")>=0?":":"?";e+=s+o}n.src=e};var i=require("eoo").create(require("mini-event/EventTarget"),exports),a=new i;return a.Ajax=i,a});