/*! @2014 Leo Wang. All Rights Reserved */
define("er/Model",["require","./util","./Deferred","eoo","mini-event/EventTarget"],function(require){function e(e,t){function n(n){if(t.dump)e.fill(n,h);else e.set(t.name,n,h);return{success:!0,name:t.name,options:t,value:n}}function i(e){return{success:!1,name:t.name,options:t,error:e}}try{var a=t.retrieve(e,t);if(l.isPromise(a)){if("function"==typeof a.abort)e.addPendingWorker(a);return a.then(n,function(t){t=i(t);try{var a=e.handleError(t);return n(a)}catch(o){if(o.success===!1)throw o;else throw i(o)}})}else{var o=n(a);return l.resolved(o)}}catch(s){var r=i(s);return l.rejected(r)}}function t(e,t){for(var n=l.resolved(),a=0;a<t.length;a++){var o=t[a],s=r.bind(i,null,e,o);n=n.then(s)}return n}function n(e,t){var n=[];for(var a in t)if(t.hasOwnProperty(a)){var o=t[a];if("function"==typeof o)o={retrieve:o,name:a};else if("function"==typeof o.retrieve)o=r.mix({name:a},o);n.push(i(e,o))}return l.all(n)}function i(i,a){if(!a)return l.resolved();if("function"==typeof a){var o={retrieve:a,dump:!0};return e(i,o)}if(a instanceof Array)return t(i,a);if("function"==typeof a.retrieve)return e(i,a);else return n(i,a)}function a(e,t){for(var n=0;n<e.pendingWorkers.length;n++)if(e.pendingWorkers[n]===t)return void e.pendingWorkers.splice(n,1)}function o(){function e(e){var t={success:!1,name:"$prepare",options:{},error:e};throw t}try{var t=this.prepare();if(l.isPromise(t))return t.fail(e);else return t}catch(n){e(n)}}function s(e,t,n){var i=e.store.hasOwnProperty(t)?"change":"add",a=e.store[t];if(e.store[t]=n,a!==n)return{type:i,name:t,oldValue:a,newValue:n};else return null}var r=require("./util"),l=require("./Deferred"),h={silent:!0},exports={};exports.constructor=function(e){if(this.store={},this.pendingWorkers=[],e)this.fill(e,h);this.initialize()},exports.initialize=r.noop,exports.addPendingWorker=function(e){this.pendingWorkers.push(e),e.ensure(r.bind(a,null,this,e))},exports.datasource=null,exports.getDatasource=function(){return this.datasource},exports.load=function(){try{var e=this.getDatasource(),t=i(this,e);return t.then(r.bind(o,this))}catch(n){return l.rejected(n)}},exports.prepare=r.noop,exports.get=function(e){return this.store[e]},exports.set=function(e,t,n){n=n||{};var i=s(this,e,t);if(i&&!n.silent){var a={changes:[i]};this.fire("change",a)}return t},exports.fill=function(e,t){t=t||{};var n=[];for(var i in e)if(e.hasOwnProperty(i)){var a=s(this,i,e[i]);if(a)n.push(a)}if(n.length&&!t.silent){var o={changes:n};this.fire("change",o)}return e},exports.remove=function(e,t){if(this.store.hasOwnProperty(e)){t=t||{};var n=this.store[e];if(delete this.store[e],!t.silent){var i={changes:[{type:"remove",name:e,oldValue:n,newValue:void 0}]};this.fire("change",i)}return n}},exports.getAsModel=function(e){var t=this.get(e);if(!t||"[object Object]"!=={}.toString.call(t))return new V;else return new V(t)},exports.dump=function(){return r.mix({},this.store)},exports.has=function(e){return this.store.hasOwnProperty(e)},exports.hasValue=function(e){return this.has(e)&&null!=this.store[e]},exports.hasReadableValue=function(e){return this.hasValue(e)&&""!==this.store[e]},exports.valueOf=function(){return this.dump()},exports.clone=function(){return new V(this.store)},exports.handleError=function(e){throw e},exports.dispose=function(){if(this.pendingWorkers){for(var e=0;e<this.pendingWorkers.length;e++){var t=this.pendingWorkers[e];if("function"==typeof t.abort)try{t.abort()}catch(n){}}this.pendingWorkers=null}};var V=require("eoo").create(require("mini-event/EventTarget"),exports);return V});