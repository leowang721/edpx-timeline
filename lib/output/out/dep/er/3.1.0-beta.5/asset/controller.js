/*! @2014 Leo Wang. All Rights Reserved */
define("er/controller",["require","./Deferred","./URL","./config","./util","./assert","mini-event/EventTarget","eoo","./locator","./router","./events","./permission"],function(require){function e(e,t,n){var i=e.childActionMapping[t.id];if(i){if(e.childActionMapping[t.id]=void 0,i.hijack)if(t.removeEventListener)t.removeEventListener("click",i.hijack,!1);else t.detachEvent("onclick",i.hijack);if(i.action){if(!n)n={url:null,referrer:i.url,container:t.id,isChildAction:!0};if(e.getEventBus().fire("leaveaction",{controller:e,action:i.action,to:n}),"function"==typeof i.action.leave)i.action.leave()}}}function t(t,n,i,a,o){if(e(t,n,o),n.addEventListener)n.addEventListener("click",a,!1);else n.attachEvent("onclick",a);var s={url:o.url,container:n.id,action:i,hijack:a};t.childActionMapping[n.id]=s;var r=require("mini-event/EventTarget");if(i instanceof r)i.on("leave",function(){e(t,n)})}var n=require("./Deferred"),i=require("./URL"),a=require("./config"),o=require("./util"),s=require("./assert"),exports={};exports.constructor=function(){this.actionPathMapping={},this.childActionMapping={},this.currentURL=null,this.currentAction=null,this.globalActionLoader=null,this.childActionLoaders={}},exports.registerAction=function(e){if(!e.hasOwnProperty("length"))e=[e];for(var t=0;t<e.length;t++){var n=e[t];s.hasProperty(n,"path",'action config should contains a "path" property'),this.actionPathMapping[n.path]=n}},exports.getDefaultTitle=function(){return this.defaultTitle},exports.setDefaultTitle=function(e){this.defaultTitle=e},exports.getRouter=function(){return this.router},exports.setRouter=function(e){this.router=e},exports.getLocator=function(){return this.locator},exports.setLocator=function(e){this.locator=e},exports.getEventBus=function(){return this.eventBus},exports.setEventBus=function(e){this.eventBus=e},exports.getPermissionProvider=function(){return this.permissionProvider},exports.setPermissionProvider=function(e){this.permissionProvider=e},exports.getMainContainer=function(){return this.mainContainer||a.mainElement},exports.setMainContainer=function(e){this.mainContainer=e},exports.getNoAuthorityLocation=function(){return this.noAuthorityLocation||a.noAuthorityLocation},exports.setNoAuthorityLocation=function(e){this.noAuthorityLocation=e},exports.getNotFoundLocation=function(){return this.notFoundLocation||a.notFoundLocation},exports.setNotFoundLocation=function(e){this.notFoundLocation=e},exports.start=function(){if(!this.getDefaultTitle())this.setDefaultTitle(a.systemName||document.title);this.getRouter().setBackup(o.bind(this.renderAction,this))},exports.findActionConfig=function(e){var t=e.url.getPath(),n=this.actionPathMapping[t];return n},exports.resolveActionConfig=function(e){return e},exports.checkAuthority=function(e,t){var n=e.authority;if(!n)return!0;var i=this.getPermissionProvider();if("function"==typeof n)return n(t,e,i);if("string"==typeof n)n=n.split("|");for(var a=0;a<n.length;a++)if(i.isAllow(o.trim(n[a])))return!0;return!1},exports.findEligibleActionConfig=function(e){var t=this.findActionConfig(e);if(t&&t.movedTo)return this.getEventBus().fire("actionmoved",{controller:this,url:e.url,config:t,movedTo:t.movedTo}),e.originalURL=e.url,e.url=i.parse(t.movedTo),this.findEligibleActionConfig(e);if(t&&t.childActionOnly&&!e.isChildAction)t=null;if(!t)if(this.getEventBus().fire("actionnotfound",o.mix({controller:this,failType:"NotFound",reason:"Not found"},e)),e.originalURL=e.url,e.url=i.parse(this.getNotFoundLocation()),!this.actionPathMapping[e.url.getPath()])return null;else return this.findEligibleActionConfig(e);var n=this.checkAuthority(t,e);if(!n){this.getEventBus().fire("permissiondenied",o.mix({controller:this,failType:"PermissionDenied",reason:"Permission denied",config:t},e));var a=t.noAuthorityLocation||this.getNoAuthorityLocation();return e.originalURL=e.url,e.url=i.parse(a),this.findEligibleActionConfig(e)}return t},exports.loadAction=function(e){var t=this.findEligibleActionConfig(e);if(t=this.resolveActionConfig(t,e),!t){var i=new n;return i.syncModeEnabled=!1,i.reject("no action configured for url "+e.url.getPath()),i.promise}if(t.title)e.title=t.title,e.args.title=t.title;if(t.documentTitle)e.documentTitle=t.documentTitle,e.args.documentTitle=t.documentTitle;if(t.args)for(var a in t.args)if(t.args.hasOwnProperty(a)){if(!e.args.hasOwnProperty(a))e.args[a]=t.args[a];if(!e.hasOwnProperty(a))e[a]=t.args[a]}var s=new n;s.syncModeEnabled=!1;var r=s.promise,l=!1,h=function(){if(!l)l=!0,this.getEventBus().fire("actionabort",o.mix({controller:this},e))};if(r.abort=o.bind(h,this),!e.isChildAction)this.currentURL=e.url;var V=function(i){if(!l){if(!i){var a="No action implement for "+t.type,r=o.mix({controller:this,failType:"NoModule",config:t,reason:a},e);return this.getEventBus().fire("actionfail",r),this.getEventBus().notifyError(r),void s.reject(a)}if(this.getEventBus().fire("actionloaded",{controller:this,url:e.url,config:t,action:i}),"function"==typeof i)s.resolve(new i,e);else if("function"==typeof i.createRuntimeAction){var h=function(n){if(!n){var i="Action factory returns non-action",a=o.mix({controller:this,failType:"InvalidFactory",config:t,reason:i,action:n},e);this.getEventBus().fire("actionfail",a),this.getEventBus().notifyError(a),s.reject(i)}else s.resolve(n,e)};h=o.bind(h,this);var V=i.createRuntimeAction(e);n.when(V).then(h)}else s.resolve(i,e)}};if(V=o.bind(V,this),"string"==typeof t.type)window.require([t.type],V);else V(t.type);return r},exports.enterAction=function(e,t){if(!t.isChildAction){if(t.url!==this.currentURL)return;if(this.currentAction)if(this.getEventBus().fire("leaveaction",{controller:this,action:this.currentAction,to:o.mix({},t)}),"function"==typeof this.currentAction.leave)this.currentAction.leave();this.currentAction=e,document.title=t.title||t.documentTitle||this.getDefaultTitle()}this.getEventBus().fire("enteraction",o.mix({controller:this,action:e},t));var n=function(){this.getEventBus().fire("enteractioncomplete",o.mix({controller:this,action:e},t))};n=o.bind(n,this);var i=function(e){var n="";if(!e)n="Invoke action.enter() causes error";else if(e.message){if(n=e.message,e.stack)n+="\n"+e.stack}else if(window.JSON&&"function"==typeof JSON.stringify)try{n=JSON.stringify(e)}catch(i){n=e}else n=e;var a=o.mix({failType:"EnterFail",reason:n},t);this.getEventBus().fire("enteractionfail",a),this.getEventBus().notifyError(a)};i=o.bind(i,this);var a=e.enter(t);return a.then(n,i),a},exports.forward=function(e,t,n,i){var a={url:e,container:t,isChildAction:!!i};if(i){var r=this.childActionMapping[t];a.referrer=r?r.url:null}else a.referrer=this.currentURL;o.mix(a,n),a.args=o.mix({},a),o.mix(a.args,e.getQuery()),this.getEventBus().fire("forwardaction",o.mix({controller:this},a));var l=this.loadAction(a);return s.has(l,"loadAction should always return a Promise"),l},exports.renderAction=function(e){if("string"==typeof e)e=i.parse(e);if(this.globalActionLoader&&"function"==typeof this.globalActionLoader.abort)this.globalActionLoader.abort();if(this.currentAction&&"function"==typeof this.currentAction.filterRedirect&&this.currentAction.filterRedirect(e)===!1)return n.rejected("Redirect aborted by previous action");this.globalActionLoader=this.forward(e,this.getMainContainer(),null,!1);var t=this.getEventBus();return this.globalActionLoader.then(o.bind(this.enterAction,this)).fail(o.bind(t.notifyError,t))},exports.enterChildAction=function(n,i){function a(t,n,a){n=n||{};var t=h.resolveURL(t,n);if(n.global){var o=document.getElementById(i.container),s=h.redirect(t,n);if(s&&o)e(V,o);return s}var r=V.childActionMapping[i.container],l=t.toString()!==r.url.toString(),U=l||n.force;if(U)if(n.silent)r.url=t;else V.renderChildAction(t,r.container,a);return U}function s(e){if(e.isChildActionRedirected)return!0;for(var t=e.target||e.srcElement;t&&(!t.id||!V.childActionMapping[t.id]);)t=t.parentNode;if(t.id!==i.container)return e.isChildActionRedirected=!0,!0;else return!1}function r(e){e=e||window.event;var t=e.target||e.srcElement;if("a"===t.nodeName.toLowerCase()){var n=t.getAttribute("href",2)||"";if("#"===n.charAt(0))if(!s(e)){if(e.preventDefault)e.preventDefault();else e.returnValue=!1;for(var i=n.substring(1),r=(t.getAttribute("data-redirect")||"").split(/[,\s]/),l={},h=0;h<r.length;h++){var V=o.trim(r[h]);l[V]=!0}a(i,l)}}}this.childActionLoaders[i.container]=null;var l=document.getElementById(i.container);if(l){var h=this.getLocator(),V=this;return n.redirect=a,n.reload=function(e){this.redirect(i.url,{force:!0},e)},n.back=function(e,t){var n=this.context&&this.context.referrer,i=n||e;this.redirect(i,null,t)},t(this,l,n,r,i),this.enterAction(n,i)}},exports.renderChildAction=function(e,t,a){if(s.has(t),"string"==typeof e)e=i.parse(e);var r=this.childActionLoaders[t];if(r&&"function"==typeof r.abort)r.abort();var l=this.childActionMapping[t],h=l&&l.action;if(h&&"function"==typeof h.filterRedirect&&h.filterRedirect(e)===!1)return n.rejected("Redirect aborted by previous action");var V=this.forward(e,t,a,!0),U=this.getEventBus(),m=V.then(o.bind(this.enterChildAction,this)).fail(o.bind(U.notifyError,U));return m.abort=V.abort,this.childActionLoaders[t]=m,m};var r=require("eoo").create(require("mini-event/EventTarget"),exports),l=new r;return l.setLocator(require("./locator")),l.setRouter(require("./router")),l.setEventBus(require("./events")),l.setPermissionProvider(require("./permission")),l.Controller=r,l});